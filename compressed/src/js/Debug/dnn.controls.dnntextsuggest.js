Type.registerNamespace("dnn.controls"),dnn.extend(dnn.controls,{initTextSuggest:function(ctl){if(ctl){var ts=new dnn.controls.DNNTextSuggest(ctl);return ts.initialize(),ts}}}),dnn.controls.DNNTextSuggest=function(o){dnn.controls.DNNTextSuggest.initializeBase(this,[o]),this.resultCtr=null,this.tscss=this.getProp("tscss",""),this.css=this.getProp("css",""),this.cssChild=this.getProp("csschild",""),this.cssHover=this.getProp("csshover",""),this.cssSel=this.getProp("csssel",""),this.sysImgPath=this.getProp("sysimgpath",""),this.workImg="dnnanim.gif",this.target=this.getProp("target",""),this.defaultJS=this.getProp("js",""),this.postBack=this.getProp("postback",""),this.callBack=this.getProp("callback",""),this.callBackStatFunc=this.getProp("callbackSF",""),this.callBackStatFunc.length>0&&this.add_handler("callBackStatus",eval(this.callBackStatFunc)),this.rootNode=null,this.selNode=null,this.selIndex=-1,this.lookupDelay=this.getProp("ludelay","500"),this.lostFocusDelay=this.getProp("lfdelay","500"),this.inAnimObj=null,this.inAnimType=null,this.prevText="",this.addHandlers(o,{keyup:this.keyUp,keypress:this.keyPress,blur:this.onblur,focus:this.onfocus},this),o.setAttribute("autocomplete","off"),this.delimiter=this.getProp("del",""),this.idtoken=this.getProp("idtok",""),this.maxRows=new Number(this.getProp("maxRows","10")),0==this.maxRows&&(this.maxRows=9999),this.minChar=new Number(this.getProp("minChar","1")),this.caseSensitive="1"==this.getProp("casesens","0"),this.prevLookupText="",this.prevLookupOffset=0,this._blurHideDelegate=dnn.createDelegate(this,this.blurHide),this._doLookupDelegate=dnn.createDelegate(this,this.doLookup)},dnn.controls.DNNTextSuggest.prototype={keyPress:function(e){if(e.charCode==KEY_RETURN)return e.stopPropagation(),e.preventDefault(),!1},onblur:function(e){dnn.doDelay(this.ns+"ob",this.lostFocusDelay,this._blurHideDelegate)},onfocus:function(e){dnn.cancelDelay(this.ns+"ob")},blurHide:function(e){this.clearResults(!0)},keyUp:function(e){this.prevText=this.container.value,e.keyCode==KEY_UP_ARROW?this.setNodeIndex(this.selIndex-1):e.keyCode==KEY_DOWN_ARROW?this.setNodeIndex(this.selIndex+1):e.keyCode==KEY_RETURN?this.selIndex>-1&&(this.selectNode(this.getNodeByIndex(this.selIndex)),this.clearResults(!0)):e.keyCode==KEY_ESCAPE?this.clearResults(!0):(dnn.cancelDelay(this.ns+"kd"),dnn.doDelay(this.ns+"kd",this.lookupDelay,this._doLookupDelegate))},nodeMOver:function(evt){var node=this._findEventNode(evt);if(null!=node){var tsNode=new dnn.controls.DNNTextSuggestNode(node);tsNode.hover=!0,this.assignCss(tsNode)}},nodeMOut:function(evt){var node=this._findEventNode(evt);if(null!=node){var tsNode=new dnn.controls.DNNTextSuggestNode(node);tsNode.hover=!1,this.assignCss(tsNode)}},nodeClick:function(evt){var node=this._findEventNode(evt);if(null!=node){var tsNode=new dnn.controls.DNNTextSuggestNode(node);this.selectNode(tsNode),this.clearResults(!0)}},getTextOffset:function(){var offset=0;if(this.delimiter.length>0){var ary=this.container.value.split(this.delimiter),pos=dnn.dom.cursorPos(this.container),len=0;for(offset=0;offset<ary.length-1&&(len+=ary[offset].length+1,!(len>pos));offset++);}return offset},setText:function(s,id){if(this.idtoken.length>0&&(s+=" "+this.idtoken.replace("~",id)),this.delimiter.length>0){var ary=this.container.value.split(this.delimiter);ary[this.getTextOffset()]=s,this.container.value=ary.join(this.delimiter),this.container.value.lastIndexOf(this.delimiter)!=this.container.value.length-1&&(this.container.value+=this.delimiter)}else this.container.value=s;this.prevText=this.container.value},getText:function(){if(this.delimiter.length>0&&this.container.value.indexOf(this.delimiter)>-1){var ary=this.container.value.split(this.delimiter);return ary[this.getTextOffset()]}return this.container.value},formatText:function(s){return this.caseSensitive?s:s.toLowerCase()},highlightNode:function(index,bHighlight){if(index>-1){var tsNode=this.getNodeByIndex(index);tsNode.hover=bHighlight,this.assignCss(tsNode)}},getNodeByIndex:function(index){var element=this.resultCtr.childNodes[index];if(element){var node=this.rootNode.findNode(this.getChildControlBaseId(element));if(node)return new dnn.controls.DNNTextSuggestNode(node)}},setNodeIndex:function(index){index>-1&&index<this.resultCtr.childNodes.length&&(this.highlightNode(this.selIndex,!1),this.selIndex=index,this.highlightNode(this.selIndex,!0))},selectNode:function(tsNode){var arg=new dnn.controls.DNNNodeEventArgs(tsNode);if(this.invoke_handler("click",arg),!arg.get_cancel()){if(null!=this.selNode&&(this.selNode.selected=null,this.assignCss(this.selNode)),tsNode.selected?(tsNode.selected=null,this.assignCss(tsNode)):(tsNode.selected=!0,this.assignCss(tsNode)),this.selNode=tsNode,tsNode.selected){this.setText(tsNode.text,tsNode.id);var js="";if(this.defaultJS.length>0&&(js=this.defaultJS),tsNode.js.length>0&&(js=tsNode.js),js.length>0&&0==eval(js))return;null==tsNode.clickAction||tsNode.clickAction==dnn.controls.action.postback?eval(this.postBack.replace("[TEXT]",this.getText())):tsNode.clickAction==dnn.controls.action.nav&&dnn.dom.navigate(tsNode.url,tsNode.target.length>0?tsNode.target:this.target)}return!0}},positionMenu:function(){var dims=new dnn.dom.positioning.dims(this.container);this.resultCtr.style.left=dims.l-dnn.dom.positioning.bodyScrollLeft(),this.resultCtr.style.top=dims.t+dims.h},showResults:function(){this.resultCtr&&(this.resultCtr.style.display="")},hideResults:function(){this.resultCtr&&(this.resultCtr.style.display="none"),dnn.dom.positioning.placeOnTop(this.resultCtr,!1,this.sysImgPath+"spacer.gif")},clearResults:function(hide){null!=this.resultCtr&&(this.resultCtr.innerHTML=""),this.selIndex=-1,this.selNode=null,hide&&this.hideResults()},clear:function(){this.clearResults(),this.setText("","")},doLookup:function(){this.getText().length>=this.minChar?this.needsLookup()?(this.prevLookupOffset=this.getTextOffset(),this.prevLookupText=this.formatText(this.getText()),eval(this.callBack.replace("[TEXT]",this.prevLookupText))):this.renderResults(null):this.clearResults()},needsLookup:function(){if(null==this.rootNode)return!0;if(this.prevLookupOffset!=this.getTextOffset()||null==this.rootNode)return!0;if(0==this.formatText(this.getText()).indexOf(this.prevLookupText)){if(this.rootNode.childNodeCount()<this.maxRows)return!1;for(var node,oneMatch=!1,text=this.getText(),i=0;i<this.maxRows;i++)if(node=new dnn.controls.DNNTextSuggestNode(this.rootNode.childNodes(i)),0==this.formatText(node.text).indexOf(text)){if(0==i)return!1;oneMatch=!0}else if(oneMatch)return!1}return!0},renderResults:function(result){if(null!=result){var json=dnn.evalJSON("{"+result+"}");this.nodes=json.nodes,this.rootNode={},this.rootNode.nodes=this.nodes,this.rootNode.id=this.ns,this.rootNode=new dnn.controls.JSONNode(this.rootNode,"root",0)}if(null!=this.rootNode){null==this.resultCtr&&this.renderContainer(),this.clearResults();for(var i=0;i<this.rootNode.childNodeCount();i++)this.renderNode(this.rootNode.childNodes(i),this.resultCtr);this.showResults()}dnn.dom.positioning.placeOnTop(this.resultCtr,!0,this.sysImgPath+"spacer.gif")},renderContainer:function(){this.resultCtr=document.createElement("DIV"),this.container.parentNode.appendChild(this.resultCtr),this.resultCtr.className=this.tscss,this.resultCtr.style.position="absolute",this.positionMenu()},renderNode:function(node,ctr){var tsNode;if(tsNode=new dnn.controls.DNNTextSuggestNode(node),0==this.formatText(tsNode.text).indexOf(this.formatText(this.getText()))&&ctr.childNodes.length<this.maxRows){var newCtr=this.createChildControl("div",tsNode.id,"ctr");newCtr.appendChild(this.renderText(tsNode)),tsNode.enabled&&this.addHandlers(newCtr,{click:this.nodeClick,mouseover:this.nodeMOver,mouseout:this.nodeMOut},this),tsNode.toolTip.length>0&&(newCtr.title=tsNode.toolTip),ctr.appendChild(newCtr),this.assignCss(tsNode)}},renderText:function(tsNode){var span=this.createChildControl("SPAN",tsNode.id,"t");return span.innerHTML=tsNode.text,span.style.cursor="pointer",span},assignCss:function(tsNode){var oCtr=this.getChildControl(tsNode.id,"ctr"),nodeCss=this.css;tsNode.css.length>0&&(nodeCss=tsNode.css),tsNode.hover&&(nodeCss+=" "+(tsNode.cssHover.length>0?tsNode.cssHover:this.cssHover)),tsNode.selected&&(nodeCss+=" "+(tsNode.cssSel.length>0?tsNode.cssSel:this.cssSel)),oCtr.className=nodeCss},callBackStatus:function(result,ctx,req){var ts=ctx;ts.invoke_compatHandler("callBackStatus",result,ctx,req)},callBackSuccess:function(result,ctx,req){var ts=ctx;ts.invoke_compatHandler("callBackStatus",result,ctx,req),ts.invoke_handler("callBackSuccess",new dnn.controls.DNNCallbackEventArgs(result,ctx,req)),ts.renderResults(result)},callBackFail:function(result,ctx,req){var ts=ctx;ts.invoke_handler("callBackFail",new dnn.controls.DNNCallbackEventArgs(result,ctx,req))},_findEventNode:function(evt){return this.rootNode.findNode(this.getChildControlBaseId(evt.target))},dispose:function(){this._blurHideDelegate=null,this._doLookupDelegate=null,dnn.controls.DNNTextSuggest.callBaseMethod(this,"dispose")}},dnn.controls.DNNTextSuggest.registerClass("dnn.controls.DNNTextSuggest",dnn.controls.control),dnn.controls.DNNTextSuggestNode=function(node){dnn.controls.DNNTextSuggestNode.initializeBase(this,[node]),this.hover=!1,this.selected="1"==node.getAttribute("selected","0")||null,this.clickAction=node.getAttribute("ca",dnn.controls.action.none)},dnn.controls.DNNTextSuggestNode.prototype={childNodes:function(index){if(null!=this.node.childNodes[index])return new dnn.controls.DNNTextSuggestNode(this.node.childNodes[index])}},dnn.controls.DNNTextSuggestNode.registerClass("dnn.controls.DNNTextSuggestNode",dnn.controls.DNNNode);