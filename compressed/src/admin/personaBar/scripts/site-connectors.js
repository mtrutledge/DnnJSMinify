"use strict";define(["jquery","knockout","../scripts/pager","../scripts/validator","../scripts/config","../scripts/PersonaBarDialog"],function($,ko,pager,validator,cf,personaBarDialog){var utility=null,config=cf.init(),viewModel={connections:ko.observableArray([])};ko.protectedObservable=function(initialValue){var actualValue=ko.observable(initialValue),tempValue=ko.observable(initialValue),result=tempValue;return result.commit=function(){tempValue()!==actualValue()&&actualValue(tempValue().trim())},result.reset=function(){actualValue.valueHasMutated(),tempValue(actualValue())},result};var wrapConnection=function(conn){var koConfigurations=[];$.each(conn.configurations,function(key,value){var o={};o.name=key,o.localizedName=key,o.value=ko.protectedObservable(value),koConfigurations.push(o)});var koConnectionObject={name:conn.name,displayName:conn.displayName,icon:conn.icon,previousConnectionState:ko.observable(conn.connected),connected:ko.observable(conn.connected),faviconCss:ko.computed(function(){var css="socialnetwork-favicon "+conn.name;return css}),inEdit:ko.observable(!1),editLayout:ko.observable(""),buttons:ko.observableArray([]),edit:function(item,e){e.preventDefault();var btn=$(e.target),editRow=btn.parent().parent().next().find("td > div"),showEditRow=function(){$.each(viewModel.connections(),function(i,v){v.inEdit(!1)}),item.inEdit(!0),editRow.slideDown(400,"linear",function(){$(this).find("input:first").select()})},collapsedEditRow=$("#connectionstbl tr.edit-row > td > div:visible");collapsedEditRow.length>0?collapsedEditRow.slideUp(200,"linear",showEditRow):showEditRow()},cancel:function(item,e){e.preventDefault(),$.each(item.configurations,function(i,v){v.value.reset()}),$(e.target).parents("div.edit-form").slideUp(200,"linear"),item.connected(item.previousConnectionState()),item.inEdit(!1)},save:function(item,e,cb){e.preventDefault(),item.connected(!1);var container=$(e.target).parents("div.edit-form");saveConnection(item,function(success,validated){container.slideUp(200,"linear"),utility.notify(utility.resx.PersonaBar.txt_Saved,!0),item.inEdit(!1),item.connected(validated),success&&(item.previousConnectionState(validated),$.each(item.configurations,function(i,v){v.value.commit()})),"function"==typeof cb&&cb.call(item,!0)},function(xhr,status){utility.notifyError(status||"Failed..."),"function"==typeof cb&&cb.call(item,!1)})},configurations:koConfigurations},pluginFolder=conn.pluginFolder,pluginJs="rootPath"+pluginFolder+"scripts/connector",pluginCss="css!rootPath"+pluginFolder+"connector.css",pluginHtml="text!rootPath"+pluginFolder+"connector.htm";return require([pluginJs,pluginHtml,pluginCss],function(connector,layout){loadLocalizedStrings(conn.name,function(data){for(var i=0;i<koConfigurations.length;i++)"undefined"!=typeof data[koConfigurations[i].name]&&(koConfigurations[i].localizedName=data[koConfigurations[i].name]);koConnectionObject.resx=data,koConnectionObject.connector=connector,connector.init(koConnectionObject,connectionHelper,pluginFolder,utility),koConnectionObject.editLayout(layout);var buttons=getDefaultButtons();"function"==typeof connector.getActionButtons&&(buttons=connector.getActionButtons());for(var i=0;i<buttons.length;i++)koConnectionObject.buttons.push(buttons[i]);$("#connector-"+koConnectionObject.name).find(".edit-fields").children().each(function(){ko.applyBindings(koConnectionObject,this)})})}),koConnectionObject},getDefaultButtons=function(){return[{className:"primarybtn",text:viewModel.resx.btn_Save,action:function(conn,e){conn.save(conn,e)}}]},onSaveConnection=!1,saveConnection=function(conn,success,forceSave){if(!onSaveConnection){onSaveConnection=!0,viewModel.errorMessage(""),conn.connector&&conn.connector.onSave(conn),utility.sf.moduleRoot="dnncorp/personaBar",utility.sf.controller="connections";for(var postData={name:conn.name,configurations:[]},allEmpty=!0,allFilled=!0,i=0;i<conn.configurations.length;i++){var c=conn.configurations[i],value=c.value();postData.configurations.push({name:c.name,value:value}),""!=value?allEmpty=!1:allFilled=!1}var primaryButtons=$("#connector-"+conn.name).find("a.primarybtn");if(!(allEmpty||allFilled||forceSave))return primaryButtons.addClass("disabledbtn"),void(onSaveConnection=!1);primaryButtons.removeClass("disabledbtn"),viewModel.errorMessage(""),primaryButtons.html(viewModel.resx.btn_Checking),utility.sf.post("SaveConnection",postData,function(d){primaryButtons.html(viewModel.resx.btn_Save),d?d.Success?success(d.Success,d.Validated):d.Message?utility.notifyError(d.Message||"Failed..."):utility.notifyError("Failed..."):utility.notifyError("Failed..."),onSaveConnection=!1},function(xhr,status){primaryButtons.html(viewModel.resx.btn_Save),xhr.responseJSON?utility.notifyError(xhr.responseJSON.Message||status||"Failed..."):utility.notifyError(status||"Failed..."),onSaveConnection=!1})}},loadConnections=function(cb){utility.sf.moduleRoot="dnncorp/personaBar",utility.sf.controller="connections",utility.sf.get("GetConnections",null,function(data){var conn=[];$.each(data,function(i,v){conn.push(wrapConnection(v))}),viewModel.connections(conn)},function(xhr,status){utility.notifyError(status||"Failed...")}),"function"==typeof cb&&cb()},connectionHelper={loadConnections:loadConnections,saveConnection:saveConnection},localStorageAllowed=function(){var mod="DNN_localStorageTEST";try{return window.localStorage.setItem(mod,mod),window.localStorage.removeItem(mod),!0}catch(e){return!1}},loadLocalizedStrings=function(name,cb){var allowLocalStorage=localStorageAllowed(),storageName="Connections."+name+"."+config.culture+".Table";if(allowLocalStorage&&window.localStorage[storageName]){var table=JSON.parse(window.localStorage[storageName]),time=(new Date).getTime()-table.timestamp;if(!(time>36e5))return void cb(table);window.localStorage.removeItem(storageName)}utility.sf.moduleRoot="dnncorp/personaBar",utility.sf.controller="connections",utility.sf.get("GetConnectionLocalizedString",{name:name,culture:config.culture},function(data){if(allowLocalStorage)try{data.timestamp=(new Date).getTime(),window.localStorage[storageName]=JSON.stringify(data)}catch(ex){"QuotaExceededError"===ex.name&&console.log("Local Storage might be full."),console.log(ex),window.localStorage[storageName]&&window.localStorage.removeItem(storageName)}cb(data)})},copyUtility=function(util){var shadow={};for(var prop in util)"notify"!=prop&&(shadow[prop]=util[prop]);return shadow.notify=notifyMessage,shadow.popupNotify=util.notify,shadow},notifyMessage=function(text,success){success?(viewModel.errorMessage(""),utility.popupNotify(text)):viewModel.errorMessage(text)};return{init:function(wrapper,util,params,callback){utility=copyUtility(util),utility.localizeErrMessages(validator),utility.asyncParallel([function(cb1){loadConnections(cb1)}],function(){var container=wrapper[0];viewModel.resx=utility.resx.PersonaBar,viewModel.errorMessage=ko.observable(""),ko.applyBindings(viewModel,container),"function"==typeof callback&&callback()})},initMobile:function(wrapper,util,params,callback){this.init(wrapper,util,params,callback)},load:function(params,callback){"function"==typeof callback&&callback()},loadMobile:function(params,callback){this.load(params,callback)}}});