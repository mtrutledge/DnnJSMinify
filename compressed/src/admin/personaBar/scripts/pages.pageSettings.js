"use strict";"undefined"!=typeof dnn&&null!==dnn||(dnn={}),define(["jquery","knockout","../scripts/config","pikaday","moment","../scripts/pages.thumbnails","knockout.validation.min","../scripts/koComponents/dateTimePicker"],function($,ko,cf,pikaday,moment){var config=cf.init(),pageSettingsManager=function(options){this.options=options};pageSettingsManager.prototype={constructor:pageSettingsManager,init:function(){this._initValidationConfiguration(),this.options=$.extend({},pageSettingsDefaultOptions,this.options),this.container=$('<div class="pageSettingsContainer pageSettingsForm" />'),this.panel=$("#pages-panel"),this.panel.append(this.container),this.mobile=null!==window.parent.document.getElementById("personaBar-mobi-iframe");var handler=this;$(window).resize(function(){handler._resizeContentContainer()})},getElement:function(){return this.container},edit:function(pageId,activeViewIndex){this._initForm("edit",function(){"undefined"!=typeof pageId&&null!==pageId||(pageId=config.tabId),"undefined"==typeof activeViewIndex&&(activeViewIndex=0),this._setCurrentPageId(pageId),this._setActiveViewIndex(activeViewIndex),this._editTab()})},addpage:function(){this._initForm("addpage",function(){this._setCurrentPageId(-1),this._addTab()})},addtpl:function(){this._initForm("addtpl",function(){this._setCurrentPageId(-1),this._addTab("template")})},_initValidationConfiguration:function(){var handler=this;ko.validation.rules.pattern.message="Invalid.",ko.validation.configure({registerExtenders:!0,messagesOnModified:!0,insertMessages:!0,parseInputAttributes:!0,messageTemplate:null}),ko.validation.rules.needTemplate={validator:function(val,otherVal){return handler._getViewModel().page().tabId()>0||handler._getViewModel().page().templateId()>0},message:""},ko.validation.registerExtenders()},_initForm:function(type,callback){if(this._formLoaded!==type)return void this._loadForm(type,function(){this._initForm(type,callback)});var handler=this;this._resizeContentContainer();var formContainer=this.container,panel=this.panel;formContainer.css({top:0,left:0}).hide(),panel.fadeOut("fast",function(){formContainer.show(),panel.fadeIn("fast",function(){handler._formOpened=!0,callback.call(handler),$(window).trigger("resize")})})},_closeForm:function(callback){var handler=this,formContainer=this.container,panel=this.panel;panel.fadeOut("fast",function(){handler._formOpened=!1,formContainer.hide();var showMainPanel=!0;"function"==typeof callback&&(showMainPanel=callback.call(handler)),showMainPanel&&panel.fadeIn("fast")})},_getTemplate:function(type){return"pages-"+type+(this.mobile?".mobi":"")+".html"},_loadForm:function(type,callback){var handler=this,template=this._getTemplate(type);window.require(["text!templatePath/"+template],function(content){handler._createForm(type,content),callback.call(handler)})},_createForm:function(type,content){"undefined"==typeof this._form?(this._form=$('<div class="pageSettingsForm" />'),this.container.append(this._form)):ko.cleanNode(this._form[0]);var editForm=this._form;editForm.empty().append(content),this._addEventHandlers(),this._initUI(),this._viewModel=null;var viewModel=this._getViewModel();return ko.applyBindings(viewModel,editForm[0]),this._formLoaded=type,editForm},_initUI:function(){var handler=this;this._form.find(".page-settings div.body").tabs({activate:function(event,ui){setTimeout(function(){handler._resizeContentContainer()},0)}}),this._form.find('.page-settings div.body .form-item input[type="checkbox"]').dnnCheckbox(),this._form.find(".tags-input").dnnTagsInput({width:"100%",minInputWidth:"80px",defaultText:"",onAddTag:$.proxy(this._fieldsUpdateHandler,this),onRemoveTag:$.proxy(this._fieldsUpdateHandler,this)}),this._form.find(".um-page-url-textbox input").prefixInput({prefix:"/"}).on("blur",function(){var $this=$(this);""==$this.val()&&$this.trigger("change")}),setTimeout(function(){var scoller=$("div.pagetemplate-list-scroller");scoller.jScrollPane()},100)},_resizeContentContainer:function(){if(this._form){var totalWidth=0,$templateScroller=this.container.find("div.pagetemplate-list-scroller");$templateScroller.find("div.pagetemplate-list-item").each(function(){totalWidth+=$(this).outerWidth()+parseInt($(this).css("margin-left"))+parseInt($(this).css("margin-right"))}),this.container.find(".pagetemplate-list-container").width(totalWidth),$templateScroller.data("jsp")&&($templateScroller.data("jsp").destroy(),$templateScroller=this.container.find("div.pagetemplate-list-scroller")),$templateScroller.jScrollPane()}},_addEventHandlers:function(){var saveButton=this._form.find("div.actions a.save"),createButton=this._form.find("div.actions a.create-page"),backButton=$(".pageSettingsForm a.go-back, .pageSettingsForm div.actions a.cancel"),showInPageMgmtButton=this._form.find("a.show-in-page-mgmt"),copyPermissionButton=this._form.find("a.btn-copypermission"),saveTemplateButton=$(".pageSettingsForm div.actions a.savetpl"),cancelTemplateButton=$(".pageSettingsForm div.actions a.cancel-tpl");saveButton.click($.proxy(this._saveDetails,this)),createButton.click($.proxy(this._saveDetails,this)),backButton.click($.proxy(this._back,this)),showInPageMgmtButton.click($.proxy(this._showInPageMgmt,this)),copyPermissionButton.click($.proxy(this._copyPermission,this)),saveTemplateButton.click($.proxy(this._saveTemplateClickHandler,this)),cancelTemplateButton.click($.proxy(this._cancelSaveAsTemplateClickHandler,this)),this._form.find("input, textarea, select").change($.proxy(this._fieldsUpdateHandler,this)).keyup($.proxy(this._fieldsUpdateHandler,this))},_copyPageHandler:function(){var viewModel=this._getViewModel(),pageModel=viewModel.page(),sourceTabId=pageModel.tabId();this._setCurrentPageId(-1),pageModel.tabId(-1),pageModel.name(""),pageModel.url(""),pageModel.templateId(sourceTabId),pageModel.isCopy(!0),viewModel.changed(!0)},_saveAsTemplateClickHandler:function(e){this._getViewModel().editType("template");var pageModel=this._getViewModel().page(),templateModel=this._getViewModel().template();templateModel.name(pageModel.name()),templateModel.description(pageModel.description()),templateModel.templateId(pageModel.tabId()),this._showTemplateDialog()},_cancelSaveAsTemplateClickHandler:function(e){$(".dialog-newtpl").dialog("close")},_showTemplateDialog:function(title){$(".dialog-newtpl").dialog({autoOpen:!0,dialogClass:"dnnFormPopup",title:this.resx.pagesettings_SaveTemplate,modal:!0})},_saveTemplateClickHandler:function(e){var templateModel=this._getViewModel().template();templateModel.tabId(0),templateModel.pageType("template"),templateModel.url(""),this._saveTemplate()},_fieldsUpdateHandler:function(e){this._getViewModel().changed(!0)},hasPendingChanges:function(){return this._formOpened},handlePendingChanges:function(e){var handler=this;return this._checkPendingChange(e,function(){this._closeForm(function(){handler._pageContentChanged&&$(e.target).data("need-refresh",!0);var events=$._data(e.target,"events").click;if(events&&events.length>1)for(var i=1;i<events.length;i++)events[i].handler.call(e.target,e);dnn.dnnPageHierarchy&&dnn.dnnPageHierarchy._closePersonaBarOnUpdate&&(dnn.dnnPageHierarchy._closePersonaBarOnUpdate=!1);var requestPanelId=$(e.target).data("panel-id");return requestPanelId&&this.panel.attr("id")===requestPanelId.replace("#","")&&!this.panel.is(":visible")})}),e.stopImmediatePropagation(),!1},_setCurrentPageId:function(pageId){this._currentPageId=pageId},_getCurrentPageId:function(){return this._currentPageId},_setActiveViewIndex:function(viewIndex){this._activeViewIndex=viewIndex},_getActiveViewIndex:function(){var index=this._activeViewIndex;return this._activeViewIndex=0,index},_editTab:function(){var handler=this,pagePayload={pageId:this._getCurrentPageId()};this._getViewModel().enableScheduling(!1);var getWorkflowsPromise=this._getService().get("GetWorkflows"),getPageDetailsPromise=this._getService().get("GetPageDetails",pagePayload),getPermissionGridDataPromise=this._getService().get("GetPermissionsData",pagePayload);$.when(getWorkflowsPromise,getPageDetailsPromise,getPermissionGridDataPromise).then(function(argsWorkflows,argsPageDetails,argsPermissions){var workflows=argsWorkflows[0],pageDetails=argsPageDetails[0],permissions=argsPermissions[0];handler._viewModel.workflows.removeAll(),ko.utils.arrayPushAll(handler._viewModel.workflows,workflows),handler._updateViewModel(pageDetails),handler._form.find(".tags-input").each(function(){$(this).dnnImportTags(handler._getViewModel().page().tags())}),handler._resizeContentContainer(),handler._buildPermissionGrid(permissions)}),this._form.find(".page-settings div.body").tabs("option","active",this._getActiveViewIndex())},_getTabUrlPreview:function(url){var handler=this,deferred=$.Deferred();return url?handler._getService().getsilence("GetPageUrlPreview",{url:url},function(data){deferred.resolve("/"+data.Url)}):deferred.resolve("/"),deferred.promise()},_addTab:function(type){var handler=this;this._getViewModel().enableScheduling(!1),this._updateViewModel(this._getInitialViewModel()),"undefined"!=typeof type&&this._getViewModel().page().pageType(type),this._form.find(".tags-input").each(function(){$(this).dnnImportTags($(this).val())}),this._getService().get("GetAddNewPageInfo",{},function(data){var vm=handler._getViewModel();vm.page().description(data.defaults.description),vm.page().keywords(data.defaults.keywords),vm.page().isWorkflowCompleted(!0),vm.workflows.removeAll();for(var i=0;i<data.workflows.length;i++)vm.workflows.push(data.workflows[i]),data.workflows[i].IsDefaultWorkflow===!0&&vm.page().workflowId(data.workflows[i].WorkflowId);vm.pageTemplates.removeAll();for(var defaultTemplateId=0,i=0;i<data.templates.length;i++)vm.pageTemplates.push(data.templates[i]),data.templates[i].useDefaultSkin&&(defaultTemplateId=data.templates[i].id);vm.page().name.extend({rateLimit:500}).subscribe(function(val){vm.isTitleDirty||(vm.page().title(val),vm.isTitleDirty=!1),vm.isUrlDirty||handler._getTabUrlPreview(val).done(function(urlPreview){vm.page().url(urlPreview),vm.isUrlDirty=!1})});var descriptionSubscription=vm.page().description.subscribe(function(){vm.isDescriptionDirty(!0),descriptionSubscription.dispose()}),keyWordsSubscription=vm.page().keywords.subscribe(function(){vm.isKeyWordsDirty(!0),keyWordsSubscription.dispose()});vm.page().title.subscribe(function(){vm.isTitleDirty=!0}),vm.page().url.subscribe(function(){vm.isUrlDirty=!0}),vm.changed(!1),setTimeout(function(){defaultTemplateId>0&&$('div[data-template-id="'+defaultTemplateId+'"]').click()},20),handler._resizeContentContainer(),dnn.dnnPageThumbnails.updateThumbnails()}),this._getService().get("GetPermissionsData",{pageId:this._getCurrentPageId()},function(data){handler._buildPermissionGrid(data)}),this._form.find(".page-settings div.body").tabs("option","active",0),this._form.find(".validationMessage").hide(),this._resizeContentContainer()},_updateViewModel:function(data){var pageViewModel=this._viewModel.page();for(var a in data)"__ko_mapping__"!==a&&ko.isWriteableObservable(pageViewModel[a])&&pageViewModel[a]("function"==typeof data[a]?data[a]():data[a]);pageViewModel.createdOnDate(null!==pageViewModel.createdOnDate()?moment(data.createdOnDate).toDate():new Date),pageViewModel.startDate(null!==pageViewModel.startDate()?moment(data.startDate).toDate():null),pageViewModel.endDate(null!==pageViewModel.endDate()?moment(data.endDate).toDate():null),this._viewModel.enableScheduling(null!==pageViewModel.startDate()||null!==pageViewModel.endDate()),this._viewModel.initialWorkflowId=this._viewModel.page().workflowId(),this._viewModel.workflowHasBeenChanged(!1),this._updateViewStatus({code:0,field:"",message:""}),this._viewModel.editType(""),this._viewModel.page().isCopy(!1),this._viewModel.changed(!1)},_updateViewStatus:function(data){this._viewModel.status(data)},_getViewModel:function(){var handler=this;return this._viewModel||(this._viewModel=new function(){var self=this;this.page=ko.observable(handler._getInitialViewModel()),this.template=ko.observable(handler._getInitialViewModel()),this.changed=ko.observable(!1),this.isTitleDirty=!1,this.isUrlDirty=!1,this.isDescriptionDirty=ko.observable(!1),this.isKeyWordsDirty=ko.observable(!1),this.workflows=ko.observableArray(),this.workflowChanged=handler._workflowChanged,this.workflowHasBeenChanged=ko.observable(!1),this.initialWorkflowId=this.page().workflowId(),this.workflowDisableTooltipShown=ko.observable(!1),this.showWorkflowDisableTooltip=function(){this.workflowDisableTooltipShown(!0)},this.hideWorkflowDisableTooltip=function(){this.workflowDisableTooltipShown(!1)},this.resx=handler.resx,this.status=ko.observable({code:0,field:"",message:""}),this.pageTemplates=ko.observableArray([]),this.editType=ko.observable(""),this.isErrorField=function(fieldName){return this.status().code>0&&this.status().field===fieldName},this.selectTemplate=function(data,e){self.page().templateId(data.id),$(e.currentTarget).parents(".pagetemplate-list-container").find("div.pagetemplate-list-item").removeClass("selected"),$(e.currentTarget).addClass("selected")},self.today=function(){var today=new Date;return today.setHours(0,0,0,0),today},self.tempStartDate=ko.observable(),self.tempEndDate=ko.observable(),self.startCalendarVisible=ko.observable(!1),self.endCalendarVisible=ko.observable(!1),self.showStartDatePicker=function(){self.tempStartDate(self.page().startDate()||self.today()),self.startCalendarVisible(!0),self.endCalendarVisible(!1)},self.showEndDatePicker=function(){self.tempEndDate(self.page().endDate()||self.today()),self.startCalendarVisible(!1),self.endCalendarVisible(!0)},self.cancelStartDate=function(){self.startCalendarVisible(!1)},self.cancelEndDate=function(){self.endCalendarVisible(!1)},self.applyStartDate=function(){var page=self.page(),date=new Date(self.tempStartDate().getTime());page.startDate(date),null!==page.endDate()&&page.endDate().getTime()<page.startDate().getTime()&&page.endDate(page.startDate()),self.startCalendarVisible(!1)},self.applyEndDate=function(){var page=self.page(),date=new Date(self.tempEndDate().getTime());if(page.endDate(date),null===page.startDate()){var createdOnDay=page.createdOnDate();createdOnDay.setHours(0,0,0,0),page.startDate(createdOnDay)}self.endCalendarVisible(!1)},self.clearEndDate=function(){self.endCalendarVisible(!1),self.page().endDate(null)},self.clearStartDate=function(){self.startCalendarVisible(!1),self.page().startDate(null)},self.enableScheduling=ko.observable(!1),self.enableScheduling.subscribe(function(value){value||(self.startCalendarVisible(!1),self.endCalendarVisible(!1))}),this.saveAsTemplate=$.proxy(handler._saveAsTemplateClickHandler,handler),this.duplicatePage=$.proxy(handler._copyPageHandler,handler)},this._setModelValidation()),this._viewModel},_workflowChanged:function(){this.workflowHasBeenChanged(this.initialWorkflowId!=this.page().workflowId())},_getInitialViewModel:function(){function formatDate(date){if(null===date)return"";var format="MM/DD/YYYY ["+dnn.dnnPageSettings.resx.pagesettings_DateTimeSeparator+"] hh:mma";return moment(date).format(format)}var pageModel=ko.mapping.fromJS({tabId:0,name:"",localizedName:"",title:"",description:"",tags:"",keywords:"",alias:"",url:"",includeInMenu:!0,thumbnail:"",created:"",hierarchy:"",hasChild:!1,type:0,customUrlEnabled:!0,templateId:0,pageType:"",workflowId:ko.observable(-1),isWorkflowCompleted:!1,applyWorkflowToChildren:!1,isWorkflowPropagationAvailable:!1,isCopy:!1,trackLinks:!1,startDate:null,endDate:null,createdOnDate:null,placeholderURL:"/"});return pageModel.formattedStartDate=ko.computed(function(){return formatDate(pageModel.startDate())}),pageModel.formattedEndDate=ko.computed(function(){return formatDate(pageModel.endDate())}),pageModel},_setModelValidation:function(){var pageModel=this._getViewModel().page();pageModel.errors=ko.validation.group(pageModel),pageModel.name.extend({required:!0}).subscribe($.proxy(this._validationFieldChanged,this)),pageModel.templateId.extend({needTemplate:{message:$.proxy(this._needTemplateMessage,this)}}).subscribe($.proxy(this._validationFieldChanged,this));var templateModel=this._getViewModel().template();templateModel.errors=ko.validation.group(templateModel),templateModel.name.extend({required:!0}).subscribe($.proxy(this._validationFieldChanged,this))},_validationFieldChanged:function(newValue){this._resizeContentContainer()},_needTemplateMessage:function(){return"template"==this._getViewModel().page().pageType()?this.resx.pagesettings_Errors_templates_NoTemplate:this.resx.pagesettings_Errors_NoTemplate},_convertToObject:function(model){var dateFormat="YYYY-MM-DDTHH:mm[Z]",o=ko.mapping.toJS(model);return o.startDate=null!==model.startDate()?moment(model.startDate()).format(dateFormat):null,o.endDate=null!==model.endDate()?moment(model.endDate()).format(dateFormat):null,o},_buildPermissionGrid:function(data){var gridContainer=$("#page-permissions"),handler=this;this._permissionGrid&&(this._permissionGrid.getLayout().remove(),this._permissionGrid=null),dnn.controls.PermissionGrid.resx=this.resx,this._permissionGrid=new dnn.controls.PermissionGrid(this,data,{onPermissionChanged:$.proxy(this._fieldsUpdateHandler,this)}),gridContainer.prepend(this._permissionGrid.getLayout()),this._permissionGrid.getLayout().on("tableUpdated",function(){handler._resizeContentContainer()})},_isAddPage:function(){return this._getViewModel().page().tabId()<=0},_saveDetails:function(e,callback){var handler=this;if(this._saving)return!1;var viewModel=this._getViewModel(),pageModel=viewModel.page();if(pageModel.errors().length>0)return pageModel.errors.showAllMessages(),this._form.find(".validationMessage:not(:empty)").show(),this._resizeContentContainer(),!1;pageModel.tags(this._form.find(".tags-input").val());var params=this._convertToObject(pageModel);return!viewModel.isUrlDirty&&this._isAddPage()&&(params.url=""),viewModel.enableScheduling()||(params.startDate=null,params.endDate=null),this._saving=!0,this._getService().post("SavePageDetails",params,function(data){return data.Status>0?(handler._updateViewStatus({code:data.Status,field:data.Field,message:data.Message}),void(handler._saving=!1)):(viewModel.changed(!1),data.Page.isCopy=pageModel.isCopy(),pageModel.pageType&&"template"===pageModel.pageType()||(handler._pageContentChanged=!0),void handler._savePermissions(data.Page,callback))}),!1},_saveTemplate:function(e){if(this._saving)return!1;var templateModel=this._getViewModel().template();if(templateModel.errors().length>0)return templateModel.errors.showAllMessages(),this._form.find(".validationMessage:not(:empty)").show(),this._resizeContentContainer(),!1;var handler=this;return this._saving=!0,this._getService().post("SavePageDetails",this._convertToObject(templateModel),function(data){return data.Status>0?(handler._updateViewStatus({code:data.Status,field:data.Field,message:data.Message}),void(handler._saving=!1)):void handler._savePermissions(data.Page)}),!1},_savePermissions:function(pageData,callback){var handler=this,permissions=this._permissionGrid.getPermissions();permissions.tabId=pageData.id,this._getService().post("SavePagePermissions",permissions,function(data){return handler._saving=!1,data.Status>0?void $.dnnAlert({text:data.Message}):void handler._closeForm(function(){var viewModel=handler._getViewModel();if("template"==viewModel.editType())return $(".dialog-newtpl").data("ui-dialog")&&$(".dialog-newtpl").dialog("close"),void handler.getElement().trigger("templateAdded",[pageData]);var detail=this._convertToObject(viewModel.page());return"undefined"==typeof detail.tabId||detail.tabId<=0?handler.getElement().trigger((detail.pageType&&detail.pageType.length>0?detail.pageType:"page")+"Added",[pageData]):handler.getElement().trigger("pageEdit",[pageData]),"function"==typeof callback&&callback.call(handler),!0})})},_copyPermission:function(){this._getService().post("CopyPagePermissions",{id:this._getCurrentPageId()},function(data){$.dnnAlert({text:data.Message})})},_back:function(e,callback){return!this._saving&&(this._checkPendingChange(e,function(){this._closeForm(function(){return"function"==typeof callback&&callback.call(this),this.getElement().trigger("pageSettingsCancel"),!0})}),!1)},_showInPageMgmt:function(e){return this._back(e,function(){dnn.dnnPageHierarchy&&dnn.dnnPageHierarchy.selectPage(this._getCurrentPageId())})},_checkPendingChange:function(e,callback){var handler=this,viewModel=this._getViewModel();if(viewModel.changed()){var confirmText=this.resx.pagesettings_ContentChanged,saveText=this.resx.pagesettings_Save,cancelText=this.resx.pages_Discard;return this.utility.confirm(confirmText,saveText,cancelText,function(){handler._saveDetails(e,callback)},function(){"function"==typeof callback&&callback.call(handler),viewModel.changed(!1)}),!0}return"function"==typeof callback&&callback.call(this),!1},_getPersonaBar:function(){return $("#personabar")},_getService:function(){return this.serviceController.moduleRoot="EvoqContentLibrary",this.serviceController.controller="PageManagement",this.serviceController},_getVar:function(name){var dnn=window!=window.top?window.top.dnn:window.dnn;return dnn.getVar(name)}};var pageSettingsDefaultOptions={requestDelayTime:2e3,defaultThumbnail:"fallback-thumbnail.png"};return dnn.dnnPageSettings||(dnn.dnnPageSettings=new pageSettingsManager),dnn.dnnPageSettings});