"undefined"!=typeof dnn&&null!==dnn||(dnn={}),define(["jquery","knockout"],function($,ko){var pageThumbnails=function(options){this.options=options};pageThumbnails.prototype={constructor:pageThumbnails,init:function(panelId){this.options=$.extend({},pageThumbnailsDefaultOptions,this.options),this.container=$(panelId),this.wrapper=$(".thumbnails-loader-wrapper"),this._abort=!1,$(document.body).on("thumbnailcreated",$.proxy(this._thumbnailCreated,this))},updateThumbnails:function(){if(this.container.is(":visible")){var handler=this,defaultName=this.options.defaultThumbnail;if(!(this.container.find('img[src$="'+defaultName+'"][class~="loading"]').length>0)){var $defaultImg=this.container.find('img[src$="'+defaultName+'"][class~="list"]').filter(':not([class~="loading"])').filter(':not([class~="failed"])').filter(':not([class~="disabled"])').eq(0);if(0==$defaultImg.length)return void this.removeThumbnailLoader();var checkData=ko.dataFor($defaultImg[0]);if(checkData){if(checkData.id<=0)return $defaultImg.addClass("failed").parent().addClass("failed"),void this.updateThumbnails();var protocol=checkData.url.indexOf("://"),checkUrl=checkData.url.substr(protocol>-1?protocol+3:0);if(0!=checkUrl.toLowerCase().indexOf(location.host))return $defaultImg.addClass("failed").parent().addClass("failed"),void this.updateThumbnails();$defaultImg.addClass("loading"),$defaultImg.parent().addClass("loading");var url=checkData.url+(checkData.url.indexOf("?")==-1?"?":"&")+"dnnprintmode=true&createthumbnail=true&userid="+this._getVar("dnn_current_userid");this._abort=!1,$.get(url,function(data){if(!handler._abort){handler.removeThumbnailLoader();var thumbnailLoader=$('<iframe class="thumbnail-loader"></iframe>');thumbnailLoader.css({width:$(window).width(),height:$(window).height(),zIndex:-1,visibility:"hidden"}),thumbnailLoader.load($.proxy(handler._thumbnailLoaderLoaded,handler)),thumbnailLoader.data("listitem",$defaultImg.parents("[data-page-id], [data-template-id]")),thumbnailLoader.attr("data-currentid",checkData.id),handler.wrapper.append(thumbnailLoader);var iframeDoc=thumbnailLoader[0].contentWindow.document,ie=function(){for(var undef,v=3,div=document.createElement("div"),all=div.getElementsByTagName("i");div.innerHTML="<!--[if gt IE "+ ++v+"]><i></i><![endif]-->",all[0];);return v>4?v:undef}();if(ie&&ie<10){var wrapper=$("<div></div>");wrapper.html(data),wrapper.find("script").each(function(){""!=$(this).html()&&$(this).attr("defer","defer")}),data=wrapper.html()}var baseUrl=url;baseUrl.indexOf("?")>-1&&(baseUrl=baseUrl.substr(0,baseUrl.indexOf("?"))),data='<base href="'+baseUrl+'" />'+data,iframeDoc.write(data),iframeDoc.close(),thumbnailLoader.data("contentloaded",!0)}})}}}},_thumbnailCreated:function(e,data){var $loader=this.wrapper.find("iframe[data-currentid="+data.pageId+"]"),$listItem=$loader.data("listitem");if($listItem){var koData=ko.dataFor($listItem[0]);koData&&(koData.thumbnail=data.thumbnails[2],koData.largeThumbnail=data.thumbnails[3],$listItem.find(".thumbnail img").attr("src",data.thumbnails[2]).removeClass("loading").parent().removeClass("loading"))}else this.wrapper.find("iframe.thumbnail-loader").data("listitem").find(".thumbnail img").attr("src",data.thumbnails[2]).removeClass("loading").parent().removeClass("loading");var handler=this;setTimeout(function(){handler.updateThumbnails()},0)},_thumbnailLoaderLoaded:function(e){var loader=e.target;if($(loader).data("contentloaded")&&loader.contentWindow&&loader.contentWindow.document&&loader.contentWindow.document.body.innerHTML){var dnnPage=!0;try{var contentWindow=loader.contentWindow;"undefined"!=typeof contentWindow.dnn&&"undefined"!=typeof contentWindow.WebPageThumbnailGenerator||(dnnPage=!1)}catch(e){dnnPage=!1}if(!dnnPage){var $listItem=$(e.target).data("listitem");$listItem.find(".thumbnail img").removeClass("loading").parent().removeClass("loading"),$listItem.find(".thumbnail img").addClass("failed").parent().addClass("failed"),this.removeThumbnailLoader();var handler=this;setTimeout(function(){handler.updateThumbnails()},0)}}},removeThumbnailLoader:function(){this.wrapper.find("iframe").each(function(){var loader=$(this);$.removeData(loader);try{var iframeDoc=loader[0].contentWindow.document;iframeDoc.write(""),iframeDoc.close()}catch(ex){}loader.remove(),loader=null}),this._abort=!0},_getVar:function(name){var dnn=window!=window.top?window.top.dnn:window.dnn;return dnn.getVar(name)}};var pageThumbnailsDefaultOptions={delayTime:500,requestDelayTime:2e3,requestTimeout:4e3,defaultThumbnail:"fallback-thumbnail.png"};return dnn.dnnPageThumbnails||(dnn.dnnPageThumbnails=new pageThumbnails),dnn.dnnPageThumbnails});