"use strict";define(["jquery","knockout"],function($,ko){var utility=null,viewModel={pageIndex:ko.observable(0),pageSize:10,totalResults:ko.observable(0),totalTasks:ko.observable(0),results:ko.observableArray([]),hasNewTasks:ko.observable(!1),hasMoreTasks:ko.observable(!1)};viewModel.totalTasks.subscribe(function(totalTasks){$(window).trigger("total-tasks-changed",[totalTasks])}),viewModel.loadMore=function(){if(viewModel.hasMoreTasks()){var notifications=viewModel.results(),lastNotificationId=0;notifications.length&&(lastNotificationId=notifications[notifications.length-1].notificationId()),getTasks(lastNotificationId)}else viewModel.results([]),getTasks(0)};var isMobile=!1,currentDetailView=null,toggleDetailView=function(task,li){var detailView=li.next();li.hasClass("detail-view")?detailView.slideUp(100,"linear",function(){currentDetailView=null,li.removeClass("detail-view")}):(detailView.find(".mobile").each(function(){var href=$(this).attr("href"),mobileQueryString="";isMobile&&(mobileQueryString=href.indexOf("?")>-1?"&mobile=true":"?mobile=true"),$(this).attr("href",href+mobileQueryString)}),detailView.find(".notification-body a[target!='_blank']").unbind("click").bind("click",function(evt){evt.preventDefault();var link=$(this).attr("href");link&&utility.closePersonaBar(function(){window.parent.document.location.href=link})}),currentDetailView?(currentDetailView.prev().removeClass("detail-view"),currentDetailView.slideUp(100,"linear",function(){li.addClass("detail-view"),detailView.slideDown(200,"linear",function(){currentDetailView=detailView})})):(li.addClass("detail-view"),detailView.slideDown(200,"linear",function(){currentDetailView=detailView})))},removeTask=function(task){var count=task.count(),totalTasks=viewModel.totalTasks()-count;totalTasks=totalTasks<0?0:totalTasks,viewModel.totalTasks(totalTasks);var results=viewModel.results(),index=-1;$.each(results,function(i,v){if(v.notificationId()===task.notificationId())return index=i,!1}),index>=0&&(results.splice(index,1),viewModel.results(results))},bindTaskAction=function(action,task){action.call=function(data,e){if(e.preventDefault(),!action.onCall){action.onCall=!0;var li=$(e.target).closest("li"),titleLi=li.prev();if(data.api){utility.sf.moduleRoot="dnncorp/personaBar";var url=utility.sf.getSiteRoot()+data.api;utility.sf.rawCall("POST",url,{NotificationId:data.notificationId},function(d){action.onCall=!1,d&&"success"===d.Result?li.slideUp(200,"linear",function(){titleLi.slideUp(50,"linear",function(){currentDetailView=null,removeTask(task)})}):utility.notifyError("Failed...")},function(d){utility.notifyError("Failed..."),404==d.status&&li.slideUp(200,"linear",function(){titleLi.slideUp(50,"linear",function(){currentDetailView=null,removeTask(task)})}),action.onCall=!1})}}}},getTasks=function(afterNotificationId,cb){utility.sf.moduleRoot="dnncorp/personaBar",utility.sf.controller="tasks",utility.sf.get("gettasks",{pageIndex:viewModel.pageIndex(),pageSize:viewModel.pageSize,afterNotificationId:afterNotificationId},function(d){var results=viewModel.results();d&&$.each(d.Results||[],function(i,v){var t={count:ko.observable(v.Count),subject:ko.observable(v.Subject),summary:ko.observable(v.Summary),index:ko.observable(1),notificationId:ko.observable(v.NotificationId),currentView:{body:ko.observable(v.Body),avatar:ko.observable(v.SenderAvatarUrl),displayName:ko.observable(v.SenderDisplayName),when:ko.observable(v.When),notificationId:ko.observable(v.NotificationId),actions:ko.observableArray([])}},actions=[];v.Actions&&$.each(v.Actions,function(ii,vv){var a={api:vv.ApiCall,name:vv.Name,notificationId:v.NotificationId};a.css=0==actions.length?"primarybtn":"secondarybtn",a.onCall=!1,bindTaskAction(a,t),actions.push(a)}),t.currentView.actions(actions),t.currentView.parent=t,t.showFooter=ko.computed(function(){return t.count()>1}),t.navigateViewDesc=ko.computed(function(){var f=utility.resx.PersonaBar.txt_ViewIndex;return f.replace("{0}",t.index()).replace("{1}",t.count())}),t.onNav=!1,t.navPrev=function(data,e){e.preventDefault();var parent=data.parent;1!=parent.index()&&(parent.index(parent.index()-1),parent.onNav||(parent.onNav=!0,getTaskView(parent,function(){parent.onNav=!1})))},t.navNext=function(data,e){e.preventDefault();var parent=data.parent;parent.index()!=parent.count()&&(parent.index(parent.index()+1),parent.onNav||(parent.onNav=!0,getTaskView(parent,function(){parent.onNav=!1})))},t.expand=function(data,e){e.preventDefault();var li=$(e.target);"LI"!==e.target.nodeName&&(li=$(e.target).closest("li")),li.hasClass("detail-view")||toggleDetailView(data,li)},t.collapse=function(data,e){e.preventDefault();var li=$(e.target).parent("li");li.hasClass("detail-view")&&toggleDetailView(data,li)},results.push(t)}),viewModel.results(results),0==afterNotificationId&&(viewModel.totalResults(d.TotalRollups||0),viewModel.totalTasks(d.TotalTasks||0),viewModel.hasNewTasks(!1)),viewModel.hasMoreTasks(viewModel.totalResults()>results.length),"function"==typeof cb&&cb()},function(){utility.notifyError("Failed..."),viewModel.results([]),0==afterNotificationId&&(viewModel.totalResults(0),viewModel.totalTasks(0),viewModel.hasNewTasks(!1)),viewModel.hasMoreTasks(!1),"function"==typeof cb&&cb()})},getTaskView=function(task,cb){utility.sf.moduleRoot="dnncorp/personaBar",utility.sf.controller="tasks",utility.sf.get("gettask",{notificationId:task.notificationId(),indexId:task.index()},function(d){if(!d||!d.Success)return utility.notifyError("Failed..."),void("function"==typeof cb&&cb());var v=d.UserDetail;task.currentView.body(v.Body),task.currentView.avatar(v.SenderAvatarUrl),task.currentView.displayName(v.SenderDisplayName),task.currentView.when(v.When),task.currentView.notificationId(v.NotificationId);var actions=[];v.Actions&&$.each(v.Actions,function(ii,vv){var a={api:vv.ApiCall,name:vv.Name,notificationId:v.NotificationId};a.css=0==actions.length?"primarybtn":"secondarybtn",bindTaskAction(a,task),actions.push(a)}),task.currentView.actions(actions),"function"==typeof cb&&cb()},function(){utility.notifyError("Failed..."),"function"==typeof cb&&cb()})},refreshTasks=function(){utility.persistent.load().expandPersonaBar&&(utility.sf.moduleRoot="dnncorp/personaBar",utility.sf.controller="tasks",utility.sf.getsilence("gettasks",{pageIndex:0,pageSize:1,afterNotificationId:0},function(d){var originalCount=viewModel.totalTasks(),newCount=d.TotalTasks||0;viewModel.totalTasks(newCount),newCount>originalCount&&newCount>0&&viewModel.hasNewTasks(!0)},function(){utility.notifyError("Failed..."),viewModel.hasNewTasks(!1)}))};return{init:function(wrapper,util,params,callback){utility=util,$(".socialtasksheader > div > div.right > a").click(function(e){if(e.preventDefault(),!utility.inAnimation){utility.inAnimation=!0;var width=parent.document.body.clientWidth,socialTasksPanel=-297;width<=1024&&width>768?socialTasksPanel=-238:width<=768&&(socialTasksPanel=-182);var userSettings=utility.persistent.load();userSettings.expandTasksPane?($(".socialtasks").css("background-color","transparent"),$(".socialtasks > div > div").animate({left:socialTasksPanel},189,"linear",function(){$(".socialtasksheader").animate({left:58},378,"linear",function(){utility.inAnimation=!1,utility.persistent.save({expandTasksPane:!1})})})):($(".socialtasksheader").css({left:0}),$(".socialtasks > div > div").animate({left:0},189,"linear",function(){utility.inAnimation=!1,utility.persistent.save({expandTasksPane:!0}),$(".socialtasks").css("background-color","#eee")}))}}),utility.persistent.load().expandTasksPane||($(".socialtasks").css("background-color","transparent"),$(".socialtasks > div > div").css({left:-297}),$(".socialtasksheader").css({left:58})),utility.asyncParallel([function(cb1){getTasks(0,cb1)}],function(){var container=wrapper[0];viewModel.resx=utility.resx.PersonaBar,ko.applyBindings(viewModel,container),setInterval(refreshTasks,3e4),"function"==typeof callback&&callback()})},initMobile:function(wrapper,util,params,callback){isMobile=!0,this.init(wrapper,util,params,callback)},load:function(params,callback){isMobile=!0,"function"==typeof callback&&callback()},loadMobile:function(params,callback){isMobile=!1,this.load(params,callback)}}});