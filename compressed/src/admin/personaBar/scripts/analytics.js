define(["jquery","knockout","pikaday","d3","moment","../scripts/d3charts","../scripts/pager","../scripts/scroller","../scripts/tabpanel","../scripts/koComponents/pageActivities"],function($,ko,pikaday,d3,moment,d3Charts,pager,scroller,tabPanel){"use strict";var analytics=function(){function getMaxTimeOnPage(timeOnPage){for(var max=0,i=0;i<timeOnPage.length;i++){var time=timeOnPage[i];time.count>max&&(max=time.count)}return max}var analyticsMode,resx,contentResx,wrapper,koBinded=!1,isMobile=!1,pageId=-1,legendSettings=[],triggerComparativeTerm=!0,utility=null,comparativeTerms={Year:"1 y",Month:"1 m",Week:"1 w",Day:"1 d"},PAGEACTIVITIES_PAGE_SIZE=5,WAIT_TIME_FOR_RETRIES=5e3,graphColors=["#004b7a","#0996d8","#b5958a","#f26b5e","#9d8edb","#a13c57","#799e61"],dateFormat="YYYY-MM-DD",sequence=-1,lastCallStatus=null,sequenceConversions=-1,sequenceTopReferrers=-1,sequenceTopPages=-1,sequenceTopOperatingSystems=-1,periodLabel=ko.observable(""),pikerStart=null,pikerEnd=null,pikerContainer=null,viewModel={},currentTabId=-2,currentContentItemId=-2,tabIdFromContext=function(){if(currentTabId!=-2)return currentTabId;var perTabId=window.top.dnn.getVar("dnnContentPersonalization_PersonalizedTabId","-1");return perTabId!=-1?perTabId:window.top.dnn.getVar("evoq_TabId","-1")},contentItemIdFromContext=function(){return currentContentItemId!=-2?currentContentItemId:window.top.dnn.getVar("evoq_ContentItemId","-1")},conversionsViewModel={results:ko.observableArray([]),max:-1,totalResults:ko.observable(0)},operatingSystemsViewModel={results:ko.observableArray([]),max:-1,totalResults:ko.observable(0)},pagesViewModel={results:ko.observableArray([]),max:-1,totalResults:ko.observable(0)},referrersViewModel={totalResults:ko.observable(0),max:-1,results:ko.observableArray([])},getToNewTabFromMobile=function(referrerModel){"Internal"!==referrerModel.category&&"ExitPages"!==referrerModel.category||(currentTabId=referrerModel.referrerPageId,currentContentItemId=referrerModel.referrerContentItemId,refresh())},navigationSummaryViewModel=ko.observable(),navigationSummaryCategoriesViewModel=ko.observableArray([]),summaryViewModel={averageTimeOnPage:ko.observable(""),bounceRate:ko.observable(""),totalPageViews:ko.observable("0"),totalPageViewsDetail:ko.observable("0"),totalSessions:ko.observable("0"),totalSessionsDetail:ko.observable("0"),totalVisits:ko.observable("0"),totalVisitsDetail:ko.observable("0"),load:function(data){this.averageTimeOnPage(data.averageTimeOnPage),this.bounceRate(data.bounceRate),this.totalPageViews(utility.formatAbbreviateBigNumbers(data.totalPageViews)),this.totalPageViewsDetail(utility.formatCommaSeparate(data.totalPageViews)),this.totalSessions(utility.formatAbbreviateBigNumbers(data.totalSessions)),this.totalSessionsDetail(utility.formatCommaSeparate(data.totalSessions)),this.totalVisits(utility.formatAbbreviateBigNumbers(data.totalVisits)),this.totalVisitsDetail(utility.formatCommaSeparate(data.totalVisits))}},applyCustomDates=function(){wrapper.find(".pika-calendar-apply-btn").hasClass("disabled")||(viewModel.period("Custom"),viewModel.startDate(utility.serializeCustomDate(pikerStart.getDate())),viewModel.endDate(utility.serializeCustomDate(pikerEnd.getDate())),getGraphDataStart(function(){bindScrollbar()}),utility.persistent.save({period:viewModel.period(),startDate:viewModel.startDate(),endDate:viewModel.endDate(),comparativeOptions:viewModel.comparativeOptions(),comparativeTerm:viewModel.comparativeTerm()}),restartPiker(),"undefined"!=typeof viewModel.originModel&&viewModel.originModel.applyCustomDates())},bindScrollbar=function(){setTimeout(function(){var holder=wrapper.find("div.module-performance-card-holder"),cards=wrapper.find("div.module-performance-card",holder),left=wrapper.find("a.module-performance-scroll-left"),right=wrapper.find("a.module-performance-scroll-right"),initialOffset=holder.css("left")||0,scrollOffset=243;scroller.init(holder,cards,left,right,initialOffset,scrollOffset)},100)},drawDonutChart=function(container,labels,values,colors,tooltipSelector,legendSelector,ratioSelector,animation,valuesLabels,valuesTooltips){var $legend=wrapper.find(legendSelector),$container=wrapper.find(container);$legend.empty(),$container.find("svg").remove(),$container.append('<svg class="donut-chart"></svg>');var data=[{values:values,labels:labels,colors:colors,valuesLabels:valuesLabels,valuesTooltips:valuesTooltips}],chart=d3Charts.donutChart(animation,150,150,30).tooltipSelector(tooltipSelector).legendSelector(legendSelector).ratioSelector(ratioSelector);d3.select(container+" svg").datum(data).call(chart);var containerWidth=$container.width(),padding=(containerWidth-150)/2;wrapper.find(container+" svg").css("padding-left",padding+"px");var legendWidth=$legend.width();isMobile&&$legend.css("margin-left",(containerWidth-legendWidth)/2+"px")},drawNavigationSummaryChart=function(width,height,margins,direction){function my(selection){selection.each(function(data){if(data){tree=d3.layout.tree().size([h,w]),diagonal=d3.svg.diagonal().projection(function(d){return[d.y,d.x]}),root=data,root.x0=h/2,root.y0=0,root.y=w/2,root.children.forEach(toggleAll);var y0=direction>0?m[3]:width-m[1],x0=m[0];svg=d3.select(this).attr("width",width).attr("height",height).append("svg:g").attr("transform","translate("+y0+","+x0+")"),update(root)}})}var tree,root,svg,diagonal,m=margins,NAVSUMLENGTH=20,w=width-m[1]-m[3],h=height-m[0]-m[2],i=0,toggle=function(d){d.children?(d._children=d.children,d.children=null):(d.children=d._children,d._children=null)},toggleAll=function(d){d.children&&(d.children.forEach(toggleAll),toggle(d))},update=function(source){function onClickInternalLinkItem(selection){selection.on("click",function(d){"Internal"!==d.category&&"ExitPages"!==d.category||(currentTabId=d.referrerPageId,currentContentItemId=d.referrerContentItemId,$(".navigation-tooltip").hide(),refresh())})}function rightRoundedRect(x,y,width,height,radius){return"M"+x+","+y+"h"+(width-radius)+"a"+radius+","+radius+" 0 0 1 "+radius+","+radius+"v"+(height-2*radius)+"a"+radius+","+radius+" 0 0 1 "+-radius+","+radius+"h"+(radius-width)+"z"}function leftRoundedRect(x,y,width,height,radius){return"M"+(x+radius)+","+y+"h"+(width-radius)+"v"+height+"h"+(radius-width)+"a"+radius+","+radius+" 0 0 1 "+-radius+","+-radius+"v"+(2*radius-height)+"a"+radius+","+radius+" 0 0 1 "+radius+","+-radius+"z"}function navigationRectangleWidth(d){var text=nodeEnter.selectAll("#navigation-summary-label-"+d.id);return text.node().getComputedTextLength()+2*LABEL_MARGIN}function navigationRectanglePosition(d){return direction>0?COUNT_WIDTH:-navigationRectangleWidth(d)-COUNT_WIDTH}function navigationSummaryRectangleText(d){return direction>0?COUNT_WIDTH+LABEL_MARGIN:-COUNT_WIDTH-navigationRectangleWidth(d)+LABEL_MARGIN}function mouseover(){var altText=$(this),nav=$(".navigation-tooltip"),ttip=altText.attr("alt"),navCat=[contentResx.analytics_direct,contentResx.analytics_direct_referral,contentResx.analytics_external,contentResx.analytics_social,contentResx.analytics_search,contentResx.analytics_exitpages];if(navCat.indexOf(ttip)>=0||ttip.length<NAVSUMLENGTH)return!1;if(nav.show(),navigator.userAgent.search("Safari")>=0&&navigator.userAgent.search("Chrome")<0)var t=d3.event.pageY-1170;else var t=d3.event.pageY-1120;var l=d3.event.pageX+160;nav.text(ttip),nav.css("left",l+"px"),nav.css("top",t+"px")}function mouseout(){$(".navigation-tooltip").hide()}var COUNT_WIDTH=50,COUNT_HEIGHT=30,BORDER_RADIUS=5,TEXT_VERTICAL_OFFSET=5,LABEL_MARGIN=10,duration=d3.event&&d3.event.altKey?5e3:500,nodes=tree.nodes(root).reverse();nodes.forEach(function(d){d.y=180*d.depth*direction});var node=svg.selectAll("g.node").data(nodes,function(d){return d.id||(d.id=++i)}),nodeEnter=node.enter().append("svg:g").attr("class","node").attr("transform",function(){return"translate("+source.y0+","+source.x0+")"});nodeEnter.append("svg:path").attr("d",direction>0?leftRoundedRect(0,-COUNT_HEIGHT/2,COUNT_WIDTH,COUNT_HEIGHT,BORDER_RADIUS):rightRoundedRect(-COUNT_WIDTH,-COUNT_HEIGHT/2,COUNT_WIDTH,COUNT_HEIGHT,BORDER_RADIUS)).attr("class",function(d){return"navigation-summary-count "+d.category.toLowerCase()}).call(onClickInternalLinkItem),nodeEnter.append("svg:text").attr("class",function(d){return"navigation-summary-count "+d.category.toLowerCase()}).attr("x",direction*COUNT_WIDTH/2).attr("dy",TEXT_VERTICAL_OFFSET).attr("text-anchor","middle").call(onClickInternalLinkItem).text(function(d){return d.count}).append("svg:title").text(function(d){return d.count}),nodeEnter.append("svg:text").attr("id",function(d,i){return"navigation-summary-label-"+d.id}).on("mouseover",mouseover).on("mouseout",mouseout).attr("class",function(d){return"navigation-summary-label "+d.category.toLowerCase()}).attr("x",navigationSummaryRectangleText).attr("dy",TEXT_VERTICAL_OFFSET).attr("text-anchor",function(d){return d.children||d._children?direction<0?"start":"end":direction<0?"end":"start"}).call(onClickInternalLinkItem).text(function(d){var text=d.label;return text.length>NAVSUMLENGTH&&(text=text.substring(0,NAVSUMLENGTH)+"..."),text}).attr("alt",function(d){var text=d.label;return text}),nodeEnter.insert("svg:path","text.navigation-summary-label").attr("d",function(d){return direction<0?leftRoundedRect(navigationRectanglePosition(d),-COUNT_HEIGHT/2,navigationRectangleWidth(d),COUNT_HEIGHT,BORDER_RADIUS):rightRoundedRect(navigationRectanglePosition(d),-COUNT_HEIGHT/2,navigationRectangleWidth(d),COUNT_HEIGHT,BORDER_RADIUS)}).attr("class",function(d){return"navigation-summary-label "+d.category.toLowerCase()}).call(onClickInternalLinkItem),node.transition().duration(duration).attr("transform",function(d){return"translate("+d.y+","+d.x+")"}),node.exit().transition().duration(duration).attr("transform",function(){return"translate("+source.y+","+source.x+")"}).remove();var link=svg.selectAll("path.link").data(tree.links(nodes),function(d){return d.target.id});link.enter().insert("svg:path","g").attr("class","link").attr("class",function(d){return"link "+d.target.category.toLowerCase()}).attr("d",function(){var o={x:source.x0,y:source.y0};return diagonal({source:o,target:o})}).transition().duration(duration).attr("d",diagonal),link.transition().duration(duration).attr("d",diagonal),link.exit().transition().duration(duration).attr("d",function(){var o={x:source.x,y:source.y};return diagonal({source:o,target:o})}).remove(),nodes.forEach(function(d){d.x0=d.x,d.y0=d.y})};return my},getComparativeOptions=function(period){var options=[];return $.each(comparativeTerms,function(i,v){return i===period?(options.push(v),!1):void options.push(v)}),options},getComparativeTerm=function(period){return comparativeTerms[period]},getConversions=function(){utility.sf.moduleRoot="evoqcontentlibrary",utility.sf.controller="analyticsservice";var method="page"==analyticsMode?"GetTopConversionsByPage":"GetTopConversions";sequenceConversions++;var comparativeTerm="Custom"==viewModel.period()?"c":viewModel.comparativeTerm(),params={period:viewModel.period(),comparativeTerm:comparativeTerm,startDate:viewModel.startDate(),endDate:viewModel.endDate(),pageIndex:viewModel.conversions.pageIndex(),pageSize:viewModel.conversions.pageSize,sequence:sequenceConversions};"page"==analyticsMode&&(params.tabId=tabIdFromContext(),params.contentItemId=contentItemIdFromContext()),utility.sf.get(method,params,function(data){if(data&&data.data&&data.sequence===sequenceConversions)return data.data.isPending?void setTimeout(function(){getConversions()},WAIT_TIME_FOR_RETRIES):void updateConversions(data.data)},function(){})},getGraphData=function(cb){utility.sf.moduleRoot="evoqcontentlibrary",utility.sf.controller="analyticsservice";var method,params;sequence++;var comparativeTerm="Custom"==viewModel.period()?"c":viewModel.comparativeTerm();"page"===analyticsMode?(method="GetPageAnalytics",params={period:viewModel.period(),comparativeTerm:comparativeTerm,startDate:viewModel.startDate(),endDate:viewModel.endDate(),tabId:tabIdFromContext(),contentItemId:contentItemIdFromContext(),sequence:sequence}):(method="GetSiteAnalytics",params={period:viewModel.period(),comparativeTerm:comparativeTerm,startDate:viewModel.startDate(),endDate:viewModel.endDate(),sequence:sequence}),utility.sf.get(method,params,function(data){data&&data.data&&data.sequence===sequence&&(viewModel.pageName(data.data.pageName),viewModel.summary.load(data.data.summary),updateGraphs(data.data,function(){data.data.isPending&&(lastCallStatus=data.data,setTimeout(function(){getGraphData(cb)},WAIT_TIME_FOR_RETRIES)),"function"==typeof cb&&cb()}))},function(){})},getGraphDataStart=function(cb){lastCallStatus=null,getGraphData(cb)},getTopOperatingSystems=function(){utility.sf.moduleRoot="evoqcontentlibrary",utility.sf.controller="analyticsservice";var method="GetTopOperatingSystems";sequenceTopOperatingSystems++;var comparativeTerm="Custom"==viewModel.period()?"c":viewModel.comparativeTerm(),params={period:viewModel.period(),comparativeTerm:comparativeTerm,startDate:viewModel.startDate(),endDate:viewModel.endDate(),pageIndex:viewModel.topOperatingSystems.pageIndex(),pageSize:viewModel.topOperatingSystems.pageSize,tabId:tabIdFromContext(),contentItemId:contentItemIdFromContext(),sequence:sequenceTopOperatingSystems};utility.sf.get(method,params,function(data){if(data&&data.data&&data.sequence===sequenceTopOperatingSystems)return data.data.isPending?void setTimeout(function(){getTopOperatingSystems()},WAIT_TIME_FOR_RETRIES):void updateTopOperatingSystems(data.data)},function(){})},getTopPages=function(){utility.sf.moduleRoot="evoqcontentlibrary",utility.sf.controller="analyticsservice";var method="GetTopPages";sequenceTopPages++;var comparativeTerm="Custom"==viewModel.period()?"c":viewModel.comparativeTerm(),params={period:viewModel.period(),comparativeTerm:comparativeTerm,startDate:viewModel.startDate(),endDate:viewModel.endDate(),pageIndex:viewModel.topPages.pageIndex(),pageSize:viewModel.topPages.pageSize,sequence:sequenceTopPages};utility.sf.get(method,params,function(data){if(data&&data.data&&data.sequence===sequenceTopPages)return data.data.isPending?void setTimeout(function(){getTopPages()},WAIT_TIME_FOR_RETRIES):void updateTopPages(data.data)},function(){})},getTopReferrers=function(){utility.sf.moduleRoot="evoqcontentlibrary",utility.sf.controller="analyticsservice";var method="page"==analyticsMode?"GetTopReferrersByPage":"GetTopReferrers";sequenceTopReferrers++;var comparativeTerm="Custom"==viewModel.period()?"c":viewModel.comparativeTerm(),params={period:viewModel.period(),comparativeTerm:comparativeTerm,startDate:viewModel.startDate(),endDate:viewModel.endDate(),pageIndex:viewModel.topReferrers.pageIndex(),pageSize:viewModel.topReferrers.pageSize,sequence:sequenceTopReferrers};"page"==analyticsMode&&(params.tabId=tabIdFromContext(),params.contentItemId=contentItemIdFromContext()),utility.sf.get(method,params,function(data){if(data&&data.data&&data.sequence===sequenceTopReferrers)return data.data.isPending?void setTimeout(function(){getTopReferrers()},WAIT_TIME_FOR_RETRIES):void updateTopReferrers(data.data)},function(){})},init=function(wrap,util,params,callback,viewModelParam){wrapper=wrap,pageId=params.pageId,analyticsMode=params.mode,utility=util,resx=utility.resx.PersonaBar,contentResx=utility.resx.ContentPB,isMobile||(pager.init(pagesViewModel,PAGEACTIVITIES_PAGE_SIZE,getTopPages,resx),pager.init(referrersViewModel,PAGEACTIVITIES_PAGE_SIZE,getTopReferrers,resx),pager.init(operatingSystemsViewModel,PAGEACTIVITIES_PAGE_SIZE,getTopOperatingSystems,resx),pager.init(conversionsViewModel,PAGEACTIVITIES_PAGE_SIZE,getConversions,resx));var userSettings=utility.persistent.load();legendSettings=userSettings.legends||[];var userSettingsPeriod=isMobile&&"Custom"==userSettings.period?"Week":userSettings.period,defaultDate=utility.serializeCustomDate(new Date((new Date).toUTCString())),periods=[{value:"Year",label:resx.opt_Year},{value:"Month",label:resx.opt_Month},{value:"Week",label:resx.opt_Week},{value:"Day",label:resx.opt_Day}];if("undefined"==typeof viewModelParam)viewModel={resx:resx,periods:periods,periodLabel:periodLabel,period:ko.observable(userSettingsPeriod),startDate:ko.observable(userSettings.startDate||defaultDate),endDate:ko.observable(userSettings.endDate||defaultDate),startDateLabel:ko.observable(),endDateLabel:ko.observable(),applyCustomDates:applyCustomDates,comparativeTerm:ko.observable(userSettings.comparativeTerm),comparativeOptions:ko.observableArray(getComparativeOptions(userSettingsPeriod))};else{viewModel={};for(var prop in viewModelParam)viewModel[prop]=viewModelParam[prop];viewModel.originalModel=viewModelParam,viewModel.periodLabel=periodLabel,viewModel.applyCustomDates=applyCustomDates,viewModel.pikerStart=pikerStart,viewModel.pikerEnd=pikerEnd,viewModel.pikerContainer=pikerContainer,viewModel.periodLabel.subscribe(function(newValue){"undefined"!=typeof viewModel.originModel&&viewModel.originalModel.periodLabel(newValue)}),viewModel.periodLabel.extend({notify:"always"})}viewModel.contentResx=contentResx,viewModel.pageName=ko.observable(""),viewModel.summary=summaryViewModel,viewModel.topPages=pagesViewModel,viewModel.topOperatingSystems=operatingSystemsViewModel,viewModel.topReferrers=referrersViewModel,viewModel.conversions=conversionsViewModel,viewModel.navigationSummary=navigationSummaryViewModel,viewModel.navigationSummaryCategories=navigationSummaryCategoriesViewModel,viewModel.getToNewTabFromMobile=getToNewTabFromMobile,viewModel.changePeriod=function(data,event){var newPeriod=$(event.target).data("value"),oldPeriod=this.period(),oldComparativeTerm=this.comparativeTerm();this.period(newPeriod),triggerComparativeTerm=!1,this.comparativeOptions(getComparativeOptions(newPeriod));var newComparativeTerm=getComparativeTerm(newPeriod);this.comparativeTerm(newComparativeTerm),triggerComparativeTerm=!0,newPeriod===oldPeriod&&newComparativeTerm===oldComparativeTerm||refresh()},viewModel.showCustomCalendar=function(){var period=this.period();if("Custom"==period&&viewModel.startDate()&&viewModel.endDate())viewModel.initialStartDate=new Date(viewModel.startDate()),viewModel.initialEndDate=new Date(viewModel.endDate()),viewModel.initialStartDate.setHours(0,0,0,0),viewModel.initialEndDate.setHours(0,0,0,0),pikerStart.setDate(utility.deserializeCustomDate(viewModel.startDate())),pikerEnd.setDate(utility.deserializeCustomDate(viewModel.endDate()));else{var now=new Date((new Date).toUTCString());switch(now.setDate(now.getDate()-1),viewModel.initialEndDate=new Date(now.getTime()),viewModel.initialEndDate.setHours(0,0,0,0),pikerEnd.setDate(now),period){case"Week":now.setDate(now.getDate()-6);break;case"Month":now.setMonth(now.getMonth()-1),now.setDate(now.getDate()+1);break;case"Year":now.setYear(now.getFullYear()-1),now.setDate(now.getDate()+1)}viewModel.initialStartDate=new Date(now.getTime()),viewModel.initialStartDate.setHours(0,0,0,0),pikerStart.setDate(now)}wrapper.find(".pika-calendar-apply-btn").addClass("disabled"),pikerContainer.show();var hidePikerHandler=function(){pikerContainer.hide()};$(window).on("click",function(){hidePikerHandler(),$(window).off("click",hidePikerHandler)})},utility.asyncParallel([function(cb1){getGraphDataStart(cb1)}],function(){if(viewModel.comparativeTerm.subscribe(refresh),isMobile?(viewModel.period.subscribe(function(value){this.comparativeOptions(getComparativeOptions(value)),this.comparativeTerm(getComparativeTerm(value))},viewModel),"page"===analyticsMode&&tabPanel.init(viewModel,null)):"page"===analyticsMode&&tabPanel.init(viewModel,null),ko.applyBindings(viewModel,wrapper[0]),koBinded=!0,isMobile)refreshCarousel();else{bindScrollbar();var pikerStartField=wrapper.find("#dashboard-period-custom-calendar-start-field"),pikerEndField=wrapper.find("#dashboard-period-custom-calendar-end-field");pikerContainer=wrapper.find("#dashboard-period-custom-calendar-container"),pikerStart=pikerStartField?new pikaday({format:dateFormat,field:pikerStartField[0],bound:!1,container:wrapper.find("#dashboard-period-custom-calendar-container-left")[0],maxDate:new Date((new Date).toUTCString()),onSelect:function(date){var label=viewModel.contentResx.analytics_From+":&nbsp;&nbsp;&nbsp;"+utility.serializeCustomDate(date);viewModel.startDateLabel(label),pikerEnd.setMinDate(date),pikerEnd.draw(),viewModel.initialStartDate&&date.getTime()===viewModel.initialStartDate.getTime()||wrapper.find(".pika-calendar-apply-btn").removeClass("disabled")}}):null,pikerEnd=pikerEndField?new pikaday({format:dateFormat,field:pikerEndField[0],bound:!1,container:wrapper.find("#dashboard-period-custom-calendar-container-right")[0],maxDate:new Date((new Date).toUTCString()),onSelect:function(date){var label=viewModel.contentResx.analytics_To+":&nbsp;&nbsp;&nbsp;"+utility.serializeCustomDate(date);viewModel.endDateLabel(label),pikerStart.setMaxDate(date),pikerStart.draw(),viewModel.initialEndDate&&date.getTime()===viewModel.initialEndDate.getTime()||wrapper.find(".pika-calendar-apply-btn").removeClass("disabled")}}):null,pikerContainer&&pikerContainer.on("click",function(e){return e.stopPropation?e.stopPropation():e.cancelBubble=!0,!1})}"function"==typeof callback&&callback()}),viewModel.moduleDashboard&&viewModel.moduleDashboard.subscribe(function(val){val||getGraphDataStart()},viewModel)},initMobile=function(wrapper,util,params,callback){isMobile=!0,this.init(wrapper,util,params,callback)},load=function(params,callback){pageId=params.pageId,analyticsMode=params.mode;var userSettings=utility.persistent.load();legendSettings=userSettings.legends||[];var userSettingsPeriod=isMobile&&"Custom"==userSettings.period?"Week":userSettings.period,defaultDate=utility.serializeCustomDate(new Date((new Date).toUTCString()));triggerComparativeTerm=!1,viewModel.periodLabel(""),viewModel.period(userSettingsPeriod),viewModel.startDate(userSettings.startDate||defaultDate),viewModel.endDate(userSettings.endDate||defaultDate),viewModel.comparativeOptions(getComparativeOptions(userSettingsPeriod)),viewModel.comparativeTerm(userSettings.comparativeTerm),triggerComparativeTerm=!0,"Custom"==userSettingsPeriod&&viewModel.startDate()&&viewModel.endDate()&&(pikerStart.setDate(utility.deserializeCustomDate(viewModel.startDate())),pikerEnd.setDate(utility.deserializeCustomDate(viewModel.endDate()))),getGraphDataStart(function(){isMobile?refreshCarousel():bindScrollbar(),"function"==typeof callback&&callback()})},loadMobile=function(params,callback){isMobile=!0,this.load(params,callback)},refresh=function(){triggerComparativeTerm&&(getGraphDataStart(function(){isMobile?refreshCarousel():bindScrollbar()}),utility.persistent.save({period:viewModel.period(),startDate:viewModel.startDate(),endDate:viewModel.endDate(),comparativeOptions:viewModel.comparativeOptions(),comparativeTerm:viewModel.comparativeTerm()}),isMobile||restartPiker())},restartPiker=function(){pikerContainer.hide(),pikerStart.setDate(null),pikerEnd.setDate(null),wrapper.find(".pika-calendar-apply-btn").removeClass("disabled").addClass("disabled")},refreshCarousel=function(){setTimeout(function(){var holder=wrapper.find(".site-performance-card-holder");return holder.data("owlCarousel")?void holder.data("owlCarousel").reinit():void holder.owlCarousel({itemsCustom:[[0,1],[490,2],[730,3]],navigation:!1})},100)},updateChannelsGraph=function(labels,channels,animation,channelsLabels,channelsTooltips){var root="page"==analyticsMode?"#page-traffic-panel":"#site-traffic-panel",container=root+" #channels-svg",legendSelector=root+" #channels-legend",tooltipSelector=root+" #channels .donut-chart-tooltip",colors=getColorsArray(channels.length);drawDonutChart(container,labels,channels,colors,tooltipSelector,legendSelector,null,animation,channelsLabels,channelsTooltips)},getColorsArray=function(arraySize){for(var colors=new Array(arraySize),i=0;i<arraySize;i++)colors[i]=graphColors[i%arraySize];return colors},addEmptyEntriesToFitPage=function(results){var missedElementCountToFitPage=PAGEACTIVITIES_PAGE_SIZE-results.length;if(missedElementCountToFitPage!==PAGEACTIVITIES_PAGE_SIZE)for(var i=0;i<missedElementCountToFitPage;i++)results.push({count:"-",label:"",countTooltip:""})},updateConversions=function(data,setFirstPageSelected){var results=[],width=195,totalResults=0;data&&($.each(data.results||[],function(i,v){var title=v.title;title=utility.trimContentToFit(title,width),v.title=title,v.countTooltip=utility.formatCommaSeparate(v.count),v.count=utility.formatAbbreviateBigNumbers(v.count),results.push(v)}),totalResults=data.totalResults||0,isMobile||addEmptyEntriesToFitPage(results)),viewModel.conversions.results(results),viewModel.conversions.totalResults(totalResults),setFirstPageSelected&&viewModel.conversions.pageIndex&&viewModel.conversions.pageIndex(0)},updateDevicesGraph=function(labels,devices,animation,devicesLabels,devicesTooltips){var root="page"==analyticsMode?"#page-traffic-panel":"#site-traffic-panel",container=root+" #devices-svg",legendSelector=root+" #devices-legend",tooltipSelector=root+" #devices .donut-chart-tooltip",colors=getColorsArray(devices.length);drawDonutChart(container,labels,devices,colors,tooltipSelector,legendSelector,null,animation,devicesLabels,devicesTooltips)},updateSeriesListCommaFormat=function(seriesList,propertyName){for(var i=0;i<seriesList.length;i++)updateSeriesFormat(seriesList[i],function(value){return utility.formatCommaSeparate(value)},propertyName)},updateSeriesFormat=function(series,formatter,propertyName){if(series)for(var i=0;i<series.length;i++)propertyName?series[i][propertyName]=formatter(series[i][propertyName]):series[i]=formatter(series[i])},createNewSeriesCommaFormat=function(series,propertyName){return createNewSeriesFormat(series,function(value){return utility.formatCommaSeparate(value)},propertyName)},createNewSeriesAbbreviateFormat=function(series,propertyName){return createNewSeriesFormat(series,function(value){return utility.formatAbbreviateBigNumbers(value)},propertyName)},createNewSeriesFormat=function(series,formatter,propertyName){if(!series)return series;for(var newSeries=new Array(series.length),i=0;i<series.length;i++)propertyName?newSeries[i][propertyName]=formatter(series[i][propertyName]):newSeries[i]=formatter(series[i]);return newSeries},updateGraphs=function(data,cb){periodLabel(data.periodLabel||"");var labels=[];isMobile||(labels=data.labels),updatePageViewsGraph(labels||[],data.pageViews||[],data.visitors||[],(null==lastCallStatus||lastCallStatus.isPendingPageViews)&&!data.isPendingPageViews);var channelsLabels=createNewSeriesAbbreviateFormat(data.channels.values||[]),channelsTooltips=createNewSeriesCommaFormat(data.channels.values||[]);updateChannelsGraph(data.channels.labels||[],data.channels.values||[],(null==lastCallStatus||lastCallStatus.isPendingChannels)&&!data.isPendingChannels,channelsLabels,channelsTooltips);var devicesLabels=createNewSeriesAbbreviateFormat(data.devices.values||[]),devicesTooltips=createNewSeriesCommaFormat(data.devices.values||[]);updateDevicesGraph(data.devices.labels||[],data.devices.values||[],(null==lastCallStatus||lastCallStatus.isPendingDevices)&&!data.isPendingDevices,devicesLabels,devicesTooltips),updateTopReferrers(data.referrers,!0),updateConversions(data.conversions,!0),"page"==analyticsMode?(updateTimeOnPageGraph(labels||[],data.timeOnPage||[],(null==lastCallStatus||lastCallStatus.isPendingPageViews)&&!data.isPendingPageViews),updateTopOperatingSystems(data.operatingSystems,!0),updateNavigationSummary(data.navigationSummary||[],(null==lastCallStatus||lastCallStatus.isPendingNavigationSummary)&&!data.isPendingNavigationSummary)):updateTopPages(data.pages,!0),updateSeriesListCommaFormat([data.pageViews||[],data.visitors||[]],"count"),"function"==typeof cb&&cb()},updateLegendSettings=function(update){utility.persistent.save({legends:update})},updateNavigationSummary=function(navigationSummary){var $container,referrersChart,exitPagesChart,data,categories,container="#page-traffic-panel #navigation-summary .chart-container > div";navigationSummary.referrers.forEach(function(d){d.count=utility.formatAbbreviateBigNumbers(d.count)}),navigationSummary.exitPages.forEach(function(d){d.count=utility.formatAbbreviateBigNumbers(d.count)}),$container=wrapper.find(container),$container.find("svg.referrers-svg").remove(),$container.append('<svg class="referrers-svg"></svg>'),$container.find("svg.exitPages-svg").remove(),$container.append('<svg class="exitPages-svg"></svg>'),$container.css("left","-300px"),referrersChart=drawNavigationSummaryChart(700,500,[20,0,20,0],-1),data={label:"",category:"",children:navigationSummary.referrers},d3.select(container+" svg.referrers-svg").datum(data).call(referrersChart),exitPagesChart=drawNavigationSummaryChart(400,500,[20,0,20,0],1),data={label:"",category:"",children:navigationSummary.exitPages},d3.select(container+" svg.exitPages-svg").datum(data).call(exitPagesChart),categories=getNavigationSummaryCategories(navigationSummary),viewModel.navigationSummaryCategories(categories),viewModel.navigationSummary(navigationSummary)},getNavigationSummaryCategories=function(navigationSummary){for(var categoryLabel,categories=[],i=0;i<navigationSummary.referrers.length;i++)categoryLabel=getCategoryLabel(navigationSummary.referrers[i].category),categories.indexOf(categoryLabel)<0&&categories.push(categoryLabel);return navigationSummary.exitPages.length>0&&(categoryLabel=getCategoryLabel(navigationSummary.exitPages[0].category),categories.push(categoryLabel)),categories},getCategoryLabel=function(category){var label="";switch(category){case"Direct":label=contentResx.analytics_direct;break;case"Direct Referral":label=contentResx.analytics_direct_referral;break;case"Internal":label=contentResx.analytics_internal;break;case"External":label=contentResx.analytics_external;break;case"Social":label=contentResx.analytics_social;break;case"Search":label=contentResx.analytics_search;break;case"ExitPages":label=contentResx.analytics_exitpages}return label.toUpperCase()},updatePageViewsGraph=function(labels,pageViews,visitors,animation){var root="page"==analyticsMode?"#page-traffic-panel":"#site-traffic-panel",legend=wrapper.find(root+" #page-views-legend"),container=root+" #page-views",$legend=wrapper.find(legend).empty(),$container=wrapper.find(container);if(0!==$container.length){$container.find("svg").remove(),$container.append('<svg class="line-chart"></svg>');var data=[{values:visitors,key:viewModel.contentResx.analytics_Visitors.toUpperCase(),color:graphColors[0]},{values:pageViews,key:viewModel.contentResx.analytics_PageViews.toUpperCase(),color:graphColors[1]}],width=$container[0].clientWidth-10,height=width/2.5,chart=d3Charts.lineChart(animation,width,height).margins({right:20}).labels(labels).legendSelector(legend).legendSettings(legendSettings).updateLegendSettings(updateLegendSettings).tooltipSelector(container+" > div.line-chart-tooltip").yAxisFormatter(function(value){return utility.formatCommaSeparate(value)});d3.select(container+" svg").datum(data).call(chart);var containerWidth=$container.width(),legendWidth=$legend.width();$legend.css("margin-left",(containerWidth-legendWidth)/2+"px")}},updateTimeOnPageGraph=function(labels,timeOnPage,animation){var oneMinute=60,oneHour=3600,root="#page-traffic-panel",container=root+" #time-on-page",$container=wrapper.find(container);$container.find("svg").remove(),$container.append('<svg class="line-chart"></svg>');var data=[{values:timeOnPage,key:viewModel.contentResx.analytics_TimeOnPage.toUpperCase(),color:graphColors[0]}],width=$container[0].clientWidth-10,height=width/2.5,chart=d3Charts.lineChart(animation,width,height).margins({left:40}).margins({right:20}).labels(labels).tooltipSelector(container+" > div.line-chart-tooltip").tooltipLabel("[COUNT]").tooltipFormatter(utility.secondsFormatter).yAxisLabel(viewModel.resx.seconds),maxTimeOnPage=getMaxTimeOnPage(timeOnPage);maxTimeOnPage>oneMinute&&chart.margins({left:50}).yAxisFormatter(function(seconds){var duration=moment().startOf("day").add(seconds,"seconds");
return seconds>=oneHour?duration.format("H:mm:ss"):duration.format("m:ss")}).yAxisLabel(viewModel.resx.minutes).yAxisCoefficient(oneMinute),d3.select(container+" svg").datum(data).call(chart)},updateTopOperatingSystems=function(data,setFirstPageSelected){var results=[],width=195,totalResults=0;data&&($.each(data.results||[],function(i,v){var title=v.title;title=utility.trimContentToFit(title,width),v.title=title,v.countTooltip=utility.formatCommaSeparate(v.count),v.count=utility.formatAbbreviateBigNumbers(v.count),results.push(v)}),totalResults=data.totalResults||0,isMobile||addEmptyEntriesToFitPage(results)),viewModel.topOperatingSystems.results(results),viewModel.topOperatingSystems.totalResults(totalResults),setFirstPageSelected&&viewModel.topOperatingSystems.pageIndex&&viewModel.topOperatingSystems.pageIndex(0)},updateTopPages=function(data,setFirstPageSelected){var results=[],width=195,totalResults=0;data&&($.each(data.results||[],function(i,v){var title=v.title;title=utility.trimContentToFit(title,width),v.title=title,v.countTooltip=utility.formatCommaSeparate(v.count),v.count=utility.formatAbbreviateBigNumbers(v.count),results.push(v)}),totalResults=data.totalResults||0,isMobile||addEmptyEntriesToFitPage(results)),viewModel.topPages.results(results),viewModel.topPages.totalResults(totalResults),setFirstPageSelected&&viewModel.topPages.pageIndex&&viewModel.topPages.pageIndex(0)},updateTopReferrers=function(data,setFirstPageSelected){var results=[],width=195,totalResults=0;data&&($.each(data.results||[],function(i,v){var title=v.title;title=utility.trimContentToFit(title,width),v.title=title,v.countTooltip=utility.formatCommaSeparate(v.count),v.count=utility.formatAbbreviateBigNumbers(v.count),results.push(v)}),totalResults=data.totalResults||0,isMobile||addEmptyEntriesToFitPage(results)),viewModel.topReferrers.results(results),viewModel.topReferrers.totalResults(totalResults),setFirstPageSelected&&viewModel.topReferrers.pageIndex&&viewModel.topReferrers.pageIndex(0)};return{init:init,initMobile:initMobile,load:load,loadMobile:loadMobile}};return analytics});