"use strict";define(["jquery","knockout","../scripts/pager","../scripts/validator","../scripts/config","dnn.jquery"],function($,ko,pager,validator,cf){var config=cf.init(),utility=null,triggerSubscribe=!0,onCreateUser=!1,andSearchTerm=!1,viewModel={searchText:ko.observable(""),results:ko.observableArray([]),totalResults:ko.observable(0),sortColumn:ko.observable("Joined"),sortAscending:ko.observable(!1),showSocial:ko.observable("DNNSOCIAL"===config.sku),isCommunityManager:ko.observable(config.isCommunityManager),userEditing:{userName:ko.observable(""),firstName:ko.observable(""),lastName:ko.observable(""),email:ko.observable(""),save:function(vm,e){if(!onCreateUser&&validator.validate($("#createusertbl"))){onCreateUser=!0;var saveBtn=$(e.target);saveBtn.html(utility.resx.PersonaBar.btn_Saving),createUser(function(){viewModel.userEditing.cancel(),utility.notify(utility.resx.PersonaBar.txt_UserSaved),triggerSubscribe=!1,viewModel.searchText(""),viewModel.sortColumn("Joined"),viewModel.sortAscending(!1),viewModel.pageIndex(0),triggerSubscribe=!0,searchUsers(),onCreateUser=!1,saveBtn.html(utility.resx.PersonaBar.btn_Save)},function(d){var $input=$("#createuser-username");$("<span></span>").addClass("dnnFormError").html(d).insertAfter($input).click(function(){return $(this).hide(),!1}),$input.bind("focus",function(){$input.parent().find("span.dnnFormError").hide()}),onCreateUser=!1,utility.notifyError("Failed..."),saveBtn.html(utility.resx.PersonaBar.btn_Save)})}},cancel:function(){$("#createusertbl > tbody > tr > td > div").slideUp(200,"linear",function(){$("#createusertbl > tbody > tr").hide()})}},detailUser:{userId:ko.observable(0),userName:ko.observable(""),displayName:ko.observable(""),rank:ko.observable(0),reputation:ko.observable(0),experience:ko.observable(0),engagement:ko.observable(0),influence:ko.observable(0),profileUrl:ko.observable(""),userFolder:ko.observable(0),hasFiles:ko.observable(!1),isDeleted:ko.observable(!1),lastActive:ko.observable(""),timeOnSite:ko.observable(""),totalContribution:ko.observable(0),recentActivities:ko.observableArray([]),tempReputation:ko.observable(0),tempExperience:ko.observable(0),tempNotes:ko.observable(""),canToggleModerator:ko.observable(!1),canToggleEditor:ko.observable(!1),isModerator:ko.observable(!1),isEditor:ko.observable(!1),navigateProfile:function(data,e){e.preventDefault(),utility.closePersonaBar(function(){window.parent.document.location.href=data.profileUrl()})},navigateFiles:function(data,e){e.preventDefault();var folderId=data.userFolder(),hasFiles=data.hasFiles();if(folderId>0&&hasFiles)utility.loadPanel("#assets-panel",$("li.btn_assets.btn_panel"),{folderId:folderId});else{var message=utility.resx.PersonaBar.err_NoUserFolder;message=message.replace("{0}",data.displayName()),utility.notifyError(message)}},editPoint:function(data,e){e.preventDefault(),data.tempExperience(data.experience()),data.tempReputation(data.reputation()),data.tempNotes("");var inputs=$(".user-statistics-input");inputs.prev().hide(),inputs.css({display:"block"});var notes=$(".user-statistics-edit-notes");notes.show(),$(e.target).hide()},cancelEditPoint:function(data,e){if(e&&e.preventDefault(),viewModel.isCommunityManager()){var inputs=$(".user-statistics-input");inputs.css({display:"none"}),inputs.prev().show();var notes=$(".user-statistics-edit-notes");notes.hide(),$(".user-statistics > li > span.dnnFormError").remove(),$("#user-editpointbtn").show()}},saveEditPoint:function(data,e){e.preventDefault(),saveAdhocPoint(data,$(e.target))}}};viewModel.sort=function(vm,e){var column=$(e.target).data("column");column===viewModel.sortColumn()?viewModel.sortAscending(!viewModel.sortAscending()):(viewModel.sortColumn(column),viewModel.sortAscending(!0)),searchUsers()},viewModel.sortColumnClass=function(column){return column===viewModel.sortColumn()?viewModel.sortAscending()?"asc":"desc":""},viewModel.create=function(){$("#createusertbl > tbody > tr").is("visible")||($("#userstbl tr").removeClass("in-edit-row"),$("#users-editrow > td > div").slideUp(200,"linear",function(){$("#users-editrow").appendTo("#users-editbody"),viewModel.userEditing.firstName(""),viewModel.userEditing.lastName(""),viewModel.userEditing.userName(""),viewModel.userEditing.email(""),$("#createusertbl").find("span.dnnFormError").remove(),$("#createusertbl > tbody > tr").show(),$("#createusertbl > tbody > tr > td > div").slideDown(400,"linear")}))};var onSaveAdhocPoint=!1,saveAdhocPoint=function(user,btn){validator.validate($("#users-editrow"),[{name:"nolargerthanexp",errorMsg:utility.resx.PersonaBar.err_NoLargerThanExp,validate:function(){var r=parseInt(user.tempReputation()),e=parseInt(user.tempExperience());return r<=e}}])&&(onSaveAdhocPoint||(onSaveAdhocPoint=!0,btn.html(utility.resx.PersonaBar.btn_Saving),utility.sf.moduleRoot="dnncorp/personaBar",utility.sf.controller="users",utility.sf.post("saveuserpoints",{userId:user.userId(),reputation:user.tempReputation(),experience:user.tempExperience(),note:user.tempNotes()},function(d){d&&d.Success?(user.experience(user.tempExperience()),user.reputation(user.tempReputation()),user.cancelEditPoint(),utility.notify(utility.resx.PersonaBar.txt_Saved)):utility.notifyError("Failed..."),onSaveAdhocPoint=!1,btn.html(utility.resx.PersonaBar.btn_Save)},function(){utility.notifyError("Failed..."),onSaveAdhocPoint=!1,btn.html(utility.resx.PersonaBar.btn_Save)})))},createUser=function(success,fail){utility.sf.moduleRoot="dnncorp/personaBar",utility.sf.controller="users";var params={firstName:viewModel.userEditing.firstName(),lastName:viewModel.userEditing.lastName(),userName:viewModel.userEditing.userName(),email:viewModel.userEditing.email()};utility.sf.post("createuser",params,function(d){/^\d+$/.test(d)?"function"==typeof success&&success(d):"function"==typeof fail&&fail(d)},function(){"function"==typeof fail&&fail(d)})},getUserDetail=function(userId,cb){utility.sf.moduleRoot="dnncorp/personaBar",utility.sf.controller="users",utility.sf.get("getuserdetail",{userId:userId},function(d){if(d.Success&&d.UserDetail){for(var i=0;i<toggleUserRoleSubscribers.length;i++)toggleUserRoleSubscribers[i].dispose();toggleUserRoleSubscribers=[],viewModel.detailUser.userId(d.UserDetail.UserId),viewModel.detailUser.displayName(d.UserDetail.Displayname),viewModel.detailUser.userName(d.UserDetail.Username),viewModel.detailUser.rank(d.UserDetail.Rank==-1?utility.resx.PersonaBar.label_NA:d.UserDetail.Rank),viewModel.detailUser.experience(d.UserDetail.Experience),viewModel.detailUser.reputation(d.UserDetail.Reputation),viewModel.detailUser.engagement(d.UserDetail.Engagement),viewModel.detailUser.influence(d.UserDetail.Influence),viewModel.detailUser.profileUrl(d.UserDetail.ProfileUrl),viewModel.detailUser.userFolder(d.UserDetail.UserFolder),viewModel.detailUser.hasFiles(d.UserDetail.HasUserFiles),viewModel.detailUser.isDeleted(d.UserDetail.IsDeleted),viewModel.detailUser.timeOnSite(d.UserDetail.TimeOnSite),viewModel.detailUser.lastActive(d.UserDetail.LastActive),viewModel.detailUser.totalContribution(d.UserDetail.TotalContribution),viewModel.detailUser.canToggleModerator(d.UserDetail.ModeratorStatus>0),viewModel.detailUser.canToggleEditor(d.UserDetail.EditorStatus>0),viewModel.detailUser.isModerator(2==d.UserDetail.ModeratorStatus),viewModel.detailUser.isEditor(2==d.UserDetail.EditorStatus),toggleUserRoleSubscribers.push(viewModel.detailUser.isModerator.subscribe(function(checked){toggleUserRoleHandler("Moderator",checked)})),toggleUserRoleSubscribers.push(viewModel.detailUser.isEditor.subscribe(function(checked){toggleUserRoleHandler("Editor",checked)}));var activities=[];$.each(d.UserDetail.RecentActivities,function(i,v){var a={title:ko.observable(v.Title),created:ko.observable(v.Action+" "+v.Created),area:ko.observable(v.Area)};activities.push(a)}),viewModel.detailUser.recentActivities(activities),viewModel.detailUser.cancelEditPoint()}"function"==typeof cb&&cb()},function(){})},toggleUserRoleSubscribers=[],toggleUserRoleHandler=function(role,checked){var params={userId:viewModel.detailUser.userId()},action=(checked?"Make":"Remove")+role,property="Moderator"==role?viewModel.detailUser.isModerator:viewModel.detailUser.isEditor;utility.sf.moduleRoot="dnncorp/personaBar",utility.sf.controller="users",utility.sf.post(action,params,function(data){data.Success||(property(!property()),utility.notifyError("Failed..."))},function(){property(!property()),utility.notifyError("Failed...")})},viewUserDetail=function(user,target){var row=$(target);if(0==row.is("tr")&&(row=row.closest("tr")),row.hasClass("in-edit-row"))return row.removeClass("in-edit-row"),void $("#users-editrow > td > div").slideUp(200,"linear",function(){$("#users-editrow").appendTo("#users-editbody")});$("#createusertbl > tbody > tr > td > div").slideUp(200,"linear",function(){$("#createusertbl > tbody > tr").hide()});var tbody=row.parent();$("tr",tbody).removeClass("in-edit-row"),row.addClass("in-edit-row"),utility.asyncParallel([function(cb1){getUserDetail(user.userId,cb1)},function(cb2){$("#users-editrow > td > div").slideUp(200,"linear",function(){cb2()})}],function(){$("#users-editrow").insertAfter(row),$("#users-editrow > td > div").slideDown(400,"linear")})},getUserSearchParams=function(){var searchText=viewModel.searchText();if(andSearchTerm){var arr=searchText.split(" ");searchText=arr.join(" AND ")}return{pageIndex:viewModel.pageIndex(),pageSize:viewModel.pageSize,sortColumn:viewModel.sortColumn(),sortAscending:viewModel.sortAscending(),searchText:searchText}},searchUsers=function(cb){$("#users-editrow > td > div").hide(),$("#users-editrow").appendTo("#users-editbody"),$("#createusertbl > tbody > tr > td > div").hide(),$("#createusertbl > tbody > tr").hide(),utility.sf.moduleRoot="dnncorp/personaBar",utility.sf.controller="users";var searchParams=getUserSearchParams();utility.sf.get("getusers",searchParams,function(d){andSearchTerm=!1;var results=[];$.each(d.Results,function(i,v){var user={userId:ko.observable(v.UserId),userName:ko.observable(v.Username),displayName:ko.observable(v.Displayname),email:ko.observable(v.Email),avatar:ko.observable(v.AvatarUrl),joined:ko.observable(v.Joined)};user.expand=function(data,e){return"A"==e.target.nodeName&&"email-link"==e.target.className?void(window.location.href=e.target.href):(viewUserDetail(data,e.target),void e.preventDefault())},results.push(user)}),viewModel.results(results),viewModel.totalResults(d.TotalResults),"function"==typeof cb&&cb()},function(){andSearchTerm=!1})},searchUsersStart=function(cb){viewModel.pageIndex(0),searchUsers(cb)},expandMatchedUserDetail=function(params,cb){params&&params.displayName?setTimeout(function(){var users=viewModel.results(),matched=0;$.each(users,function(i,v){if(v.displayName()===params.displayName)return matched=i+1,!1}),matched>0&&$("#userstbl tbody tr:nth-child("+matched+")").click(),"function"==typeof cb&&cb()},200):"function"==typeof cb&&cb()};return{init:function(wrapper,util,params,callback){utility=util,pager.init(viewModel,10,searchUsers,utility.resx.PersonaBar,utility.resx.PersonaBar.pager_UserPagedDesc,utility.resx.PersonaBar.pager_UserDesc),utility.localizeErrMessages(validator),utility.asyncParallel([function(cb1){params&&params.displayName&&(andSearchTerm=!0,viewModel.searchText(params.displayName)),searchUsers(cb1)}],function(){var searchTextThrottle=null;viewModel.searchText.subscribe(function(){triggerSubscribe&&(searchTextThrottle&&clearTimeout(searchTextThrottle),searchTextThrottle=setTimeout(searchUsersStart,500))});var container=wrapper[0];viewModel.resx=utility.resx.PersonaBar,ko.applyBindings(viewModel,container),expandMatchedUserDetail(params,callback),wrapper.find('input[type="checkbox"]').dnnCheckbox()})},initMobile:function(wrapper,util,params,callback){this.init(wrapper,util,params,callback)},load:function(params,callback){params&&params.displayName&&(triggerSubscribe=!1,andSearchTerm=!0,viewModel.searchText(params.displayName),searchUsersStart(function(){triggerSubscribe=!0,expandMatchedUserDetail(params,callback)}))},loadMobile:function(params,callback){this.load(params,callback)}}});