"use strict";define(["jquery","d3"],function($,d3){var d3Charts={};return d3Charts.areaDonutChart=function(){function my(selection){selection.each(function(data,index){if(data&&data.length){var dd=data[index],pie=d3.layout.pie().value(function(d){return d}).sort(null),arc=d3.svg.arc().innerRadius(radius-5).outerRadius(radius),svg=d3.select(this).attr("width",width).attr("height",height).append("g").attr("transform","translate("+width/2+","+height/2+")");svg.selectAll("path").data(pie(dd.values)).enter().append("path").attr("fill",function(d,i){return dd.colors[i%dd.colors.length]}).attr("d",arc)}})}var width=100,height=100,radius=width/2;return my},d3Charts.donutChart=function(animation,width,height,thickness){function my(selection){selection.each(function(data,index){if(data&&data.length){var tooltip=tooltipSelector?d3.select(tooltipSelector):null,dd=data[index],total=d3.sum(dd.values,function(d){return d}),svg=d3.select(this).attr("width",width).attr("height",height).append("g").attr("transform","translate("+width/2+","+height/2+")"),pie=d3.layout.pie().value(function(d){return d}).sort(null),arc=d3.svg.arc().innerRadius(radius-thickness).outerRadius(radius);if(0===total)svg.selectAll("path").data(pie([1])).enter().append("path").attr("fill",function(){return"#ccc"}).transition().delay(function(d,i){return 200*i}).duration(200).attrTween("d",function(d){var i=d3.interpolate(d.startAngle+.1,d.endAngle);return function(t){return d.endAngle=i(t),arc(d)}});else{var labels=dd.labels;svg.selectAll("path").data(pie(dd.values)).enter().append("path").attr("fill",function(d,i){return dd.colors[i%dd.colors.length]}).on("mouseover",function(d,i){if(tooltip){var l=d3.event.pageX-parseInt(tooltip.style("width"))/2-10,t=d3.event.pageY-80,offset=$(tooltipSelector).parent().offset();l-=offset.left,t-=offset.top;var label=labels[i];tooltip.select(".title").text(label+":");var value=dd.valuesTooltips?dd.valuesTooltips[i]:d.value;tooltip.select(".info.line-1").text(tooltipLabel.replace("[COUNT]",value)),tooltip.style("left",l+"px").style("top",t+"px").style("display","").transition().style("opacity",1)}}).on("mouseout",function(){tooltip&&tooltip.transition().style("opacity",0).each("end",function(){d3.select(this).style("display","none")})}).transition().delay(function(d,i){return 200*i}).duration(200).attrTween("d",function(d){var i=d3.interpolate(d.startAngle+.1,d.endAngle);return function(t){return d.endAngle=i(t),arc(d)}})}if(legendSelector)for(var i=0;i<dd.colors.length;i++){var $check=$("<li></li>");i%2===0?$check.addClass("item-left"):$check.addClass("item-right"),$check.append($("<div></div>").css("background-color",dd.colors[i])),$check.append($("<span></span>").text(dd.labels[i]).addClass("label"));var legendElementLabel=dd.valuesLabels?dd.valuesLabels[i]:dd.values[i],legendElement=$check.append($("<span></span>").text(legendElementLabel).addClass("value"));dd.valuesTooltips&&legendElement.prop("title",dd.labels[i]+" "+dd.valuesTooltips[i]),$(legendSelector).append($check)}if(ratioSelector&&2===dd.values.length&&total>0){var ratio=Math.round(dd.values[0]/total*100);$(ratioSelector).append(ratio+"<sup>%</sup>")}ratioSelector&&0===total&&$(ratioSelector).append("<span>No Data</span>")}})}var radius=Math.min(width,height)/2,legendSelector=null,ratioSelector=null,tooltipSelector=null,tooltipLabel="[COUNT]";return my.width=function(value){return arguments.length?(width=value,my):width},my.height=function(value){return arguments.length?(height=value,my):height},my.radius=function(value){return arguments.length?(radius=value,my):radius},my.thickness=function(value){return arguments.length?(thickness=value,my):thickness},my.tooltipSelector=function(value){return arguments.length?(tooltipSelector=value,my):tooltipSelector},my.tooltipLabel=function(value){return arguments.length?(tooltipLabel=value,my):tooltipLabel},my.legendSelector=function(value){return arguments.length?(legendSelector=value,my):legendSelector},my.ratioSelector=function(value){return arguments.length?(ratioSelector=value,my):ratioSelector},my},d3Charts.horizontalBarChart=function(maxWidth,animation){function my(selection){selection.each(function(data){if(data&&data.length){var x=d3.scale.linear().domain([0,d3.max(data,function(d){return d.count})]).range([0,maxWidth]),chart=d3.select(this).attr("width",width),bar=chart.selectAll("g").data(data);bar.exit().remove();var g=bar.enter().append("g").attr("transform",function(d,i){return"translate(0,"+i*itemHeight+")"});g.append("rect").attr("y",24).attr("class","background").attr("width",width).attr("height",barHeight),g.append("rect").attr("y",24).attr("class","bar").attr("width",0).attr("height",barHeight),animation?bar.select("rect.bar").transition().delay(function(d,i){return 100*i}).duration(500).attr("width",function(d){return x(d.count)}):bar.select("rect.bar").attr("width",function(d){return x(d.count)}),bar.selectAll("text").remove(),bar.append("text").attr("class","label").attr("x",0).attr("y",8).attr("dy",".35em").text(function(d){return d.label}),bar.append("text").attr("class","count").attr("x",width).attr("y",8).attr("dy",".35em").text(function(d){return d.valueLabel||d.count}).append("svg:title").text(function(d){return d.valueTooltip||""})}})}var width=370,barHeight=10,itemHeight=60;return my.width=function(value){return arguments.length?(width=value,my):width},my},d3Charts.lineChart=function(animation,width,height){function formatYAxisValue(value){if(!yAxisFormatter)return value;if("function"!=typeof yAxisFormatter)throw new Exception("yAxisFormatter must be a function");return yAxisFormatter(value)}function my(selection){selection.each(function(data){if(data&&data.length){var max=getYAxisMax(data);if(!isNaN(max)){max>999&&(margins.left=margins.left+getDigitsPixelOffSet(getNumberOfDigits(max))),width=width-margins.left-margins.right,height=height-margins.top-margins.bottom;for(var chart=d3.select(this).attr("width",width+margins.left+margins.right).attr("height",height+margins.top+margins.bottom).append("g").attr("transform","translate("+margins.left+","+margins.top+")"),count=d3.max(data,function(d){return d.values.length}),factor=NUMBER_OF_TICKS_IN_X_AXIS/count,isOnePointPerTick=factor>=ONE_POINT_PER_TICK_LOWERBOUND&&factor<ONE_POINT_PER_TICK_UPPERBOUND,x=d3.scale.linear().domain([0,count-1]).range([0,width]),gridGap=max/6,found=!1,seed=0;!found;){seed=0===seed?1:seed*yAxisCoefficient;var seedArray=[1*seed,2*seed,5*seed];$.each(seedArray,function(ii,s){return!(gridGap<=s)||(gridGap=s,found=!0,!1)})}for(var gridMax=0,gridRange=[0];gridMax<max;)gridMax+=gridGap,gridRange.push(gridMax);var y=d3.scale.linear().domain([0,gridMax]).range([height,0]),xAxis=d3.svg.axis().scale(x).ticks(NUMBER_OF_TICKS_IN_X_AXIS).tickSize(-height,0,0).tickFormat(function(i){return i===parseInt(i,10)&&!isOnePointPerTick||isOnePointPerTick&&i%3===0?labels[i]:""}).orient("bottom"),yAxis=d3.svg.axis().scale(y).tickSize(-width,0,0).orient("left").tickValues(gridRange).tickFormat(function(i){var isPositiveInteger=Math.round(i)===i&&i>0;return isPositiveInteger?formatYAxisValue(i).toString():""});chart.append("rect").attr("class","background").attr("rx",3).attr("ry",3).attr("width",width).attr("height",height),chart.append("g").attr("class","x axis").attr("transform","translate(0,"+height+")").call(xAxis),chart.append("g").attr("class","y axis").call(yAxis),yAxisLabel&&chart.append("text").attr("transform","rotate(-90)").attr("y",-margins.left).attr("x",0-height/2).attr("dy","1em").attr("class","y-axis-label").text(yAxisLabel),d3.selectAll("g.x.axis text").attr("y","8"),d3.selectAll("g.y.axis text").attr("x","-8");for(var i=0;i<data.length;i++){var show=legendSettings.indexOf(data[i].key)<0;legendSelector&&addLineToggle(legendSelector,chart,data[i].key,i,data[i].color,show),drawGraphLine(chart,x,y,data[i].values,data[i].key,i,data[i].color,show,data[i].tooltipLabel)}}}})}function addLineToggle(selector,graph,label,id,color,checked){var $check=$("<li></li>").attr("data-id",id);checked&&$check.addClass("checked"),$check.append($("<div></div>").css("background-color",color)),$check.append($("<span></span>").text(label)),$check.on("click",function(){var index,group=graph.select("g.graph-line-"+$(this).attr("data-id"));$(this).is(".checked")?($(this).removeClass("checked"),group.transition().style("opacity","0").each("end",function(){d3.select(this).style("visibility","hidden")}),index=legendSettings.indexOf(label),index<0&&(legendSettings.push(label),"function"==typeof updateLegendSettings&&updateLegendSettings(legendSettings))):($(this).addClass("checked"),group.style("visibility","visible").transition().style("opacity","1"),index=legendSettings.indexOf(label),index>-1&&(legendSettings.splice(index,1),"function"==typeof updateLegendSettings&&updateLegendSettings(legendSettings)))}),$(selector).append($check)}function formatTooltipValue(value){if(!tooltipFormatter)return value;if("function"!=typeof tooltipFormatter)throw new Exception("tooltipFormatter must be a function");return tooltipFormatter(value)}function drawGraphLine(chart,x,y,data,label,id,color,show,seriesTooltipLabel){var tooltip=d3.select(tooltipSelector),delay=100*id,zeroLine=d3.svg.line().x(function(d,i){return x(i)}).y(function(){return y(0)}),line=d3.svg.line().x(function(d,i){return x(i)}).y(function(d){return y(d.count)}),g=chart.append("g").attr("class","graph-line-"+id),tooltipToUse=tooltipLabel;seriesTooltipLabel&&(tooltipToUse=seriesTooltipLabel),show&&animation?(g.append("path").datum(data).attr("stroke",color).attr("class","line").attr("d",zeroLine).transition().delay(delay).attr("d",line),g.selectAll("circle").data(data).enter().append("circle").attr("class","node").attr("fill",color).attr("r",5).attr("cx",function(d,i){return x(i)}).attr("cy",function(){return y(0)}).on("mouseover",function(d){var l=Math.floor(d3.select(this).attr("cx"))+margins.left-parseInt(tooltip.style("width"))/2-10,b=height+margins.bottom+20-Math.floor(d3.select(this).attr("cy"));tooltip.select(".title").text(label+":"),tooltip.select(".info.line-1").text(tooltipToUse.replace("[COUNT]",formatTooltipValue(d.count))),tooltip.select(".info.line-2").html(d.label),tooltip.style("left",l+"px").style("bottom",b+"px").style("display","").transition().style("opacity",1)}).on("mouseout",function(){tooltip.transition().style("opacity",0).each("end",function(){d3.select(this).style("display","none")})}).transition().delay(delay).attr("cy",function(d){return y(d.count)})):(g.append("path").datum(data).attr("stroke",color).attr("class","line").attr("d",line),g.selectAll("circle").data(data).enter().append("circle").attr("class","node").attr("fill",color).attr("r",5).attr("cx",function(d,i){return x(i)}).attr("cy",function(d){return y(d.count)}).on("mouseover",function(d){var l=Math.floor(d3.select(this).attr("cx"))+margins.left-parseInt(tooltip.style("width"))/2-10,b=height+margins.bottom+20-Math.floor(d3.select(this).attr("cy"));tooltip.select(".title").text(label+":"),tooltip.select(".info.line-1").text(tooltipToUse.replace("[COUNT]",formatTooltipValue(d.count)));var ll=d.label.replace("-","- <br/>");tooltip.select(".info.line-2").html(ll),tooltip.style("left",l+"px").style("bottom",b+"px").style("display","").transition().style("opacity",1)}).on("mouseout",function(){tooltip.transition().style("opacity",0).each("end",function(){d3.select(this).style("display","none")})}),show||g.style("visibility","hidden"))}var margins={top:20,right:15,bottom:30,left:30},legendSelector=null,legendSettings=[],updateLegendSettings=null,tooltipSelector=null,tooltipLabel="[COUNT]",tooltipFormatter=null,yAxisFormatter=null,yAxisLabel=null,yAxisCoefficient=10,labels=null,NUMBER_OF_TICKS_IN_X_AXIS=24,ONE_POINT_PER_TICK_LOWERBOUND=.75,ONE_POINT_PER_TICK_UPPERBOUND=1.333334,getMax=function(data){return d3.max(data,function(d){return d.count})},getYAxisMax=function(data){for(var max=6,i=0;i<data.length;i++)max=Math.max(max,getMax(data[i].values));return max},getNumberOfDigits=function(number){return(""+number).length},getDigitsPixelOffSet=function(numberOfDigits){return 6*(numberOfDigits-2)};return my.legendSelector=function(value){return arguments.length?(legendSelector=value,my):legendSelector},my.legendSettings=function(value){return arguments.length?(legendSettings=value,my):legendSettings},my.updateLegendSettings=function(value){return arguments.length?(updateLegendSettings=value,my):updateLegendSettings},my.tooltipSelector=function(value){return arguments.length?(tooltipSelector=value,my):tooltipSelector},my.tooltipLabel=function(value){return arguments.length?(tooltipLabel=value,my):tooltipLabel},my.tooltipFormatter=function(value){return arguments.length?(tooltipFormatter=value,my):tooltipFormatter},my.yAxisFormatter=function(value){return arguments.length?(yAxisFormatter=value,my):yAxisFormatter},my.yAxisLabel=function(value){return arguments.length?(yAxisLabel=value,my):yAxisLabel},my.yAxisCoefficient=function(value){return arguments.length?(yAxisCoefficient=value,my):yAxisCoefficient},my.margins=function(value){return arguments.length?(margins=$.extend(margins,value),my):margins},my.labels=function(value){return arguments.length?(labels=value,my):labels},my},d3Charts});