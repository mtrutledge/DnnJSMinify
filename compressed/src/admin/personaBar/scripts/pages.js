define(["jquery","knockout","knockout.mapping","jquery-ui.min","dnn.jquery","dnn.extensions","dnn.jquery.extensions","jquery.tokeninput","dnn.jScrollBar","css!../css/pages-settings.css","css!../css/pages-hierarchy.css","css!../css/tags-input.css"],function($,ko,koMapping){"use strict";var viewModel,koBinded,isMobile,utility,container,resx,init,initMobile,load,loadMobile,addEventListeners,onHidePanelClick,onAddPageClick,changeView,initializeView,showPagesList,callPageSettings,pageAddComplete,templateAddComplete,pageEditComplete,pageSettingsCancel,PERSONABAR_TEMPLATES_SUBMENU_ID="#personabar #nav_Templates";return viewModel={},koBinded=!1,isMobile=!1,utility=null,container=null,resx=null,ko.mapping=koMapping,init=function(wrapper,util,params,callback){utility=util,viewModel={},container=wrapper,addEventListeners(),"undefined"!=typeof dnn&&"undefined"!=typeof dnn.dnnPageHierarchy||(window.Sys=window.Sys?window.Sys:window.top.Sys,window.dnn=window.dnn?window.dnn:window.top.dnn),changeView(),"function"==typeof callback&&callback(),(navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPod/i))&&$(".header").css("width","80%")},initMobile=function(wrapper,util,params,callback){isMobile=!0,this.init(wrapper,util,params,callback)},load=function(params,callback){changeView(),dnn&&dnn.dnnPageHierarchy&&dnn.dnnPageHierarchy.load()},loadMobile=function(params,callback){isMobile=!0,this.load(params,callback)},onHidePanelClick=function(e){"undefined"!=typeof dnn.dnnPageSettings&&dnn.dnnPageSettings.hasPendingChanges()?dnn.dnnPageSettings.handlePendingChanges(e):"undefined"!=typeof dnn.dnnPageHierarchy&&dnn.dnnPageHierarchy.hasPendingChanges()&&dnn.dnnPageHierarchy.handlePendingChanges(e)},addEventListeners=function(){container.find("a.btn-addpage").click(onAddPageClick),$("#topLevelMenu .personabarnav li, #topLevelMenu .hovermenu ul li").click(onHidePanelClick).each(function(){var events=$._data(this,"events").click,first=events.pop();events.splice(0,0,first)})},onAddPageClick=function(){return"undefined"!=typeof dnn.dnnPageHierarchy&&dnn.dnnPageHierarchy.hasPendingChanges()?dnn.dnnPageHierarchy.handlePendingChanges():(changeView("addpage"),!1)},changeView=function(action){var initView,params;return"undefined"==typeof action?(initView=container.data("init-view"))?(container.data("init-view",null),void changeView(initView)):void initializeView():(params=container.data("init-view-params"),container.data("init-view-params",null),void initializeView(action,function(){switch(action){case"edit":this._closePersonaBarOnUpdate=!0,callPageSettings("edit",params);break;case"addpage":callPageSettings("addpage",params)}}))},initializeView=function(action,callback){setTimeout(function(){showPagesList(action,callback)},100)},showPagesList=function(action,callback){"undefined"==typeof dnn.dnnPageHierarchy?window.require(["../pages.pageHierarchy"],function(){dnn.dnnPageHierarchy=dnn.dnnPageHierarchy||{},dnn.dnnPageHierarchy.resx=utility.resx.ContentPB,dnn.dnnPageHierarchy.utility=utility,dnn.dnnPageHierarchy._viewModel=viewModel,dnn.dnnPageHierarchy.callPageSettings=callPageSettings,"edit"===action&&"function"==typeof callback&&dnn.dnnPageHierarchy.hide(),dnn.dnnPageHierarchy.init(callback),$(window).trigger("resize")}):("edit"===action&&"function"==typeof callback?(dnn.dnnPageHierarchy.hide(),callback.call(dnn.dnnPageHierarchy)):"addpage"===action?callback.call(dnn.dnnPageHierarchy):dnn.dnnPageHierarchy.show(),$(window).trigger("resize"))},callPageSettings=function(action,params){"undefined"==typeof dnn||"undefined"==typeof dnn.dnnPageSettings?(dnn.permissionGridManager=null,window.require(["../pages.pageSettings","../permissionGridManager","../permissionGrid"],function(){dnn.dnnPageSettings.resx=utility.resx.ContentPB,dnn.dnnPageSettings.serviceController=utility.sf,dnn.dnnPageSettings.utility=utility,dnn.dnnPageSettings.init(),dnn.dnnPageSettings.getElement().on("pageAdded",pageAddComplete),dnn.dnnPageSettings.getElement().on("templateAdded",templateAddComplete),dnn.dnnPageSettings.getElement().on("pageEdit",pageEditComplete),dnn.dnnPageSettings.getElement().on("pageSettingsCancel",pageSettingsCancel),dnn.dnnPageSettings[action].apply(dnn.dnnPageSettings,params)})):dnn.dnnPageSettings[action].apply(dnn.dnnPageSettings,params)},pageAddComplete=function(e,data){dnn.dnnPageHierarchy&&dnn.dnnPageHierarchy.addPage(data)},templateAddComplete=function(e,data){$(PERSONABAR_TEMPLATES_SUBMENU_ID).click()},pageEditComplete=function(e,data){dnn.dnnPageHierarchy&&(dnn.dnnPageHierarchy.editPage(data),dnn.dnnPageHierarchy._closePersonaBarOnUpdate&&(dnn.dnnPageHierarchy._closePersonaBarOnUpdate=!1,$(".btn_showsite").click()))},pageSettingsCancel=function(){dnn.dnnPageHierarchy&&dnn.dnnPageHierarchy._closePersonaBarOnUpdate&&(dnn.dnnPageHierarchy._closePersonaBarOnUpdate=!1,$(".btn_showsite").click())},{init:init,load:load,initMobile:initMobile,loadMobile:loadMobile}});