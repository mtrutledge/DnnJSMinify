window.dnn=window.dnn||{},define(["jquery","knockout","../scripts/config","../scripts/pages.thumbnails"],function($,ko,cf){var OVER_TIME_TO_OPEN_PAGE_CHILDS,config,templatesHierarchyManager,pageHierarchyDefaultOptions,draggingJqObj,pageDropped;OVER_TIME_TO_OPEN_PAGE_CHILDS=700,draggingJqObj=null,pageDropped=null,dropOnDroppable=!1,config=cf.init();var onDeleteCallback;return templatesHierarchyManager=function(options){this.options=options},templatesHierarchyManager.prototype={constructor:templatesHierarchyManager,init:function(initCallback,onDeleteCallbck){var handler,viewModel;onDeleteCallback=onDeleteCallbck,handler=this,this.options=$.extend({},pageHierarchyDefaultOptions,this.options),this.panel=$("#templates-panel"),this.container=$(".pagehierarchy-container",this.panel),this.dragContainer=this.container.find(".pages-drag-container"),this._selectPageInHierarchyHandler=$.proxy(this._selectPageInHierarchy,this),$(window).resize(function(){handler._resizeContentContainer(!0)}),$(".btn_showsite, .btn_panel").click($.proxy(this._leavePanelClickHandler,this)),viewModel=this._getViewModel(),ko.applyBindings(viewModel,handler.panel[0]),this._initCallback=initCallback;var viewModel=this._getViewModel();viewModel.selectedPage(this._getEmptyPageData()),viewModel.searchKeyword(""),this._loadPageTemplates()},load:function(){dnn.dnnPageThumbnails.init("#templates-panel"),dnn.dnnPageThumbnails.updateThumbnails(),this._loadPageTemplates()},getElement:function(){return this.container},addTemplate:function(){this._loadPageTemplates(),dnn.dnnPageThumbnails.init("#templates-panel"),dnn.dnnPageThumbnails.updateThumbnails()},selectPage:function(pageId,notFindMore){var handler,pageData,find;if(handler=this,find=this._findDataPosition(pageId))pageData=this._getViewModel().pagesList()[find.level].pages()[find.index],this._needScrollToSelectedPage=!0,this._supressUI=!1,this._getViewModel().selectedPage(pageData);else if("undefined"==typeof notFindMore||!notFindMore)return this._supressUI=!0,this.getElement().on("childpagesloaded",this._selectPageInHierarchyHandler),void this._getService().get("GetPageHierarchy",{pageId:pageId},function(data){handler._selectPageInHierarchyPath=data,handler._selectPageInHierarchy()});this.getElement().off("childpagesloaded",this._selectPageInHierarchyHandler)},hasPendingChanges:function(){return this._getViewModel().dragPage().id>0},handlePendingChanges:function(e){return this.utility.notify(this.resx.pages_Pending),e&&e.stopImmediatePropagation(),!1},_loadPageTemplates:function(callback){var handler,viewModel,params;handler=this,viewModel=handler._getViewModel(),viewModel.pagesList.removeAll(),params={searchKey:viewModel.searchKeyword()},this._getService().get("GetPageTemplates",params,function(data){viewModel.inDrag(!1),viewModel.pagesList.push({parentId:-1,level:0,pages:ko.observableArray(data)}),handler._resizeContentContainer(!0),handler._initDrag(),dnn.dnnPageThumbnails.init("#templates-panel"),dnn.dnnPageThumbnails.updateThumbnails(),"function"==typeof callback&&callback.call(handler),handler._getService().get("GetDeletedTemplates",{},function(deletedPages){viewModel.deletedPagesCount(deletedPages.length)})})},_addPagesList:function(parentPage,pagesData){var handler,viewModel,$listItem,$pagesList,level,nextLevel;handler=this,viewModel=this._getViewModel(),$listItem=$('li[data-page-id="'+parentPage.id+'"]'),$pagesList=$listItem.parents(".pages-list"),level=$pagesList.data("page-level"),draggingJqObj?$(".pages-list").each(function(){var self=$(this);self.data("page-level")>level&&(self.hide(),self.addClass("removeMe"))}):$(".pages-list").each(function(){var self=$(this);self.data("page-level")>level&&viewModel.pagesList.remove(function(item){return item.level>level})}),nextLevel=viewModel.pagesList().length,viewModel.pagesList.push({parentId:parentPage.id,level:nextLevel,pages:ko.observableArray(pagesData||[])}),setTimeout(function(){$pagesList.next().addClass("expand"),handler._initScrollView(!0,function(){var listScroller,containerScroller,$nextList,eventTriggeredByHover;eventTriggeredByHover=!1,listScroller=$pagesList.data("jsp"),containerScroller=handler.container.find(".pages-list-scroller").data("jsp"),handler._needScrollToSelectedPage?(handler._needScrollToSelectedPage=!1,listScroller&&listScroller.scrollToElement($listItem[0],!0,!0),containerScroller&&containerScroller.scrollToElement($pagesList[0],!0,!0)):($nextList=$('div.pages-list[data-page-level="'+nextLevel+'"]'),containerScroller&&$nextList.length>0&&containerScroller.scrollToElement($nextList[0],!0,!0)),handler._initDrag(),handler.getElement().trigger("childpagesloaded"),dnn.dnnPageThumbnails.init("#templates-panel"),dnn.dnnPageThumbnails.updateThumbnails()})},0)},_leavePanelClickHandler:function(e){$(e.target).hasClass("btn_pages")||(dnn.dnnPageThumbnails.init("#templates-panel"),dnn.dnnPageThumbnails.removeThumbnailLoader(),this.container.find(".thumbnail img.loading").removeClass("loading").parent().removeClass("loading"))},_pageItemClickHandler:function(pageData,e){this._getViewModel().selectedPage(pageData)},_viewPageClickHandler:function(pageData,e){this.utility.closePersonaBar(function(){window.top.location.href=pageData.url})},_editPageClickHandler:function(pageData,e){this._enterEditMode(pageData)},_enterEditMode:function(pageData){var handler=this;setTimeout(function(){dnn.dnnPageThumbnails.init("#templates-panel"),dnn.dnnPageThumbnails.removeThumbnailLoader(),handler._getService().get("EditModeForPage",{id:pageData.id},function(){handler.utility.closePersonaBar(function(){window.top.location.href=pageData.url})})},100)},_settingsPageClickHandler:function(pageData,e){this.callPageSettings&&this.callPageSettings("edit",[pageData.id,0])},_deletePageClickHandler:function(pageData,e){var handler,viewModel,confirmText,deleteText,cancelText;handler=this,viewModel=this._getViewModel(),confirmText=this.resx.pages_DeleteTemplateConfirm,confirmText=confirmText.replace("[NAME]",pageData.name),deleteText=this.resx.pages_Delete,cancelText=this.resx.pages_Cancel,this.utility.confirm(confirmText,deleteText,cancelText,function(){handler._getService().get("DeletePage",{pageId:pageData.id},function(){if(pageData.id==config.tabId)return void(window.top.location.href=config.siteRoot);var position,level,parentId;if(position=handler._findDataPosition(pageData.id),level=position.level,viewModel.pagesList.remove(function(data){return data.level>level}),handler._updatePageData(pageData.id,null),viewModel.deletedPagesCount(viewModel.deletedPagesCount()+1),parentId=viewModel.pagesList()[level].parentId,viewModel.selectedPage(parentId>-1?handler._findPageData(parentId):handler._getEmptyPageData()),parentId>-1){var parentPosition=handler._findDataPosition(parentId),cloneData=handler._clonePageData(handler._findPageData(parentId));cloneData.childCount-=1,viewModel.pagesList()[parentPosition.level].pages.splice(parentPosition.index,1,cloneData)}window.top.location.pathname.substr(window.top.location.pathname.lastIndexOf("/")+1)==pageData.url.substr(pageData.url.lastIndexOf("/")+1)?$(".btn_showsite").data("need-homeredirect",!0):$(".btn_showsite").data("need-refresh",!0),onDeleteCallback(pageData),setTimeout(function(){handler._initScrollView(!0)},0)},function(data){data&&data.responseJSON&&data.responseJSON.Message?handler.utility.notifyError(data.responseJSON.Message):handler.utility.notifyError("Failed...")})})},_toggleViewClickHandler:function(data,e){data.inDrag($(e.target).hasClass("view-drag"))},_mouseOverThumbnailHandler:function(pageData,e){var handler=this;this._showPreviewTimeoutHandler&&clearTimeout(this._showPreviewTimeoutHandler),this._showPreviewTimeoutHandler=setTimeout(function(){handler._showPreview(pageData,e.target)},this.options.delayTime)},_mouseOutThumbnailHandler:function(){this._showPreviewTimeoutHandler&&clearTimeout(this._showPreviewTimeoutHandler);var handler=this;setTimeout(function(){handler._hidePreview()},0)},_searchKeywordsChangedHandler:function(e){var handler=this;return this._doSearchTimeoutHandler&&clearTimeout(this._doSearchTimeoutHandler),this._doSearchTimeoutHandler=setTimeout(function(){handler._searchPage()},this.options.delayTime),!0},_searchPage:function(){var viewModel=this._getViewModel();return this.hasPendingChanges()?(viewModel.searchKeyword(""),this.handlePendingChanges()):(viewModel.selectedPage(this._getEmptyPageData()),void this._loadPageTemplates())},_toggleViewChanged:function(inDrag){var handler=this;this._removeListScrollView(),this.container.find(".pages-list-container").width(2e4),setTimeout(function(){handler._initScrollView(!0)},120)},_selectedPageChanged:function(newPage){var $listItem;$listItem=$('li[data-page-id="'+newPage.id+'"]'),ko.dataFor($listItem[0]),this._computeSelectedPagePath()},_selectPageInHierarchy:function(){var pageId,find,pageData;1==this._selectPageInHierarchyPath.length?this.selectPage(this._selectPageInHierarchyPath[0],!0):(pageId=this._selectPageInHierarchyPath[0],this._selectPageInHierarchyPath.splice(0,1),find=this._findDataPosition(pageId),find&&(pageData=this._getViewModel().pagesList()[find.level].pages()[find.index],this._getViewModel().selectedPage(this._clonePageData(pageData))))},_showPreview:function(pageData,element){var handler=this;this._previewContainer||(this._previewContainer=$('<div class="pages-preview"><img src="" /></div>'),this._previewContainer.mouseenter(function(){handler._mouseOnPreview=!0}).mouseleave(function(e){handler._mouseOnPreview=!1,handler._hidePreview()}),$(document.body).append(this._previewContainer)),this._previewContainer.find("img").attr("src",pageData.largeThumbnail),this._calcPreviewPosition(element),this._previewContainer.show("fast")},_hidePreview:function(){this._previewContainer&&!this._mouseOnPreview&&this._previewContainer.hide("fast")},_calcPreviewPosition:function(element){var pos,$element,previewHeight,elementWidth,elementHeight,windowHeight,offset;pos={},$element=$(element),previewHeight=this._previewContainer.outerHeight(),elementWidth=$element.width(),elementHeight=$element.height(),windowHeight=$(window).height(),offset=$element.offset(),pos.left=offset.left+elementWidth-25,pos.top=offset.top-previewHeight/2+elementHeight/2,pos.top<0?(this._previewContainer.removeClass("bottom").addClass("top"),pos.top=$element.offset().top):pos.top+previewHeight>windowHeight?(this._previewContainer.removeClass("top").addClass("bottom"),pos.top=offset.top-previewHeight+elementHeight):this._previewContainer.removeClass("top bottom"),this._previewContainer.css({left:pos.left,top:pos.top})},_updatePageData:function(id,newData){var find,pages;find=this._findDataPosition(id),null!==find&&(pages=this._getViewModel().pagesList()[find.level].pages,newData?pages.splice(find.index,1,newData):pages.splice(find.index,1))},_findDataPosition:function(pageId){var viewModel,i,j,pagesList,listData;for(viewModel=this._getViewModel(),i=0;i<viewModel.pagesList().length;i++)for(pagesList=viewModel.pagesList()[i].pages,listData=pagesList(),j=0;j<listData.length;j++)if(listData[j].id==pageId)return{level:i,index:j,parentId:listData[j].parentId,childCount:listData[j].childCount};return null},_findPageData:function(pageId){var viewModel,position;return viewModel=this._getViewModel(),position=this._findDataPosition(pageId),null!==position?viewModel.pagesList()[position.level].pages()[position.index]:null},_getEmptyPageData:function(){return{id:0,parentId:0,name:"",thumbnail:"",largeThumbnail:"",childCount:0,isspecial:!1,publishDate:""}},_clonePageData:function(data){return{id:data.id,parentId:data.parentId,name:data.name,thumbnail:data.thumbnail,childCount:data.childCount,isspecial:data.isspecial,publishDate:data.publishDate,pages:data.pages,timestamp:(new Date).getTime()}},_scrollToSelectedPage:function(){var selectedPage,$listItem,$pagesList,containerScroller;if(selectedPage=this._getViewModel().selectedPage(),selectedPage.id>0){if($(this.container.selector).find(".item-can-be-parent-list").length>0)return;$listItem=this.container.find('li[data-page-id="'+selectedPage.id+'"]'),$pagesList=$listItem.parents(".pages-list"),containerScroller=this.container.find(".pages-list-scroller"),$pagesList.hasClass("jspScrollable")&&$pagesList.data("jsp")&&$pagesList.data("jsp").scrollToElement($listItem[0],!0,!0),containerScroller.hasClass("jspScrollable")&&containerScroller.data("jsp")&&containerScroller.data("jsp").scrollToElement($pagesList[0],!0,!0)}},_pageExist:function(parentId){var pagesList,i;for(pagesList=this._getViewModel().pagesList(),i=0;i<pagesList.length;i++)if(pagesList[i].parentId==parentId)return!0;return!1},_resizeContentContainer:function(resetContainer){var panel,headerHeight,marginTop,restHeight;panel=this.panel,headerHeight=this.container.parent().prev().outerHeight(),marginTop=parseInt(this.container.parent().css("margin-top")),restHeight=(marginTop>headerHeight?marginTop:headerHeight)+parseInt(this.container.css("margin-top"))+panel.find("div.title-container").outerHeight()+parseInt(this.container.css("margin-bottom"))+this.container.next().outerHeight(),this.container.css("height",$(window).height()-restHeight),this._initScrollView(resetContainer)},_initScrollView:function(resetContainer,callback){var handler,inDrag,$pagesList,bottomSpace,scrollContainer,totalWidth;return handler=this,inDrag=this._getViewModel().inDrag(),this._supressUI?void("function"==typeof callback&&callback.call(this)):($pagesList=this.container.find(".pages-list-container div.pages-list"),bottomSpace=30,$pagesList.css("height",this.container.height()-bottomSpace).each(function(){var scrollContent=$(this);scrollContent.removeClass("animate");var padding=parseInt(scrollContent.css("padding-top"))+parseInt(scrollContent.css("padding-bottom"));0==padding&&(padding=parseInt(scrollContent.find(".jspPane").css("padding-top"))+parseInt(scrollContent.find(".jspPane").css("padding-bottom"))),scrollContent.find("ul:first").css({"min-height":scrollContent.innerHeight()-padding+"px"}),scrollContent.data("jsp")?scrollContent.data("jsp").reinitialise():scrollContent.jScrollPane({contentWidth:scrollContent.width()})}),scrollContainer=this.container.find(".pages-list-scroller"),resetContainer&&(totalWidth=0,$pagesList.each(function(){var self=$(this);return"none"===self.css("display")||void(totalWidth+=self.outerWidth()+parseInt(self.css("margin-left")))}),this.container.find(".pages-list-container").width(totalWidth),scrollContainer.data("jsp")&&(scrollContainer.data("jsp").destroy(),scrollContainer=this.container.find(".pages-list-scroller")),scrollContainer.css("height",handler.container.height()),scrollContainer.find("> .jspContainer .shadow").height($pagesList.outerHeight(!0)),scrollContainer.find(" li").length>1&&scrollContainer.jScrollPane().on("jsp-scroll-x",function(e,offset,isLeft){var $this=$(this);if(isLeft)$this.find("> .jspContainer .shadow").remove();else if(0==$this.find("> .jspContainer .shadow").length){var $shadow=$('<div class="shadow" />');$this.find("> .jspContainer").append($shadow),$shadow.height($pagesList.outerHeight(!0))}}),handler.container.find(".pages-list-scroller > .jspContainer").css("height",handler.container.height()),handler._scrollToSelectedPage(),"function"==typeof callback&&callback.call(this)),void setTimeout(function(){$pagesList.addClass("animate")},100))},_removeListScrollView:function(){this.container.find(".pages-list-container div.pages-list").each(function(){var scrollContent=$(this);scrollContent.data("jsp")&&scrollContent.data("jsp").destroy()}),this.container.find(".pages-list-container div.pages-list").addClass("animate")},_initDrag:function(){var handler,viewModel,lists,droppables;handler=this,viewModel=this._getViewModel(),lists=this.container.find(".pages-list ul"),droppables=$(".pagehierarchy-container .pages-list ul li"),droppables.droppable({hoverClass:"item-can-be-parent-list",over:function(){var self=$(this);setTimeout(function(){self.hasClass("item-can-be-parent-list")&&self.trigger("click")},OVER_TIME_TO_OPEN_PAGE_CHILDS)},drop:function(event,ui){function updateHirerarchy(){var sourcePageId,sourceIndex,sourceFind,targetId,targetFind;pageDropped={item:$(ui.draggable[0]),helper:$(ui.helper[0])},sourcePageId=item.data("page-id"),sourceUl=item.parent(),sourceFind=handler._findDataPosition(sourcePageId),source=viewModel.pagesList()[sourceFind.level].pages()[sourceFind.index],sourceData=handler._clonePageData(source),targetId=self.data("page-id"),targetId!==sourceFind.parentId&&(targetFind=handler._findDataPosition(targetId),target=viewModel.pagesList()[targetFind.level].pages()[targetFind.index],setTimeout(function(){var allowDrop;return(allowDrop=handler._allowDrop(sourcePageId,targetFind.level))?(sourceUl.sortable("cancel"),viewModel.pagesList()[sourceFind.level].pages.splice(sourceFind.index,1),ko.cleanNode(item[0]),item.remove(),params={pageId:sourcePageId,parentId:targetId,action:"parent",relatedPageId:-1},movePage200Callback=function(data){var targetData,index,sourceParentFind,sourceParentData;return data.Status>0?(handler.utility.notifyError(handler.resx["pagesettings_Errors_"+data.Message]),viewModel.pagesList()[sourceFind.level].pages.splice(sourceFind.index,0,sourceData),draggingJqObj=null,uiOnDragStart=null,void(dropOnDroppable=!1)):(sourceData.url=data.Page.url,sourceData.parentId=data.Page.parentId,index=sourceFind.level===targetFind.level&&sourceFind.index<targetFind.index?targetFind.index-1:targetFind.index,targetData=handler._clonePageData(viewModel.pagesList()[targetFind.level].pages()[index]),targetData.childCount+=1,viewModel.pagesList()[targetFind.level].pages.splice(index,1,targetData),sourceFind.parentId!=-1&&(sourceParentFind=handler._findDataPosition(sourceFind.parentId),sourceParentData=handler._clonePageData(viewModel.pagesList()[sourceParentFind.level].pages()[sourceParentFind.index]),sourceParentData.childCount-=1,viewModel.pagesList()[sourceParentFind.level].pages.splice(sourceParentFind.index,1,sourceParentData)),self.hasClass("selected")&&void 0!==viewModel.pagesList()[data.Page.level]&&viewModel.pagesList()[data.Page.level].pages.push(sourceData),$(".btn_showsite").data("need-refresh",!0),draggingJqObj=null,uiOnDragStart=null,setTimeout(function(){handler._initDrag()},0),viewModel.dragPage(handler._getEmptyPageData()),viewModel.isNew()&&(viewModel.isNew(!1),handler._enterEditMode(data.Page)),void(dropOnDroppable=!1))},movePageErrorCallback=function(data){handler.utility.notifyError("Unknown error"),draggingJqObj=null,uiOnDragStart=null,viewModel.pagesList()[sourceFind.level].pages.splice(sourceIndex,0,sourceData),dropOnDroppable=!1},void handler._getService().get("MovePage",params,movePage200Callback,movePageErrorCallback)):(handler.utility.notifyError(handler.resx.pages_DragInvalid),sourceUl.sortable("cancel"),viewModel.pagesList()[sourceFind.level].pages.splice(sourceFind.index,1,sourceData),ko.cleanNode(item[0]),void item.remove())},0))}var self,item;return $(event.target).hasClass("page-drag-target")?void(dropOnDroppable=!1):(dropOnDroppable=!0,void(uiOnDragStart&&(self=$(this),self.hasClass("page-drag-target")||(item=jQuery.extend({},uiOnDragStart.item),uiOnDragStart=null,updateHirerarchy()))))}}),lists.each(function(){var $self=$(this);return $self.sortable({connectWith:".pagehierarchy-container .pages-list ul",dropOnEmpty:!0,cursor:"",cursorAt:{left:110,top:10},handle:"span.drag-area",placeholder:"page-drag-target",tolerance:"intersect",revert:!1,helper:function(event,ui){var $dragItem,data;return $dragItem=$('<div class="page-drag-helper"></div>').append('<span class="icon" />').append(ui.find("span.field-name").html()).appendTo(handler.container),data=ko.dataFor(ui[0]),data&&data.childCount>0&&$dragItem.addClass("page-drag-multiple"),$dragItem},start:function(event,ui){uiOnDragStart={item:$(ui.item)},draggingJqObj=$(ui.item[0]),handler.container.find("div.pages-drag-container").hide()},beforeStop:function(event,ui){dropOnDroppable&&($(this).sortable("cancel"),dropOnDroppable=!1)},receive:function(event,ui){},over:function(event,ui){},sort:function(event,ui){ui.placeholder.html(ui.helper.html())},stop:function(event,ui){var item,sourceParentFind,isDragItem,$pageList,level,parentId,pageId,index,find,movePageData,allowDrop,pageItem,moveAction,relatedPageId,params;if(uiOnDragStart&&(item=jQuery.extend({},uiOnDragStart.item),uiOnDragStart=null,draggingJqObj=null,$(".pages-list.removeMe").each(function(){ko.cleanNode(this),$(this).remove()}),isDragItem=ui.item.find("> div").hasClass("drag-item"),$pageList=ui.item.parents(".pages-list:eq(0)"),level=$pageList.data("page-level"),parentId=$pageList.data("parent-id"),pageId=ui.item.data("page-id"),index=ui.item.parent().find("> li").index(ui.item),find=handler._findDataPosition(pageId),isDragItem||!find||find.level!=level||find.index!=index)){if(movePageData=viewModel.pagesList()[find.level].pages()[find.index],allowDrop=handler._allowDrop(pageId,level),!allowDrop)return handler.utility.notifyError(handler.resx.pages_DragInvalid),$self.sortable("cancel"),viewModel.pagesList()[find.level].pages.splice(find.index,1,handler._clonePageData(movePageData)),ko.cleanNode(ui.item[0]),void ui.item.remove();if(moveAction="after",relatedPageId=-1,0===ui.item.prev().length&&0===ui.item.next().length){if(isDragItem&&void 0===parentId)return ui.item.remove(),viewModel.inDrag(!1),pageItem=$('li[data-page-id="'+pageId+'"] > div'),pageItem.show(),handler._needScrollToSelectedPage=!0,viewModel.selectedPage(movePageData),void viewModel.dragPage(handler._getEmptyPageData());moveAction="parent"}else 0===ui.item.prev().length?(moveAction="before",relatedPageId=ui.item.next().length>0?ui.item.next().data("page-id"):relatedPageId):relatedPageId=ui.item.prev().data("page-id");params={pageId:pageId,parentId:parentId,action:moveAction,relatedPageId:relatedPageId},handler._getService().get("MovePage",params,function(data){var pageData,sourceParentFindB,targetId,targetFind,targetFindB;return data.Status>0?(handler.utility.notifyError(handler.resx["pagesettings_Errors_"+data.Message]),$self.sortable("cancel"),viewModel.pagesList()[find.level].pages.splice(find.index,1,handler._clonePageData(movePageData)),ko.cleanNode(ui.item[0]),void ui.item.remove()):(targetId=data.Page.parentId,pageData=ko.dataFor(ui.item[0]),pageData.url=data.Page.url,pageData.parentId=data.Page.parentId,sourceParentFind=handler._findDataPosition(find.parentId),targetFind=handler._findDataPosition(targetId),handler._updatePagePosition(pageData,level,index),targetFindB=handler._findDataPosition(targetId),sourceParentFindB=handler._findDataPosition(find.parentId),find.parentId!=-1&&sourceParentFind.childCount===sourceParentFindB.childCount&&(sourceParentData=handler._clonePageData(viewModel.pagesList()[sourceParentFind.level].pages()[sourceParentFind.index]),sourceParentData.childCount-=1,viewModel.pagesList()[sourceParentFind.level].pages.splice(sourceParentFind.index,1,sourceParentData)),targetFind&&targetFind.childCount===targetFindB.childCount&&(sourceParentData=handler._clonePageData(viewModel.pagesList()[targetFind.level].pages()[targetFind.index]),sourceParentData.childCount+=1,viewModel.pagesList()[targetFind.level].pages.splice(targetFind.index,1,sourceParentData)),isDragItem&&(viewModel.inDrag(!1),handler._needScrollToSelectedPage=!0,viewModel.selectedPage(pageData),viewModel.dragPage(handler._getEmptyPageData()),pageData.isCopy&&handler._enterEditMode(pageData)),$(".btn_showsite").data("need-refresh",!0),ko.cleanNode(ui.item[0]),ui.item.remove(),setTimeout(function(){handler._initDrag()},0),void(viewModel.isNew()&&(viewModel.isNew(!1),handler._enterEditMode(pageData))))})}}}),draggingJqObj&&setTimeout(function(){$(".pages-list ul").each(function(){$(this).sortable("refresh")})},0),!0})},_allowDrop:function(pageId,level){if(0===level)return!0;var $pagesList=this.container.find(".pages-list-container .pages-list"),$currentList=this.container.find('.pages-list-container .pages-list[data-parent-id="'+pageId+'"]');return 0===$currentList.length||$pagesList.index($currentList)>level},_updatePagePosition:function(page,level,index){var viewModel,pagesList,originalPosition,originalLevel,parentId,addOffset,find,pageData;viewModel=this._getViewModel(),pagesList=viewModel.pagesList(),originalPosition=this._findDataPosition(page.id),originalPosition&&(originalLevel=originalPosition.level,pagesList[originalLevel].pages.splice(originalPosition.index,1),pagesList[level].pages.splice(index,0,page),parentId=-1,addOffset=0,level>originalLevel?(parentId=pagesList[level].parentId,addOffset=1):level<originalLevel&&(parentId=pagesList[originalLevel].parentId,addOffset=-1),parentId>0&&(find=this._findDataPosition(parentId),find&&(pageData=this._clonePageData(pagesList[find.level].pages()[find.index]),pageData.childCount+=addOffset,pagesList[find.level].pages.splice(find.index,1,pageData),viewModel.selectedPage().id==pageData.id&&viewModel.selectedPage(pageData))),originalLevel!=level&&viewModel.selectedPage().id==page.id&&(viewModel.pagesList.remove(function(data){return data.level>=originalLevel}),viewModel.selectedPage(page)),this._initScrollView())},_computeSelectedPagePath:function(){var selectedPage,selectedPagePath,find,i,parentId,$pageItem,pageData;if(selectedPage=this._getViewModel().selectedPage(),selectedPagePath=this._getViewModel().selectedPagePath,selectedPagePath.removeAll(),selectedPage.id&&(selectedPagePath.push(selectedPage),find=this._findDataPosition(selectedPage.id)))for(i=find.level;i>0;i--)return parentId=this.container.find('.pages-list[data-page-level="'+i+'"]').data("parent-id"),$pageItem=this.container.find('li[data-page-id="'+parentId+'"]'),pageData=ko.dataFor($pageItem[0]),void selectedPagePath.splice(0,0,pageData)},_getViewModel:function(){var handler=this;return"undefined"==typeof this._viewModel.pagesList&&(this._viewModel.pagesList=ko.observableArray([]),this._viewModel.resx=handler.resx,this._viewModel.selectedPage=ko.observable(handler._getEmptyPageData()),this._viewModel.dragPage=ko.observable({id:0,name:"",thumbnail:"",status:"",publishDate:"",childCount:0}),this._viewModel.inDrag=ko.observable(!1),this._viewModel.isNew=ko.observable(!1),this._viewModel.selectedPagePath=ko.observableArray([]),this._viewModel.searchKeyword=ko.observable(""),this._viewModel.searchFocus=ko.observable(!0),this._viewModel.deletedPagesCount=ko.observable(0),this._viewModel.selectedPage.subscribe($.proxy(this._selectedPageChanged,this)),this._viewModel.inDrag.subscribe($.proxy(this._toggleViewChanged,this)),this._viewModel.pageItemClick=$.proxy(this._pageItemClickHandler,this),this._viewModel.viewPageClick=$.proxy(this._viewPageClickHandler,this),this._viewModel.editPageClick=$.proxy(this._editPageClickHandler,this),this._viewModel.settingsPageClick=$.proxy(this._settingsPageClickHandler,this),this._viewModel.deletePageClick=$.proxy(this._deletePageClickHandler,this),this._viewModel.doSelectPage=$.proxy(this._selectPage,this),this._viewModel.searchKeyDown=$.proxy(this._searchKeywordsChangedHandler,this),this._viewModel.searchKeyUp=$.proxy(this._searchKeywordsChangedHandler,this),this._viewModel.doSearch=$.proxy(this._searchPage,this),this._viewModel.mouseOverThumbnail=$.proxy(this._mouseOverThumbnailHandler,this),this._viewModel.mouseOutThumbnail=$.proxy(this._mouseOutThumbnailHandler,this),this._viewModel.toggleView=$.proxy(this._toggleViewClickHandler,this)),this._viewModel},_getService:function(){return this.utility.sf.moduleRoot="EvoqContentLibrary",this.utility.sf.controller="PageManagement",this.utility.sf}},pageHierarchyDefaultOptions={delayTime:500,requestDelayTime:2e3,requestTimeout:4e3,defaultThumbnail:"fallback-thumbnail.png"},dnn.dnnTemplatesHierarchy||(dnn.dnnTemplatesHierarchy=new templatesHierarchyManager),dnn.dnnTemplatesHierarchy});