define(["jquery","knockout","text!templatePath/recycleBin.html","../scripts/koBindingHandlers/toggle","../scripts/koBindingHandlers/jScrollPane","../scripts/koBindingHandlers/tabs","../scripts/koBindingHandlers/setWhenHover","../scripts/koBindingHandlers/setWidthFromParentScrollPaneWhen"],function($,ko,template){var DnnPageRecycleBin,ModuleInfo=function(requestData){var self=this;self.Id=requestData.Id,self.TabModuleId=requestData.TabModuleId,self.Title=requestData.Title,self.PortalId=requestData.PortalId,self.TabName=requestData.TabName,self.TabID=requestData.TabID,self.TabDeleted=requestData.TabDeleted,self.LastModifiedOnDate=requestData.LastModifiedOnDate,self.friendlyLastModifiedOnDate=requestData.friendlyLastModifiedOnDate,self.selected=ko.observable(!1),self.mouseOver=ko.observable(!1)},PageOrTemplateInfo=function(requestData){var calculateDepthOfNode,calculateNumberOfAllChildrenTree,selectAllChildren,isItsRootElementEven,setOddEvenInChildren,hasUnselectedChildren,PAGES_TREE_LEFT_PADDING=50,self=this;calculateDepthOfNode=function(node){return node.parent?self.depth(1+calculateDepthOfNode(node.parent)):self.depth(0),self.depth()},calculateNumberOfAllChildrenTree=function(children){var numberOfNestedChildren=0;return children&&0!==children.length?(children.forEach(function(child){numberOfNestedChildren+=calculateNumberOfAllChildrenTree(child.children())}),children.length+numberOfNestedChildren):0},hasUnselectedChildren=function(children){for(var i=0;i<children.length;i++){var child=children[i];if(!child.selected())return!0;if(hasUnselectedChildren(child.children()))return!0}return!1},selectAllChildren=function(children,newValue){self.children&&children().forEach(function(child){child.selected(newValue)})},setOddEvenInChildren=function(children,newValue){self.children&&children().forEach(function(child){child.even(newValue)})},isItsRootElementEven=function(node){return node.parent?isItsRootElementEven(node.parent):node.even()},self.id=requestData.id,self.name=requestData.name,self.childCount=requestData.childCount,self.thumbnail=requestData.thumbnail,self.largeThumbnail=requestData.largeThumbnail,self.url=requestData.url,self.publishDate=requestData.publishDate,self.status=requestData.status,self.parentId=requestData.parentId,self.level=requestData.level,self.tabpath=requestData.tabpath,self.isspecial=requestData.isspecial,self.useDefaultSkin=requestData.useDefaultSkin,self.lastModifiedOnDate=requestData.lastModifiedOnDate,self.friendlyLastModifiedOnDate=requestData.friendlyLastModifiedOnDate,self.thumbnailVisible=ko.observable(!1),self.thumbnailTop=ko.observable("0px"),self.thumbnailLeft=ko.observable("0px"),self.even=ko.observable(!1),self.even.extend({notify:"always"}),self.selected=ko.observable(!1),self.selected.extend({notify:"always"}),self.mouseOver=ko.observable(!1),self.depth=ko.observable(0),self.parent=null,self.children=ko.observableArray([]),self.numberOfNestedChildren=ko.computed(function(){return 1+calculateNumberOfAllChildrenTree(self.children())}),self.cellWidth=ko.computed(function(){var separatorWidth=19,thumbnailIconPadding=10,thumbnailUsedWidth=24,labelWidth=160;return self.numberOfNestedChildren()*(separatorWidth+thumbnailIconPadding+thumbnailUsedWidth)+labelWidth}),self.totalHeight=ko.computed(function(){var childrenWithEdge,childrenHeight;childrenWithEdge=[];for(var i=0;i<self.children().length-1;i++)childrenWithEdge.push(self.children()[i]);return childrenHeight=calculateNumberOfAllChildrenTree(childrenWithEdge),0===childrenHeight?0:64*childrenHeight+"px"}),self.isItsRootElementEven=ko.computed(function(){return isItsRootElementEven(self)}),self.depthInPixels=ko.computed(function(){return self.depth()*PAGES_TREE_LEFT_PADDING+"px"}),self.selected.subscribe(function(newValue){selectAllChildren(self.children,newValue)}),self.even.subscribe(function(newValue){setOddEvenInChildren(self.children,newValue)}),self.thumbnailVisible.subscribe(function(newVal){if(newVal){var pageId=self.id,$preview=$('.row[data-page-id="'+pageId+'"]').find(".pages-preview");$preview.parent().is(".pageDataContainer")&&$(document.body).append($preview)}}),self.calculateDepth=function(){calculateDepthOfNode(self)},self.hasUnselectedChildren=function(){return hasUnselectedChildren(self.children())}};return DnnPageRecycleBin=function(){"use strict";function DnnPageRecycleBin(resx,serviceController,utility,options){_resx=resx,_serviceController=serviceController,_utility=utility,_options=options}var _options,_resx,_serviceController,_utility,_viewModel,getSelectedElements,markAllElementsAs,markAllModulesAsIfPossible,getTreesOfPages,setOddEvenOrderInRoots,calculateDepthOfPages,changeElementSelectedStatus,restoreSelectedPagesHandler,removeSelectedPagesHandler,pageRestoreRevomeOperationsCallback,canBeDeleted,restoreSelectedModulesHandler,removeSelectedModulesHandler,restoreSelectedTemplatesHandler,removeSelectedTemplatesHandler,restorePageHandler,removePageHandler,restoreModuleHandler,removeModuleHandler,restoreTemplateHandler,removeTemplateHandler,emptyRecycleBinHandler,getDeletedPageList,getDeletedModuleList,getDeletedTemplateList,showPreview,hidePreview,getService,getViewModel,tabActivated,RECYCLE_BIN_DEFAULT_OPTIONS={},IMAGE_THUMBNAIL_HEIGTH=480,RECYCLE_PANEL_ID="#recycleBin-panel";return DnnPageRecycleBin.class="DnnPageRecycleBin",DnnPageRecycleBin.type="Class",changeElementSelectedStatus=function(page){page.selected(!page.selected())},getSelectedElements=function(collection){var selectedElements=[];return collection?(collection.forEach(function(element){element.selected()&&selectedElements.push(element),element.children&&(selectedElements=selectedElements.concat(getSelectedElements(element.children())))}),selectedElements):selectedElements},markAllElementsAs=function(collection,value){collection&&collection.forEach(function(element){element.selected(value)})},markAllModulesAsIfPossible=function(modules,newValue){modules&&modules.forEach(function(module){module.TabDeleted||module.selected(newValue)})},restoreSelectedPagesHandler=function(){var pagesList,viewModel;if(viewModel=getViewModel(),pagesList=getSelectedElements(viewModel.deletedpagesList()),pagesList.length>0){var confirmText,yesText,noText;confirmText=pagesList.length>1?_resx.recyclebin_RestorePagesConfirm:_resx.recyclebin_RestorePageConfirm,yesText=_resx.recyclebin_YesConfirm,noText=_resx.recyclebin_NoConfirm,_utility.confirm(confirmText,yesText,noText,function(){getService().post("RestorePage",pagesList,pageRestoreRevomeOperationsCallback)})}},canBeDeleted=function(selectedPages){var result={};return result.value=!0,result.errors="",selectedPages.forEach(function(page){page.hasUnselectedChildren()&&(result.value=!1,result.errors+=_resx.Service_RemoveTabError.replace(/\{0\}/g,page.name))}),result},removeSelectedPagesHandler=function(){var pagesList,viewModel;if(viewModel=getViewModel(),pagesList=getSelectedElements(viewModel.deletedpagesList()),pagesList.length>0){var confirmText,yesText,noText;confirmText=pagesList.length>1?_resx.recyclebin_RemovePagesConfirm:_resx.recyclebin_RemovePageConfirm,yesText=_resx.recyclebin_YesConfirm,noText=_resx.recyclebin_NoConfirm,_utility.confirm(confirmText,yesText,noText,function(){var result=canBeDeleted(pagesList);return result.value?void getService().post("RemovePage",pagesList,pageRestoreRevomeOperationsCallback):void _utility.notify(_resx.Service_RemoveTabErrorHeader+result.errors)})}},restoreSelectedModulesHandler=function(){var viewModel,modulesList;if(viewModel=getViewModel(),modulesList=getSelectedElements(viewModel.deletedmodulesList()),modulesList.length>0){var confirmText,yesText,noText;confirmText=modulesList.length>1?_resx.recyclebin_RestoreModulesConfirm:_resx.recyclebin_RestoreModuleConfirm,yesText=_resx.recyclebin_YesConfirm,noText=_resx.recyclebin_NoConfirm,_utility.confirm(confirmText,yesText,noText,function(){getService().post("RestoreModule",modulesList,function(){for(var i=0;i<modulesList.length;i++)viewModel.deletedmodulesList.remove(modulesList[i]);viewModel.selectAllModules(!1)})})}},removeSelectedModulesHandler=function(){var viewModel,modulesList;if(viewModel=getViewModel(),modulesList=getSelectedElements(viewModel.deletedmodulesList()),modulesList.length>0){var confirmText,yesText,noText;confirmText=modulesList.length>1?_resx.recyclebin_RemoveModulesConfirm:_resx.recyclebin_RemoveModuleConfirm,yesText=_resx.recyclebin_YesConfirm,noText=_resx.recyclebin_NoConfirm,_utility.confirm(confirmText,yesText,noText,function(){getService().post("RemoveModule",modulesList,function(){for(var i=0;i<modulesList.length;i++)viewModel.deletedmodulesList.remove(modulesList[i]);viewModel.selectAllModules(!1)})})}},restoreSelectedTemplatesHandler=function(){var templatesList,viewModel;if(viewModel=getViewModel(),templatesList=getSelectedElements(viewModel.deletedtemplatesList()),templatesList.length>0){var confirmText,yesText,noText;confirmText=templatesList.length>1?_resx.recyclebin_RestoreTemplatesConfirm:_resx.recyclebin_RestoreTemplateConfirm,yesText=_resx.recyclebin_YesConfirm,noText=_resx.recyclebin_NoConfirm,_utility.confirm(confirmText,yesText,noText,function(){getService().post("RestorePage",templatesList,function(){for(var i=0;i<templatesList.length;i++)viewModel.deletedtemplatesList.remove(templatesList[i])})})}},removeSelectedTemplatesHandler=function(){var templatesList,viewModel;if(viewModel=getViewModel(),templatesList=getSelectedElements(viewModel.deletedtemplatesList()),templatesList.length>0){var confirmText,yesText,noText;confirmText=templatesList.length>1?_resx.recyclebin_RemoveTemplatesConfirm:_resx.recyclebin_RemoveTemplateConfirm,yesText=_resx.recyclebin_YesConfirm,noText=_resx.recyclebin_NoConfirm,_utility.confirm(confirmText,yesText,noText,function(){getService().post("RemovePage",templatesList,function(){for(var i=0;i<templatesList.length;i++)viewModel.deletedtemplatesList.remove(templatesList[i])})})}},pageRestoreRevomeOperationsCallback=function(data){data.Status>0&&_utility.notify(data.Message),getDeletedPageList(),$(".btn_showsite").data("need-refresh",!0)},restorePageHandler=function(pageData){var viewModel,confirmText,yesText,noText;viewModel=getViewModel(),confirmText=_resx.recyclebin_RestorePageConfirm,yesText=_resx.recyclebin_YesConfirm,noText=_resx.recyclebin_NoConfirm,_utility.confirm(confirmText,yesText,noText,function(){var pagesList=[];pagesList.push({id:pageData.id}),getService().post("RestorePage",pagesList,pageRestoreRevomeOperationsCallback)})},removePageHandler=function(pageData){var viewModel,confirmText,yesText,noText;viewModel=getViewModel(),confirmText=_resx.recyclebin_RemovePageConfirm,yesText=_resx.recyclebin_YesConfirm,noText=_resx.recyclebin_NoConfirm,_utility.confirm(confirmText,yesText,noText,function(){if(pageData.children().length>0)return void _utility.notify(_resx.Service_RemoveTabError.replace(/\{0\}/g,pageData.name));var pagesList=[];pagesList.push({id:pageData.id}),getService().post("RemovePage",pagesList,pageRestoreRevomeOperationsCallback)})},restoreModuleHandler=function(moduleData,e){var viewModel,confirmText,yesText,noText;viewModel=getViewModel(),confirmText=_resx.recyclebin_RestoreModuleConfirm,yesText=_resx.recyclebin_YesConfirm,noText=_resx.recyclebin_NoConfirm,_utility.confirm(confirmText,yesText,noText,function(){var moduleList=[];moduleList.push({Id:moduleData.Id,TabModuleId:moduleData.TabModuleId,TabID:moduleData.TabID}),getService().post("RestoreModule",moduleList,function(){viewModel.deletedmodulesList.remove(moduleData)})})},removeModuleHandler=function(moduleData,e){var viewModel,confirmText,yesText,noText;viewModel=getViewModel(),confirmText=_resx.recyclebin_RemoveModuleConfirm,yesText=_resx.recyclebin_YesConfirm,noText=_resx.recyclebin_NoConfirm,_utility.confirm(confirmText,yesText,noText,function(){var moduleList=[];moduleList.push({Id:moduleData.Id,TabModuleId:moduleData.TabModuleId,TabID:moduleData.TabID}),getService().post("RemoveModule",moduleList,function(){viewModel.deletedmodulesList.remove(moduleData)})})},restoreTemplateHandler=function(templateData,e){var viewModel,confirmText,yesText,noText;viewModel=getViewModel(),confirmText=_resx.recyclebin_RestoreTemplateConfirm,yesText=_resx.recyclebin_YesConfirm,noText=_resx.recyclebin_NoConfirm,_utility.confirm(confirmText,yesText,noText,function(){var templateList=[];templateList.push({id:templateData.id}),getService().post("RestorePage",templateList,function(){viewModel.deletedtemplatesList.remove(templateData)})})},removeTemplateHandler=function(templateData,e){var viewModel,confirmText,yesText,noText;viewModel=getViewModel(),confirmText=_resx.recyclebin_RemoveTemplateConfirm,yesText=_resx.recyclebin_YesConfirm,noText=_resx.recyclebin_NoConfirm,_utility.confirm(confirmText,yesText,noText,function(){var templateList=[];templateList.push({id:templateData.id}),getService().post("RemovePage",templateList,function(){viewModel.deletedtemplatesList.remove(templateData)})})},emptyRecycleBinHandler=function(){var viewModel=getViewModel(),confirmText=_resx.recyclebin_EmptyRecycleBinConfirm,deleteText=_resx.recyclebin_DeleteConfirm,cancelText=_resx.recyclebin_CancelConfirm;_utility.confirm(confirmText,deleteText,cancelText,function(){getService().get("EmptyRecycleBin",{t:(new Date).getTime()},function(){viewModel.deletedpagesList.removeAll(),viewModel.deletedmodulesList.removeAll(),viewModel.deletedtemplatesList.removeAll()})})},setOddEvenOrderInRoots=function(roots){var isPreviousElementEven=!1;roots.forEach(function(root){root.even(isPreviousElementEven),isPreviousElementEven=!isPreviousElementEven})},calculateDepthOfPages=function(pages){"undefined"!=typeof pages&&pages.forEach(function(page){page.calculateDepth()})},getTreesOfPages=function(pages){var roots,idToNodeMap,parentNode;return roots=[],idToNodeMap={},pages.forEach(function(page){return idToNodeMap[page.id]=page,"undefined"==typeof page.parentId?void roots.push(page):(parentNode=idToNodeMap[page.parentId],void(parentNode?(parentNode.children.push(page),page.parent=parentNode):roots.push(page)))}),calculateDepthOfPages(pages),setOddEvenOrderInRoots(roots),roots},getDeletedPageList=function(){var listOfPages,viewModel;listOfPages=[],viewModel=getViewModel(),viewModel.deletedPagesReady(!1),viewModel.deletedpagesList.removeAll(),getService().get("GetDeletedPageList",{},function(data){for(var i=0;i<data.length;i++){var page=new PageOrTemplateInfo(data[i]);listOfPages.push(page)}viewModel.selectAllPages(!1),viewModel.deletedpagesList(getTreesOfPages(listOfPages)),viewModel.deletedPagesReady(!0)})},getDeletedModuleList=function(){var viewModel=getViewModel();viewModel.deletedModulesReady(!1),viewModel.deletedmodulesList.removeAll(),getService().get("GetDeletedModuleList",{},function(data){for(var i=0;i<data.length;i++){var module=new ModuleInfo(data[i]);viewModel.deletedmodulesList.push(module)}viewModel.deletedModulesReady(!0)})},getDeletedTemplateList=function(){var viewModel=getViewModel();viewModel.deletedTemplatesReady(!1),viewModel.deletedtemplatesList.removeAll(),getService().get("GetDeletedTemplates",{},function(data){for(var i=0;i<data.length;i++){var template=new PageOrTemplateInfo(data[i]);viewModel.deletedtemplatesList.push(template)}viewModel.selectAllTemplates(!1),viewModel.deletedTemplatesReady(!0)})},showPreview=function(page,event){var $image,offset,left,top;$image=$(event.target),offset=$image.offset(),left=offset.left+$image.width()+5,top=offset.top+$image.height()/2-IMAGE_THUMBNAIL_HEIGTH/2,page.thumbnailLeft(left+"px"),page.thumbnailTop(top+"px"),page.thumbnailVisible(!0)},hidePreview=function(page,event){page.thumbnailVisible(!1)},tabActivated=function(event,ui){var panelId=ui.newPanel.attr("id"),activeTab=0;switch(panelId){case"pages":activeTab=0;break;case"modules":activeTab=1;break;case"templates":activeTab=2;break;default:activeTab=0}getViewModel().activeTab(activeTab)},getViewModel=function(){return _viewModel||(_viewModel={resx:_resx,activeTab:ko.observable(0),deletedPagesReady:ko.observable(!1),deletedModulesReady:ko.observable(!1),deletedTemplatesReady:ko.observable(!1),deletedpagesList:ko.observableArray([]),deletedmodulesList:ko.observableArray([]),deletedtemplatesList:ko.observableArray([]),selectAllPages:ko.observable(!1),selectAllTemplates:ko.observable(!1),selectAllModules:ko.observable(!1),changeElementSelectedStatus:changeElementSelectedStatus,removePage:removePageHandler,removeModule:removeModuleHandler,removeTemplate:removeTemplateHandler,restorePage:restorePageHandler,restoreModule:restoreModuleHandler,restoreTemplate:restoreTemplateHandler,restoreSelectedPages:restoreSelectedPagesHandler,restoreSelectedModules:restoreSelectedModulesHandler,restoreSelectedTemplates:restoreSelectedTemplatesHandler,removeSelectedPages:removeSelectedPagesHandler,removeSelectedModules:removeSelectedModulesHandler,removeSelectedTemplates:removeSelectedTemplatesHandler,refreshPages:getDeletedPageList,refreshModules:getDeletedModuleList,refreshTemplates:getDeletedTemplateList,emptyRecycleBin:emptyRecycleBinHandler,showPreview:showPreview,hidePreview:hidePreview,tabActivated:tabActivated},_viewModel.selectAllPages.subscribe(function(newValue){markAllElementsAs(_viewModel.deletedpagesList(),newValue)}),_viewModel.selectAllTemplates.subscribe(function(newValue){markAllElementsAs(_viewModel.deletedtemplatesList(),newValue)}),_viewModel.selectAllModules.subscribe(function(newValue){markAllModulesAsIfPossible(_viewModel.deletedmodulesList(),newValue)})),_viewModel},getService=function(){return _utility.sf.moduleRoot="EvoqContentLibrary",_utility.sf.controller="PageManagement",_utility.sf},DnnPageRecycleBin.prototype.init=function(){var viewModel,recycleBinPanel;_options=$.extend({},RECYCLE_BIN_DEFAULT_OPTIONS,_options),recycleBinPanel=$(RECYCLE_PANEL_ID),viewModel=getViewModel(),ko.applyBindings(viewModel,recycleBinPanel[0])},DnnPageRecycleBin.prototype.show=function(){getDeletedPageList(),getDeletedModuleList(),getDeletedTemplateList()},DnnPageRecycleBin}()});