define(["jquery","knockout","../scripts/PersonaBarDialog","../scripts/content-workflows-states","knockout.validation.min","jquery-ui.min","jquery.qatooltip","dnn.jquery"],function($,ko,PersonaBarDialog,ContentWorkflowsStates){var ContentWorkflowClass;return ContentWorkflowClass=function(){"use strict";function ContentWorkflow(wrapper,utilities,params,mobile){getBrowser(),_msie=navigator.userAgent.search(/msie|\.net|firefox/i)!==-1,_scrollObj=$(_msie?"html":"body"),mobile||(mobile=!1),isMobile=mobile,htmlHeader=wrapper[HTML_HEADER_INDEX],util=utilities,_resx=util.resx.ContentPB,ko.validation.localize({required:_resx.validation_required,min:_resx.validation_min,max:_resx.validation_max,minLength:_resx.validation_minLength,maxLength:_resx.validation_maxLength,number:_resx.validation_number,digit:_resx.validation_digit}),ko.validation.init({errorMessageClass:"validationMessage "+_browser},!0),_utilConfirmBtnLbl=_resx.settings_common_yes_btn,_utilCancelBtnLbl=_resx.settings_common_no_btn,configServiceFramework(),util.sf.get("Index",{},init200Callback,initErrorCallback)}var NEW_WORKFLOW_TITLE_SELECTOR,HTML_HEADER_INDEX,NEW_WORKFLOW_HEIGHT,STATE_ROW_HEIGHT,NEW_WORKFLOW_TITLE_HEIGHT,BORDER_BOTTOM_WIDTH,NO_EDITABLE_WORKFLOW_HEIGHT,OPACITY_VISIBLE,OPACITY_INVISIBLE,EDIT_WORKFLOW_HEIGHT,INFO_DESCRIPTION_MARGIN,WORKFLOW_ANIMATION_DURATION,WORKFLOW_ANIMATION_EASING,WORKFLOW_ANIMATION_DURATION_TITLE,WORKFLOW_ANIMATION_EASING_TITLE,ERROR_HEIGHT,MOVE_UP,MOVE_DOWN,ANIMATION_PANEL_MARGIN,LAST_TAG_TO_END_DISTANCE,_browser,_koBinded,htmlHeader,configServiceFramework,configServiceFrameworkStates,util,viewModel,newWorkflowExtendedObj,viewModelExtra,isMobile,newWorkflowJqObj,newWorkflowJqObjTitle,newWorkflowJqObjAnimationPanel,_resx,_contentWorkflowsStates,_tmpEditedWorkflow,_htmlError,_utilConfirmBtnLbl,_utilCancelBtnLbl,_resourcesLoadOffset,_isGettingMoreResources,_viewModelResources,_personaBarDialog,_msie,_scrollObj,_newWorkflowTarget,getBrowser,updateWorkflowsList,showDialog,showAddState,showEditState,loadWeb,usedText,showResources,showResources200Callback,viewModelResourcesAddData,showResourcesErrorCallback,afterBindShowResourcesCallback,getResourcesLazyLoad,getResourcesLazyLoad200Callback,loadMobile,init200Callback,initErrorCallback,initViewModel,firstWorkflowClass,cleanNewForm,showNew,hideNew,toggleNew,createWorkflowErrorCallback,createWorkflow200Callback,saveNew,showEdit,hideEdit,toggleEdit,bindDescriptionHeight,unbindDescriptionHeight,editWorkflow200Callback,editWorkflowErrorCallback,saveEdited,cleanEditedTmp,cancelEdited,cancelNew,animateShowPanel,animateHidePanel,highlightLastAdded,delWorkflow200Callback,delWorkflowErrorCallback,delWorkflow,delState,delState200Callback,delStateErrorCallback,cleanBackendErrors,showBackendErrors,moveUp,moveDown,move,move200Callback,moveErrorCallback;return ContentWorkflow.class="ContentWorkflow",ContentWorkflow.type="Class",ANIMATION_PANEL_MARGIN=35,LAST_TAG_TO_END_DISTANCE=60,MOVE_UP=1,MOVE_DOWN=2,NEW_WORKFLOW_TITLE_SELECTOR=".workflowspanelbody .workflows ul li:first",HTML_HEADER_INDEX=0,NEW_WORKFLOW_HEIGHT=458,NO_EDITABLE_WORKFLOW_HEIGHT=553,EDIT_WORKFLOW_HEIGHT=633,INFO_DESCRIPTION_MARGIN=20,NEW_WORKFLOW_TITLE_HEIGHT=32,STATE_ROW_HEIGHT=31,BORDER_BOTTOM_WIDTH="4px",WORKFLOW_ANIMATION_DURATION=300,WORKFLOW_ANIMATION_DURATION_TITLE=100,ERROR_HEIGHT=13,WORKFLOW_ANIMATION_EASING="swing",WORKFLOW_ANIMATION_EASING_TITLE="linear",OPACITY_VISIBLE=1,OPACITY_INVISIBLE=0,util=null,viewModel=null,newWorkflowExtendedObj=null,viewModelExtra=null,isMobile=null,newWorkflowJqObj=null,newWorkflowJqObjTitle=null,newWorkflowJqObjAnimationPanel=null,_resx=null,_tmpEditedWorkflow={},_htmlError='<div data-bind="css: errorClass">                        <ul data-bind="foreach: messages">                            <li data-bind="name"></li>                        </ul>                    </div>',getBrowser=function(){var agent,osx;switch(agent=navigator.userAgent,osx=agent.search(/Macintosh/i)!==-1?"osx":"",!0){case agent.search(/msie|\.net/i)!==-1:_browser="ie";break;case agent.search(/Firefox/i)!==-1:_browser="ff"+osx;break;case agent.search(/Chrome/i)!==-1:_browser="chrome";break;case agent.search(/AppleWebKit/i)!==-1:_browser="safari";break;default:_browser="unknown "+osx}},loadWeb=function(params,callback){viewModel.isNewOpen(!1),configServiceFramework(),util.sf.get("Index",{},updateWorkflowsList,initErrorCallback)},loadMobile=function(params,callback){},initViewModel=function(data,htmlHeader){var item,itemState;_tmpEditedWorkflow={},newWorkflowExtendedObj=jQuery.extend(!0,{},data.NewWorkflow),viewModel={browser:_browser,load:!0,title:_resx.settings_title,subtitle:_resx.workflows_title,workflows:{header:{workflowType:_resx.workflows_header_workflow_type||"WORKFLOW TYPE",inUse:_resx.workflows_header_in_use||"IN USE",actions:_resx.workflows_header_actions||"ACTIONS"},tooltip:{lock:_resx.workflows_tooltip_lock},page:{title:_resx.workflows_page_title||"Workflows",description:_resx.workflows_page_description||"",newWorkflowBtn:_resx.workflows_new_btn,inUse:_resx.workflows_in_use,NotInUse:_resx.workflows_not_in_use,resources_info:_resx.workflows_resources_info,resources_link:_resx.workflows_resources_link,states:{title:_resx.workflows_states_title||"Workflows States",description:_resx.workflows_states_descriptions||""},table:{order:_resx.workflows_states_table_order,state:_resx.workflows_states_table_state,active:_resx.workflows_states_table_active,actions:_resx.workflows_states_table_actions,move:_resx.workflows_states_table_move},form:{addStateBtn:_resx.workflows_add_state_btn||"Add a State",title:_resx.workflows_common_title_lbl,description:_resx.workflows_common_description_lbl,cancel:_resx.workflows_common_cancel_btn,save:_resx.workflows_common_save_btn}},list:ko.observableArray([])},firstWorkflowClass:firstWorkflowClass,isAnimationEnable:ko.observable(!1),isNewOpen:ko.observable(!1),isEditOpen:ko.observableArray([]),isAddStateOpen:ko.observable(!1),koBinded:ko.observable(!1),showNew:showNew,toggleNew:toggleNew,saveNew:saveNew,toggleEdit:toggleEdit,saveEdited:saveEdited,cancelEdited:cancelEdited,cancelNew:cancelNew,showDialog:showDialog,showAddState:showAddState,showEditState:showEditState,delWorkflow:delWorkflow,delState:delState,showResources:showResources,moveUp:moveUp,moveDown:moveDown},data.Workflows.unshift(data.NewWorkflow),data.Workflows.forEach(function(elemWorkFlow,idx){item={isUsed:ko.observable(elemWorkFlow.IsInUse),isOpen:ko.observable(!1),isEditable:ko.observable(!elemWorkFlow.IsSystem),isSystem:elemWorkFlow.IsSystem,isAddStateBtnEnable:ko.observable(0!==idx&&!elemWorkFlow.IsSystem),WorkflowId:ko.observable(elemWorkFlow.WorkflowId),WorkflowName:ko.observable(elemWorkFlow.WorkflowName||_resx.workflows_new_workflow).extend({required:!0,minLength:3,maxLength:40}),NameErrors:ko.observableArray([]),Description:ko.observable(elemWorkFlow.Description).extend({maxLength:255}),DescriptionErrors:ko.observableArray([]),States:ko.observableArray([])},elemWorkFlow.States&&elemWorkFlow.States.forEach(function(elemState){itemState={StateId:ko.observable(elemState.StateId),StateName:ko.observable(elemState.StateName),Order:ko.observable(elemState.Order),IsSystem:ko.observable(elemState.IsSystem),SendNotification:ko.observable(elemState.SendNotification),SendNotificationToAdministrators:ko.observable(elemState.SendNotificationToAdministrators)},item.States().push(itemState)}),viewModel.workflows.list().push(item)}),_koBinded||(ko.applyBindings(viewModel,htmlHeader),viewModel.koBinded(!0),_koBinded=!0),setTimeout(function(){_newWorkflowTarget=$(".workflows .isNewWorkflow .detailsPanel"),$(".qaTooltip").qaTooltip()},0)},updateWorkflowsList=function(data){var item,itemState;viewModel.workflows.list.valueWillMutate(),viewModel.workflows.list([]),newWorkflowExtendedObj=jQuery.extend(!0,{},data.NewWorkflow),data.Workflows.unshift(data.NewWorkflow),data.Workflows.forEach(function(elemWorkFlow,idx){item={isUsed:ko.observable(elemWorkFlow.IsInUse),isOpen:ko.observable(!1),isEditable:ko.observable(!elemWorkFlow.IsSystem),isSystem:elemWorkFlow.IsSystem,isAddStateBtnEnable:ko.observable(0!==idx&&!elemWorkFlow.IsSystem),WorkflowId:ko.observable(elemWorkFlow.WorkflowId),WorkflowName:ko.observable(elemWorkFlow.WorkflowName||_resx.workflows_new_workflow).extend({required:!0,minLength:3,maxLength:40}),NameErrors:ko.observableArray([]),Description:ko.observable(elemWorkFlow.Description).extend({maxLength:255}),DescriptionErrors:ko.observableArray([]),States:ko.observableArray([])},elemWorkFlow.States&&elemWorkFlow.States.forEach(function(elemState){itemState={StateId:ko.observable(elemState.StateId),StateName:ko.observable(elemState.StateName),Order:ko.observable(elemState.Order),IsSystem:ko.observable(elemState.IsSystem),SendNotification:ko.observable(elemState.SendNotification),SendNotificationToAdministrators:ko.observable(elemState.SendNotificationToAdministrators)},item.States.push(itemState)}),viewModel.workflows.list.push(item)}),viewModel.workflows.list.valueHasMutated()},showResources=function(workflow){_resourcesLoadOffset=0,configServiceFramework(),util.sf.post("Resources",{WorkflowId:workflow.WorkflowId(),Offset:_resourcesLoadOffset},function(data){showResources200Callback(data,workflow)},showResourcesErrorCallback)},showResources200Callback=function(data,workflow){var html,modelCallback;html='<div class="panel"><div class="resourcesUsedByWorkflow head"><div class="name" data-bind="text: name"></div><div class="contentType" data-bind="text: contentType"></div></div><div class="resourcesUsedByWorkflow resources"><ul class="" data-bind="foreach: messages"><li class="clearBoth" data-bind="css: {odd: $index()%2 === 0, even: $index()%2 === 1}"><span class="title" data-bind="text: title, attr: { title: title }"></span><span class="contentType" data-bind="text: contentType, attr: { title: contentType }"></span><span class="clearBoth"></span></li></ul></div></div>',modelCallback=function(){return _viewModelResources={name:_resx.worflow_usages_dialog_table_name,contentType:_resx.worflow_usages_dialog_table_contentType,messages:ko.observableArray([])},viewModelResourcesAddData(data),_viewModelResources},_personaBarDialog=new PersonaBarDialog({title:_resx.worflow_usages_dialog_title,innerTitle:_resx.worflow_usages_dialog_inner_title.replace("{0}",workflow.WorkflowName()),showAcceptBtn:!1,cancelBtnLbl:_resx.workflows_common_close_btn},html,modelCallback,function(data){afterBindShowResourcesCallback(data,workflow)})},viewModelResourcesAddData=function(data){var resource;data.resources.forEach(function(elem){resource={title:ko.observable(elem.title),contentType:ko.observable("Tab"===elem.type?"Page":elem.type)},_viewModelResources.messages.push(resource)})},afterBindShowResourcesCallback=function(data,workflow){var resources,scrollable,lastPos,currentPos,scrollDown;_isGettingMoreResources=!1,_resourcesLoadOffset++,resources=$(".resourcesUsedByWorkflow.resources"),resources.jScrollPane(),resources.css("width","100%"),resources.find(".jspContainer").css("width","100%"),0===resources.find(".jspDrag").length?$(".personaBarDialog .resourcesUsedByWorkflow.head").css("width","calc(100% - 22px)"):$(".personaBarDialog .resourcesUsedByWorkflow.head").css("width","calc(100% - 20px)"),scrollable=$(".resourcesUsedByWorkflow.resources .jspDrag"),setTimeout(function(){resources.off("scroll.workflowResources").on("scroll.workflowResources",function(){scrollable=$(".resourcesUsedByWorkflow.resources .jspDrag"),_isGettingMoreResources||(currentPos=scrollable.css("top"),scrollDown=!(lastPos>currentPos),scrollDown&&currentPos===lastPos?(_isGettingMoreResources=!0,getResourcesLazyLoad(workflow)):lastPos=currentPos)}),_personaBarDialog.updateHeight()},0)},getResourcesLazyLoad=function(workflow){configServiceFramework(),util.sf.post("Resources",{WorkflowId:workflow.WorkflowId(),Offset:_resourcesLoadOffset},getResourcesLazyLoad200Callback,null)},getResourcesLazyLoad200Callback=function(data){var resources;viewModelResourcesAddData(data),setTimeout(function(){resources=$(".resourcesUsedByWorkflow.resources"),resources.jScrollPane(),_isGettingMoreResources=!data.loadMore,_resourcesLoadOffset++,data.loadMore||resources.off("scroll.workflowResources")},0)},showResourcesErrorCallback=function(){},showDialog=function(){},configServiceFramework=function(){util.sf.moduleRoot="EvoqContentLibrary",util.sf.controller="Workflows"},configServiceFrameworkStates=function(){util.sf.moduleRoot="EvoqContentLibrary",util.sf.controller="WorkflowStates"},init200Callback=function(data){data&&(initViewModel(data,htmlHeader),"function"==typeof callback&&callback())},initErrorCallback=function(data){data?200!==data.status&&util.notifyError("Error "+data.status+": "+data.statusText):util.notifyError(_resx.workflows_unknown_error)},usedText=function(isUsed){return isUsed?_resx.workflows_in_use:_resx.workflows_not_used},firstWorkflowClass=function(index){return 0===index?"isNewWorkflow":""},animateShowPanel=function(isEditable,objTitle,objPanel,numberOfStates,endAnimationCallback){var finalHeight,initialPosition,scrollPosition,panelPosition;finalHeight=objPanel.find(".lastTag")[0].getBoundingClientRect().top-objPanel[0].getBoundingClientRect().bottom+LAST_TAG_TO_END_DISTANCE,objPanel.stop(!0,!0).animate({opacity:OPACITY_VISIBLE,height:finalHeight,"border-bottom-width":BORDER_BOTTOM_WIDTH},{duration:WORKFLOW_ANIMATION_DURATION,easing:WORKFLOW_ANIMATION_EASING,queue:!1,complete:function(){endAnimationCallback(),scrollPosition=_scrollObj.scrollTop(),panelPosition=objPanel[0].getBoundingClientRect().top,initialPosition=scrollPosition+panelPosition,_scrollObj.stop(!0,!0).animate({"scroll-top":parseInt(initialPosition-ANIMATION_PANEL_MARGIN,10)},{duration:WORKFLOW_ANIMATION_DURATION})}}),objTitle&&objTitle.stop(!0,!0).animate({opacity:OPACITY_VISIBLE,height:NEW_WORKFLOW_TITLE_HEIGHT+"px"},{duration:WORKFLOW_ANIMATION_DURATION_TITLE,easing:WORKFLOW_ANIMATION_EASING_TITLE,queue:!1})},animateHidePanel=function(objTitle,objPanel,endAnimationCallback){var endAnimationTitleCallback,endAnimationPanelCallback;objTitle?(endAnimationPanelCallback=!1,endAnimationTitleCallback=function(){endAnimationCallback()}):(endAnimationTitleCallback=!1,endAnimationPanelCallback=function(){endAnimationCallback()}),objPanel.animate({opacity:OPACITY_INVISIBLE,height:0,"border-bottom-width":0},{duration:WORKFLOW_ANIMATION_DURATION,easing:WORKFLOW_ANIMATION_EASING,queue:!1,complete:endAnimationPanelCallback}),objTitle&&setTimeout(function(){objTitle.stop(!0,!0).animate({opacity:OPACITY_INVISIBLE,height:0},{duration:WORKFLOW_ANIMATION_DURATION_TITLE,easing:WORKFLOW_ANIMATION_EASING_TITLE,queue:!1,complete:endAnimationTitleCallback})},0)},highlightLastAdded=function(){var lastListTitle,originalBackground;lastListTitle=$(".workflowsList:last").find("div.title div:first"),originalBackground=lastListTitle.css("background-color"),lastListTitle.stop(!0,!0).animate({backgroundColor:"#ffff99"},{duration:700,queue:!1,complete:function(){lastListTitle.stop(!0,!0).animate({"background-color":originalBackground},{duration:700,complete:function(){lastListTitle.css("background-color","")}})}})},cleanNewForm=function(){viewModel.workflows.list()[0].WorkflowName(newWorkflowExtendedObj.WorkflowName||"New Workflow"),viewModel.workflows.list()[0].Description(newWorkflowExtendedObj.Description||"")},showNew=function(){var callback;viewModel.isNewOpen()||(hideEdit(),viewModel.isNewOpen(!0),viewModel.workflows.list()[0].isOpen(!0),newWorkflowJqObj=$(NEW_WORKFLOW_TITLE_SELECTOR),newWorkflowJqObjTitle=newWorkflowJqObj.find(".title:first"),newWorkflowJqObjAnimationPanel=newWorkflowJqObj.find(".animationPanel"),newWorkflowJqObj=!0,callback=function(){newWorkflowJqObjAnimationPanel.find(".focusMe").focus().select(),bindDescriptionHeight(_newWorkflowTarget)},$(document.body).animate({scrollTop:0},{duration:WORKFLOW_ANIMATION_DURATION}),animateShowPanel(!0,newWorkflowJqObjTitle,newWorkflowJqObjAnimationPanel,0,callback))},hideNew=function(endAnimationCallback){var callback;cleanNewForm(),cleanBackendErrors(viewModel.workflows.list()[0],_newWorkflowTarget),unbindDescriptionHeight(_newWorkflowTarget),viewModel.isNewOpen()&&(viewModel.isNewOpen(!1),callback=function(){viewModel.workflows.list()[0].isOpen(!1),"function"==typeof endAnimationCallback&&endAnimationCallback()},null===newWorkflowJqObj&&(newWorkflowJqObj=$(NEW_WORKFLOW_TITLE_SELECTOR),newWorkflowJqObjTitle=newWorkflowJqObj.find(".title:first"),newWorkflowJqObjAnimationPanel=newWorkflowJqObj.find(".animationPanel"),newWorkflowJqObj=!0),animateHidePanel(newWorkflowJqObjTitle,newWorkflowJqObjAnimationPanel,callback))},toggleNew=function(workflow,event){viewModel.isNewOpen()?hideNew():showNew(event)},createWorkflow200Callback=function(data){var newWorkflow,itemState,hideCallback;newWorkflow={isSystem:!1,isUsed:ko.observable(!1),isAddStateBtnEnable:ko.observable(!0),isOpen:ko.observable(!1),isEditable:ko.observable(!0),WorkflowId:ko.observable(data.Workflow.WorkflowId),WorkflowName:ko.observable(data.Workflow.WorkflowName).extend({required:!0,minLength:3,maxLength:40}),Description:ko.observable(data.Workflow.Description).extend({maxLength:255}),States:ko.observableArray([]),NameErrors:ko.observableArray([]),DescriptionErrors:ko.observableArray([])},data.States.forEach(function(elemState){itemState={StateName:ko.observable(elemState.StateName),Order:ko.observable(elemState.Order),IsSystem:ko.observable(elemState.IsSystem),SendNotification:ko.observable(elemState.SendNotification),SendNotificationToAdministrators:ko.observable(elemState.SendNotificationToAdministrators)},newWorkflow.States().push(itemState)}),hideCallback=function(){viewModel.workflows.list.push(newWorkflow),highlightLastAdded(),showEdit(newWorkflow,viewModel.workflows.list().length-1)},hideNew(hideCallback)},createWorkflowErrorCallback=function(data,workflow,eventTarget){data&&500!=data.status&&data.responseJSON&&data.responseJSON.Messages?showBackendErrors(workflow,eventTarget,data.responseJSON.Messages):util.notifyError(_resx.workflows_unknown_error)},saveNew=function(bindedWorkflow,event){var workflow;cleanBackendErrors(bindedWorkflow,event.target),workflow={WorkflowName:bindedWorkflow.WorkflowName(),Description:bindedWorkflow.Description()||""},configServiceFramework(),util.sf.post("Create",workflow,createWorkflow200Callback,function(data){createWorkflowErrorCallback(data,bindedWorkflow,event.target)})},showEdit=function(target,index){var workflow,animationPanel,numberOfStates,callback;0===index||viewModel.isEditOpen()[index]||(hideEdit(),hideNew(),viewModel.isEditOpen()[index]=!0,workflow=viewModel.workflows.list()[index],workflow.isOpen(!0),animationPanel=$(".workflowsListItem").eq(index).find(".animationPanel"),numberOfStates=workflow.States().length,callback=function(){bindDescriptionHeight(target)},animateShowPanel(workflow.isEditable(),null,animationPanel,numberOfStates,callback),_tmpEditedWorkflow.WorkflowName=workflow.WorkflowName(),_tmpEditedWorkflow.Description=workflow.Description(),_tmpEditedWorkflow.index=index,_tmpEditedWorkflow.target=target)},hideEdit=function(index,force){var workflowObj,callback;if(0===index)return hideNew();if(force||void 0===index||viewModel.isEditOpen()[index]){if(index&&index===_tmpEditedWorkflow.index&&(unbindDescriptionHeight(_tmpEditedWorkflow.target),cancelEdited(viewModel.workflows.list()[index],_tmpEditedWorkflow.target,index)),void 0===index)return void viewModel.isEditOpen().forEach(function(elem,idx){elem===!0&&hideEdit(idx,!0)});viewModel.isEditOpen()[index]=!1,callback=function(){viewModel.workflows.list()[index].isOpen(!1)},workflowObj=$(".workflowsListItem").eq(index).find(".animationPanel"),animateHidePanel(null,workflowObj,callback)}},toggleEdit=function(workflow,event,index){0===index?toggleNew(workflow,event,index):viewModel.isEditOpen()[index]?(cancelEdited(workflow,event.target,index),hideEdit(index)):showEdit(event.target,index)},bindDescriptionHeight=function(eventTarget){var panel,infoBox,textarea,diff,infoBoxHeight,animationPanel,animationPanelHeight,currentinfoBoxHeight;panel=$(eventTarget).closest("li.workflowsListItem"),infoBox=panel.find(".info.description"),textarea=panel.find("textarea"),animationPanel=panel.find(".animationPanel"),animationPanelHeight=animationPanel.height(),setTimeout(function(){infoBoxHeight=infoBox.height()},0),textarea.on("keydown.contentWorkflow, onpaste.contentWorkflow",function(){setTimeout(function(){animationPanelHeight=animationPanel.height(),currentinfoBoxHeight=infoBox.height(),currentinfoBoxHeight!==infoBoxHeight&&(currentinfoBoxHeight>infoBoxHeight?(diff=currentinfoBoxHeight-infoBoxHeight,animationPanelHeight+=diff):(diff=infoBoxHeight-currentinfoBoxHeight,animationPanelHeight-=diff),animationPanel.height(animationPanelHeight),infoBoxHeight=infoBox.height())},0)})},unbindDescriptionHeight=function(eventTarget){$(eventTarget).closest("li.workflowsList").find("textarea").off("keydown.contentWorkflow")},editWorkflow200Callback=function(data,workflow,editedWorkflow){workflow.WorkflowName(editedWorkflow.WorkflowName),workflow.Description(editedWorkflow.Description),cleanEditedTmp(),hideEdit()},editWorkflowErrorCallback=function(data,workflow,eventTarget){data&&500!=data.status&&data.responseJSON&&data.responseJSON.Messages?showBackendErrors(workflow,eventTarget,data.responseJSON.Messages):util.notifyError(_resx.unknown_error)},saveEdited=function(workflow,event){var editedWorkflow;cleanBackendErrors(workflow,event.target),editedWorkflow={WorkflowId:workflow.WorkflowId(),WorkflowName:workflow.WorkflowName(),Description:workflow.Description()||""},configServiceFramework(),util.sf.post("Edit",editedWorkflow,function(data){editWorkflow200Callback(data,workflow,editedWorkflow,event.target)},function(data){editWorkflowErrorCallback(data,workflow,event.target)})},delWorkflow200Callback=function(data,index){viewModel.workflows.list.splice(index,1),util.notify(_resx.workflows_notify_deleted)},delWorkflowErrorCallback=function(data){var messages,dialogObj;data.responseJSON&&data.responseJSON.Messages||util.notifyError("Error "+data.status+": "+data.statusText),messages=[];for(var idx in data.responseJSON.Messages)""===messages.Field&&messages.push(data.responseJSON.Messages[idx]);messages.length>0&&(dialogObj={cancelBtnLbl:_resx.workflows_common_close_btn,showAcceptBtn:!1},412===data.status?(dialogObj.title=_resx.workflows_common_error_resource_busy,dialogObj.errorClass="resourceBusy"):(dialogObj.title=_resx.workflows_common_errors_title,dialogObj.errorClass="panel errors"),_personaBarDialog=new PersonaBarDialog(dialogObj,_htmlError,function(){return{messages:ko.observableArray(messages)}}))},delWorkflow=function(index,event){var workflow,title,onConfirmCallback;event.stopPropagation(),workflow=viewModel.workflows.list()[index],title=_resx.workflows_confirm_delete_workflow.replace("{0}",workflow.WorkflowName()),onConfirmCallback=function(data){configServiceFramework(),util.sf.post("Delete",{WorkflowId:workflow.WorkflowId()},function(data){delWorkflow200Callback(data,index)},delWorkflowErrorCallback)},util.confirm(title,_utilConfirmBtnLbl,_utilCancelBtnLbl,onConfirmCallback)},delState=function(indexWorkflow,indexState,event){var title,workflow,state,onConfirmCallback,panel;panel=$(event.target).closest(".animationPanel"),workflow=viewModel.workflows.list()[indexWorkflow],state=workflow.States()[indexState],title=_resx.workflows_confirm_delete_state.replace("{0}",state.StateName()),onConfirmCallback=function(){configServiceFrameworkStates(),util.sf.post("delete",{WorkflowId:workflow.WorkflowId(),StateId:state.StateId()},function(data){delState200Callback(data,panel,workflow,indexState)},delStateErrorCallback)},util.confirm(title,_utilConfirmBtnLbl,_utilCancelBtnLbl,onConfirmCallback)},delState200Callback=function(data,panel,workflow,indexState){var height;workflow.States.splice(indexState,1),height=parseInt(panel.height(),10),panel.height(height-STATE_ROW_HEIGHT),workflow.States().forEach(function(elem,idx){elem.Order(idx+1)})},delStateErrorCallback=function(data){var messages;if(!data.responseJSON||!data.responseJSON.Messages)return void util.notifyError(_resx.workflows_unknown_error);messages="";for(var i in data.responseJSON.Messages)messages+=data.responseJSON.Messages[i].Description+". ";util.notifyError(messages)},cleanEditedTmp=function(){_tmpEditedWorkflow.WorkflowName=null,_tmpEditedWorkflow.Description=null,_tmpEditedWorkflow.index=null,_tmpEditedWorkflow.target=null},cancelEdited=function(workflow,target,index){workflow.WorkflowName(_tmpEditedWorkflow.WorkflowName),workflow.Description(_tmpEditedWorkflow.Description),cleanEditedTmp(),cleanBackendErrors(workflow,target),hideEdit(index)},cancelNew=function(){hideNew()},showAddState=function(index,event){var workflow,onCloseCallback;workflow=viewModel.workflows.list()[index],onCloseCallback=function(state){var lastState,animationPanel;workflow.isAddStateBtnEnable(!0),state&&state.Order&&(state={isEditable:ko.observable(!state.IsSystem),StateId:ko.observable(state.StateId),StateName:ko.observable(state.StateName),IsSystem:ko.observable(state.IsSystem),Order:ko.observable(state.Order),SendNotificationToAdministrators:ko.observable(state.SendNotificationToAdministrators),SendNotification:ko.observable(state.SendNotification)},lastState=workflow.States.slice(-1).pop(),lastState.Order(lastState.Order()+1),workflow.States.valueWillMutate(),workflow.States()[workflow.States().length-1]=state,workflow.States.valueHasMutated(),workflow.States.push(lastState),animationPanel=$(event.target).closest(".animationPanel"),animationPanel.height(animationPanel.height()+STATE_ROW_HEIGHT))},_contentWorkflowsStates=new ContentWorkflowsStates(util,isMobile,"new",{WorkflowID:workflow.WorkflowId(),WorkflowName:workflow.WorkflowName()},{StateId:null},null,onCloseCallback),workflow.isAddStateBtnEnable(!1)},showEditState=function(workflowIndex,stateIndex){var workflow,state,onCloseCallback;workflow=viewModel.workflows.list()[workflowIndex],state=workflow.States()[stateIndex],onCloseCallback=function(stateSaved){stateSaved&&(state.StateName(stateSaved.StateName),state.SendNotification(stateSaved.SendNotification),state.SendNotificationToAdministrators(stateSaved.SendNotificationToAdministrators))},_contentWorkflowsStates=new ContentWorkflowsStates(util,isMobile,"edit",{WorkflowID:workflow.WorkflowId(),WorkflowName:workflow.WorkflowName()},{StateId:state.StateId(),StateName:state.StateName(),SendNotification:state.SendNotification(),SendNotificationToAdministrators:state.SendNotificationToAdministrators()},null,onCloseCallback)},showBackendErrors=function(workflow,eventTarget,messages){var panel,messageIdx,increasePanelHeight;panel=$(eventTarget).closest(".animationPanel");for(messageIdx in messages)switch(messages[messageIdx].Field){case"":break;case"WorkflowName":workflow.NameErrors.push({Description:messages[messageIdx].Description});break;case"Description":workflow.DescriptionErrors.push({Description:messages[messageIdx].Description})}increasePanelHeight=0,panel.find("ul.errors").each(function(idx,elem){increasePanelHeight+=$(elem).height()}),panel.height(panel.height()+increasePanelHeight)},cleanBackendErrors=function(workflow,eventTarget){var panel,decreaseHeight;panel=$(eventTarget).closest(".animationPanel"),decreaseHeight=0,panel.find("ul.errors").each(function(idx,elem){decreaseHeight+=$(elem).height()}),panel.height(panel.height()-decreaseHeight),workflow.NameErrors.removeAll(),workflow.DescriptionErrors.removeAll()},move=function(stateId,direction,state,workflowIndex,stateIndex){configServiceFrameworkStates(),util.sf.post("ConmuteStates",{StateID:stateId,Direction:direction},function(data){move200Callback(data,direction,state,workflowIndex,stateIndex)},moveErrorCallback)},move200Callback=function(data,direction,state,workflowIndex,stateIndex){var workflow,tmpUpOrDownState;switch(workflow=viewModel.workflows.list()[workflowIndex],direction){case MOVE_UP:tmpUpOrDownState=workflow.States()[stateIndex-1],workflow.States.valueWillMutate(),workflow.States()[stateIndex-1]=state,workflow.States()[stateIndex]=tmpUpOrDownState,state.Order(state.Order()-1),tmpUpOrDownState.Order(tmpUpOrDownState.Order()+1),workflow.States.valueHasMutated();break;case MOVE_DOWN:tmpUpOrDownState=workflow.States()[stateIndex+1],workflow.States.valueWillMutate(),workflow.States()[stateIndex+1]=state,workflow.States()[stateIndex]=tmpUpOrDownState,state.Order(state.Order()+1),tmpUpOrDownState.Order(tmpUpOrDownState.Order()-1),workflow.States.valueHasMutated()}},moveErrorCallback=function(){},moveUp=function(state,workflowIndex,stateIndex){move(state.StateId(),MOVE_UP,state,workflowIndex,stateIndex)},moveDown=function(state,workflowIndex,stateIndex){move(state.StateId(),MOVE_DOWN,state,workflowIndex,stateIndex)},ContentWorkflow.prototype.load=function(params,callback){return this.isMobile?loadMobile(params,callback):loadWeb(params,callback)},ContentWorkflow}()});