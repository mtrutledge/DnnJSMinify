"use strict";define(["jquery","knockout","d3"],function($,ko){var utility=null,viewModel={pageName:ko.observable(""),moduleName:ko.observable(""),viewCount:ko.observable("0"),viewCountDetail:ko.observable("0"),timeCount:ko.observable(0),bounceRate:ko.observable("N/A"),bounceRateUnits:ko.observable(""),engageAnalyticsVisible:ko.observable(!1),engagementPercentProgress:ko.observable(""),engagementPercent:ko.observable(0),period:ko.observable(""),comparativeTerm:ko.observable(""),startDate:ko.observable(""),endDate:ko.observable(""),loadPageAnalytics:function(d,e){e.preventDefault(),$(".incontext-analytics").hide(),utility.loadPageAnalytics()},loadEngageModuleDashboard:function(d,e){e.preventDefault(),$(".incontext-analytics").hide(),utility.loadModuleDashboard(viewModel.moduleName())}},getContextData=function(cb){var userSettings=utility.persistent.load(),defaultDate=utility.serializeCustomDate(new Date((new Date).toUTCString()));viewModel.period()!==userSettings.period||viewModel.comparativeTerm()!==userSettings.comparativeTerm?(viewModel.period(userSettings.period),viewModel.comparativeTerm(userSettings.comparativeTerm),viewModel.startDate(userSettings.startDate||defaultDate),viewModel.endDate(userSettings.endDate||defaultDate),utility.sf.moduleRoot="evoqcontentlibrary",utility.sf.controller="analyticsservice",utility.sf.getsilence("GetPageAnalyticsInContext",{period:viewModel.period(),comparativeTerm:viewModel.comparativeTerm(),startDate:viewModel.startDate(),endDate:viewModel.endDate()},function(data){data&&updatePageAnalyticsModel(data,cb),getContextDataEngage()},function(){getContextDataEngage()})):"function"==typeof cb&&cb()},getContextDataEngage=function(){if(viewModel.engageAnalyticsVisible()){var userSettings=utility.persistent.load(),defaultDate=utility.serializeCustomDate(new Date((new Date).toUTCString()));viewModel.period(userSettings.period),viewModel.comparativeTerm(userSettings.comparativeTerm),viewModel.startDate(userSettings.startDate||defaultDate),viewModel.endDate(userSettings.endDate||defaultDate),utility.sf.moduleRoot="dnncorp/cmx",utility.sf.controller="analytics",utility.sf.getsilence("GetModuleContextData",{period:viewModel.period(),comparativeTerm:viewModel.comparativeTerm(),moduleName:viewModel.moduleName(),startDate:viewModel.startDate(),endDate:viewModel.endDate()},function(data){data&&updateEngageAnalyticsModel(data)},function(){})}},updatePageAnalyticsModel=function(data,cb){viewModel.pageName(data.data.pageName||""),viewModel.viewCount(utility.formatAbbreviateBigNumbers(data.data.totalPageViews||0)),viewModel.viewCountDetail(utility.formatCommaSeparate(data.data.totalPageViews||0)),viewModel.timeCount(data.data.averageTimeOnPageTotalMinutes||0);var bounceRateData=(data.data.bounceRate||"").split(" ");bounceRateData.length>0?viewModel.bounceRate(bounceRateData[0]):viewModel.bounceRate("N/A"),bounceRateData.length>1?viewModel.bounceRateUnits(bounceRateData[1]):viewModel.bounceRateUnits(""),"function"==typeof cb&&cb()},updateEngageAnalyticsModel=function(data){viewModel.engagementPercent(data.engagementPercent||0),viewModel.engagementPercentProgress(1==data.percentProgress?"higher":data.percentProgress==-1?"lower":0==data.engagementPercent?"equal hidden":"equal")};return{init:function(wrapper,util,params,callback){utility=util,viewModel.resx=utility.resx.PersonaBar,viewModel.moduleName(params.moduleName),params.showEngageStats?viewModel.engageAnalyticsVisible(!0):viewModel.engageAnalyticsVisible(!1),ko.applyBindings(viewModel,wrapper[0]),utility.asyncParallel([function(cb1){getContextData(cb1)}],function(){"function"==typeof callback&&callback()})},load:function(params,callback){getContextData(function(){"function"==typeof callback&&callback()})}}});