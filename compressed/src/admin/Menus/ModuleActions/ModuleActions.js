!function($){$.fn.dnnModuleActions=function(options){function buildMoveMenu(root,rootText,rootClass){var htmlString,i,parent=buildMenuRoot(root,rootText,rootClass),modulePane=$(".DnnModule-"+moduleId).parent(),paneName=modulePane.attr("id").replace("dnn_",""),moduleIndex=-1,id=paneName+moduleId,modules=modulePane.children(),moduleCount=modules.length;for(i=0;i<moduleCount;i++){var module=modules[i],mid=getModuleId(module);if(moduleId==parseInt(mid)){moduleIndex=i;break}}moduleIndex>0&&(htmlString='<li id="'+id+'-top" class="common">'+opts.topText,parent.append(htmlString),parent.find("li#"+id+"-top").click(function(){moveTop(paneName)}),htmlString='<li id="'+id+'-up" class="common">'+opts.upText,parent.append(htmlString),parent.find("li#"+id+"-up").click(function(){moveUp(paneName,moduleIndex)})),moduleIndex<moduleCount-1&&(htmlString='<li id="'+id+'-down" class="common">'+opts.downText,parent.append(htmlString),parent.find("li#"+id+"-down").click(function(){moveDown(paneName,moduleIndex)}),htmlString='<li id="'+id+'-bottom" class="common">'+opts.bottomText,parent.append(htmlString),parent.find("li#"+id+"-bottom").click(function(){moveBottom(paneName)}));var htmlStringContainer="";for(i=0;i<panes.length;i++){var pane=panes[i];paneName!==pane&&(id=pane+moduleId,htmlStringContainer+='<li id="'+id+'">'+opts.movePaneText.replace("{0}",pane))}htmlStringContainer&&(parent.append(htmlStringContainer),parent.find("li").not(".common").click(function(){moveToPane($(this).attr("id").replace(moduleId,""))}))}function buildMenu(root,rootText,rootClass,actions,actionCount){for(var $parent=buildMenuRoot(root,rootText,rootClass),i=0;i<actionCount;i++){var action=actions[i];if("~"!==action.Title){action.Url?action.Url=decodeURIComponent(action.Url):action.Url="javascript: __doPostBack('"+actionButton+"', '"+action.ID+"')";var htmlString="<li>";switch(action.CommandName){case"DeleteModule.Action":htmlString='<li id="moduleActions-'+moduleId+'-Delete">';break;case"ModuleSettings.Action":htmlString='<li id="moduleActions-'+moduleId+'-Settings">';break;case"ImportModule.Action":htmlString='<li id="moduleActions-'+moduleId+'-Import">';break;case"ExportModule.Action":htmlString='<li id="moduleActions-'+moduleId+'-Export">';break;case"ModuleHelp.Action":htmlString='<li id="moduleActions-'+moduleId+'-Help">'}htmlString+=isEnabled(action)?'<a href="'+action.Url+'"><img src="'+action.Icon+'"><span>'+action.Title+"</span></a>":'<img src="'+action.Icon+'"><span>'+action.Title+"</span>",$parent.append(htmlString)}}$parent.find("#moduleActions-"+moduleId+"-Delete a").dnnConfirm({text:opts.deleteText,yesText:opts.yesText,noText:opts.noText,title:opts.confirmTitle})}function buildSharedMenu(root,rootText,rootClass,actions,actionCount){root.append('<li class="'+rootClass+'"><div>'+rootText+"</div>")}function buildMenuRoot(root,rootText,rootClass){root.append('<li class="'+rootClass+"\"><a href='javascript:void(0)' /><ul></ul>");var parent=root.find("li."+rootClass+" > ul");return parent}function getModuleId(module){var $anchor=$(module).children("a");return 0===$anchor.length&&($anchor=$(module).children("div.dnnDraggableContent").children("a")),$anchor.attr("name")}function isEnabled(action){return action.ClientScript||action.Url||action.CommandArgument}function moveBottom(targetPane){moveToPane(targetPane)}function moveDown(targetPane,moduleIndex){var container=$(".DnnModule-"+moduleId);container.fadeOut("slow",function(){$(this).detach().insertAfter($("#dnn_"+targetPane).children()[moduleIndex]).fadeIn("slow",function(){completeMove(targetPane,2*moduleIndex+4)})})}function moveTop(targetPane){var container=$(".DnnModule-"+moduleId);container.fadeOut("slow",function(){$(this).detach().prependTo($("#dnn_"+targetPane)).fadeIn("slow",function(){completeMove(targetPane,0)})})}function moveToPane(targetPane){var container=$(".DnnModule-"+moduleId);container.fadeOut("slow",function(){$(this).detach().appendTo("#dnn_"+targetPane).fadeIn("slow",function(){completeMove(targetPane,-1)})})}function moveUp(targetPane,moduleIndex){var container=$(".DnnModule-"+moduleId);container.fadeOut("slow",function(){$(this).detach().insertBefore($("#dnn_"+targetPane).children()[moduleIndex-1]).fadeIn("slow",function(){completeMove(targetPane,2*moduleIndex-2)})})}function position(mId){var container=$(".DnnModule-"+mId),root=$("#moduleActions-"+mId+" > ul"),containerPosition=container.offset(),containerWidth=container.width();root.css({position:"absolute",marginLeft:0,marginTop:0,top:containerPosition.top,left:containerPosition.left+containerWidth-65})}function watchResize(mId){var container=$(".DnnModule-"+mId);container.data("o-size",{w:container.width(),h:container.height()});var loopyFunc=function(){var data=container.data("o-size");data.w==container.width()&&data.h==container.height()||(container.data("o-size",{w:container.width(),h:container.height()}),container.trigger("resize")),setTimeout(loopyFunc,250)};container.trigger("resize",function(){position(mId)}),loopyFunc()}function completeMove(targetPane,moduleOrder){$("#dnn_"+targetPane).removeClass("DNNEmptyPane");var dataVar={TabId:tabId,ModuleId:moduleId,Pane:targetPane,ModuleOrder:moduleOrder},service=$.dnnSF(),serviceUrl=$.dnnSF().getServiceRoot("InternalServices")+"ModuleService/";$.ajax({url:serviceUrl+"MoveModule",type:"POST",data:dataVar,beforeSend:service.setModuleHeaders,success:function(){window.location.reload()},error:function(){}}),$(window).resize()}var opts=$.extend({},$.fn.dnnModuleActions.defaultOptions,options),$self=this,actionButton=opts.actionButton,moduleId=opts.moduleId,tabId=opts.tabId,adminActions=opts.adminActions,adminCount=adminActions.length,customActions=opts.customActions,customCount=customActions.length,panes=opts.panes,supportsMove=opts.supportsMove,count=adminCount+customCount,isShared=opts.IsShared;if(count>0||supportsMove){var $form=$("form#Form");if(0===$form.find("div#moduleActions-"+moduleId).length){$form.append('<div id="moduleActions-'+moduleId+'" class="actionMenu"><ul class="dnn_mact"></ul></div>');var menu=$form.find("div:last"),menuRoot=menu.find("ul");customCount>0&&buildMenu(menuRoot,"Edit","actionMenuEdit",customActions,customCount),adminCount>0&&buildMenu(menuRoot,"Admin","actionMenuAdmin",adminActions,adminCount),supportsMove&&buildMoveMenu(menuRoot,"Move","actionMenuMove"),isShared&&buildSharedMenu(menuRoot,"Shared Module","dnn_shared"),watchResize(moduleId)}}return $self},$.fn.dnnModuleActions.defaultOptions={customText:"CustomText",adminText:"AdminText",moveText:"MoveText",topText:"Top",upText:"Up",downText:"Down",bottomText:"Bottom",movePaneText:"To {0}"};var resizeThrottle;$(window).resize(function(){resizeThrottle&&(clearTimeout(resizeThrottle),resizeThrottle=null),resizeThrottle=setTimeout(function(){var menu=$(".actionMenu");menu.each(function(){var $this=$(this),id=$this.attr("id");if(id){var mId=id.split("-")[1],container=$(".DnnModule-"+mId),root=$("ul.dnn_mact",$this),containerPosition=container.offset(),containerWidth=container.width();root.css({position:"absolute",marginLeft:0,marginTop:0,top:containerPosition.top,left:containerPosition.left+containerWidth-65})}}),resizeThrottle=null},100)}),$(window).load(function(){$(document).ajaxComplete(function(){$(window).resize()}),$(window).resize()})}(jQuery);