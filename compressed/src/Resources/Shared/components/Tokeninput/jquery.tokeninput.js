!function($){var DEFAULT_SETTINGS={method:"GET",contentType:"json",queryParam:"q",searchDelay:300,minChars:1,propertyToSearch:"name",jsonContainer:null,supportModules:null,hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",animateDropdown:!0,tokenLimit:null,tokenDelimiter:",",preventDuplicates:!1,tokenValue:"id",prePopulate:null,processPrePopulate:!1,idPrefix:"token-input-",resultsFormatter:function(item){return"<li>"+item[this.propertyToSearch]+"</li>"},tokenFormatter:function(item){return"<li><p>"+item[this.propertyToSearch]+"</p></li>"},onResult:null,onError:null,onAdd:null,onDelete:null,onReady:null},DEFAULT_CLASSES={tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token"},POSITION={BEFORE:0,AFTER:1,END:2},KEY={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,NUMPAD_ENTER:108,COMMA:188},methods={init:function(url_or_data_or_function,options){var settings=$.extend({},DEFAULT_SETTINGS,options||{});return this.each(function(){$(this).data("tokenInputObject",new $.TokenList(this,url_or_data_or_function,settings))})},clear:function(){return this.data("tokenInputObject").clear(),this},add:function(item){return this.data("tokenInputObject").add(item),this},remove:function(item){return this.data("tokenInputObject").remove(item),this},get:function(){return this.data("tokenInputObject").getTokens()}};$.fn.tokenInput=function(method){return methods[method]?methods[method].apply(this,Array.prototype.slice.call(arguments,1)):methods.init.apply(this,arguments)},$.TokenList=function(input,url_or_data,settings){function checkTokenLimit(){if(null!==settings.tokenLimit&&token_count>=settings.tokenLimit)return input_box.hide(),void hide_dropdown()}function resize_input(){if(input_val!==(input_val=input_box.val())){var escaped=input_val.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");input_resizer.html(escaped),input_box.width(input_resizer.width()+30)}}function insert_token(item){var this_token=settings.tokenFormatter(item);this_token=$(this_token).addClass(settings.classes.token).insertBefore(input_token),$("<span>"+settings.deleteText+"</span>").addClass(settings.classes.tokenDelete).appendTo(this_token).click(function(){return delete_token($(this).parent()),hidden_input.change(),!1});var token_data={id:item.id};return token_data[settings.propertyToSearch]=item[settings.propertyToSearch],$.data(this_token.get(0),"tokeninput",item),saved_tokens=saved_tokens.slice(0,selected_token_index).concat([token_data]).concat(saved_tokens.slice(selected_token_index)),selected_token_index++,update_hidden_input(saved_tokens,hidden_input),token_count+=1,null!==settings.tokenLimit&&token_count>=settings.tokenLimit&&(input_box.hide(),hide_dropdown()),this_token}function add_token(item){var callback=settings.onAdd;if(token_count>0&&settings.preventDuplicates){var found_existing_token=null;if(token_list.children().each(function(){var existing_token=$(this),existing_data=$.data(existing_token.get(0),"tokeninput");if(existing_data&&existing_data.id===item.id)return found_existing_token=existing_token,!1}),found_existing_token)return select_token(found_existing_token),input_token.insertAfter(found_existing_token),void input_box.focus()}(null==settings.tokenLimit||token_count<settings.tokenLimit)&&(insert_token(item),checkTokenLimit()),input_box.val(""),hide_dropdown(),$.isFunction(callback)&&callback.call(hidden_input,item)}function select_token(token){token.addClass(settings.classes.selectedToken),selected_token=token.get(0),input_box.val(""),hide_dropdown()}function deselect_token(token,position){token.removeClass(settings.classes.selectedToken),selected_token=null,position===POSITION.BEFORE?(input_token.insertBefore(token),selected_token_index--):position===POSITION.AFTER?(input_token.insertAfter(token),selected_token_index++):(input_token.appendTo(token_list),selected_token_index=token_count),input_box.focus()}function toggle_select_token(token){var previous_selected_token=selected_token;selected_token&&deselect_token($(selected_token),POSITION.END),previous_selected_token===token.get(0)?deselect_token(token,POSITION.END):select_token(token)}function delete_token(token){var token_data=$.data(token.get(0),"tokeninput"),callback=settings.onDelete,index=token.prevAll().length;index>selected_token_index&&index--,token.remove(),selected_token=null,input_box.focus(),saved_tokens=saved_tokens.slice(0,index).concat(saved_tokens.slice(index+1)),index<selected_token_index&&selected_token_index--,update_hidden_input(saved_tokens,hidden_input),token_count-=1,null!==settings.tokenLimit&&input_box.show().val("").focus(),$.isFunction(callback)&&callback.call(hidden_input,token_data)}function update_hidden_input(saved_tokens,hidden_input){var token_values=$.map(saved_tokens,function(el){return el[settings.tokenValue]});hidden_input.val(token_values.join(settings.tokenDelimiter))}function hide_dropdown(){dropdown.hide().empty(),selected_dropdown_item=null}function show_dropdown(){dropdown.css({position:"absolute",top:$(token_list).offset().top+$(token_list).outerHeight(),left:$(token_list).offset().left,zindex:999}).show()}function show_dropdown_searching(){settings.searchingText&&(dropdown.html("<p>"+settings.searchingText+"</p>"),show_dropdown())}function show_dropdown_hint(){settings.hintText&&(dropdown.html("<p>"+settings.hintText+"</p>"),show_dropdown())}function highlight_term(value,term){return value.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+term+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")}function find_value_and_highlight_term(template,value,term){return template.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+value+")(?![^<>]*>)(?![^&;]+;)","g"),highlight_term(value,term))}function populate_dropdown(query,results){if(results&&results.length){dropdown.empty();var dropdown_ul=$("<ul>").appendTo(dropdown).mouseover(function(event){select_dropdown_item($(event.target).closest("li"))}).mousedown(function(event){return add_token($(event.target).closest("li").data("tokeninput")),hidden_input.change(),!1}).hide();$.each(results,function(index,value){var this_li=settings.resultsFormatter(value);this_li=find_value_and_highlight_term(this_li,value[settings.propertyToSearch],query),this_li=$(this_li).appendTo(dropdown_ul),index%2?this_li.addClass(settings.classes.dropdownItem):this_li.addClass(settings.classes.dropdownItem2),0===index&&select_dropdown_item(this_li),$.data(this_li.get(0),"tokeninput",value)}),show_dropdown(),settings.animateDropdown?dropdown_ul.slideDown("fast"):dropdown_ul.show()}else settings.noResultsText&&(dropdown.html("<p>"+settings.noResultsText+"</p>"),show_dropdown())}function select_dropdown_item(item){item&&(selected_dropdown_item&&deselect_dropdown_item($(selected_dropdown_item)),item.addClass(settings.classes.selectedDropdownItem),selected_dropdown_item=item.get(0))}function deselect_dropdown_item(item){item.removeClass(settings.classes.selectedDropdownItem),selected_dropdown_item=null}function do_search(){var query=input_box.val().toLowerCase();query&&query.length&&(selected_token&&deselect_token($(selected_token),POSITION.AFTER),query.length>=settings.minChars?(show_dropdown_searching(),clearTimeout(timeout),timeout=setTimeout(function(){run_search(query)},settings.searchDelay)):hide_dropdown())}function run_search(query){var cache_key=query+computeURL(),cached_results=cache.get(cache_key);if(cached_results)populate_dropdown(query,cached_results);else if(settings.url){var url=computeURL(),ajax_params={};if(ajax_params.data={},url.indexOf("?")>-1){var parts=url.split("?");ajax_params.url=parts[0];var param_array=parts[1].split("&");$.each(param_array,function(index,value){var kv=value.split("=");ajax_params.data[kv[0]]=kv[1]})}else ajax_params.url=url;ajax_params.data[settings.queryParam]=query,ajax_params.type=settings.method,ajax_params.dataType=settings.contentType,settings.crossDomain&&(ajax_params.dataType="jsonp"),null!=settings.supportModules&&(ajax_params.beforeSend=settings.supportModules),ajax_params.success=function(results){$.isFunction(settings.onResult)&&(results=settings.onResult.call(hidden_input,results)),cache.add(cache_key,settings.jsonContainer?results[settings.jsonContainer]:results),input_box.val().toLowerCase()===query&&populate_dropdown(query,settings.jsonContainer?results[settings.jsonContainer]:results)},ajax_params.error=function(xhr,status,error){$.isFunction(settings.onError)&&settings.onError.call(xhr,status,error)},$.ajax(ajax_params)}else if(settings.local_data){var results=$.grep(settings.local_data,function(row){return row[settings.propertyToSearch].toLowerCase().indexOf(query.toLowerCase())>-1});$.isFunction(settings.onResult)&&(results=settings.onResult.call(hidden_input,results)),cache.add(cache_key,results),populate_dropdown(query,results)}}function computeURL(){var url=settings.url;return"function"==typeof settings.url&&(url=settings.url.call()),url}if("string"===$.type(url_or_data)||"function"===$.type(url_or_data)){settings.url=url_or_data;var url=computeURL();void 0===settings.crossDomain&&(url.indexOf("://")===-1?settings.crossDomain=!1:settings.crossDomain=location.href.split(/\/+/g)[1]!==url.split(/\/+/g)[1])}else"object"==typeof url_or_data&&(settings.local_data=url_or_data);settings.classes?settings.classes=$.extend({},DEFAULT_CLASSES,settings.classes):settings.theme?(settings.classes={},$.each(DEFAULT_CLASSES,function(key,value){settings.classes[key]=value+"-"+settings.theme})):settings.classes=DEFAULT_CLASSES;var timeout,input_val,saved_tokens=[],token_count=0,cache=new $.TokenList.Cache,input_box=$('<input type="text"  autocomplete="off">').css({outline:"none"}).attr("id",settings.idPrefix+input.id).focus(function(){null!==settings.tokenLimit&&settings.tokenLimit===token_count||show_dropdown_hint()}).blur(function(){hide_dropdown(),$(this).val("")}).bind("keyup keydown blur update",resize_input).keydown(function(event){var previous_token,next_token;switch(event.keyCode){case KEY.LEFT:case KEY.RIGHT:case KEY.UP:case KEY.DOWN:if($(this).val()){var dropdown_item=null;return dropdown_item=event.keyCode===KEY.DOWN||event.keyCode===KEY.RIGHT?$(selected_dropdown_item).next():$(selected_dropdown_item).prev(),dropdown_item.length&&select_dropdown_item(dropdown_item),!1}previous_token=input_token.prev(),next_token=input_token.next(),previous_token.length&&previous_token.get(0)===selected_token||next_token.length&&next_token.get(0)===selected_token?event.keyCode===KEY.LEFT||event.keyCode===KEY.UP?deselect_token($(selected_token),POSITION.BEFORE):deselect_token($(selected_token),POSITION.AFTER):event.keyCode!==KEY.LEFT&&event.keyCode!==KEY.UP||!previous_token.length?event.keyCode!==KEY.RIGHT&&event.keyCode!==KEY.DOWN||!next_token.length||select_token($(next_token.get(0))):select_token($(previous_token.get(0)));break;case KEY.BACKSPACE:if(previous_token=input_token.prev(),!$(this).val().length)return selected_token?(delete_token($(selected_token)),hidden_input.change()):previous_token.length&&select_token($(previous_token.get(0))),!1;1===$(this).val().length?hide_dropdown():setTimeout(function(){do_search()},5);break;case KEY.TAB:case KEY.ENTER:case KEY.NUMPAD_ENTER:case KEY.COMMA:if(selected_dropdown_item)return add_token($(selected_dropdown_item).data("tokeninput")),hidden_input.change(),!1;break;case KEY.ESCAPE:return hide_dropdown(),!0;default:String.fromCharCode(event.which)&&setTimeout(function(){do_search()},5)}}),hidden_input=$(input).hide().val("").focus(function(){input_box.focus()}).blur(function(){input_box.blur()}),selected_token=null,selected_token_index=0,selected_dropdown_item=null,token_list=$("<ul />").addClass(settings.classes.tokenList).click(function(event){var li=$(event.target).closest("li");li&&li.get(0)&&$.data(li.get(0),"tokeninput")?toggle_select_token(li):(selected_token&&deselect_token($(selected_token),POSITION.END),input_box.focus())}).mouseover(function(event){var li=$(event.target).closest("li");li&&selected_token!==this&&li.addClass(settings.classes.highlightedToken)}).mouseout(function(event){var li=$(event.target).closest("li");li&&selected_token!==this&&li.removeClass(settings.classes.highlightedToken)}).insertBefore(hidden_input),input_token=$("<li />").addClass(settings.classes.inputToken).appendTo(token_list).append(input_box),dropdown=$("<div>").addClass(settings.classes.dropdown).appendTo("body").hide(),input_resizer=$("<tester/>").insertAfter(input_box).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:input_box.css("fontSize"),fontFamily:input_box.css("fontFamily"),fontWeight:input_box.css("fontWeight"),letterSpacing:input_box.css("letterSpacing"),whiteSpace:"nowrap"});hidden_input.val("");var li_data=settings.prePopulate||hidden_input.data("pre");settings.processPrePopulate&&$.isFunction(settings.onResult)&&(li_data=settings.onResult.call(hidden_input,li_data)),li_data&&li_data.length&&$.each(li_data,function(index,value){insert_token(value),checkTokenLimit()}),$.isFunction(settings.onReady)&&settings.onReady.call(),this.clear=function(){token_list.children("li").each(function(){0===$(this).children("input").length&&delete_token($(this))})},this.add=function(item){add_token(item)},this.remove=function(item){token_list.children("li").each(function(){if(0===$(this).children("input").length){var currToken=$(this).data("tokeninput"),match=!0;for(var prop in item)if(item[prop]!==currToken[prop]){match=!1;break}match&&delete_token($(this))}})},this.getTokens=function(){return saved_tokens}},$.TokenList.Cache=function(options){var settings=$.extend({max_size:500},options),data={},size=0,flush=function(){data={},size=0};this.add=function(query,results){size>settings.max_size&&flush(),data[query]||(size+=1),data[query]=results},this.get=function(query){return data[query]}}}(jQuery);