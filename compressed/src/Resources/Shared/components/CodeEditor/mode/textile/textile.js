!function(mod){"object"==typeof exports&&"object"==typeof module?mod(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],mod):mod(CodeMirror)}(function(CodeMirror){"use strict";function Parser(regExpFactory,state,stream){this.regExpFactory=regExpFactory,this.state=state,this.stream=stream,this.styles=TOKEN_STYLES,this.state.specialChar=null}function RegExpFactory(){this.cache={},this.single={bc:"bc",bq:"bq",definitionList:/- [^(?::=)]+:=+/,definitionListEnd:/.*=:\s*$/,div:"div",drawTable:/\|.*\|/,foot:/fn\d+/,header:/h[1-6]/,html:/\s*<(?:\/)?(\w+)(?:[^>]+)?>(?:[^<]+<\/\1>)?/,link:/[^"]+":\S/,linkDefinition:/\[[^\s\]]+\]\S+/,list:/(?:#+|\*+)/,notextile:"notextile",para:"p",pre:"pre",table:"table",tableCellAttributes:/[/\\]\d+/,tableHeading:/\|_\./,tableText:/[^"_\*\[\(\?\+~\^%@|-]+/,text:/[^!"_=\*\[\(<\?\+~\^%@-]+/},this.attributes={align:/(?:<>|<|>|=)/,selector:/\([^\(][^\)]+\)/,lang:/\[[^\[\]]+\]/,pad:/(?:\(+|\)+){1,2}/,css:/\{[^\}]+\}/}}var TOKEN_STYLES={addition:"positive",attributes:"attribute",bold:"strong",cite:"keyword",code:"atom",definitionList:"number",deletion:"negative",div:"punctuation",em:"em",footnote:"variable",footCite:"qualifier",header:"header",html:"comment",image:"string",italic:"em",link:"link",linkDefinition:"link",list1:"variable-2",list2:"variable-3",list3:"keyword",notextile:"string-2",pre:"operator",p:"property",quote:"bracket",span:"quote",specialChar:"tag",strong:"strong",sub:"builtin",sup:"builtin",table:"variable-3",tableHeading:"operator"};Parser.prototype.eat=function(name){return this.stream.match(this.regExpFactory.pattern(name),!0)},Parser.prototype.check=function(name){return this.stream.match(this.regExpFactory.pattern(name),!1)},Parser.prototype.setModeForNextToken=function(mode){return this.state.mode=mode},Parser.prototype.execMode=function(newMode){return this.setModeForNextToken(newMode).call(this)},Parser.prototype.startNewLine=function(){this.setModeForNextToken(Modes.newLayout),this.state.tableHeading=!1,"definitionList"===this.state.layoutType&&this.state.spanningLayout&&this.check("definitionListEnd")&&(this.state.spanningLayout=!1)},Parser.prototype.nextToken=function(){return this.state.mode.call(this)},Parser.prototype.styleFor=function(token){if(this.styles.hasOwnProperty(token))return this.styles[token];throw"unknown token"},Parser.prototype.handlePhraseModifier=function(ch){if("_"===ch)return this.stream.eat("_")?this.togglePhraseModifier("italic",/^.*__/):this.togglePhraseModifier("em",/^.*_/);if("*"===ch)return this.stream.eat("*")?this.togglePhraseModifier("bold",/^.*\*\*/):this.togglePhraseModifier("strong",/^.*\*/);if("["===ch)return this.stream.match(/\d+\]/)&&(this.state.footCite=!0),this.tokenStyles();if("("===ch)return this.stream.match("r)")?this.state.specialChar="r":this.stream.match("tm)")?this.state.specialChar="tm":this.stream.match("c)")&&(this.state.specialChar="c"),this.tokenStyles();if("<"===ch&&this.stream.match(/(\w+)[^>]+>[^<]+<\/\1>/))return this.tokenStylesWith(this.styleFor("html"));if("?"===ch&&this.stream.eat("?"))return this.togglePhraseModifier("cite",/^.*\?\?/);if("="===ch&&this.stream.eat("="))return this.togglePhraseModifier("notextile",/^.*==/);if("-"===ch)return this.togglePhraseModifier("deletion",/^.*-/);if("+"===ch)return this.togglePhraseModifier("addition",/^.*\+/);if("~"===ch)return this.togglePhraseModifier("sub",/^.*~/);if("^"===ch)return this.togglePhraseModifier("sup",/^.*\^/);if("%"===ch)return this.togglePhraseModifier("span",/^.*%/);if("@"===ch)return this.togglePhraseModifier("code",/^.*@/);if("!"===ch){var type=this.togglePhraseModifier("image",/^.*(?:\([^\)]+\))?!/);return this.stream.match(/^:\S+/),type}return this.tokenStyles()},Parser.prototype.togglePhraseModifier=function(phraseModifier,closeRE){if(this.state[phraseModifier]){var type=this.tokenStyles();return this.state[phraseModifier]=!1,type}return this.stream.match(closeRE,!1)&&(this.state[phraseModifier]=!0,this.setModeForNextToken(Modes.attributes)),this.tokenStyles()},Parser.prototype.tokenStyles=function(){var disabled=this.textileDisabled(),styles=[];return disabled?disabled:(this.state.layoutType&&styles.push(this.styleFor(this.state.layoutType)),styles=styles.concat(this.activeStyles("addition","bold","cite","code","deletion","em","footCite","image","italic","link","span","specialChar","strong","sub","sup","table","tableHeading")),"header"===this.state.layoutType&&styles.push(this.styleFor("header")+"-"+this.state.header),styles.length?styles.join(" "):null)},Parser.prototype.textileDisabled=function(){var type=this.state.layoutType;switch(type){case"notextile":case"code":case"pre":return this.styleFor(type);default:return this.state.notextile?this.styleFor("notextile")+(type?" "+this.styleFor(type):""):null}},Parser.prototype.tokenStylesWith=function(extraStyles){var type,disabled=this.textileDisabled();return disabled?disabled:(type=this.tokenStyles(),extraStyles?type?type+" "+extraStyles:extraStyles:type)},Parser.prototype.activeStyles=function(){var i,styles=[];for(i=0;i<arguments.length;++i)this.state[arguments[i]]&&styles.push(this.styleFor(arguments[i]));return styles},Parser.prototype.blankLine=function(){var key,spanningLayout=this.state.spanningLayout,type=this.state.layoutType;for(key in this.state)this.state.hasOwnProperty(key)&&delete this.state[key];this.setModeForNextToken(Modes.newLayout),spanningLayout&&(this.state.layoutType=type,this.state.spanningLayout=!0)},RegExpFactory.prototype.pattern=function(name){return this.cache[name]||this.createRe(name)},RegExpFactory.prototype.createRe=function(name){switch(name){case"drawTable":return this.makeRe("^",this.single.drawTable,"$");case"html":return this.makeRe("^",this.single.html,"(?:",this.single.html,")*","$");case"linkDefinition":return this.makeRe("^",this.single.linkDefinition,"$");case"listLayout":return this.makeRe("^",this.single.list,this.pattern("allAttributes"),"*\\s+");case"tableCellAttributes":return this.makeRe("^",this.choiceRe(this.single.tableCellAttributes,this.pattern("allAttributes")),"+\\.");case"type":return this.makeRe("^",this.pattern("allTypes"));case"typeLayout":return this.makeRe("^",this.pattern("allTypes"),this.pattern("allAttributes"),"*\\.\\.?","(\\s+|$)");case"attributes":return this.makeRe("^",this.pattern("allAttributes"),"+");case"allTypes":return this.choiceRe(this.single.div,this.single.foot,this.single.header,this.single.bc,this.single.bq,this.single.notextile,this.single.pre,this.single.table,this.single.para);case"allAttributes":return this.choiceRe(this.attributes.selector,this.attributes.css,this.attributes.lang,this.attributes.align,this.attributes.pad);default:return this.makeRe("^",this.single[name])}},RegExpFactory.prototype.makeRe=function(){var i,arg,pattern="";for(i=0;i<arguments.length;++i)arg=arguments[i],pattern+="string"==typeof arg?arg:arg.source;return new RegExp(pattern)},RegExpFactory.prototype.choiceRe=function(){var i,parts=[arguments[0]];for(i=1;i<arguments.length;++i)parts[2*i-1]="|",parts[2*i]=arguments[i];return parts.unshift("(?:"),parts.push(")"),this.makeRe.apply(this,parts)};var Modes={newLayout:function(){if(this.check("typeLayout"))return this.state.spanningLayout=!1,this.execMode(Modes.blockType);if(!this.textileDisabled()){if(this.check("listLayout"))return this.execMode(Modes.list);if(this.check("drawTable"))return this.execMode(Modes.table);if(this.check("linkDefinition"))return this.execMode(Modes.linkDefinition);if(this.check("definitionList"))return this.execMode(Modes.definitionList);if(this.check("html"))return this.execMode(Modes.html)}return this.execMode(Modes.text)},blockType:function(){var match,type;return this.state.layoutType=null,(match=this.eat("type"))?(type=match[0],(match=type.match(this.regExpFactory.pattern("header")))?(this.state.layoutType="header",this.state.header=parseInt(match[0][1])):type.match(this.regExpFactory.pattern("bq"))?this.state.layoutType="quote":type.match(this.regExpFactory.pattern("bc"))?this.state.layoutType="code":type.match(this.regExpFactory.pattern("foot"))?this.state.layoutType="footnote":type.match(this.regExpFactory.pattern("notextile"))?this.state.layoutType="notextile":type.match(this.regExpFactory.pattern("pre"))?this.state.layoutType="pre":type.match(this.regExpFactory.pattern("div"))?this.state.layoutType="div":type.match(this.regExpFactory.pattern("table"))&&(this.state.layoutType="table"),this.setModeForNextToken(Modes.attributes),this.tokenStyles()):this.execMode(Modes.text)},text:function(){if(this.eat("text"))return this.tokenStyles();var ch=this.stream.next();return'"'===ch?this.execMode(Modes.link):this.handlePhraseModifier(ch)},attributes:function(){return this.setModeForNextToken(Modes.layoutLength),this.eat("attributes")?this.tokenStylesWith(this.styleFor("attributes")):this.tokenStyles()},layoutLength:function(){return this.stream.eat(".")&&this.stream.eat(".")&&(this.state.spanningLayout=!0),this.setModeForNextToken(Modes.text),this.tokenStyles()},list:function(){var listMod,match=this.eat("list");return this.state.listDepth=match[0].length,listMod=(this.state.listDepth-1)%3,listMod?1===listMod?this.state.layoutType="list2":this.state.layoutType="list3":this.state.layoutType="list1",this.setModeForNextToken(Modes.attributes),this.tokenStyles()},link:function(){return this.setModeForNextToken(Modes.text),this.eat("link")?(this.stream.match(/\S+/),this.tokenStylesWith(this.styleFor("link"))):this.tokenStyles()},linkDefinition:function(){return this.stream.skipToEnd(),this.tokenStylesWith(this.styleFor("linkDefinition"))},definitionList:function(){return this.eat("definitionList"),this.state.layoutType="definitionList",this.stream.match(/\s*$/)?this.state.spanningLayout=!0:this.setModeForNextToken(Modes.attributes),this.tokenStyles()},html:function(){return this.stream.skipToEnd(),this.tokenStylesWith(this.styleFor("html"))},table:function(){return this.state.layoutType="table",this.execMode(Modes.tableCell)},tableCell:function(){return this.eat("tableHeading")?this.state.tableHeading=!0:this.stream.eat("|"),this.setModeForNextToken(Modes.tableCellAttributes),this.tokenStyles()},tableCellAttributes:function(){return this.setModeForNextToken(Modes.tableText),this.eat("tableCellAttributes")?this.tokenStylesWith(this.styleFor("attributes")):this.tokenStyles()},tableText:function(){return this.eat("tableText")?this.tokenStyles():"|"===this.stream.peek()?(this.setModeForNextToken(Modes.tableCell),this.tokenStyles()):this.handlePhraseModifier(this.stream.next())}};CodeMirror.defineMode("textile",function(){var regExpFactory=new RegExpFactory;return{startState:function(){return{mode:Modes.newLayout}},token:function(stream,state){var parser=new Parser(regExpFactory,state,stream);return stream.sol()&&parser.startNewLine(),parser.nextToken()},blankLine:function(state){new Parser(regExpFactory,state).blankLine()}}}),CodeMirror.defineMIME("text/x-textile","textile")});