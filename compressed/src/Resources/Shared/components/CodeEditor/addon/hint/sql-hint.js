!function(mod){"object"==typeof exports&&"object"==typeof module?mod(require("../../lib/codemirror"),require("../../mode/sql/sql")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","../../mode/sql/sql"],mod):mod(CodeMirror)}(function(CodeMirror){"use strict";function getKeywords(editor){var mode=editor.doc.modeOption;return"sql"===mode&&(mode="text/x-sql"),CodeMirror.resolveMode(mode).keywords}function match(string,word){var len=string.length,sub=word.substr(0,len);return string.toUpperCase()===sub.toUpperCase()}function addMatches(result,search,wordlist,formatter){for(var word in wordlist)wordlist.hasOwnProperty(word)&&(Array.isArray(wordlist)&&(word=wordlist[word]),match(search,word)&&result.push(formatter(word)))}function nameCompletion(result,editor){var cur=editor.getCursor(),token=editor.getTokenAt(cur),useBacktick="`"==token.string.charAt(0),string=token.string.substr(1),prevToken=editor.getTokenAt(Pos(cur.line,token.start));if("."==token.string.charAt(0)||"."==prevToken.string){if("."==prevToken.string)var prevToken=editor.getTokenAt(Pos(cur.line,token.start-1));var table=prevToken.string,useBacktickTable=!1;table.match(/`/g)&&(useBacktickTable=!0,table=table.replace(/`/g,"")),tables.hasOwnProperty(table)||(table=findTableByAlias(table,editor));var columns=tables[table];if(!columns)return;useBacktick?addMatches(result,string,columns,function(w){return"`"+w+"`"}):useBacktickTable?addMatches(result,string,columns,function(w){return".`"+w+"`"}):addMatches(result,string,columns,function(w){return"."+w})}else{for(;token.start&&"."==string.charAt(0);)token=editor.getTokenAt(Pos(cur.line,token.start-1)),string=token.string+string;useBacktick?(addMatches(result,string,tables,function(w){return"`"+w+"`"}),addMatches(result,string,defaultTable,function(w){return"`"+w+"`"})):(addMatches(result,string,tables,function(w){return w}),addMatches(result,string,defaultTable,function(w){return w}))}}function eachWord(lineText,f){if(lineText)for(var excepted=/[,;]/g,words=lineText.split(" "),i=0;i<words.length;i++)f(words[i]?words[i].replace(excepted,""):"")}function convertCurToNumber(cur){return cur.line+cur.ch/Math.pow(10,6)}function convertNumberToCur(num){return Pos(Math.floor(num),+num.toString().split(".").pop())}function findTableByAlias(alias,editor){for(var doc=editor.doc,fullQuery=doc.getValue(),aliasUpperCase=alias.toUpperCase(),previousWord="",table="",separator=[],validRange={start:Pos(0,0),end:Pos(editor.lastLine(),editor.getLineHandle(editor.lastLine()).length)},indexOfSeparator=fullQuery.indexOf(CONS.QUERY_DIV);indexOfSeparator!=-1;)separator.push(doc.posFromIndex(indexOfSeparator)),indexOfSeparator=fullQuery.indexOf(CONS.QUERY_DIV,indexOfSeparator+1);separator.unshift(Pos(0,0)),separator.push(Pos(editor.lastLine(),editor.getLineHandle(editor.lastLine()).text.length));for(var prevItem=0,current=convertCurToNumber(editor.getCursor()),i=0;i<separator.length;i++){var _v=convertCurToNumber(separator[i]);if(current>prevItem&&current<=_v){validRange={start:convertNumberToCur(prevItem),end:convertNumberToCur(_v)};break}prevItem=_v}for(var query=doc.getRange(validRange.start,validRange.end,!1),i=0;i<query.length;i++){var lineText=query[i];if(eachWord(lineText,function(word){var wordUpperCase=word.toUpperCase();wordUpperCase===aliasUpperCase&&tables.hasOwnProperty(previousWord)&&(table=previousWord),wordUpperCase!==CONS.ALIAS_KEYWORD&&(previousWord=word)}),table)break}return table}var tables,defaultTable,keywords,CONS={QUERY_DIV:";",ALIAS_KEYWORD:"AS"},Pos=CodeMirror.Pos;CodeMirror.registerHelper("hint","sql",function(editor,options){tables=options&&options.tables||{};var defaultTableName=options&&options.defaultTable;defaultTable=defaultTableName&&tables[defaultTableName]||[],keywords=keywords||getKeywords(editor);var start,end,search,cur=editor.getCursor(),result=[],token=editor.getTokenAt(cur);return token.string.match(/^[.`\w@]\w*$/)?(search=token.string,start=token.start,end=token.end):(start=end=cur.ch,search=""),"."==search.charAt(0)||"`"==search.charAt(0)?nameCompletion(result,editor):(addMatches(result,search,tables,function(w){return w}),addMatches(result,search,defaultTable,function(w){return w}),addMatches(result,search,keywords,function(w){return w.toUpperCase()})),{list:result,from:Pos(cur.line,start),to:Pos(cur.line,end)}})});