"undefined"!=typeof window.dnn&&null!==window.dnn||(window.dnn={}),function($,window,document,undefined){"use strict";var DropDownList=this.DropDownList=function(element,options,controller){this.element=element,this.options=options,this._controller=controller,this.init()};DropDownList.prototype={constructor:DropDownList,init:function(){this.options=$.extend({},DropDownList.defaults(),this.options),this.$this=$(this),this.$element=this.element?$(this.element):this._createLayout(),this._$selectedItemContainer=this.$element.find("."+this.options.selectedItemCss),this._$selectedItemCaption=this._$selectedItemContainer.find("."+this.options.selectedValueCss),this._onOpenItemListHandler=$.proxy(this._onOpenItemList,this),this._onCloseItemListHandler=$.proxy(this._onCloseItemList,this),this._onSelectedItemCaptionClickHandler=$.proxy(this._onSelectedItemCaptionClick,this),this._onDocumentClickHandler=$.proxy(this._onDocumentClick,this),this._$selectedItemCaption.on("click",this._onSelectedItemCaptionClickHandler),this._state=new StateField(this.options.initialState,this.options.internalStateFieldId);var stateValue=this._state.val();this._setSelectedItemCaption(stateValue?stateValue.selectedItem:null),this.disabled(this.options.disabled),this._id=dnn.guid()},_createLayout:function(){var layout=$("<div id='"+(this.options.containerId||dnn.uid())+"' class='"+this.options.containerCss+"'/>").append($("<div class='"+this.options.selectedItemCss+"'/>").append($("<a href='javascript:void(0);' class='"+this.options.selectedValueCss+"'/>")));return layout},id:function(){return this.$element.attr("id")},selectedItem:function(item){if("undefined"==typeof item){var state=this._state.val();return state?state.selectedItem:null}return this._state.val({selectedItem:item}),this._setSelectedItemCaption(item),this._treeView&&this._treeView.selectedId(item?item.key:null),this.$element.trigger("selectedItemChanged",item),item},selectedPath:function(){return this._treeView?this._treeView.selectedPath():[]},disabled:function(disable){return"undefined"!=typeof disable&&(disable?(this._selectedItemTitle=this._$selectedItemCaption.prop("title"),this._$selectedItemCaption.removeAttr("href").removeAttr("title")):this._$selectedItemCaption.prop("href","javascript:void(0);").prop("title",this._selectedItemTitle||""),this._disabled=disable),this._disabled},refresh:function(parentId){this.options.services.parameters.parentId=parentId,this._treeView&&(this._treeView._showTree(),this._treeView._dynamicTree.updateLayout())},_setSelectedItemCaption:function(item){var caption=item?item.value:"";this._$selectedItemCaption.text(caption||this.options.selectItemDefaultText)},_onOpenItemList:function(){this._$selectedItemCaption.addClass(this.options.openedItemListCss),$(document).on("click."+this._id,this._onDocumentClickHandler),this._treeView._dynamicTree.scrollToSelectedNode()},_onCloseItemList:function(){this._$selectedItemCaption.removeClass(this.options.openedItemListCss),$(document).off("click."+this._id,this._onDocumentClickHandler),this._$treeViewLayout.detach()},_openItemList:function(){var showTreeView=!1;this._treeView||(this._treeView=this._createTreeView(),this._$treeViewLayout=this._treeView.$element,showTreeView=!0),$.inContainer(this.$element,this._$treeViewLayout[0])||this.$element[0].appendChild(this._$treeViewLayout[0]),showTreeView&&this._treeView.show(),this._$treeViewLayout.slideDown(this.options.openItemListSpeed,this._onOpenItemListHandler)},_isItemListOpen:function(){return this._$treeViewLayout&&this._$treeViewLayout.is(":visible")},_closeItemList:function(){this._$treeViewLayout.slideUp(this.options.closeItemListSpeed,this._onCloseItemListHandler)},_onSelectedItemCaptionClick:function(eventObject){this._disabled||(this._isItemListOpen()?this._closeItemList():this._openItemList())},_onDocumentClick:function(eventObject){var clickedElement=eventObject.target;!$.inContainer(this.$element,clickedElement)&&this._isItemListOpen()&&this._closeItemList()},_createTreeView:function(){var controller=this._controller?this._controller:new dnn.DynamicTreeViewController(this.options.services),treeView=new dnn.SortableTreeView(null,this.options.itemList,controller),onChangeNodeHandler=$.proxy(this._onChangeNode,this),onSelectNodeHandler=$.proxy(this._onSelectNode,this),onTreeLoadedHandler=$.proxy(this._onTreeLoaded,this),onShowChildrenHandler=$.proxy(this._onShowChildren,this),onRequestExpandHandler=$.proxy(this._onRequestExpand,this);$(treeView).on("onchangenode",onChangeNodeHandler).on("onselectnode",onSelectNodeHandler).on("ontreeloaded",onTreeLoadedHandler).on("onloadchildren",onTreeLoadedHandler).on("onshowchildren",onShowChildrenHandler).on("onrequestexpand",onRequestExpandHandler);var item=this.selectedItem();return treeView.selectedId(item?item.key:null),treeView},_onTreeLoaded:function(){var id=this.$element[0].id;if(id){var expandPath=dnn.getVar(id+"_expandPath");if(null==expandPath&&$(this._treeView).off("onshowchildren"),expandPath&&expandPath.length>0){var position=expandPath.indexOf(",")>-1?expandPath.indexOf(","):expandPath.length,nodeId=expandPath.substr(0,position),leftPath=expandPath.substr(position);leftPath.length>1&&","==leftPath[0]&&(leftPath=leftPath.substr(1)),dnn.setVar(id+"_expandPath",leftPath);var dynamicTree=this._treeView._dynamicTree,node=dynamicTree._getNodeById(nodeId);if(node){var expandIcon=dynamicTree._tree.getNodeElement(node).children(":first");expandIcon.hasClass(dynamicTree.options.expandedCss)?this._onTreeLoaded():expandIcon.trigger("click")}}}},_onShowChildren:function(){this._treeView._dynamicTree.scrollToSelectedNode();var id=this.$element[0].id;if(id){var expandPath=dnn.getVar(id+"_expandPath");expandPath||$(this._treeView).off("onshowchildren")}},_onRequestExpand:function(){this._onTreeLoaded()},_onSelectNode:function(eventObject,node){this._closeItemList()},_onChangeNode:function(eventObject,node){var item=node?dnn.TreeNodeConverter.toKeyValue(node.data):null;if(this.selectedItem(item),this.options.onSelectionChanged&&this.options.onSelectionChanged.length)for(var i=0,size=this.options.onSelectionChanged.length;i<size;i++)dnn.executeFunctionByName(this.options.onSelectionChanged[i],window,item,eventObject.target.$element);"function"==typeof this.options.onSelectionChangedBackScript&&this.options.onSelectionChangedBackScript.apply(this),this.$this.trigger($.Event("onchangenode"),[item])}},DropDownList._defaults={containerCss:"dnnDropDownList",selectedItemCss:"selected-item",selectedValueCss:"selected-value",openedItemListCss:"opened",openItemListSpeed:"fast",closeItemListSpeed:"fast"},DropDownList.defaults=function(settings){return"undefined"!=typeof settings&&$.extend(DropDownList._defaults,settings),DropDownList._defaults};var StateField=this.StateField=function(initialState,stateElementId){stateElementId&&(this._stateElement=document.getElementById(stateElementId)),this.val(initialState)};StateField.prototype={constructor:StateField,val:function(stateObject){if("undefined"==typeof stateObject){if("undefined"==typeof this._state)try{this._state=this._stateElement&&this._stateElement.value?JSON.parse(this._stateElement.value):null}catch(ex){}return this._state}if(this._stateElement){var stateAsJson=stateObject?JSON.stringify(stateObject):"";this._stateElement.value=stateAsJson}return this._state=stateObject,this._state}}}.apply(dnn,[jQuery,window,document]),dnn.createDropDownList=function(selector,options,methods){$(document).ready(function(){var $element=$(selector);if(0!==$element.length){$.extend(options,methods);var element=$element[0],instance=new dnn.DropDownList(element,options);element.id&&(dnn[element.id]=instance)}})};