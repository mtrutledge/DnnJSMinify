!function($,ko){"use strict";$.fn.userFileManager=function(options){function fileManagerModel(items){var self=this,data=items;self.items=ko.observableArray(data),self.chosenFolderId=ko.observable(),self.chosenFolderData=ko.observable(),self.chosenFileData=ko.observable(),self.nameHeaderText=ko.observable(),self.typeHeaderText=ko.observable(),self.lastModifiedHeaderText=ko.observable(),self.fileSizeText=ko.observable(),self.find=function(array,id){if(array)for(var i=0;i<array.length;i++){if(array[i].id===id)return array[i];var a=self.find(array[i].children,id);if(null!==a)return a}return null},self.goToFolder=function(folder){self.chosenFileData(null),$wrap.data("chosenFileData",null),self.chosenFolderData(self.find(data,folder.id)),self.chosenFolderId(folder.id)},self.updateItems=function(newItems){data=newItems,self.items=ko.observable(newItems),self.goToFolder(newItems[0])},self.showFilePreview=function(file){self.chosenFileData(file),$wrap.data("chosenFileData",file)},self.attachFile=function(file){opts.attachCallback(file),$wrap.dialog("close")},ko.bindingHandlers.updateRowNumbers={update:function(){$("#"+$wrap.attr("id")+" tbody tr").each(function(i){$(this).find("td.fm-number").text(i+1)})}},self.currentBreadcrumbs=ko.computed(function(){for(var result=[],current=self.chosenFolderData();current;)result.unshift(current),current=current.parentId?self.find(data,current.parentId):null;return result},self),self.nameHeaderText=opts.nameHeaderText,self.typeHeaderText=opts.typeHeaderText,self.lastModifiedHeaderText=opts.lastModifiedHeaderText,self.fileSizeText=opts.fileSizeText,self.goToFolder(data[0])}function getItems(callback){$.get(opts.getItemsServiceUrl,{fileExtensions:$wrap.data("fileExtensions")},callback)}var opts=$.extend({},$.fn.userFileManager.defaultOptions,options),$wrap=$(this),templateUrl=opts.templatePath+opts.templateName+opts.templateExtension;$.get(templateUrl,function(data){$wrap.html(data)}),$wrap.css("display","none"),$(opts.openTriggerScope).delegate(opts.openTriggerSelector,"click",function(e){e.preventDefault(),getItems(function(result){if($wrap.data("userFileManager.bound")===!0){var boundDomElement=$wrap.get(0),context=ko.contextFor(boundDomElement);context.$root.updateItems(result)}else ko.applyBindings(new fileManagerModel(result),document.getElementById($wrap.attr("id"))),$wrap.data("userFileManager.bound",!0)}),$wrap.dialog({dialogClass:opts.dialogClass,width:opts.width,minHeight:opts.minHeight,title:opts.title,modal:!0,resizable:!0,open:function(event,ui){var $div=$("<div />",{class:"fm-actions"}),$actionList=$("<ul />",{class:"dnnActions"});$("<a />",{class:"dnnSecondaryAction",text:opts.cancelText,href:"#"}).appendTo($actionList).click(function(ev){ev.preventDefault(),$(event.target).dialog("close")}),$("<a />",{class:"dnnPrimaryAction",text:opts.attachText,href:"#"}).appendTo($actionList).click(function(ev){ev.preventDefault();var file=$wrap.data("chosenFileData");file&&(opts.attachCallback(file),$(event.target).dialog("close"))}),$actionList.appendTo($div),$wrap.dialog("widget").find(".ui-dialog-buttonpane").empty(),$div.appendTo($wrap.dialog("widget").find(".ui-dialog-buttonpane")),$wrap.dialog("widget").find(".ui-dialog-buttonset").hide(),"function"==typeof $.ui.dialog.prototype.options.open&&$.ui.dialog.prototype.options.open()},buttons:[{}],close:function(){}})}),$.fn.userFileManager.setFileExtensions=function(fileExtensions){$wrap.data("fileExtensions",fileExtensions)}},$.fn.userFileManager.defaultOptions={openTriggerScope:"body",openTriggerSelector:"#photoFromSite",dialogClass:"dnnFormPopup fileManagerPopup",width:"700px",minHeight:"400px",getItemsServiceUrl:"/DesktopModules/Journal/API/UserFile/GetItems",attachCallback:function(file){alert(file.name+" attached.")},templatePath:"/Resources/Shared/Components/UserFileManager/Templates/",templateName:"Default",templateExtension:".html",title:"My Files",cancelText:"Cancel",attachText:"Attach",nameHeaderText:"Name",typeHeaderText:"Type",lastModifiedHeaderText:"Last Modified",fileSizeText:"File size: "}}(jQuery,ko);