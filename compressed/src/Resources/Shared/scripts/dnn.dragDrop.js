!function($){$.fn.dnnModuleDragDrop=function(options){var isEditMode=$("body").hasClass("dnnEditState");if(!isEditMode)return $(function(){$(".DNNEmptyPane").each(function(){$(this).removeClass("DNNEmptyPane").addClass("dnnDropEmptyPanes")}),$(".contentPane").each(function(){this.className=this.className})}),this;var settings={actionMenu:"div.actionMenu",cursor:"move",draggingHintText:"DraggingHintText",dragHintText:"DragHintText",dropOnEmpty:!0,dropHintText:"DropHintText",dropTargetText:"DropModuleText"};settings=$.extend(settings,options||{});for(var paneModuleIndex,modulePaneName,mid,$module,$self=this,tabId=settings.tabId,$modules=$(".DnnModule"),getModuleId=function($mod){return $mod.find("a").first().attr("name")},getModuleIndex=function(moduleId,$pane){for(var index=-1,modules=$pane.children(".DnnModule"),i=0;i<modules.length;i++){var module=modules[i];if(mid=getModuleId($(module)),moduleId==parseInt(mid)){index=i;break}}return index},updateServer=function(moduleId,$pane,callback){var order,paneName=$pane.attr("id").substring(4),index=getModuleIndex(moduleId,$pane);order=paneName!==modulePaneName?2*index:index>paneModuleIndex?2*(index+1):2*index;var dataVar={TabId:tabId,ModuleId:moduleId,Pane:paneName,ModuleOrder:order},service=$.dnnSF(),serviceUrl=$.dnnSF().getServiceRoot("InternalServices")+"ModuleService/";$.ajax({url:serviceUrl+"MoveModule",type:"POST",data:dataVar,beforeSend:service.setModuleHeaders,success:function(){"function"==typeof callback?callback.call($pane):window.location.reload()},error:function(){}})},moduleNo=0;moduleNo<$modules.length;moduleNo++)$module=$($modules[moduleNo]),mid=getModuleId($module),0===$module.find(".dnnDragHint").length&&$module.prepend('<div class="dnnDragHint"></div>'),$module.find(".dnnDragHint").dnnHelperTip({helpContent:settings.dragHintText,holderId:"ModuleDragToolTip-"+mid});var originalPane=null,allDnnSortableEmpty=!0;return $(".dnnSortable").each(function(n,v){return!$.trim($(v).html()).length||(allDnnSortableEmpty=!1,!1)}),allDnnSortableEmpty?($(function(){$(".DNNEmptyPane").each(function(){$(this).removeClass("DNNEmptyPane").addClass("dnnDropEmptyPanes")}),$(".contentPane").each(function(){this.className=this.className})}),$self.droppable({tolerance:"pointer",over:function(event,ui){$(this).append("<div class='dnnDropTarget'><p>"+settings.dropTargetText+"("+$(this).attr("id").substring(4)+")</p></div>")},out:function(event,ui){$(this).empty()},drop:function(event,ui){var dropItem=ui.draggable,pane=$(this).empty(),order=0,paneName=pane.attr("id").substring(4);dropItem.remove(),dnn.controlBar&&dnn.controlBar.addModule(dnn.controlBar.dragdropModule+"",dnn.controlBar.dragdropPage,paneName,"-1",order+"",dnn.controlBar.dragdropVisibility+"",dnn.controlBar.dragdropAddExistingModule+"",dnn.controlBar.dragdropCopyModule+"")}}),$self):($("div.dnnDragHint").mousedown(function(){$(".DNNEmptyPane").each(function(){$(this).removeClass("DNNEmptyPane").addClass("dnnDropEmptyPanes")}),$(".contentPane").each(function(){this.className=this.className})}).mouseup(function(){$(".dnnDropEmptyPanes").each(function(){$(this).removeClass("dnnDropEmptyPanes").addClass("DNNEmptyPane")}),$(".contentPane").each(function(){this.className=this.className})}),$self.sortable({connectWith:".dnnSortable",dropOnEmpty:settings.dropOnEmpty,cursor:settings.cursor,cursorAt:{left:10,top:30},handle:"div.dnnDragHint",placeholder:"dnnDropTarget",tolerance:"pointer",helper:function(event,ui){var dragTip=$('<div class="dnnDragdropTip ControlBar_DragdropModule"></div>'),title=$("span.Head",ui).html();return title||(title="The Dragging Module"),dragTip.html(title),$("body").append(dragTip),dragTip},start:function(event,ui){var $pane=ui.item.parent();originalPane=$pane,modulePaneName=$pane.attr("id").substring(4),mid=getModuleId(ui.item),paneModuleIndex=getModuleIndex(mid,$pane);var $dropTarget=$(".dnnDropTarget");$dropTarget.append("<p>"+settings.dropTargetText+"("+modulePaneName+")</p>"),$(settings.actionMenu).hide()},over:function(event,ui){var $dropTarget=$(".dnnDropTarget");$dropTarget.empty().append("<p>"+settings.dropTargetText+"("+$(this).attr("id").substring(4)+")</p>")},stop:function(event,ui,callback){var dropItem=ui.item;if(dnn.controlBar&&dropItem.hasClass("ControlBar_ModuleDiv")){var pane=ui.item.parent(),order=-1,paneName=pane.attr("id").substring(4);if($("div.DnnModule",pane).length>0)for(var modules=$("div.DnnModule, div.ControlBar_ModuleDiv",pane),i=0;i<modules.length;i++){var module=modules.get(i);$(module).hasClass("ControlBar_ModuleDiv")&&(order=i)}dropItem.remove(),dnn.controlBar.addModule(dnn.controlBar.dragdropModule+"",dnn.controlBar.dragdropPage,paneName,"-1",order+"",dnn.controlBar.dragdropVisibility+"",dnn.controlBar.dragdropAddExistingModule+"",dnn.controlBar.dragdropCopyModule+"")}else mid=getModuleId(dropItem),updateServer(mid,dropItem.parent(),callback),$(settings.actionMenu).show(),dropItem.parent().removeClass("dnnDropEmptyPanes"),originalPane&&0===$("div",originalPane).length&&originalPane.addClass("dnnDropEmptyPanes"),callback||(dropItem.css("background-color","#fffacd"),setTimeout(function(){dropItem.css("background","#fffff0"),setTimeout(function(){dropItem.css("background","transparent")},300)},2500)),$('div[data-tipholder="ModuleDragToolTip-'+mid+'"] .dnnHelpText').text(settings.dragHintText),$(".dnnDropEmptyPanes").each(function(){$(this).removeClass("dnnDropEmptyPanes").addClass("DNNEmptyPane")}),$(".contentPane").each(function(){this.className=this.className}),$(window).resize()}}),$self)}}(jQuery);