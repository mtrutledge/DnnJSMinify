jQuery(function($){function InitCommon(){$(".required").focusout(function(){if(!$(this).val()){var msgId="#"+$(this).attr("id")+"_error";$(msgId).show()}}),$("#cccardnumber").hcCardInput(".hc-card-icons",function($input){$.post(hcc.getServiceUrl("checkout/CleanCreditCard"),{CardNumber:$input.val()},null,"json").done(function(data){$input.val(data.CardNumber)})})}function ajaxErrorNotification(){$("#loginmessage").html(hcc.l10n.common_AjaxError).attr("class","dnnFormMessage dnnFormError").show()}function IsEmailKnown(forceSwitch,emailfieldid){var emailfield=$(emailfieldid||"#customeremail").val();$.post(hcc.getServiceUrl("checkout/IsEmailKnown"),{email:emailfield},function(data){"1"==data.success?($("#hcLoginSection").show(),$("#loginmessage").html(hcc.l10n.checkout_PleaseLogin).attr("class","dnnFormMessage dnnFormSuccess").slideDown(),forceSwitch&&($("#username").focus(),ClickLoginTab("#hcTabLogin"))):$("#loginmessage").attr("class","dnnFormMessage dnnFormError").slideUp()},"json")}function LoginAjax(){$("#hcLoginSection").ajaxLoader("start"),$("#loginmessage").hide();var username=$("#hcLoginSection #username").val(),passwordfield=$("#hcLoginSection #password").val();$.post(hcc.getServiceUrl("account/AjaxSignIn"),{username:username,password:passwordfield},function(data){"True"==data.Success||1==data.Success?($("#loginmessage").html(hcc.l10n.checkout_LoggedIn).attr("class","dnnFormMessage dnnFormSuccess").show(),$("#hcLoginChoose").hide(),$("#hcTabLogin").hide(),UserLoggedIn()):$("#loginmessage").html(hcc.l10n.checkout_LoginFailed).attr("class","dnnFormMessage dnnFormError").show()},"json").error(function(){ajaxErrorNotification()}).complete(function(){$("#hcLoginSection").ajaxLoader("stop"),location.reload()})}function UserLoggedIn(){$.ajax({type:"POST",url:hcc.getServiceUrl("checkout/getcustomerdata"),dataType:"json",success:function(data){RewardPoints.displayRewardPoints(data.RewardPoints),Addresses.loadAddresses(data.Addresses,data.ShippingAddress,data.BillingAddress)},error:function(data){ajaxErrorNotification()}})}function ChooseLoginTab(loginTabId){$("#loginField").find(".hcTabPane").hide(),$(loginTabId).show()}function ClickLoginTab(loginTabId){$("#hcLoginChoose input[value='"+loginTabId+"']").click()}function CheckConfirmPassword(){$("#regconfirmpassword").val()!=$("#regpassword").val()&&$("#regconfirmpassword_error").show()}function InitLogin(){$("#loginmessage").hide(),$("#customeremail").change(function(){IsEmailKnown()}),$("#regemail").change(function(){IsEmailKnown(!1,"#regemail")}),$("#loginbutton").click(function(){return LoginAjax(),!1}),$("#hcTabLogin").keydown(function(e){13==e.which&&(LoginAjax(),e.stopPropagation(),e.preventDefault())}),$("#hcLoginChoose input").click(function(){ChooseLoginTab($(this).val())}),$("#regconfirmpassword").focusout(function(){CheckConfirmPassword()}),"undefined"!=typeof HCC&&"undefined"!=typeof HCC.CheckoutLogin&&(HCC.CheckoutLogin.LoginTab?ClickLoginTab(HCC.CheckoutLogin.LoginTab):IsEmailKnown(!0))}function RefreshShippingRates(){$("#hcShippingRates").html(""),$("#hcDeliverySection").ajaxLoader("start"),$("#hcShippingNotValid").hide(),$.ajax({type:"POST",url:hcc.getServiceUrl("estimateshipping/getratesasradiobuttons"),data:{country:$("#shippingcountry :selected").val(),firstname:$("#shippingfirstname").val(),lastname:$("#shippinglastname").val(),address:$("#shippingaddress").val(),address2:$("#shippingaddress2").val(),city:$("#shippingcity").val(),zip:$("#shippingzip").val(),state:$("#shippingstate :selected").val(),orderid:$("#orderbvin").val()},dataType:"json",success:function(data){$("#hcDeliverySection").ajaxLoader("stop"),$("#hcShippingRates").html(data.rates),$("#hcShippingRates").show(),$("#hcShippingRates input").attr("tabindex","300"),BindShippingRadioButtons()},error:function(data){$("#hcDeliverySection").ajaxLoader("stop"),$("#hcShippingNotValid").show()}})}function ApplyCurrentShippingRate(){var methodid=$("input[name='shippingrate']:checked").val();OrderSummary.showLoadingProgress();var orderid=$("#orderbvin").val();$.ajax({type:"POST",url:hcc.getServiceUrl("checkout/applyshippingmethod"),data:{MethodId:methodid,OrderId:orderid},dataType:"json",success:function(data){OrderSummary.displayTotals(data.totalsastable),OrderSummary.updateItems(data.orderitems),UpdatePaymentMethods(data.PaymentViewModel),GiftCards.displayGiftCards(data.GiftCards)},error:function(data){OrderSummary.displayTotals("")}})}function BindShippingRadioButtons(){$("input[name = 'shippingrate']").change(function(){ApplyCurrentShippingRate()})}function UpdatePaymentMethods(paymentViewModel){paymentViewModel.NoPaymentNeeded?($("#hcPayment").hide(),$("#hcNoPayment").show(),$("#hcNoPayment input[name=paymethod]").first().prop("checked",!0)):($("#hcPayment").show(),$("#hcNoPayment").hide(),$("#hcNoPayment input[name=paymethod]").first().prop("checked")&&$("#hcPayment input[name=paymethod]").filter(function(){return this.value==paymentViewModel.SelectedMethodId}).prop("checked",!0))}function IsAffiliateValid(fieldId,messageId){var affid=$("#"+fieldId).val();$.post(hcc.getServiceUrl("AffiliateRegistration/IsAffiliateValid"),{affiliateId:affid},function(data){data?$("#"+messageId).slideUp():$("#"+messageId).html(HCC.Affiliate.MessageAffiliateInvalid).slideDown()},"json")}function InitAffiliate(){$("#affiliateid").change(function(){IsAffiliateValid("affiliateid","affiliatemessage")})}var RewardPoints={init:function(){this.$radioButtons=$("input[name = 'userewardspoints']"),this.$rpWrapper=$("#hccRewardPointsWrap"),this.bindEvents()},bindEvents:function(){this.$radioButtons.change(function(e){RewardPoints.changeRewardPoints(e)})},changeRewardPoints:function(e){var self=RewardPoints;OrderSummary.showLoadingProgress(),$.ajax({type:"POST",url:hcc.getServiceUrl("checkout/applyRewardPointsChange"),data:{orderid:$("#orderbvin").val(),userewardspoints:self.$radioButtons.filter(":checked").val()},dataType:"json",success:function(data){OrderSummary.displayTotals(data.totalsastable),UpdatePaymentMethods(data.PaymentViewModel),GiftCards.displayGiftCards(data.GiftCards)},error:function(){}})},displayRewardPoints:function(data){var self=RewardPoints;data.ShowRewards?self.$rpWrapper.show():self.$rpWrapper.hide(),self.$rpWrapper.find("h3").html(data.LabelRewardPoints),self.$rpWrapper.find("label:first").text(data.RewardPointsAvailable),self.updatePointsAmount(data.LabelRewardsUse)},updatePointsAmount:function(points){$("#userewardspointslabel1").text(points)}},Addresses={init:function(){this.isInitializing=!0,this.showDialog=!0,this.$billingWrapper=$("#hcBillingWrapper"),this.$chkShowBilling=$("#chkbillsame"),this.$shAvailableAddresses=$("#shippingAvailableAddresses"),this.$shCountry=$("#shippingcountry"),this.$shState=$("#shippingstate"),this.$shFirstname=$("#shippingfirstname"),this.$shLastname=$("#shippinglastname"),this.$shAddress=$("#shippingaddress"),this.$shAddress2=$("#shippingaddress2"),this.$shCity=$("#shippingcity"),this.$shZip=$("#shippingzip"),this.$shAll=$("#shippingcountry, #shippingstate, #shippingfirstname, #shippinglastname, #shippingaddress, #shippingaddress2, #shippingcity, #shippingzip"),this.$deliveryWarning=$("#hcShippingNotValid"),this.$shippingMessage=$("#hcShippingValidation"),this.shippingNmAddr=null,this.$blAvailableAddresses=$("#billingAvailableAddresses"),this.$blCountry=$("#billingcountry"),this.$blState=$("#billingstate"),this.$blFirstname=$("#billingfirstname"),this.$blLastname=$("#billinglastname"),this.$blAddress=$("#billingaddress"),this.$blAddress2=$("#billingaddress2"),this.$blCity=$("#billingcity"),this.$blZip=$("#billingzip"),this.$blAll=$("#billingcountry, #billingstate, #billingfirstname, #billinglastname, #billingaddress, #billingaddress2, #billingcity, #billingzip"),this.$billingMessage=$("#hcBillingValidation"),this.billingNmAddr=null,this.$submitButton=$("#hcTakeOrder"),this.$dialog=$("#hcNormalizedAddressDlg"),this.$dialogShippingBlock=this.$dialog.find(".hcShipping"),this.$dialogBillingBlock=this.$dialog.find(".hcBilling"),this.$dialogShippingNormalized=this.$dialogShippingBlock.find(".hcNormalizedAddress"),this.$dialogShippingOriginal=this.$dialogShippingBlock.find(".hcOriginalAddress"),this.$dialogShippingRadio=this.$dialogShippingBlock.find("[name='shipping']"),this.$dialogBillingNormalized=this.$dialogBillingBlock.find(".hcNormalizedAddress"),this.$dialogBillingOriginal=this.$dialogBillingBlock.find(".hcOriginalAddress"),this.$dialogBillingRadio=this.$dialogBillingBlock.find("[name='billing']"),this.bindEvents(),this.toggleBilling(),this.shippingChanged(),this.billingChanged(),this.loadRegionsWithSelection($("#shippingstate"),$("#shippingcountry option:selected").val(),$("#shippingtempregion").val(),!this.isInitializing),this.loadRegionsWithSelection($("#billingstate"),$("#billingcountry option:selected").val(),$("#billingtempregion").val(),!this.isInitializing),this.forceAddressChange(),this.isInitializing=!1},bindEvents:function(){var self=this;this.$chkShowBilling.change(function(e){Addresses.toggleBilling(e)}),this.$shAvailableAddresses.change(function(e){Addresses.selectedAddressChanged(e)}),this.$shCountry.change(function(){self.loadRegionsWithSelection(self.$shState,$("#shippingcountry :selected").val(),"")}),this.$shState.change(function(){$("#shippingtempregion").val($(this).val())}),this.$shAll.change(function(e){Addresses.shippingChanged(e)}),this.$blAvailableAddresses.change(function(e){Addresses.selectedAddressChanged(e)}),this.$blCountry.change(function(){self.loadRegionsWithSelection(self.$blState,$("#billingcountry :selected").val(),"")}),this.$blState.change(function(){$("#billingtempregion").val($(this).val())}),this.$blAll.change(function(e){Addresses.billingChanged(e)}),$("#hcSaveNormalizedAction").click(function(e){Addresses.saveNormalized(e)}),this.$submitButton.click(function(e){$.xhrPool.abortAll(),Addresses.save(e)})},toggleBilling:function(e){this.$chkShowBilling.is(":checked")?(this.$billingWrapper.hide(),this.$dialogBillingBlock.hide(),$("#billingField").css("display","none"),$("#billingField").css("visibility","hidden")):(this.$billingWrapper.show(),this.$dialogBillingBlock.show(),$("#billingField").css("display","block"),$("#billingField").css("visibility","visible")),this.billingChanged()},getShippingData:function(){return{country:this.$shCountry.find(":selected").val(),state:this.$shState.find(":selected").val(),firstname:this.$shFirstname.val(),lastname:this.$shLastname.val(),address:this.$shAddress.val(),address2:this.$shAddress2.val(),city:this.$shCity.val(),zip:this.$shZip.val()}},isShippingValid:function(){var data=this.getShippingData();return!this.isEmpty(data.firstname)&&(!this.isEmpty(data.lastname)&&(!this.isEmpty(data.address)&&(!this.isEmpty(data.city)&&!(!data.zip||data.zip.length<1))))},isEmpty:function(input){return!("undefined"==typeof input||input.length>0)},shippingChanged:function(e){$("#hcShippingRates").html(""),this.isShippingValid()?(RefreshShippingRates(),this.$deliveryWarning.hide()):this.$deliveryWarning.show(),this.isInitializing||this.forceAddressChange()},billingChanged:function(e){this.isInitializing||this.forceAddressChange()},handleAddressValidation:function(data){var shRes=data.ShippingValidationResult,blRes=data.BillingValidationResult;this.$shippingMessage.hide(),""!=this.$shAddress.val()&&""!=this.$shCity.val()&&""!=this.$shZip.val()&&""!=this.$shState.val()&&null!=shRes&&null!=shRes.Message&&""!=shRes.Message&&(this.$shippingMessage.html(shRes.Message),this.$shippingMessage.show()),this.$billingMessage.hide(),""!=this.$blAddress.val()&&""!=this.$blCity.val()&&""!=this.$blZip.val()&&""!=this.$blState.val()&&null!=blRes&&null!=blRes.Message&&""!=blRes.Message&&(this.$billingMessage.html(blRes.Message),this.$billingMessage.show())},enableDialog:function(enable){this.showDialog=enable,enable?this.$submitButton.attr("data-nosubmit","true"):this.$submitButton.removeAttr("data-nosubmit")},saveNormalized:function(e){null!=this.shippingNmAddr&&"N"==this.$dialogShippingRadio.filter(":checked").val()&&(this.$shAddress.val(this.shippingNmAddr.Line1),this.$shAddress2.val(this.shippingNmAddr.Line2),this.$shCity.val(this.shippingNmAddr.City),this.$shZip.val(this.shippingNmAddr.PostalCode),this.$shState.val(this.shippingNmAddr.RegionBvin)),null!=this.billingNmAddr&&"N"==this.$dialogBillingRadio.filter(":checked").val()&&(this.$blAddress.val(this.billingNmAddr.Line1),this.$blAddress2.val(this.billingNmAddr.Line2),this.$blCity.val(this.billingNmAddr.City),this.$blZip.val(this.billingNmAddr.PostalCode),this.$blState.val(this.billingNmAddr.RegionBvin)),this.$dialog.hcDialog("close"),this.saveForm()},save:function(e){var self=this;return!this.showDialog||(e.stopPropagation(),e.preventDefault(),$(".hc-checkout").ajaxLoader("start"),this.applyAddressChange(function(res){$(".hc-checkout").ajaxLoader("stop");var shRes=res.ShippingValidationResult,blRes=res.BillingValidationResult,showShippingNm=null!=shRes&&null!=shRes.NormalizedAddress,showBillingNm=null!=blRes&&null!=blRes.NormalizedAddress;showShippingNm||showBillingNm?(showShippingNm?(self.shippingNmAddr=shRes.NormalizedAddress,self.$dialogShippingNormalized.html(shRes.NormalizedAddressHtml),self.$dialogShippingOriginal.html(shRes.OriginalAddressHtml),self.$dialogShippingBlock.show()):self.$dialogShippingBlock.hide(),showBillingNm?(self.billingNmAddr=blRes.NormalizedAddress,self.$dialogBillingNormalized.html(blRes.NormalizedAddressHtml),self.$dialogBillingOriginal.html(blRes.OriginalAddressHtml),self.$dialogBillingBlock.show()):self.$dialogBillingBlock.hide(),showShippingNm&&showBillingNm?self.$dialog.hcDialog({height:"500"}):self.$dialog.hcDialog({height:"300"})):self.saveForm()}),!1)},saveForm:function(){this.enableDialog(!1),this.$submitButton.click()},forceAddressChange:function(){OrderSummary.showLoadingProgress(),this.applyAddressChange(function(data){OrderSummary.displayTotals(data.totalsastable),data.orderitems&&OrderSummary.updateItems(data.orderitems),data.PaymentViewModel&&UpdatePaymentMethods(data.PaymentViewModel)},this.isInitializing)},applyAddressChange:function(callback,isInitializing){$.ajax({type:"POST",url:hcc.getServiceUrl("checkout/applyaddresschange"),data:{shippingcountry:$("#shippingcountry :selected").val(),shippingfirstname:$("#shippingfirstname").val(),shippinglastname:$("#shippinglastname").val(),shippingaddress:$("#shippingaddress").val(),shippingaddress2:$("#shippingaddress2").val(),shippingcity:$("#shippingcity").val(),shippingzip:$("#shippingzip").val(),shippingstate:$("#shippingtempregion").val(),billingcountry:$("#billingcountry :selected").val(),billingfirstname:$("#billingfirstname").val(),billinglastname:$("#billinglastname").val(),billingaddress:$("#billingaddress").val(),billingaddress2:$("#billingaddress2").val(),billingcity:$("#billingcity").val(),billingzip:$("#billingzip").val(),billingstate:$("#billingtempregion").val(),orderid:$("#orderbvin").val(),billshipsame:$("#chkbillsame").is(":checked")},dataType:"json",success:function(data){callback(data),Addresses.handleAddressValidation(data),RewardPoints.updatePointsAmount(data.LabelRewardsUse),GiftCards.displayGiftCards(data.GiftCards)},error:function(){}})},selectedAddressChanged:function(event){var self=this,addressList=$(event.target),addressBvin=addressList.prop("value"),addressTable=addressList.closest(".hcAddressForm");$.ajax({type:"POST",url:hcc.getServiceUrl("checkout/useraddress"),data:{addressBvin:addressBvin},dataType:"json",success:function(data){self.populateAddressData(addressTable,data)},error:function(data){ajaxErrorNotification()}})},populateAddressData:function(adressWrapper,address){var addressbvinField=adressWrapper.find("[id*='addressbvin']");if(address){var countryField=adressWrapper.find("[id*='country']"),firstnameField=adressWrapper.find("[id*='firstname']"),lastnameField=adressWrapper.find("[id*='lastname']"),companyField=adressWrapper.find("[id*='company']"),addressField=adressWrapper.find("[id*='address'][type=text]"),address2Field=adressWrapper.find("[id*='address2'][type=text]"),cityField=adressWrapper.find("[id*='city']"),stateField=adressWrapper.find("[id*='state']"),tempRegionField=adressWrapper.find("[id*='tempregion']"),zipField=adressWrapper.find("[id*='zip']"),phoneField=adressWrapper.find("[id*='phone']");countryField.val(address.CountryBvin),firstnameField.val(address.FirstName),lastnameField.val(address.LastName),companyField.val(address.Company),addressField.val(address.Line1),address2Field.val(address.Line2),cityField.val(address.City),tempRegionField.val(address.RegionBvin),zipField.val(address.PostalCode),phoneField.val(address.Phone),addressbvinField.val(address.Bvin),this.loadRegionsWithSelection(stateField,address.CountryBvin,address.RegionBvin),"shipp"==countryField.attr("name").substring(0,5)?this.shippingChanged():this.billingChanged()}else addressbvinField.val("")},loadAddresses:function(addresses,shippingAddress,billingAddress){var self=this;addresses.length>0&&($(".hcAvailableAddresses").show(),$.each(addresses,function(index,value){var option=$("<option>",{value:value.Bvin,text:value.Line1});self.$shAvailableAddresses.append(option.clone()),self.$blAvailableAddresses.append(option.clone())})),this.populateAddressData($(".hc-shipping-section"),shippingAddress),this.populateAddressData($(".hc-billing-section"),billingAddress),this.$shAvailableAddresses.val(shippingAddress.Bvin),this.$blAvailableAddresses.val(billingAddress.Bvin)},loadRegionsWithSelection:function(regionlist,countryid,selectedregion,raiseChange){$.post(hcc.getServiceUrl("estimateshipping/getregions/"+countryid),{regionid:selectedregion},function(data){regionlist.html(data.Regions);var tempRegion=regionlist.parent().find("[id*='tempregion']");tempRegion.val(selectedregion),raiseChange&&regionlist.change()},"json")}},OrderSummary={init:function(){this.$totals=$("#hcCheckoutTotal")},showLoadingProgress:function(){this.$totals.html(hcc.l10n.checkout_SummaryIsLoading),this.$totals.ajaxLoader("start")},displayTotals:function(totals){this.$totals.ajaxLoader("stop"),this.$totals.html(totals)},updateItems:function(orderItems){$(".hcLineTotal").each(function(i,el){var $el=$(el),$totalBase=$el.find(".hcLineTotalBase"),$totalAdj=$el.find(".hcLineTotalAdjusted"),$lineTax=$el.find(".hcLineTax"),oItem=orderItems[i];oItem.HasAnyDiscounts?$totalBase.show():$totalBase.hide(),$totalBase.text(oItem.LineTotalWithoutDiscounts),$totalAdj.text(oItem.LineTotal),$lineTax.text(oItem.LineTaxPortion)})}},API_ADDGIFTCARD=hcc.getServiceUrl("checkout/AddNewGiftCard"),API_REMOVEGIFTCARD=hcc.getServiceUrl("checkout/RemoveGiftCard"),GiftCards={init:function(){this.$gcPanel=$("#hcGiftCardSection"),this.$addGiftCard=$("#hcGiftCardButton"),this.$txtGiftCard=$("#hcGiftCardNumber"),this.$divSummaryMsg=$("#hcGiftCardSummary"),this.$tblGiftCards=$("#hcGiftCardList"),this.$gcFormItem=$("#hcGiftCardsFormItem"),this.$gcFormAction=$("#hcGiftCardsFormAction"),this.bindEvents()},bindEvents:function(){var self=GiftCards;self.$addGiftCard.click(function(e){self.addGiftCard(e)}),self.$tblGiftCards.on("click",".hc-delete",function(e){self.removeGiftCard(e)})},addGiftCard:function(e){var self=GiftCards;self.$gcPanel.ajaxLoader("start"),OrderSummary.showLoadingProgress(),$.post(API_ADDGIFTCARD,{card:self.$txtGiftCard.val()},null,"json").done(function(data){self.$txtGiftCard.val(""),self.displayGiftCards(data.GiftCards),self.reloadPaymentAndTotals(data.TotalsAsTable,data.PaymentViewModel)}).fail(function(){}).always(function(){self.$gcPanel.ajaxLoader("stop")})},removeGiftCard:function(e){var self=GiftCards,cardNum=$(e.currentTarget).closest("tr").find("td:first").text();self.$gcPanel.ajaxLoader("start"),OrderSummary.showLoadingProgress(),$.post(API_REMOVEGIFTCARD,{card:cardNum},null,"json").done(function(data){self.displayGiftCards(data.GiftCards),self.reloadPaymentAndTotals(data.TotalsAsTable,data.PaymentViewModel)}).fail(function(){}).always(function(){self.$gcPanel.ajaxLoader("stop")})},displayGiftCards:function(gcModel){var self=GiftCards,summary=gcModel.Summary,cards=gcModel.Cards;if(gcModel.ShowGiftCards){""!=summary?(self.$divSummaryMsg.html(summary),self.$divSummaryMsg.show()):self.$divSummaryMsg.hide(),cards.length>0?this.$gcFormItem.show():this.$gcFormItem.hide(),self.$tblGiftCards.find("tr.hcGiftCardRow:visible").remove();for(var $template=self.$tblGiftCards.find(".hcGiftCardRow:hidden"),i=0;i<cards.length;i++){var $row=$template.clone(),$cells=$row.find("td"),card=cards[i];$cells.eq(0).text(card.CardNumber),$cells.eq(1).text(card.Balance),$cells.eq(2).text(card.Charge),$row.show(),self.$tblGiftCards.append($row)}}else""!=summary?(self.$divSummaryMsg.html(summary),self.$divSummaryMsg.show(),self.$gcFormAction.hide()):self.$gcPanel.hide()},reloadPaymentAndTotals:function(totals,payment){OrderSummary.displayTotals(totals),UpdatePaymentMethods(payment)}};OrderSummary.init(),Addresses.init(),InitCommon(),InitLogin(),RewardPoints.init(),InitAffiliate(),GiftCards.init()});