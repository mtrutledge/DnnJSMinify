!function($,window){$.fn.journalComments=function(options){function deleteComment(){var data={};data.JournalId=$id.replace("jcmt-",""),data.CommentId=$(this).parent().attr("id").replace("cmt-",""),Post("CommentDelete",data),$(this).parent().fadeOut(function(){var p=$(this).parent(),id=$(this).attr("id");$(this).animate({height:"0"},400,function(){p.remove("#"+id)})})}function commentComplete(data,journalId){$textarea.animate({height:"0"},400,function(){$button.addClass("disabled").hide(),$textarea.val("").hide(),$placeHolder.show()});var li=$(data);li.insertBefore("#"+$id+" .cmteditarea"),$(li).find(".miniclose").bind("click",deleteComment),bindConfirm()}function Post(method,data,callback,journalId){var sf=opts.servicesFramework;$.ajax({type:"POST",url:sf.getServiceRoot("Journal")+"Services/"+method,beforeSend:sf.setModuleHeaders,data:data,success:function(data){"undefined"!=typeof callback&&callback(data,journalId)},error:function(xhr,status,error){alert(error)}})}$.fn.journalComments.defaultOptions={maxLength:2e3};var opts=$.extend({},$.fn.journalComments.defaultOptions,options),$id=$(this).attr("id"),$maxLength=opts.maxLength,$textarea=$("#"+$id+"-txt"),$placeHolder=$("#"+$id+" .editorPlaceholder"),$button=$("#"+$id+" .cmtbtn a"),$delete=$("#"+$id+" .miniclose");$placeHolder.click(function(){$placeHolder.hide(),$button.addClass("disabled").show(),$textarea.show().animate({height:"+=45"},400,function(){$textarea.focus(),$textarea.bind("keypress",isDirtyHandler)})}),$delete.bind("click",deleteComment),$textarea.bind("paste",function(e){setTimeout(function(){if($textarea.val($textarea.val()),$textarea.val().length>$maxLength){var txt=$textarea.val().substring(0,$maxLength);$textarea.val(txt)}},100),isDirtyHandler(e)});var isDirtyHandler=function(event){$button.removeClass("disabled"),$textarea.unbind("keypress",isDirtyHandler)};$button.click(function(event){event.preventDefault();var jid=$id.replace("jcmt-",""),data={};data.JournalId=jid,data.Comment=encodeURIComponent($textarea.val()),data.mentions=$textarea.data("mentions");var tmpValue=$textarea.val();return tmpValue=tmpValue.replace(/<(?:.|\n)*?>/gm,"").replace(/\s+/g,"").replace(/&nbsp;/g,""),""!=tmpValue&&(""!=data.Comment&&"%3Cbr%3E"!=data.Comment&&void Post("CommentSave",data,commentComplete,jid))})}}(jQuery,window);