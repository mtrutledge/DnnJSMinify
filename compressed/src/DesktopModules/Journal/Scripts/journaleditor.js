!function($,window){$.fn.journalEditor=function(options){function dispose(){$menu.empty(),$menu.hide(),searchIndex=-1,$triggerIndex=-1,triggerPos=0,$search="",$triggered=!1,savedRange=null,$wrap.find("br").remove()}function render(search,data){data=filter(data,search),$menu.empty(),$menu.show(),searchIndex=-1,$.each(data,function(index,item){if("string"==typeof item){var value=item;item={},item.value=value,item.label=value}var li=$("<li></li>").attr("id",item.value).append(item.label).click(function(event){$wrap.focus(),event.preventDefault();var label=$(this).text(),value=$(this).attr("id"),token=$tokens[$triggerIndex].replace("value",value).replace("label",label),end=savedRange.endOffset;createSelection(triggerPos-1,end),insertHtmlAtCursor(token),dispose(),moveCursorToEnd()});$menu.append(li)})}function selectItem(){$wrap.focus();var item={};$menu.children("li").each(function(index){if(index==searchIndex)return item.value=$(this).attr("id"),item.label=$(this).text(),!1}),$wrap.data($triggerIndex,item);var token=$tokens[$triggerIndex].replace("value",item.value).replace("label",item.label),end=savedRange.endOffset;createSelection(triggerPos-1,end),insertHtmlAtCursor(token),dispose(),moveCursorToEnd(),console.log($wrap.data())}function escapeRegex(value){return value.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")}function filter(array,term){var matcher=new RegExp(escapeRegex(term),"i");return $.grep(array,function(value){return matcher.test(value.label||value.value||value)})}function insertHtmlAtCursor(html){var range,node;if(window.getSelection&&window.getSelection().getRangeAt)if(range=window.getSelection().getRangeAt(0),range.deleteContents(),range.createContextualFragment)node=range.createContextualFragment(html),range.insertNode(node);else{var range=document.selection.createRange();range.pasteHTML(html)}else document.selection&&document.selection.createRange&&document.selection.createRange().pasteHTML(html)}function saveSelection(){window.getSelection?savedRange=window.getSelection().getRangeAt(0):document.selection&&(savedRange=document.selection.createRange())}function restoreSelection(){if(isInFocus=!0,document.getElementById($id).focus(),null!=savedRange)if(window.getSelection){var s=window.getSelection();s.rangeCount>0&&s.removeAllRanges(),s.addRange(savedRange)}else document.createRange?window.getSelection().addRange(savedRange):document.selection&&savedRange.select()}function cancelEvent(e){if(0==isInFocus&&null!=savedRange)return e&&e.preventDefault?(e.stopPropagation(),e.preventDefault()):window.event.cancelBubble=!0,restoreSelection(),!1}function createSelection(start,end){var range=(document.getElementById($id),document.createRange());range.setStart(savedRange.startContainer,start),range.setEnd(savedRange.endContainer,end);var sel=window.getSelection();sel.removeAllRanges(),sel.addRange(range)}function getText(start,end){var range=document.createRange();return range.setStart(savedRange.startContainer,start),range.setEnd(savedRange.endContainer,end),range.toString()}function moveCursorToEnd(){var range,selection,div=document.getElementById($id);document.createRange?(range=document.createRange(),range.selectNodeContents(div),range.collapse(!1),selection=window.getSelection(),selection.removeAllRanges(),selection.addRange(range)):document.selection&&(range=document.body.createTextRange(),range.moveToElementText(div),range.collapse(!1),range.select()),div.focus(),saveSelection()}function move(index){$menu.children("li").removeClass("liselected"),searchIndex==-1?(searchIndex=0,$menu.children("li").first().addClass("liselected")):(searchIndex+=index,searchIndex<0&&(searchIndex=-1),$menu.children("li").each(function(index){if(index==searchIndex)return $(this).addClass("liselected"),!1}))}$.fn.journalEditor.defaultOptions={buttonSelector:"button",closeSelector:".close",triggers:[50,51],minLength:1,sources:[null,null],tokens:[null,null]};var opts=$.extend({},$.fn.journalEditor.defaultOptions,options),$wrap=this,$triggers=opts.triggers,$minLength=opts.minLength,$sources=opts.sources,$triggered=!1,$search="",$triggerIndex=-1,$menu=$("<ul class='jacmenu'></ul>"),$tokens=opts.tokens,$id=$(this).attr("id"),savedRange=null,triggerPos=0,isInFocus=!1,searchIndex=-1,KEY={BACKSPACE:8,TAB:9,RETURN:13,ESC:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,COMMA:188};$wrap.bind("mouseup",function(){saveSelection()}).bind("keypress",function(event){switch(event.keyCode){case KEY.TAB:if(event.preventDefault(),$triggered&&searchIndex>-1)return selectItem();break;case KEY.DOWN:$triggered&&(event.preventDefault(),move(1));break;case KEY.UP:$triggered&&searchIndex>0&&(event.preventDefault(),move(-1));break;case KEY.ESC:event.preventDefault(),dispose()}}).bind("mousedown",function(event){return cancelEvent(event)}).bind("click",function(event){return cancelEvent(event)}).bind("blur",function(){isInFocus=!1,console.log(savedRange)}).bind("focus",function(){restoreSelection()}).bind("keyup",function(event){switch(event.keyCode){case KEY.DOWN:event.preventDefault();break;case KEY.TAB:event.preventDefault()}if(!(13==event.keyCode&&$triggered&&searchIndex>-1)&&(saveSelection(),event.keyCode!=$.ui.keyCode.UP&&event.keyCode!=$.ui.keyCode.DOWN)){if(event.keyCode==$.ui.keyCode.ESCAPE)return void($triggered=!1);if(8==event.keyCode){var node=savedRange.startContainer.parentElement;if("juser"==node.className||"jtag"==node.className){var p=node.parentNode;return p.removeChild(node),$triggered=!1,void(triggerPos=0)}}if(32==event.keyCode&&($triggered=!1,$search=""),event.shiftKey&&$.inArray(event.keyCode,$triggers)>-1&&(triggerPos=savedRange.endOffset,$triggerIndex=$.inArray(event.keyCode,$triggers),$triggered=!0),$triggered&&($search=getText(triggerPos,savedRange.endOffset),$search.length>=$minLength)){var callback=$sources[$triggerIndex];callback($search,render)}}}),$wrap.parent().after($menu)}}(jQuery,window);