function CoreMessaging($,ko,settings,composeMessageOptions){function displayMessage(placeholderSelector,message,cssclass){var messageNode=$("<div/>").addClass("dnnFormMessage "+cssclass).text(message);$(containerElement+" "+placeholderSelector).prepend(messageNode),messageNode.fadeOut(3e3,"easeInExpo",function(){messageNode.remove()})}function getQuerystring(key,default_){null==default_&&(default_=""),key=key.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var regex=new RegExp("[\\?&]"+key+"=([^&#]*)"),qs=regex.exec(window.location.href);return null==qs?default_:qs[1]}function messageConversationView(data){var self=this;self.MessageID=data.MessageID,self.To=data.To,self.From=data.From,self.Subject=data.Subject,self.Body=data.Body,self.ConversationId=data.ConversationId,self.ReplyAllAllowed=data.ReplyAllAllowed,self.SenderUserID=data.SenderUserID,self.RowNumber=data.RowNumber,self.AttachmentCount=ko.observable(data.AttachmentCount),self.NewThreadCount=ko.observable(data.NewThreadCount),self.ThreadCount=ko.observable(data.ThreadCount),self.MessageIDName="messageSelect"+self.ConversationId,self.SenderAvatar=profilePicHandler.replace("{0}",self.SenderUserID).replace("{1}",64).replace("{2}",64),self.SenderProfileUrl=data.SenderProfileUrl,self.MessageAbstract=self.Body.length<50?self.Body:self.Body.substr(0,50)+"...",self.messageSelected=ko.observable(!1),self.CreatedOnDate=data.DisplayDate,self.Read=ko.computed(function(){return 0===self.NewThreadCount()}),self.HasAttachments=ko.computed(function(){return self.AttachmentCount()>0})}function messageThreadView(data){var self=this;self.MessageID=data.Conversation.MessageID,self.To=data.Conversation.To,self.From=data.Conversation.From,self.Subject=data.Conversation.Subject,self.Body=data.Conversation.Body,self.ConversationId=data.Conversation.ConversationId,self.ReplyAllAllowed=data.Conversation.ReplyAllAllowed,self.SenderUserID=data.Conversation.SenderUserID,self.RowNumber=data.Conversation.RowNumber,self.AttachmentCount=data.Conversation.AttachmentCount,self.NewThreadCount=ko.observable(data.Conversation.NewThreadCount),self.Attachments=data.Attachments,self.MessageIDName="messageSelect"+self.ConversationId,self.SenderAvatar=profilePicHandler.replace("{0}",self.SenderUserID).replace("{1}",64).replace("{2}",64),self.SenderProfileUrl=data.Conversation.SenderProfileUrl,self.CreatedOnDate=data.Conversation.DisplayDate,self.Read=ko.computed(function(){return 0===self.NewThreadCount()})}function notificationActionViewModel(data,notificationId){var self=this;self.NotificationId=notificationId,self.Name=data.Name,self.Description=data.Description,self.Confirm=data.Confirm,self.APICall=data.APICall}function notificationViewModel(data){var self=this;self.NotificationId=data.NotificationId,self.Subject=data.Subject,self.From=data.From,self.Body=data.Body,self.SenderAvatar=data.SenderAvatar,self.SenderProfileUrl=data.SenderProfileUrl,self.DisplayDate=data.DisplayDate,self.Actions=$.map(data.Actions,function(action){return new notificationActionViewModel(action,data.NotificationId)})}function coreMessagingViewModel(){var self=this;self.disablePrivateMessage=ko.observable(settings.disablePrivateMessage),self.messages=ko.observableArray([]),self.notifications=ko.observableArray([]),self.TotalNotifications=ko.observable(0),self.TotalConversations=ko.observable(0),self.TotalNewThreads=ko.observable(0),self.TotalThreads=ko.observable(0),self.TotalArchivedThreads=ko.observable(0),self.messagethreads=ko.observableArray([]),self.showInbox=ko.observable(!0),self.showSentbox=ko.observable(!1),self.showArchivebox=ko.observable(!1),self.showReplies=ko.observable(!1),self.replyHasRecipients=ko.observable(!0),self.threadSubject=ko.observable(""),self.threadTo=ko.observable(""),self.loadingData=ko.observable(!1),self.isReplySelected=ko.observable(!1),self.highlightThreads=!1,self.conversationRead=ko.observable(),self.selectMenuOn=ko.observable(!1),self.actionsMenuOn=ko.observable(!1),self.hasElementsSelected=ko.computed(function(){var selectedElement=ko.utils.arrayFirst(self.messages(),function(message){return message.messageSelected()===!0});return void 0!=selectedElement}),self.toogleSelectMenu=function(){self.selectMenuOn(!self.selectMenuOn())},self.toogleActionsMenu=function(){self.hasElementsSelected()?self.actionsMenuOn(!self.actionsMenuOn()):self.actionsMenuOn(!1)},$("body").bind("click.coremessaging",function(event){$(event.target).closest("#SelectMenu").length||self.selectMenuOn(!1),$(event.target).closest("#ActionsMenu").length||self.actionsMenuOn(!1)}),self.getPageNumbers=ko.computed(function(){return 0===self.TotalConversations()?"0-0":"1-"+self.messages().length}),self.getNotificationPageNumbers=ko.computed(function(){return 0===self.TotalNotifications()?"0-0":"1-"+self.notifications().length}),self.backToMessages=function(){self.messages([]),self.showReplies(!1),self.reloadBoxes()},self.loadMessagesTab=function(){self.messages([]),self.showReplies(!1),self.myinbox()},self.reloadBoxes=function(){self.loadingData(!0),self.showInbox()?self.myinbox():self.showSentbox()?self.mysentbox():self.showArchivebox()&&self.myarchivebox()},self.fetch_unix_timestamp=function(){return(new Date).getTime().toString().substring(0,10)},self.sendThreadRequest=function(message){History.pushState({view:"messages",action:"thread",conversationId:message.ConversationId},"","?view=messages&action=thread&t="+self.fetch_unix_timestamp())},self.checkReplyHasRecipients=function(conversationId){var returnValue=0;$.ajax({type:"GET",beforeSend:serviceFramework.setModuleHeaders,url:baseServicepath+"CheckReplyHasRecipients",async:!1,cache:!1,data:{conversationId:conversationId}}).done(function(data){"number"===$.type(data)&&(returnValue=data)}),0==returnValue?(self.replyHasRecipients(!1),displayMessage("#dnnCoreMessaging",settings.replyHasNoRecipientsText,"dnnFormWarning")):self.replyHasRecipients(!0)},self.sendThreadRequestHandler=function(conversationId,afterMessageId){self.checkReplyHasRecipients(conversationId),$.ajax({type:"GET",url:baseServicepath+"Thread",beforeSend:serviceFramework.setModuleHeaders,data:{conversationId:conversationId,afterMessageId:afterMessageId,numberOfRecords:repliesPageSize},cache:!1}).done(function(messagethreadsView){if("undefined"!=typeof messagethreadsView&&null!=messagethreadsView&&"undefined"!=typeof messagethreadsView.Conversations){var mappedMessages=$.map(messagethreadsView.Conversations,function(item){return new messageThreadView(item)});if(mappedMessages.length>0)for(var i=0;i<mappedMessages.length;i++)self.messagethreads.unshift(mappedMessages[i]);self.threadSubject(self.messagethreads()[0].Subject),self.threadTo(self.messagethreads()[0].To),self.highlightThreads=!0,"undefined"!=typeof messagethreadsView.TotalThreads&&"number"===$.type(messagethreadsView.TotalThreads)&&self.TotalThreads(messagethreadsView.TotalThreads),"undefined"!=typeof messagethreadsView.TotalNewThreads&&"number"===$.type(messagethreadsView.TotalNewThreads)&&self.TotalNewThreads(messagethreadsView.TotalNewThreads),"undefined"!=typeof messagethreadsView.TotalArchivedThreads&&"number"===$.type(messagethreadsView.TotalArchivedThreads)&&self.TotalArchivedThreads(messagethreadsView.TotalArchivedThreads)}else displayMessage("#dnnCoreMessaging",settings.serverErrorText,"dnnFormWarning")}).fail(function(xhr,status){displayMessage("#dnnCoreMessaging",settings.serverErrorWithDescriptionText+status,"dnnFormWarning")})},self.getReplies=function(message){self.highlightThreads=!1,message.Read()!==!0&&self.markAsRead(message),self.conversationRead(!0),self.messagethreads([]),self.sendThreadRequest(message),self.showReplies(!0)},self.getRepliesAndReply=function(message){self.getReplies(message),self.setReplySelected()},self.showPreviousReplies=function(){self.TotalThreads()>self.messagethreads().length&&self.sendThreadRequestHandler(self.messagethreads()[0].ConversationId,self.messagethreads()[0].MessageID)},self.showPreviousRepliesVisible=ko.computed(function(){return self.messagethreads().length<self.TotalThreads()}),self.updateThreadCount=function(messageconversationView){var previousNewThreads=self.TotalNewThreads();messageconversationView.Read()===!0?(messageconversationView.NewThreadCount(messageconversationView.ThreadCount()),self.TotalNewThreads(previousNewThreads+messageconversationView.NewThreadCount())):(self.TotalNewThreads(previousNewThreads-messageconversationView.NewThreadCount()),messageconversationView.NewThreadCount(0))},self.changeState=function(messageconversationView,url){$.ajax({type:"POST",url:url,beforeSend:serviceFramework.setModuleHeaders,data:{conversationId:messageconversationView.ConversationId}}).done(function(data){"success"===data.Result?void 0!=messageconversationView.ThreadCount&&self.updateThreadCount(messageconversationView):displayMessage("#dnnCoreMessaging",settings.serverErrorText,"dnnFormWarning")}).fail(function(xhr,status){displayMessage("#dnnCoreMessaging",settings.serverErrorWithDescriptionText+status,"dnnFormWarning")})},self.markAsRead=function(messageconversationView){self.changeState(messageconversationView,baseServicepath+"MarkRead")},self.markAsUnread=function(messageconversationView){self.changeState(messageconversationView,baseServicepath+"MarkUnRead")},self.toggleState=function(messageconversationView){messageconversationView.Read()===!0?self.markAsUnread(messageconversationView):self.markAsRead(messageconversationView)},self.toggleConversationState=function(){var messageconversationView=self.messagethreads()[0];self.toggleState(messageconversationView),self.conversationRead(!self.conversationRead()),self.conversationRead()===!0?$(".successMsg").text(settings.conversationSetAsReadText):$(".successMsg").text(settings.conversationSetAsUnreadText),$(".successMsg").show().fadeOut(3e3,"easeInExpo")},self.loadMore=function(data,event){$(event.target).html('<img src="images/dnnanim.gif" style="vertical-align:middle" /> '+settings.loadingText);var afterMessageId=0==self.messages().length?-1:self.messages()[self.messages().length-1].MessageID,url=inboxpath;self.showSentbox()?url=sentboxpath:self.showArchivebox()&&(url=archivedboxpath),$.ajax({type:"GET",url:url,beforeSend:serviceFramework.setModuleHeaders,data:{afterMessageId:afterMessageId,numberOfRecords:pageSize},cache:!1}).done(function(messageboxView){if("undefined"!=typeof messageboxView&&null!=messageboxView&&"undefined"!=typeof messageboxView.Conversations){for(var mappedMessages=$.map(messageboxView.Conversations,function(item){return new messageConversationView(item)}),i=0;i<mappedMessages.length;i++)self.messages.push(mappedMessages[i]);"undefined"!=typeof messageboxView.TotalConversations&&"number"===$.type(messageboxView.TotalConversations)&&self.TotalConversations(messageboxView.TotalConversations),"undefined"!=typeof messageboxView.TotalNewThreads&&"number"===$.type(messageboxView.TotalNewThreads)&&self.TotalNewThreads(messageboxView.TotalNewThreads)}else displayMessage("#dnnCoreMessaging",settings.serverErrorText,"dnnFormWarning")}).fail(function(xhr,status){displayMessage("#dnnCoreMessaging",settings.serverErrorWithDescriptionText+status,"dnnFormWarning")}).always(function(){$(event.target).html(settings.loadMoreText)})},self.moveToArchive=function(message){$.ajax({type:"POST",url:baseServicepath+"MarkArchived",beforeSend:serviceFramework.setModuleHeaders,data:{conversationId:message.ConversationId}}).done(function(data){"success"===data.Result?(void 0!=message.ThreadCount&&self.TotalNewThreads(self.TotalNewThreads()-message.NewThreadCount()),self.messages.remove(message),self.TotalConversations(self.TotalConversations()-1)):displayMessage("#dnnCoreMessaging",settings.serverErrorText,"dnnFormWarning")}).fail(function(xhr,status){displayMessage("#dnnCoreMessaging",settings.serverErrorWithDescriptionText+status,"dnnFormWarning")})},self.unarchive=function(message){$.ajax({type:"POST",url:baseServicepath+"MarkUnArchived",beforeSend:serviceFramework.setModuleHeaders,data:{conversationId:message.ConversationId}}).done(function(data){"success"===data.Result?(void 0!=message.ThreadCount&&self.TotalNewThreads(self.TotalNewThreads()-message.NewThreadCount()),self.messages.remove(message),self.TotalConversations(self.TotalConversations()-1)):displayMessage("#dnnCoreMessaging",settings.serverErrorText,"dnnFormWarning")}).fail(function(xhr,status){displayMessage("#dnnCoreMessaging",settings.serverErrorWithDescriptionText+status,"dnnFormWarning")})},self.delete=function(message){var opts={callbackTrue:function(){$.ajax({type:"POST",url:baseServicepath+"DeleteUserFromConversation",beforeSend:serviceFramework.setModuleHeaders,data:{conversationId:message.ConversationId}}).done(function(data){"success"===data.Result?(void 0!=message.ThreadCount&&self.TotalNewThreads(self.TotalNewThreads()-message.NewThreadCount()),self.messages.remove(message),self.TotalConversations(self.TotalConversations()-1)):displayMessage("#dnnCoreMessaging",settings.serverErrorText,"dnnFormWarning")}).fail(function(xhr,status){displayMessage("#dnnCoreMessaging",settings.serverErrorWithDescriptionText+status,"dnnFormWarning")})},text:settings.text,yesText:settings.yesText,noText:settings.noText,title:settings.title};$.dnnConfirm(opts)},self.moveSelectedToArchive=function(){$.each(self.messages(),function(){this.messageSelected()&&self.moveToArchive(this)})},self.moveSelectedToRead=function(){$.each(self.messages(),function(){this.messageSelected()&&self.markAsRead(this)})},self.moveSelectedToUnread=function(){$.each(self.messages(),function(){this.messageSelected()&&self.markAsUnread(this)})},self.toggleArchiveConversation=function(){var url,conversationId=self.messagethreads()[0].ConversationId;0===self.TotalArchivedThreads()?(url=baseServicepath+"MarkArchived",$(".successMsg").text(settings.conversationArchivedText)):(url=baseServicepath+"MarkUnArchived",$(".successMsg").text(settings.conversationUnarchivedText)),$.ajax({type:"POST",url:url,beforeSend:serviceFramework.setModuleHeaders,data:{conversationId:conversationId}}).done(function(data){"success"===data.Result?($(".successMsg").show().fadeOut(3e3,"easeInExpo"),0===self.TotalArchivedThreads()?self.TotalArchivedThreads(self.TotalThreads):self.TotalArchivedThreads(0)):displayMessage("#dnnCoreMessaging",settings.serverErrorText,"dnnFormWarning")}).fail(function(xhr,status){displayMessage("#dnnCoreMessaging",settings.serverErrorWithDescriptionText+status,"dnnFormWarning")})},self.changeBoxes=function(inbox,sentbox,archivebox){self.showInbox(inbox),self.showSentbox(sentbox),self.showArchivebox(archivebox)},self.getTotalNotifications=function(){var returnValue=0;return $.ajax({type:"GET",beforeSend:serviceFramework.setModuleHeaders,url:countnotificationspath,async:!1,cache:!1}).done(function(data){"number"===$.type(data)&&(returnValue=data)}),returnValue},self.loadNotificationsTab=function(){History.pushState({view:"notifications",action:"notifications"},"","?view=notifications&action=notifications&t="+self.fetch_unix_timestamp())},self.loadNotificationsTabHandler=function(){self.loadingData(!0),$.ajax({type:"GET",url:notificationspath,beforeSend:serviceFramework.setModuleHeaders,data:{afterNotificationId:-1,numberOfRecords:notificationsPageSize},cache:!1}).done(function(notificationsViewModel){if("undefined"!=typeof notificationsViewModel&&null!=notificationsViewModel&&"undefined"!=typeof notificationsViewModel.Notifications){var mappedNotifications=$.map(notificationsViewModel.Notifications,function(notification){return new notificationViewModel(notification)});self.notifications(mappedNotifications),"undefined"!=typeof notificationsViewModel.TotalNotifications&&"number"===$.type(notificationsViewModel.TotalNotifications)&&self.TotalNotifications(notificationsViewModel.TotalNotifications)}else displayMessage("#dnnCoreNotification",settings.serverErrorText,"dnnFormWarning")}).fail(function(xhr,status){displayMessage("#dnnCoreNotification",settings.serverErrorWithDescriptionText+status,"dnnFormWarning")}).always(function(){self.loadingData(!1)})},self.loadMoreNotifications=function(){var afterNotificationId=0==self.notifications().length?-1:self.notifications()[self.notifications().length-1].NotificationId;$.ajax({type:"GET",url:notificationspath,beforeSend:serviceFramework.setModuleHeaders,data:{afterNotificationId:afterNotificationId,numberOfRecords:notificationsPageSize},cache:!1}).done(function(notificationsViewModel){if("undefined"!=typeof notificationsViewModel&&null!=notificationsViewModel&&"undefined"!=typeof notificationsViewModel.Notifications){for(var mappedNotifications=$.map(notificationsViewModel.Notifications,function(notification){return new notificationViewModel(notification)}),i=0;i<mappedNotifications.length;i++)self.notifications.push(mappedNotifications[i]);"undefined"!=typeof notificationsViewModel.TotalNotifications&&"number"===$.type(notificationsViewModel.TotalNotifications)&&self.TotalNotifications(notificationsViewModel.TotalNotifications)}else displayMessage("#dnnCoreNotification",settings.serverErrorText,"dnnFormWarning")}).fail(function(){displayMessage("#dnnCoreNotification",settings.serverErrorWithDescriptionText,"dnnFormWarning")})},self.loadMoreVisible=ko.computed(function(){return self.messages().length<self.TotalConversations()}),self.loadMoreNotificationsVisible=ko.computed(function(){return self.notifications().length<self.TotalNotifications()}),self.isLastNotificationAction=function(notification,action){return action===notification.Actions[notification.Actions.length-1]},self.performNotificationAction=function(action){if(action.Confirm.length>0){var confirmDialog=$("<div class='dnnDialog'></div>").html(action.Confirm).dialog({autoOpen:!1,resizable:!1,modal:!0,title:settings.notificationConfirmTitleText,dialogClass:"dnnFormPopup dnnClear",open:function(){$(".ui-dialog-buttonpane").find('button:contains("'+settings.notificationConfirmNoText+'")').addClass("dnnConfirmCancel")},buttons:[{text:settings.notificationConfirmYesText,click:function(){$(this).dialog("close"),self.apiCallRequest(action)}},{text:settings.notificationConfirmNoText,click:function(){$(this).dialog("close")}}]});if(confirmDialog.is(":visible"))return confirmDialog.dialog("close"),!0;confirmDialog.dialog("open")}else self.apiCallRequest(action)},self.dismissAllNotifications=function(){var opts={callbackTrue:function(){$.ajax({type:"POST",url:baseServicepath+"DismissAllNotifications",beforeSend:serviceFramework.setModuleHeaders}).done(function(data){"success"===data.Result?(displayMessage("#dnnCoreNotification",settings.actionPerformedText,"dnnFormSuccess"),location.href=window.location.href):displayMessage("#dnnCoreMessaging",settings.serverErrorText,"dnnFormWarning")}).fail(function(xhr,status){displayMessage("#dnnCoreMessaging",settings.serverErrorWithDescriptionText+status,"dnnFormWarning")})},text:String.format(settings.dismissAllConfirmText,self.TotalNotifications()),yesText:settings.yesText,noText:settings.noText,title:settings.title,buttonYesClass:"dnnSecondaryAction",buttonNoClass:"dnnPrimaryAction"};$.dnnConfirm(opts)},self.apiCallRequest=function(action){$.ajax({type:"POST",url:dnn.getVar("sf_siteRoot","/")+action.APICall,beforeSend:serviceFramework.setModuleHeaders,data:{NotificationId:action.NotificationId}}).done(function(data){if("success"===data.Result){var notificationToRemove=ko.utils.arrayFirst(self.notifications(),function(notification){return notification.NotificationId===action.NotificationId});self.notifications.remove(notificationToRemove);var notifications=$("#dnn_dnnUser_notificationLink").children("span");if(notifications){var totalNotificationsTxt=notifications.text();if(""!=totalNotificationsTxt){var totalNotifications=parseInt(totalNotificationsTxt);totalNotifications--,totalNotifications>0?notifications.text(totalNotifications):notifications.text("")}}self.TotalNotifications(self.TotalNotifications()-1),displayMessage("#dnnCoreNotification",settings.actionPerformedText,"dnnFormSuccess"),data.Link&&(location.href=data.Link)}else"undefined"!=typeof data.Message&&null!=data.Message&&""!==data.Message?displayMessage("#dnnCoreNotification",data.Message,"dnnFormWarning"):displayMessage("#dnnCoreNotification",settings.actionNotPerformedText,"dnnFormWarning")}).fail(function(){displayMessage("#dnnCoreNotification",settings.actionNotPerformedText,"dnnFormWarning")})},self.hideNotification=function(elem){1===elem.nodeType&&$(elem).fadeOut("slow",function(){$(elem).remove()})},self.loadBox=function(boxPath){self.loadingData(!0),$.ajax({type:"GET",url:boxPath,beforeSend:serviceFramework.setModuleHeaders,data:{afterMessageId:-1,numberOfRecords:pageSize},cache:!1}).done(function(messageboxView){if("undefined"!=typeof messageboxView&&null!=messageboxView&&"undefined"!=typeof messageboxView.Conversations){var mappedMessages=$.map(messageboxView.Conversations,function(item){return new messageConversationView(item)});self.messages(mappedMessages),"undefined"!=typeof messageboxView.TotalConversations&&"number"===$.type(messageboxView.TotalConversations)&&self.TotalConversations(messageboxView.TotalConversations),"undefined"!=typeof messageboxView.TotalNewThreads&&"number"===$.type(messageboxView.TotalNewThreads)&&self.TotalNewThreads(messageboxView.TotalNewThreads)}else displayMessage("#dnnCoreMessaging",settings.serverErrorText,"dnnFormWarning")}).fail(function(xhr,status){displayMessage("#dnnCoreMessaging",settings.serverErrorWithDescription+status,"dnnFormWarning")}).always(function(){self.loadingData(!1)})},self.myinbox=function(){History.pushState({view:"messages",action:"inbox"},"","?view=messages&action=inbox&t="+self.fetch_unix_timestamp())},self.myinboxHandler=function(){self.changeBoxes(!0,!1,!1),self.loadingData(!0),self.loadBox(inboxpath)},self.mysentbox=function(){History.pushState({view:"messages",action:"sentbox"},"","?view=messages&action=sentbox&t="+self.fetch_unix_timestamp())},self.mysentboxHandler=function(){self.changeBoxes(!1,!0,!1),self.loadingData(!0),self.loadBox(sentboxpath)},self.myarchivebox=function(){History.pushState({view:"messages",action:"archivebox"},"","?view=messages&action=archivebox&t="+self.fetch_unix_timestamp())},self.myarchiveboxHandler=function(){self.changeBoxes(!1,!1,!0),self.loadingData(!0),self.loadBox(archivedboxpath)},self.reply=function(){var body=$(containerElement+" #replyMessage").val();if(0!=body.length){var conversationId=self.messagethreads()[0].ConversationId;$.ajax({type:"POST",url:baseServicepath+"Reply",beforeSend:serviceFramework.setModuleHeaders,data:{conversationId:conversationId,body:encodeURIComponent(body),fileIds:[]}}).done(function(data){"undefined"!=typeof data&&null!=data&&"undefined"!=typeof data.Conversation?(displayMessage("#dnnCoreMessaging",settings.messageSentText,"dnnFormSuccess"),$(containerElement+" #replyMessage").val(""),self.messagethreads.push(new messageThreadView(data)),"undefined"!=typeof data.TotalThreads&&"number"===$.type(data.TotalThreads)&&self.TotalThreads(data.TotalThreads),"undefined"!=typeof data.TotalNewThreads&&"number"===$.type(data.TotalNewThreads)&&self.TotalNewThreads(data.TotalNewThreads),"undefined"!=typeof data.TotalArchivedThreads&&"number"===$.type(data.TotalArchivedThreads)&&self.TotalArchivedThreads(data.TotalArchivedThreads)):displayMessage("#dnnCoreMessaging",settings.serverErrorText,"dnnFormWarning")}).fail(function(xhr,status){displayMessage("#dnnCoreMessaging",settings.serverErrorWithDescription+eval("("+xhr.responseText+")").ExceptionMessage,"dnnFormWarning")})}},self.setReplySelected=function(){self.isReplySelected(!0)},self.threadViewAfterAdd=function(node){node.childNodes.length>0&&self.highlightThreads===!0&&$(node).effect("highlight",{},3e3)},self.selectAll=function(){$.each(self.messages(),function(){this.messageSelected(!0)})},self.selectNone=function(){$.each(self.messages(),function(){this.messageSelected(!1)})},self.selectRead=function(){$.each(self.messages(),function(){this.messageSelected(this.Read()===!0)})},self.selectUnread=function(){$.each(self.messages(),function(){this.messageSelected(this.Read()===!1)})},self.getTotals=function(refresh){$.ajax({type:"GET",beforeSend:serviceFramework.setModuleHeaders,url:gettotalspath,async:!1,cache:!1}).done(function(totalsViewModel){if("undefined"!=typeof totalsViewModel&&null!=totalsViewModel){var state=window.History.getState();if("undefined"!=typeof totalsViewModel.TotalUnreadMessages&&"number"===$.type(totalsViewModel.TotalUnreadMessages)){var oldTotalNewThreads=self.TotalNewThreads();self.TotalNewThreads(totalsViewModel.TotalUnreadMessages),refresh&&oldTotalNewThreads!==totalsViewModel.TotalUnreadMessages&&(null==state.data||!state.data.view||"messages"==state.data.view&&"inbox"==state.data.action)&&self.loadBox(inboxpath)}if("undefined"!=typeof totalsViewModel.TotalNotifications&&"number"===$.type(totalsViewModel.TotalNotifications)){var oldNotifications=self.TotalNotifications();self.TotalNotifications(totalsViewModel.TotalNotifications),refresh&&oldNotifications!==totalsViewModel.TotalNotifications&&(null==state.data||!state.data.view||"notifications"==state.data.view&&"notifications"==state.data.action)&&self.loadNotificationsTabHandler()}}})}}var profilePicHandler=settings.profilePicHandler,serviceFramework=composeMessageOptions.servicesFramework,baseServicepath=serviceFramework.getServiceRoot("CoreMessaging")+"MessagingService/",inboxpath=baseServicepath+"Inbox",sentboxpath=baseServicepath+"Sentbox",archivedboxpath=baseServicepath+"Archived",notificationspath=baseServicepath+"Notifications",countnotificationspath=baseServicepath+"CountNotifications",gettotalspath=baseServicepath+"GetTotals",pageSize=10,repliesPageSize=2,notificationsPageSize=10,containerElement=null,refreshInterval=6e4;!function(window){"file:"===document.location.protocol&&alert("The HTML5 History API (and thus History.js) do not work on files, please upload it to a server.");var History=window.History;History.Adapter.bind(window,"statechange",function(){var state=History.getState();if(null!=state.data){var data=state.data,action=data.action,view=data.view,context=ko.contextFor(document.getElementById($(containerElement).attr("id")));if("notifications"==view)context.$root.loadNotificationsTabHandler(),$(containerElement+" #smMainContent").dnnTabs({selected:1});else switch($(containerElement+" #smMainContent").dnnTabs({selected:0}),action){case"inbox":context.$root.messages([]),context.$root.showReplies(!1),context.$root.myinboxHandler();break;case"sentbox":context.$root.messages([]),context.$root.showReplies(!1),context.$root.mysentboxHandler();break;case"archivebox":context.$root.messages([]),context.$root.showReplies(!1),context.$root.myarchiveboxHandler();break;case"thread":context.$root.highlightThreads=!1,context.$root.conversationRead(!0),context.$root.messagethreads([]),context.$root.sendThreadRequestHandler(data.conversationId,-1),context.$root.showReplies(!0)}}})}(window),this.init=function(element){containerElement=element;var viewModel=new coreMessagingViewModel;ko.applyBindings(viewModel,document.getElementById($(element).attr("id"))),$(element).dnnComposeMessage(composeMessageOptions);var stateview=getQuerystring("view");""==stateview&&document.URL.indexOf("view/notifications")>=0&&(stateview="notifications"),"notifications"===stateview?($(element+" #smMainContent").dnnTabs({selected:1}),viewModel.loadNotificationsTabHandler()):($(element+" #smMainContent").dnnTabs({selected:0}),viewModel.myinboxHandler()),setInterval(function(){viewModel.getTotals(!0)},refreshInterval),viewModel.getTotals()}}