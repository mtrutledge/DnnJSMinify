"undefined"!=typeof dnn&&null!==dnn||(dnn={}),dnn.PageSettings=dnn.PageSettings||{},function($,window,document,undefined){"use strict";var Helper=this.Helper=function(){};Helper.getKeyValuePairByKey=function(pairs,key){if(!pairs)return null;for(var i=0,size=pairs.length;i<size;i++)if(pairs[i].key===key)return pairs[i];return null};var UrlViewModel=this.UrlViewModel=function(properties){this.$this=$(this),this.path=ko.observable(""),this.queryString=ko.observable(""),this.siteAlias=ko.observable(null),this.locale=ko.observable(null),this.statusCode=ko.observable(null),this.editing=ko.observable(!1),this.id=ko.observable(-1),this.siteAliasUsage=ko.observable(null),this.isSystem=ko.observable(!1),this.aliasAndPath=ko.computed(this._aliasAndPath,this),this.is200=ko.computed(this._is200,this),this.statusCode.subscribe($.proxy(this._onStatusCodeChanged,this)),"undefined"!=typeof properties&&this.values(properties)};UrlViewModel.prototype={constructor:UrlViewModel,_onStatusCodeChanged:function(status){status&&200===status.key&&this.queryString("")},_aliasAndPath:function(){var alias=this.siteAlias();return alias?alias.value.append(this.path(),"").append(this.queryString(),"?"):""},_is200:function(){var status=this.statusCode();return status&&200===status.key},editUrl:function(viewModel,evt){this.$this.trigger("onEdit",[this])},values:function(properties){if("undefined"==typeof properties)return{path:this.path(),queryString:this.queryString(),siteAlias:this.siteAlias(),locale:this.locale(),statusCode:this.statusCode(),id:this.id(),siteAliasUsage:this.siteAliasUsage(),isSystem:this.isSystem()};var prop=properties||{};"undefined"!=typeof prop.path&&this.path(prop.path),"undefined"!=typeof prop.queryString&&this.queryString(prop.queryString),"undefined"!=typeof prop.siteAlias&&this.siteAlias(prop.siteAlias),"undefined"!=typeof prop.locale&&this.locale(prop.locale),"undefined"!=typeof prop.statusCode&&this.statusCode(prop.statusCode),"undefined"!=typeof prop.id&&this.id(prop.id),"undefined"!=typeof prop.siteAliasUsage&&this.siteAliasUsage(prop.siteAliasUsage),"undefined"!=typeof prop.isSystem&&this.isSystem(prop.isSystem),"function"==typeof prop.onEdit&&this.$this.bind("onEdit",prop.onEdit)}};var UrlListViewModel=this.UrlListViewModel=function(options){this.options=options,this.urls=ko.observableArray([]),this.sortingFields=ko.observable({}),this._sortingField=0,this._sortingOrder=!0,this.init()};UrlListViewModel.prototype={constructor:UrlListViewModel,init:function(){this.options=$.extend({},UrlListViewModel.defaults(),this.options),this._getUrlListServiceSettings={url:this.options.services.listUrls,beforeSend:$.dnnSF().setModuleHeaders,type:"GET",async:!0,success:$.proxy(this._onLoadUrls,this),error:$.onAjaxError},this.list()},clear:function(){this.urls=this.urls([])},_onLoadUrls:function(data,textStatus,jqXhr){this.loadFromModel(data)},selectUrl:function(caller,evt){return!0},sort:function(caller,evt){var clickedColumn=evt.currentTarget,$clickedColumn=$(clickedColumn);$(this._currentColumn).removeClass(this._getColumnClass(this._sortingOrder)),this._currentColumn===clickedColumn?this._sortingOrder=!this._sortingOrder:this._sortingOrder=!0,$clickedColumn.addClass(this._getColumnClass(this._sortingOrder)),this._currentColumn=clickedColumn,this._sortingField=$clickedColumn.attr("data"),this.list()},list:function(){this._getUrlListServiceSettings.data={sortField:this._sortingField,sortOrder:this._sortingOrder},$.ajax(this._getUrlListServiceSettings)},_getColumnClass:function(sortingOrder){return"undefined"==typeof sortingOrder||sortingOrder?"asc":"desc"},loadFromModel:function(model){var items=[],self=this;$.each(model.Urls,function(index,urlModel){var values=Object.ToCamel(urlModel);if(values.onEdit=self.options.onEditUrlProxy,items.push(new UrlViewModel(values)),200==values.statusCode.key){var pageUrlField=$("input[id$=ManageTabs_urlTextBox]"),oldValue=pageUrlField.val(),urlTextBox=$("input[id$=ManageTabs_urlTextBox]");urlTextBox.hasClass("um-page-url-modified")?urlTextBox.removeClass("um-page-url-modified"):urlTextBox.val(values.path),oldValue.length>0&&$("form[id=Form]").attr("action",$("form[id=Form]").attr("action").replace(oldValue,values.path))}}),this.urls(items)}},UrlListViewModel._defaults={},UrlListViewModel.defaults=function(settings){return"undefined"!=typeof settings&&$.extend(UrlListViewModel._defaults,settings),UrlListViewModel._defaults};var EditUrlViewModel=this.EditUrlViewModel=function(options){this.$this=$(this),this.options=options,this.locales=ko.observableArray([]),this.statusCodes=ko.observableArray([]),this.siteAliases=ko.observableArray([]),this.isPrimaryAliasUpdate=ko.observable(),this.isPrimaryAlias=ko.computed(this._isPrimaryAlias,this),this.primaryAliasId=ko.observable(null),this.siteAliasUsages=ko.observable(null),this.hasParent=ko.observable(!1),this.url=ko.observable(null),this.url.subscribe($.proxy(this._onUrlChanged,this)),this.ready=ko.observable(!1),this.saving=ko.observable(!1),this.isEdit=ko.computed(this._isEdit,this),this.init()};EditUrlViewModel.prototype={constructor:EditUrlViewModel,init:function(){var serviceSettings={beforeSend:$.dnnSF().setModuleHeaders,url:this.options.services.getOptions,type:"GET",async:!0,success:$.proxy(this._onLoadOptions,this),error:$.onAjaxError};$.ajax(serviceSettings)},_isEdit:function(){return!!this._url},_onUrlChanged:function(url){url&&url.siteAlias.subscribe($.proxy(this._onSiteAliasChanged,this)),this._invalidatePrimaryAlias()},_onSiteAliasChanged:function(alias){this._invalidatePrimaryAlias(),this.url&&alias&&(alias.key===this.primaryAliasId()?this.url().siteAliasUsage(this.siteAliasUsages().Default):this.url().siteAliasUsage(this.siteAliasUsages().ChildPagesDoNotInherit))},_invalidatePrimaryAlias:function(){this.isPrimaryAliasUpdate.notifySubscribers()},_isPrimaryAlias:function(){this.isPrimaryAliasUpdate();var url=this.url?this.url():null;if(url){var siteAlias=url.siteAlias();return siteAlias&&siteAlias.key===this.primaryAliasId()}return!1},_onLoadOptions:function(model,textStatus,jqXhr){this.locales(Object.ToCamel(model.Locales)),this.statusCodes(Object.ToCamel(model.StatusCodes)),this.siteAliases(Object.ToCamel(model.SiteAliases)),this.primaryAliasId(model.PrimaryAliasId);var usages=new dnn.Enum(Object.ToCamel(model.SiteAliasUsages));this.siteAliasUsages(usages),this.hasParent(model.HasParent),this.ready(!0),this._bindUrl()},_openDialog:function(isEdit){isEdit?this.options.editUrlDialogTitle:this.options.createUrlDialogTitle},edit:function(urlViewModel){this._openDialog("undefined"!=typeof urlViewModel),this._url=urlViewModel,this.ready()&&this._bindUrl()},_bindUrl:function(){var editingUrl=new UrlViewModel;if(this._isEdit()){var queryString=this._url.queryString();queryString&&!queryString.startsWith("/")&&(queryString="?"+queryString);var path=this._url.path();path&&!path.startsWith("/")&&(path="/"+path),editingUrl.values({path:path,queryString:queryString,siteAlias:Helper.getKeyValuePairByKey(this.siteAliases(),this._url.siteAlias().key),locale:Helper.getKeyValuePairByKey(this.locales(),this._url.locale().key),statusCode:Helper.getKeyValuePairByKey(this.statusCodes(),this._url.statusCode().key),siteAliasUsage:this._url.siteAliasUsage(),id:this._url.id(),isSystem:this._url.isSystem()})}this.url(editingUrl)},save:function(){var properties=this.url().values();properties.path=properties.path.trim(),properties.queryString=properties.queryString.trim(),properties.queryString.startsWith("?")&&(properties.queryString=properties.queryString.substring(1)||"");var serviceSettings,postData={Id:properties.id,SiteAliasKey:properties.siteAlias.key,Path:properties.path,QueryString:properties.queryString,LocaleKey:properties.locale.key,StatusCodeKey:properties.statusCode.key,SiteAliasUsage:properties.siteAliasUsage,IsSystem:properties.isSystem};this._isEdit()?(this._url.values(properties),this._updateCustomUrlServiceSettings||(this._updateCustomUrlServiceSettings={beforeSend:$.dnnSF().setModuleHeaders,url:this.options.services.updateUrl,type:"POST",async:!0,success:$.proxy(this._onUpdateUrl,this),error:$.onAjaxError,complete:$.proxy(this._onComplete,this)}),serviceSettings=this._updateCustomUrlServiceSettings):(this._createCustomUrlServiceSettings||(this._createCustomUrlServiceSettings={beforeSend:$.dnnSF().setModuleHeaders,url:this.options.services.createUrl,type:"POST",async:!0,success:$.proxy(this._onCreateUrl,this),error:$.onAjaxError,complete:$.proxy(this._onComplete,this)}),serviceSettings=this._createCustomUrlServiceSettings),serviceSettings.data=postData,$.ajax(serviceSettings),this.saving(!0)},cancel:function(){this._isEdit()?this.$this.trigger("onCancelEditUrl",[this._url]):this.$this.trigger("onCancelCreateUrl")},_onCreateUrl:function(data,textStatus,jqXhr){data.Success?this.$this.trigger("onCreateUrl",[data.Id]):($.dnnAlert({title:this.options.errorTitle||"Error",text:data.ErrorMessage||"Unknown error"}),data.SuggestedUrlPath&&this.url().path(data.SuggestedUrlPath))},_onUpdateUrl:function(data,textStatus,jqXhr){data.Success?this.$this.trigger("onUpdateUrl",[this._url]):($.dnnAlert({title:this.options.errorTitle||"Error",text:data.ErrorMessage||"Unknown error"}),data.SuggestedUrlPath&&this.url().path(data.SuggestedUrlPath))},_onComplete:function(jqXHR,textStatus){this.saving(!1)}};var ViewModel=this.ViewModel=function(options){this.options=options,this.singleLocale=ko.observable(!1),this.creating=ko.observable(!1),this.init()};ViewModel.prototype={constructor:ViewModel,init:function(){this.options=$.extend({},ViewModel.defaults(),this.options),this._serviceUrl=$.dnnSF().getServiceRoot(this.options.serviceRoot);var onEditUrlProxy=$.proxy(this._onEditUrl,this),customUrlsOptions=$.extend({services:{listUrls:this._serviceUrl+this.options.methods.getCustomUrls},onEditUrlProxy:onEditUrlProxy},this.options);this.customUrls=new UrlListViewModel(customUrlsOptions);var editUrlOptions=$.extend({services:{getOptions:this._serviceUrl+this.options.methods.getUrlOptions,createUrl:this._serviceUrl+this.options.methods.createUrl,updateUrl:this._serviceUrl+this.options.methods.updateUrl}},this.options);this.editViewModel=new EditUrlViewModel(editUrlOptions),this.$editViewModel=$(this.editViewModel),this.$editViewModel.bind("onUpdateUrl",$.proxy(this._onUpdateUrl,this)),this.$editViewModel.bind("onCreateUrl",$.proxy(this._onCreateUrl,this)),this.$editViewModel.bind("onCancelEditUrl",$.proxy(this._onCancelEditUrl,this)),this.$editViewModel.bind("onCancelCreateUrl",$.proxy(this._onCancelCreateUrl,this));var systemGeneratedUrlsOptions=$.extend({services:{listUrls:this._serviceUrl+this.options.methods.getSystemGeneratedUrls}},this.options);this.systemGeneratedUrls=new UrlListViewModel(systemGeneratedUrlsOptions);var configurationServiceSettings={beforeSend:$.dnnSF().setModuleHeaders,url:this._serviceUrl+this.options.methods.getConfiguration,type:"GET",async:!0,success:$.proxy(this._onLoadSettings,this),error:$.onAjaxError};$.ajax(configurationServiceSettings),ko.bindingHandlers.initViewRow={update:$.proxy(this._initViewRow,this)},ko.bindingHandlers.initEditRow={update:$.proxy(this._initEditRow,this)}},_initViewRow:function(element,valueAccessor,allBindingsAccessor,elementViewModel,bindingContext){if("undefined"!=typeof this._highlightUrlId){var id=elementViewModel.id();id===this._highlightUrlId&&($(element).quickHighlight(),delete this._highlightUrlId)}},_initEditRow:function(element,valueAccessor,allBindingsAccessor,elementViewModel,bindingContext){setTimeout(function(){var $editRow=$(element);$editRow.find(".um-edit-url-dialog-path").prefixInput({prefix:"/"}).focus(),$editRow.find(".um-edit-url-dialog-querystring").prefixInput({prefix:"?"})},0)},_onLoadSettings:function(model,textStatus,jqXhr){this.singleLocale(model.SingleLocale);var sortingFields=new dnn.Enum(Object.ToCamel(model.SortingFields));this.customUrls.sortingFields(sortingFields),this.systemGeneratedUrls.sortingFields(sortingFields)},createCustomUrl:function(eventObject){this.creating(!0),this._clearEditing(this.customUrls),this.editViewModel.edit()},_onEditUrl:function(eventObject,urlViewModel){this.creating(!1),this._clearEditing(this.customUrls),urlViewModel.editing(!0),this.editViewModel.edit(urlViewModel)},_clearEditing:function(urlList){for(var urls=urlList.urls(),i=0,size=urls.length;i<size;i++)urls[i].editing(!1)},_onCancelEditUrl:function(eventObject,urlViewModel){urlViewModel.editing(!1),this.editViewModel.edit(urlViewModel)},_onCancelCreateUrl:function(eventObject,urlViewModel){this.creating(!1)},_onUpdateUrl:function(eventObject,urlViewModel){urlViewModel.editing(!1),this._highlightUrlId=urlViewModel.id(),this.reload()},_onCreateUrl:function(eventObject,urlId){this.creating(!1),this._highlightUrlId=urlId,this.reload()},deleteUrl:function(id){var deleteUrlServiceSettings={beforeSend:$.dnnSF().setModuleHeaders,url:this._serviceUrl+this.options.methods.deleteUrl,type:"POST",data:{Id:id},async:!0,success:$.proxy(this._onDeleteUrl,this),error:$.onAjaxError};$.ajax(deleteUrlServiceSettings)},_onDeleteUrl:function(data,textStatus,jqXhr){this.reload()},reload:function(){this.customUrls.list(),this.systemGeneratedUrls.list()}},ViewModel._defaults={serviceRoot:"UrlManagement",methods:{createUrl:"UrlManagementService/CreateCustomUrl",updateUrl:"UrlManagementService/UpdateCustomUrl",deleteUrl:"UrlManagementService/DeleteCustomUrl",getCustomUrls:"UrlManagementService/GetCustomUrls",getSystemGeneratedUrls:"UrlManagementService/GetSystemGeneratedUrls",getUrlOptions:"UrlManagementService/GetUrlOptions",getConfiguration:"UrlManagementService/GetConfiguration"}},ViewModel.defaults=function(settings){return"undefined"!=typeof settings&&$.extend(ViewModel._defaults,settings),ViewModel._defaults};var View=this.View=function(element,options){this.element=element,this.options=options,this.init()};View.prototype={constructor:View,init:function(){this.options=$.extend({},View.defaults(),this.options),this.$this=$(this),this.$element=$(this.element);var deleteConfirmationSettings={title:this.options.removeUrlPromptTitle,text:this.options.removeUrlPromptMessage,yesText:this.options.yesButtonCaption,noText:this.options.noButtonCaption,isButton:!0};this.viewModel=new ViewModel(this.options),ko.bindingHandlers.attachDeleteConfirmation={init:function(element,valueAccessor,allBindingsAccessor,elementViewModel,bindingContext){var id=elementViewModel.id(),confirmationSettings=$.extend({},deleteConfirmationSettings,{callbackTrue:function(){bindingContext.$root.deleteUrl(id)}});$(element).dnnConfirm(confirmationSettings)}},ko.applyBindings(this.viewModel,this.element)},refreshView:function(){this.viewModel.reload()}},View._defaults={},View.defaults=function(settings){return"undefined"!=typeof settings&&$.extend(View._defaults,settings),View._defaults}}.apply(dnn.PageSettings,[jQuery,window,document]),dnn.initializePageSettingsView=function(selector,options){$(document).ready(function(){var instance=new dnn.PageSettings.View($(selector)[0],options);dnn.PageUrlSynchronizer.getInstance().setUrlManagement(instance)})},ko.bindingHandlers.dnnTooltip={init:function(element){$(element).find(".dnnTooltip").dnnTooltip()}};