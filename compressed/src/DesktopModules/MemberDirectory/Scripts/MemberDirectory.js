function MemberDirectory($,ko,settings,composeMessageSettings){function displayMessage(message,cssclass){var messageNode=$("<div/>").addClass("dnnFormMessage "+cssclass).text(message);$(containerElement).prepend(messageNode),messageNode.fadeOut(3e3,"easeInExpo",function(){messageNode.remove()})}function Member(item){var self=this;self.AddFriendText=opts.addFriendText,self.AcceptFriendText=opts.acceptFriendText,self.FriendPendingText=opts.friendPendingText,self.RemoveFriendText=opts.removeFriendText,self.FollowText=opts.followText,self.UnFollowText=opts.unFollowText,self.SendMessageText=opts.sendMessageText,self.UserNameText=opts.userNameText,self.EmailText=opts.emailText,self.CityText=opts.cityText,self.UserId=ko.observable(item.MemberId),self.LastName=ko.observable(item.LastName),self.FirstName=ko.observable(item.FirstName),self.UserName=ko.observable(item.UserName),self.DisplayName=ko.observable(item.DisplayName),self.Email=ko.observable(item.Email),self.IsUser=ko.observable(item.MemberId==viewerId),self.IsAuthenticated=viewerId>0,self.FriendStatus=ko.observable(item.FriendStatus),self.FriendId=ko.observable(item.FriendId),self.IsFriend=ko.computed(function(){return 2==self.FriendStatus()},this),self.IsPending=ko.computed(function(){return 1==self.FriendStatus()&&self.FriendId()!=viewerId},this),self.HasPendingRequest=ko.computed(function(){return 1==self.FriendStatus()&&self.FriendId()==viewerId},this),self.FollowingStatus=ko.observable(item.FollowingStatus),self.IsFollowing=ko.computed(function(){return 2==self.FollowingStatus()},this),self.FollowerStatus=ko.observable(item.FollowerStatus),self.IsFollower=ko.computed(function(){return 2==self.FollowerStatus()},this),self.City=ko.observable(item.City),self.Title=ko.observable(item.Title),self.Country=ko.observable(item.Country),self.Phone=ko.observable(item.Phone),self.Website=ko.observable(item.Website),self.PhotoURL=ko.observable(item.PhotoURL),self.ProfileProperties=ko.observable(item.ProfileProperties),self.ProfileUrl=ko.observable(item.ProfileUrl),self.Location=ko.computed(function(){var city=self.City(),country=self.Country(),location=null!=city?city:"";return""!=location&&null!=country&&""!=country&&(location+=", "),null!=country&&(location+=country),location}),self.getProfilePicture=function(w,h){return profilePicHandler.replace("{0}",self.UserId()).replace("{1}",h).replace("{2}",w)},self.acceptFriend=function(){$.ajax({type:"POST",cache:!1,url:baseServicepath+"AcceptFriend",beforeSend:serviceFramework.setModuleHeaders,data:{friendId:self.UserId}}).done(function(data){"success"===data.Result?self.FriendStatus(2):displayMessage(settings.serverErrorText,"dnnFormWarning")}).fail(function(xhr,status){displayMessage(settings.serverErrorWithDescriptionText+status,"dnnFormWarning")})},self.addFriend=function(){$.ajax({type:"POST",cache:!1,url:baseServicepath+"AddFriend",beforeSend:serviceFramework.setModuleHeaders,data:{friendId:self.UserId}}).done(function(data){"success"===data.Result?(self.FriendStatus(1),self.FriendId(self.UserId)):displayMessage(settings.serverErrorText,"dnnFormWarning")}).fail(function(xhr,status){displayMessage(settings.serverErrorWithDescriptionText+status,"dnnFormWarning")})},self.follow=function(){$.ajax({type:"POST",cache:!1,url:baseServicepath+"Follow",beforeSend:serviceFramework.setModuleHeaders,data:{followId:self.UserId}}).done(function(data){"success"===data.Result?self.FollowingStatus(2):displayMessage(settings.serverErrorText,"dnnFormWarning")}).fail(function(xhr,status){displayMessage(settings.serverErrorWithDescriptionText+status,"dnnFormWarning")})},self.removeFriend=function(){$.ajax({type:"POST",cache:!1,url:baseServicepath+"RemoveFriend",beforeSend:serviceFramework.setModuleHeaders,data:{friendId:self.UserId}}).done(function(data){"success"===data.Result?self.FriendStatus(0):displayMessage(settings.serverErrorText,"dnnFormWarning")}).fail(function(xhr,status){displayMessage(settings.serverErrorWithDescriptionText+status,"dnnFormWarning")})},self.unFollow=function(){$.ajax({type:"POST",cache:!1,url:baseServicepath+"UnFollow",beforeSend:serviceFramework.setModuleHeaders,data:{followId:self.UserId}}).done(function(data){"success"===data.Result?self.FollowingStatus(0):displayMessage(settings.serverErrorText,"dnnFormWarning")}).fail(function(xhr,status){displayMessage(settings.serverErrorWithDescriptionText+status,"dnnFormWarning")})}}function MemberDirectoryViewModel(initialData){var self=this,initialMembers=$.map(initialData,function(item){return new Member(item)});self.Visible=ko.observable(!0),self.Members=ko.observableArray(initialMembers),self.CanLoadMore=ko.observable(initialMembers.length==pageSize),self.SearchTerm=ko.observable(""),self.disablePrivateMessage=ko.observable(settings.disablePrivateMessage),self.ResetEnabled=ko.observable(!1),self.HasMembers=ko.computed(function(){return self.Members().length>0},this),self.AdvancedSearchTerm1=ko.observable(""),self.AdvancedSearchTerm2=ko.observable(""),self.AdvancedSearchTerm3=ko.observable(""),self.AdvancedSearchTerm4=ko.observable(""),self.LastSearch=ko.observable("Advanced"),self.loadingData=ko.observable(!1),self.advancedSearch=function(){pageIndex=0,self.SearchTerm(""),self.xhrAdvancedSearch(),self.LastSearch("Advanced"),self.ResetEnabled(!0)},self.basicSearch=function(){pageIndex=0,self.AdvancedSearchTerm1(""),self.AdvancedSearchTerm2(""),self.AdvancedSearchTerm3(""),self.AdvancedSearchTerm4(""),self.xhrBasicSearch(),self.LastSearch("Basic"),self.ResetEnabled(!0)},self.getMember=function(item){self.SearchTerm(item.value),$.ajax({type:"GET",cache:!1,url:baseServicepath+"GetMember",beforeSend:serviceFramework.setModuleHeaders,data:{userId:item.userId}}).done(function(members){if("undefined"!=typeof members&&null!=members){var mappedMembers=$.map(members,function(member){return new Member(member)});self.Members(mappedMembers),self.CanLoadMore(!1)}else displayMessage(settings.serverErrorText,"dnnFormWarning")}).fail(function(xhr,status){displayMessage(settings.serverErrorWithDescriptionText+status,"dnnFormWarning")})},self.getSuggestions=function(term,response){$.ajax({type:"GET",cache:!1,url:baseServicepath+"GetSuggestions",beforeSend:serviceFramework.setModuleHeaders,data:{groupId:groupId,displayName:term}}).done(function(data){response(data)}).fail(function(){displayMessage(settings.searchErrorText,"dnnFormWarning"),response({})})},self.handleAfterRender=function(elements,data){for(var i in elements){var element=elements[i];if(1==element.nodeType){var config={over:function(){$(this).find("div[id$='popUpPanel']").fadeIn("slow")},timeout:500,out:function(){$(this).find("div[id$='popUpPanel']").fadeOut("fast")}};$(element).hoverIntent(config)}}},self.isEven=function(item){return self.Members.indexOf(item)%2==0},self.loadMore=function(){pageIndex++,"Advanced"===self.LastSearch()?self.xhrAdvancedSearch():self.xhrBasicSearch()},self.resetSearch=function(){self.SearchTerm(""),self.AdvancedSearchTerm1(""),self.AdvancedSearchTerm2(""),self.AdvancedSearchTerm3(""),self.AdvancedSearchTerm4(""),self.xhrAdvancedSearch(),self.LastSearch("Advanced"),self.ResetEnabled(!1)},self.xhrAdvancedSearch=function(){$.ajax({type:"GET",cache:!1,url:baseServicepath+"AdvancedSearch",beforeSend:serviceFramework.setModuleHeaders,data:{userId:userId,groupId:groupId,pageIndex:pageIndex,pageSize:pageSize,searchTerm1:self.AdvancedSearchTerm1(),searchTerm2:self.AdvancedSearchTerm2(),searchTerm3:self.AdvancedSearchTerm3(),searchTerm4:self.AdvancedSearchTerm4()}}).done(function(members){if("undefined"!=typeof members&&null!=members){var mappedMembers=$.map(members,function(item){return new Member(item)});if(0===pageIndex)self.Members(mappedMembers);else for(var i=0;i<mappedMembers.length;i++)self.Members.push(mappedMembers[i]);self.CanLoadMore(mappedMembers.length==pageSize)}else displayMessage(settings.searchErrorText,"dnnFormWarning")}).fail(function(xhr,status){displayMessage(settings.searchErrorText,"dnnFormWarning")})},self.xhrBasicSearch=function(){$.ajax({type:"GET",cache:!1,url:baseServicepath+"BasicSearch",beforeSend:serviceFramework.setModuleHeaders,data:{groupId:groupId,searchTerm:self.SearchTerm(),pageIndex:pageIndex,pageSize:pageSize}}).done(function(members){if("undefined"!=typeof members&&null!=members){var mappedMembers=$.map(members,function(item){return new Member(item)});if(0===pageIndex)self.Members(mappedMembers);else for(var i=0;i<mappedMembers.length;i++)self.Members.push(mappedMembers[i]);self.CanLoadMore(mappedMembers.length==pageSize)}else displayMessage(settings.searchErrorText,"dnnFormWarning")}).fail(function(xhr,status){displayMessage(settings.searchErrorText,"dnnFormWarning")})}}var opts=$.extend({},MemberDirectory.defaultSettings,settings),serviceFramework=settings.servicesFramework,baseServicepath=serviceFramework.getServiceRoot("MemberDirectory")+"MemberDirectory/",pageIndex=0,pageSize=opts.pageSize,userId=opts.userId,groupId=opts.groupId,viewerId=opts.viewerId,profilePicHandler=(opts.profileUrl,opts.profileUrlUserToken,opts.profilePicHandler),containerElement=null;this.init=function(element){containerElement=element,$.ajax({type:"GET",cache:!1,url:baseServicepath+"AdvancedSearch",beforeSend:serviceFramework.setModuleHeaders,data:{userId:userId,groupId:groupId,pageIndex:pageIndex,pageSize:pageSize,searchTerm1:"",searchTerm2:"",searchTerm3:"",searchTerm4:""}}).done(function(members){if("undefined"!=typeof members&&null!=members){var viewModel=new MemberDirectoryViewModel(members);ko.applyBindings(viewModel,document.getElementById($(element).attr("id"))),$("input#mdBasicSearch").autocomplete({source:function(request,response){viewModel.getSuggestions(request.term,response)},minLength:1,select:function(event,ui){viewModel.getMember(ui.item)}}),$("a#mdAdvancedSearch").click(function(event){event.preventDefault(),$("div#mdAdvancedSearchForm").slideDown(),$(this).addClass("active"),$(".mdSearch").addClass("active")});var timer,cursorIsOnAdvancedSearchForm;if($("a#mdAdvancedSearch").mouseleave(function(){timer=setTimeout(function(){$("div#mdAdvancedSearchForm").is(":visible")&&!cursorIsOnAdvancedSearchForm&&($("div#mdAdvancedSearchForm").hide(),$(this).removeClass("active"),$(".mdSearch").removeClass("active"))},150)}),$("div#mdAdvancedSearchForm").mouseenter(function(){cursorIsOnAdvancedSearchForm=!0}),$("div#mdAdvancedSearchForm").mouseleave(function(){clearTimeout(timer),cursorIsOnAdvancedSearchForm=!1,$(this).hide(),$("a#mdAdvancedSearch").removeClass("active"),$(".mdSearch").removeClass("active")}),!settings.disablePrivateMessage){var options=$.extend({},{openTriggerSelector:containerElement+" .ComposeMessage",onPrePopulate:function(target){var context=ko.contextFor(target),prePopulatedRecipients=[{id:"user-"+context.$data.UserId(),name:context.$data.DisplayName()}];return prePopulatedRecipients},servicesFramework:serviceFramework},composeMessageSettings);$.fn.dnnComposeMessage(options)}}else displayMessage(settings.serverErrorText,"dnnFormWarning")}).fail(function(xhr,status){displayMessage(settings.serverErrorWithDescriptionText+status,"dnnFormWarning")})}}MemberDirectory.defaultSettings={userId:-1,groupId:-1,viewerId:-1,profileUrl:"",profileUrlUserToken:"PROFILEUSER",addFriendText:"AddFriend",acceptFriendText:"AcceptFriend",friendPendingText:"FriendPendingText",removeFriendText:"RemoveFriendText",followText:"FollowText",unFollowText:"UnFollowText",sendMessageText:"SendMessageText",userNameText:"UserNameText",emailText:"EmailText",cityText:"CityText",serverErrorText:"ServerErrorText",serverErrorWithDescriptionText:"ServerErrorWithDescriptionText"};