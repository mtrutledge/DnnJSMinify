"use strict";define(["jquery","knockout","templatePath/scripts/PersonaBarDialog","knockout.validation.min","dnn.servicesframework","dnn.jquery","dnn.extensions","dnn.jquery.extensions","dnn.DataStructures","jquery.mousewheel","dnn.jScrollBar","dnn.TreeView","dnn.DynamicTreeView","dnn.DropDownList","css.DropDownList","css.jScrollBar"],function($,ko,PersonaBarDialog){var bindViewModel,advancedViewModel,rootFolder,utility,helper,rules,tempRules,pagePickerOptions,allRoles,pagesDropDown,init=function(koObject,connectionHelper,pluginFolder,util){bindViewModel=koObject,rootFolder=pluginFolder,utility=util,helper=connectionHelper,$(document.body).on("click","#connector-GoogleAnalytics .advancedSetting",onAdvancedClick),initRequiredResources(),splitRuleSettings(),getAdvancedViewModel(),ko.validation.localize({required:bindViewModel.resx.Validation_Required}),ko.validation.init({errorMessageClass:"validationMessage"},!0)},onSave=function(koObject){mergeRuleSettings()},initRequiredResources=function(){"undefined"==typeof dnn&&(window.Sys=window.Sys?window.Sys:window.top.Sys,window.dnn=window.dnn?window.dnn:window.top.dnn)},splitRuleSettings=function(){rules=[];for(var i=bindViewModel.configurations.length-1;i>=0;i--){var config=bindViewModel.configurations[i];if("TrackingId"!=config.name&&(bindViewModel.configurations.splice(i,1),0==config.name.indexOf("rule-"))){var id=config.name.substr(5),valueParts=config.value().split("$$$"),pageValue=valueParts[2].split(","),pageId=pageValue[0],pageName=pageValue[1],roleValue=valueParts[3].split(","),roleId=roleValue[0],roleName=roleValue[1];rules.splice(0,0,{id:id,label:valueParts[0],value:valueParts[1],page:pageId,role:roleId,pageName:pageName,roleName:roleName})}}},mergeRuleSettings=function(){for(var i=0;i<rules.length;i++){var rule=rules[i];""===rule.page&&(rule.page="-1"),""===rule.role&&(rule.role="-1");var value=rule.label+"$$$"+rule.value+"$$$"+rule.page+"$$$"+rule.role;bindViewModel.configurations.push({name:"rule-"+(i+1),value:ko.protectedObservable(value)})}},onAfterBind=function(){pagePickerOptions?createPagesDropDown():(utility.sf.moduleRoot="dnncorp/GoogleAnalyticsConnector",utility.sf.controller="Services",utility.sf.get("GetPagePickerOptions",{},function(data){pagePickerOptions=data,pagePickerOptions.onSelectionChangedBackScript=onPageSelectionChanged,createPagesDropDown()})),pagePickerOptions?createRolesDropDown():(utility.sf.moduleRoot="dnncorp/GoogleAnalyticsConnector",utility.sf.controller="Services",utility.sf.get("GetRoles",{},function(data){allRoles=data,createRolesDropDown()}));var $rulesGrid=$(".conn-ga-advancedSetting .rule-grid .items");$rulesGrid.jScrollPane()},createPagesDropDown=function(){pagesDropDown=new dnn.DropDownList(null,pagePickerOptions),$(".conn-ga-advancedSetting .pagesDropDown").append(pagesDropDown.$element)},onPageSelectionChanged=function(){var pageId=pagesDropDown.selectedItem().key;advancedViewModel.editModel.page(pageId)},createRolesDropDown=function(){if(advancedViewModel&&0==advancedViewModel.roleData().length)for(var i=0;i<allRoles.length;i++)advancedViewModel.roleData.push(allRoles[i])},getAdvancedViewModel=function(){return advancedViewModel?resetEditModel():advancedViewModel={editModel:{id:ko.observable(-1),label:ko.observable("").extend({required:!0}),value:ko.observable("").extend({required:!0}),page:ko.observable(""),role:ko.observable("-1")},rules:ko.observableArray(rules),roleData:ko.observableArray([]),resx:bindViewModel.resx,editRule:onEditRule,deleteRule:onDeleteRule,moveUp:onMoveUp,moveDown:onMoveDown},advancedViewModel},resetEditModel=function(item){item||(item={id:-1,label:"",value:"",page:"",role:"-1",pageName:bindViewModel.resx.AnyPage,roleName:bindViewModel.resx.AnyRole}),advancedViewModel.editModel.id(item.id),advancedViewModel.editModel.label(item.label),advancedViewModel.editModel.label.isModified(!1),advancedViewModel.editModel.value(item.value),advancedViewModel.editModel.value.isModified(!1),advancedViewModel.editModel.page(item.page),advancedViewModel.editModel.role(item.role),pagesDropDown&&pagesDropDown.selectedItem({key:item.page,value:item.pageName}),$("#RolesDropDown").val(item.role)},onAdvancedSettingAccept=function(){var editModel=advancedViewModel.editModel,result=ko.validation.group(editModel,{deep:!0});return editModel.isValid()?(editModel.id()==-1?rules.push({id:rules.length+1,label:editModel.label(),value:editModel.value(),page:editModel.page(),role:editModel.role()}):rules.splice(editModel.id()-1,1,{id:editModel.id(),label:editModel.label(),value:editModel.value(),page:editModel.page(),role:editModel.role()}),void helper.saveConnection(bindViewModel,onSaveComplete,!0)):void result.showAllMessages(!0)},onEditRule=function(item,e){resetEditModel(item)},onDeleteRule=function(item,e){utility.confirm(bindViewModel.resx.DeleteConfirm,bindViewModel.resx.Delete,bindViewModel.resx.Cancel,function(){doDeleteRule(item)})},doDeleteRule=function(item){rules.splice(item.id-1,1),helper.saveConnection(bindViewModel,onSaveComplete,!0)},onMoveUp=function(item,e){if(1!=item.id){var currentIndex=item.id-1,rule=rules[currentIndex];rules.splice(currentIndex,1),rules.splice(currentIndex-1,0,rule),helper.saveConnection(bindViewModel,onSaveComplete,!0)}},onMoveDown=function(item,e){if(item.id!=rules.length){var currentIndex=item.id-1,rule=rules[currentIndex];rules.splice(currentIndex,1),rules.splice(currentIndex+1,0,rule),helper.saveConnection(bindViewModel,onSaveComplete,!0)}},onSaveComplete=function(){copyTempRules(),splitRuleSettings();var $rulesGrid=$(".conn-ga-advancedSetting .rule-grid .items"),scollY=0;$rulesGrid.length>0&&$rulesGrid.data("jsp")&&(scollY=$rulesGrid.data("jsp").getContentPositionY(),$rulesGrid.find(".jspContainer").remove(),$rulesGrid.data("jsp",null)),advancedViewModel.rules.removeAll();for(var i=0;i<rules.length;i++)rules[i].pageName||(rules[i].pageName=i<tempRules.length&&tempRules[i].pageName?tempRules[i].pageName:getSelectedPageName()),rules[i].roleName||(rules[i].roleName=i<tempRules.length&&tempRules[i].roleName?tempRules[i].roleName:getSelectedRoleName()),advancedViewModel.rules.push(rules[i]);$rulesGrid.length>0&&($rulesGrid.jScrollPane(),$rulesGrid.data("jsp").scrollToY(scollY)),resetEditModel()},copyTempRules=function(){tempRules=[];for(var i=0;i<rules.length;i++)tempRules.push(rules[i])},getSelectedPageName=function(){return pagesDropDown.selectedItem().value},getSelectedRoleName=function(){for(var rolesDropDown=document.getElementById("RolesDropDown"),selectedValue=rolesDropDown.value,i=0;i<rolesDropDown.options.length;i++)if(rolesDropDown.options[i].value==selectedValue)return rolesDropDown.options[i].text;return""},onAdvancedSettingCancel=function(){},onAdvancedClick=function(){require(["text!rootPath"+rootFolder+"advanced.htm"],function(html){new PersonaBarDialog({inObject:$("body"),width:771,title:bindViewModel.resx.AdvancedSettings,innerTitle:bindViewModel.resx.AdvancedSettingsTitle,cancelBtnLbl:"Cancel",acceptBtnLbl:"Save",onAcceptCallback:onAdvancedSettingAccept,closeOnAccept:!1,onCloseCallback:onAdvancedSettingCancel},html,getAdvancedViewModel,onAfterBind)})},getActionButtons=function(){return[{className:"primarybtn",text:bindViewModel.resx.Save,action:function(conn,e){saveConnection(conn,e)}}]},saveConnection=function(conn,e){conn.save(conn,e,function(success){onSaveComplete()})};return{init:init,onSave:onSave,getActionButtons:getActionButtons}});