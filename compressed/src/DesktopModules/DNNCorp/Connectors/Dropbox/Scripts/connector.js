"use strict";define(["jquery","knockout","templatePath/scripts/config","templatePath/scripts/PersonaBarDialog"],function($,ko,cf,PersonaBarDialog){var helper,bindViewModel,rootFolder,utility,appId,appSecret,authPage,parentFolder,siteConfig=cf.init(),init=function(koObject,connectionHelper,pluginFolder,util){helper=connectionHelper,bindViewModel=koObject,rootFolder=pluginFolder,utility=util,window.testModel=bindViewModel,bindViewModel.parentFolder=ko.observable(""),bindViewModel.foldersData=ko.observableArray([]),"undefined"==typeof dnn&&(window.Sys=window.Sys?window.Sys:window.top.Sys,window.dnn=window.dnn?window.dnn:window.top.dnn),processData(),setTimeout(function(){$("#connector-Dropbox input.senseField").blur(onFieldBlur)},0)},onSave=function(koObject){"undefined"!=typeof bindViewModel.parentFolder&&bindViewModel.configurations.push({name:"ParentFolder",value:ko.protectedObservable(bindViewModel.parentFolder())})},onFieldBlur=function(){var $this=$(this),changed=$this.hasClass("appId")&&$this.val()!=appId||$this.hasClass("appSecret")&&$this.val()!=appSecret;changed&&bindViewModel.connected(!1)},processData=function(){for(var i=bindViewModel.configurations.length-1;i>=0;i--){var config=bindViewModel.configurations[i];if("AppId"!=config.name&&"AppSecret"!=config.name)switch(config.name.toLowerCase()){case"connected":bindViewModel.connected("true"==config.value()),bindViewModel.configurations.splice(i,1);break;case"authpage":authPage=config.value();break;case"parentfolder":parentFolder=config.value(),bindViewModel.configurations.splice(i,1)}else"AppId"==config.name?appId=config.value():"AppSecret"==config.name&&(appSecret=config.value())}bindViewModel.connected()&&0==bindViewModel.foldersData().length&&setTimeout(loadFoldersData,0)},loadingFolders=!1,loadFoldersData=function(){if(!loadingFolders){var foldersDropDown=$("#DropboxFoldersDropDown");showLoading(foldersDropDown),utility.sf.moduleRoot="dnncorp/DropboxConnector",utility.sf.controller="Services",utility.sf.get("GetAllFolders",{},function(data){bindViewModel.foldersData.removeAll();for(var i=0;i<data.length;i++)bindViewModel.foldersData.push({folderPath:data[i]});setTimeout(function(){"undefined"!=typeof parentFolder&&""!=parentFolder||(parentFolder="/"),bindViewModel.parentFolder(parentFolder),hideLoading()},0)},function(xhr){var message=xhr.responseJSON.Message;0==message.indexOf("{")&&(message=JSON.parse(message).error),utility.notifyError(message)})}},showLoading=function(element){var $loading=$('<div class="loading"></div>').html(bindViewModel.resx.Loading);element.after($loading),loadingFolders=!0},hideLoading=function(){$("#connector-Dropbox .loading").remove(),loadingFolders=!1},getCookie=function(name,success,fail){utility.sf.moduleRoot="dnncorp/DropboxConnector",utility.sf.controller="Services",utility.sf.call("GET","GetAuthCookie",{},function(data){data.value?success(data.value):fail()},function(xhr){},null,null,!1,!0)},removeCookie=function(name){utility.sf.moduleRoot="dnncorp/DropboxConnector",utility.sf.controller="Services",utility.sf.call("GET","RemoveAuthCookie",{},function(data){},function(xhr){},null,null,!0,!0)},onSaveComplete=function(){processData(),bindViewModel.connected()||""==appId||""==appSecret?(bindViewModel.inEdit(!1),$("#connector-Dropbox").slideUp(200,"linear"),utility.notify(utility.resx.PersonaBar.txt_Saved,!0)):showAuthWindow()},checkCookieTimer,dropboxAuthCookieName="DropboxAuthCookie",cookieTimeout=500,showAuthWindow=function(){utility.sf.moduleRoot="dnncorp/DropboxConnector",utility.sf.controller="Services",utility.sf.call("GET","GetFolderMappingId",{},function(data){var url=authPage.replace("{0}",data);popupwindow(url,"DropboxAuth",770,600),checkCookieTimer&&clearTimeout(checkCookieTimer),checkCookieTimer=setTimeout(checkCookieForAuth,cookieTimeout)},function(xhr){utility.notifyError("Failed...")},null,null,!0,!1)},checkCookieForAuth=function(){getCookie(dropboxAuthCookieName,function(authCookie){removeCookie(dropboxAuthCookieName),eval(authCookie)},function(){checkCookieTimer=setTimeout(checkCookieForAuth,cookieTimeout)})},popupwindow=function(url,title,width,height){var winLeft=window.screenLeft?window.screenLeft:window.screenX,winTop=window.screenTop?window.screenTop:window.screenY,left=winLeft+(window.innerWidth-width)/2,top=winTop+(window.innerHeight-height)/2,params="toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no,width="+width+", height="+height+", top="+top+", left="+left;return window.open(url,title,params)},authCallback=window.DropboxAuthCallback=function(success,message){if(0==message.indexOf("{")&&(message=JSON.parse(message).error),$(".personaBarDialog .actions .btn-cancel").click(),success){utility.notify(bindViewModel.resx.AuthenticationSuccess,!0),bindViewModel.connected(!0);var c={name:"connected",value:ko.protectedObservable("true")};bindViewModel.configurations.push(c),loadFoldersData(),processData()}else utility.notifyError(message)},authenticate=function(conn,e){e.preventDefault(),$.each(conn.configurations,function(i,v){v.value.commit()}),saveConnection(conn,onSaveComplete)},onSaveConnection=!1,saveConnection=function(conn,success){if(!onSaveConnection){onSaveConnection=!0,conn.connector&&conn.connector.onSave(conn),utility.sf.moduleRoot="dnncorp/personaBar",utility.sf.controller="connections";for(var postData={name:conn.name,configurations:[]},allEmpty=!0,allFilled=!0,i=0;i<conn.configurations.length;i++){var c=conn.configurations[i],value=c.value();postData.configurations.push({name:c.name,value:c.value()}),"AppId"!=c.name&&"AppSecret"!=c.name||(""!=value?allEmpty=!1:allFilled=!1)}var primaryButtons=$("#connector-"+conn.name).find("a.primarybtn");if(!allEmpty&&!allFilled)return primaryButtons.addClass("disabledbtn"),void(onSaveConnection=!1);primaryButtons.removeClass("disabledbtn"),utility.sf.call("POST","SaveConnection",postData,function(d){d&&d.Success?success():utility.notifyError("Failed..."),onSaveConnection=!1},function(){utility.notifyError("Failed..."),onSaveConnection=!1},null,null,!0,!1)}},getActionButtons=function(){return[{className:"primarybtn",text:bindViewModel.resx.Save,action:function(conn,e){bindViewModel.connected()?conn.save(conn,e,function(success){onSaveComplete()}):authenticate(conn,e)}}]};return{init:init,onSave:onSave,getActionButtons:getActionButtons}});