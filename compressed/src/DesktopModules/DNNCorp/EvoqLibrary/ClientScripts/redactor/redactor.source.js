!function($){"use strict";function Redactor(el,options){return new Redactor.prototype.init(el,options)}Function.prototype.bind||(Function.prototype.bind=function(scope){var fn=this;return function(){return fn.apply(scope)}});var uuid=0;$.fn.dnnRedactor=function(options){var val=[],args=Array.prototype.slice.call(arguments,1);return"string"==typeof options?this.each(function(){var func,instance=$.data(this,"redactor");if("-1"!=options.search(/\./)?(func=options.split("."),"undefined"!=typeof instance[func[0]]&&(func=instance[func[0]][func[1]])):func=instance[options],"undefined"!=typeof instance&&$.isFunction(func)){var methodVal=func.apply(instance,args);void 0!==methodVal&&methodVal!==instance&&val.push(methodVal)}else $.error('No such method "'+options+'" for Redactor')}):this.each(function(){$.data(this,"redactor",{}),$.data(this,"redactor",Redactor(this,options))}),0===val.length?this:1===val.length?val[0]:val},$.dnnRedactor=Redactor,$.dnnRedactor.VERSION="10.2",$.dnnRedactor.modules=["alignment","autosave","block","buffer","build","button","caret","clean","code","core","dropdown","file","focus","image","indent","inline","insert","keydown","keyup","lang","line","link","linkify","list","modal","observe","paragraphize","paste","placeholder","progress","selection","shortcuts","tabifier","tidy","toolbar","upload","utils"],$.dnnRedactor.opts={lang:"en",direction:"ltr",plugins:!1,focus:!1,focusEnd:!1,placeholder:!1,visual:!0,tabindex:!1,minHeight:!1,maxHeight:!1,linebreaks:!1,replaceDivs:!0,paragraphize:!0,cleanStyleOnEnter:!1,enterKey:!0,cleanOnPaste:!0,cleanSpaces:!0,pastePlainText:!1,autosave:!1,autosaveName:!1,autosaveInterval:60,autosaveOnChange:!1,autosaveFields:!1,linkTooltip:!0,linkProtocol:"http",linkNofollow:!1,linkSize:50,imageEditable:!0,imageLink:!0,imagePosition:!0,imageFloatMargin:"10px",imageResizable:!0,imageUpload:null,imageUploadParam:"file",uploadImageField:!1,dragImageUpload:!0,fileUpload:null,fileUploadParam:"file",dragFileUpload:!0,s3:!1,convertLinks:!0,convertUrlLinks:!0,convertImageLinks:!0,convertVideoLinks:!0,preSpaces:4,tabAsSpaces:!1,tabKey:!0,scrollTarget:!1,toolbar:!0,toolbarFixed:!0,toolbarFixedTarget:document,toolbarFixedTopOffset:0,toolbarExternal:!1,toolbarOverflow:!1,source:!0,buttons:["html","formatting","bold","italic","deleted","unorderedlist","orderedlist","outdent","indent","image","file","link","alignment","horizontalrule"],buttonsHide:[],buttonsHideOnMobile:[],formatting:["p","blockquote","pre","h1","h2","h3","h4","h5","h6"],formattingAdd:!1,tabifier:!0,deniedTags:["script","style"],allowedTags:!1,paragraphizeBlocks:["table","div","pre","form","ul","ol","h1","h2","h3","h4","h5","h6","dl","blockquote","figcaption","address","section","header","footer","aside","article","object","style","script","iframe","select","input","textarea","button","option","map","area","math","hr","fieldset","legend","hgroup","nav","figure","details","menu","summary","p"],removeComments:!1,replaceTags:[["strike","del"],["b","strong"]],replaceStyles:[["font-weight:\\s?bold","strong"],["font-style:\\s?italic","em"],["text-decoration:\\s?underline","u"],["text-decoration:\\s?line-through","del"]],removeDataAttr:!1,removeAttr:!1,allowedAttr:!1,removeWithoutAttr:["span"],removeEmpty:["p"],activeButtons:["deleted","italic","bold","underline","unorderedlist","orderedlist","alignleft","aligncenter","alignright","justify"],activeButtonsStates:{b:"bold",strong:"bold",i:"italic",em:"italic",del:"deleted",strike:"deleted",ul:"unorderedlist",ol:"orderedlist",u:"underline"},shortcuts:{"ctrl+shift+m, meta+shift+m":{func:"inline.removeFormat"},"ctrl+b, meta+b":{func:"inline.format",params:["bold"]},"ctrl+i, meta+i":{func:"inline.format",params:["italic"]},"ctrl+h, meta+h":{func:"inline.format",params:["superscript"]},"ctrl+l, meta+l":{func:"inline.format",params:["subscript"]},"ctrl+k, meta+k":{func:"link.show"},"ctrl+shift+7":{func:"list.toggle",params:["orderedlist"]},"ctrl+shift+8":{func:"list.toggle",params:["unorderedlist"]}},shortcutsAdd:!1,buffer:[],rebuffer:[],emptyHtml:"<p>&#x200b;</p>",invisibleSpace:"&#x200b;",imageTypes:["image/png","image/jpeg","image/gif"],indentValue:20,verifiedTags:["a","img","b","strong","sub","sup","i","em","u","small","strike","del","cite","ul","ol","li"],inlineTags:["strong","b","u","em","i","code","del","ins","samp","kbd","sup","sub","mark","var","cite","small"],alignmentTags:["P","H1","H2","H3","H4","H5","H6","DL","DT","DD","DIV","TD","BLOCKQUOTE","OUTPUT","FIGCAPTION","ADDRESS","SECTION","HEADER","FOOTER","ASIDE","ARTICLE"],blockLevelElements:["PRE","UL","OL","LI"],highContrast:!1,observe:{dropdowns:[]},langs:{en:{html:"HTML",video:"Insert Video",image:"Insert Image",table:"Table",link:"Link",link_insert:"Insert link",link_edit:"Edit link",unlink:"Unlink",formatting:"Formatting",paragraph:"Normal text",quote:"Quote",code:"Code",header1:"Header 1",header2:"Header 2",header3:"Header 3",header4:"Header 4",header5:"Header 5",bold:"Bold",italic:"Italic",fontcolor:"Font Color",backcolor:"Back Color",unorderedlist:"Unordered List",orderedlist:"Ordered List",outdent:"Outdent",indent:"Indent",cancel:"Cancel",insert:"Insert",save:"Save",_delete:"Delete",insert_table:"Insert Table",insert_row_above:"Add Row Above",insert_row_below:"Add Row Below",insert_column_left:"Add Column Left",insert_column_right:"Add Column Right",delete_column:"Delete Column",delete_row:"Delete Row",delete_table:"Delete Table",rows:"Rows",columns:"Columns",add_head:"Add Head",delete_head:"Delete Head",title:"Title",image_position:"Position",none:"None",left:"Left",right:"Right",center:"Center",image_web_link:"Image Web Link",text:"Text",mailto:"Email",web:"URL",video_html_code:"Video Embed Code or Youtube/Vimeo Link",file:"Insert File",upload:"Upload",download:"Download",choose:"Choose",or_choose:"Or choose",drop_file_here:"Drop file here",align_left:"Align text to the left",align_center:"Center text",align_right:"Align text to the right",align_justify:"Justify text",horizontalrule:"Insert Horizontal Rule",deleted:"Deleted",anchor:"Anchor",link_new_tab:"Open link in new tab",underline:"Underline",alignment:"Alignment",filename:"Name (optional)",edit:"Edit",upload_label:"Drop file here or ",exceedLimit:"This file is above the {0} Mb limit, please upload a smaller file."}},linkify:{regexps:{youtube:/https?:\/\/(?:[0-9A-Z-]+\.)?(?:youtu\.be\/|youtube\.com\S*[^\w\-\s])([\w\-]{11})(?=[^\w\-]|$)(?![?=&+%\w.\-]*(?:['"][^<>]*>|<\/a>))[?=&+%\w.-]*/gi,vimeo:/https?:\/\/(www\.)?vimeo.com\/(\d+)($|\/)/,image:/((https?|www)[^\s]+\.)(jpe?g|png|gif)(\?[^\s-]+)?/gi,url:/(https?:\/\/(?:www\.|(?!www))[^\s\.]+\.[^\s]{2,}|www\.[^\s]+\.[^\s]{2,})/gi}},codemirror:!1},Redactor.fn=$.dnnRedactor.prototype={keyCode:{BACKSPACE:8,DELETE:46,UP:38,DOWN:40,ENTER:13,SPACE:32,ESC:27,TAB:9,CTRL:17,META:91,SHIFT:16,ALT:18,RIGHT:39,LEFT:37,LEFT_WIN:91},init:function(el,options){if(this.$element=$(el),this.uuid=uuid++,this.rtePaste=!1,this.$pasteBox=!1,this.loadOptions(options),this.loadModules(),this.formatting={},$.merge(this.opts.blockLevelElements,this.opts.alignmentTags),this.reIsBlock=new RegExp("^("+this.opts.blockLevelElements.join("|")+")$","i"),this.tidy.setupAllowed(),this.opts.deniedTags!==!1)for(var tags=["html","head","link","body","meta","applet"],i=0;i<tags.length;i++)this.opts.deniedTags.push(tags[i]);this.lang.load(),$.extend(this.opts.shortcuts,this.opts.shortcutsAdd),this.core.setCallback("start"),this.start=!0,this.build.run()},loadOptions:function(options){this.opts=$.extend({},$.extend(!0,{},$.dnnRedactor.opts),this.$element.data(),options)},getModuleMethods:function(object){return Object.getOwnPropertyNames(object).filter(function(property){return"function"==typeof object[property]})},loadModules:function(){for(var len=$.dnnRedactor.modules.length,i=0;i<len;i++)this.bindModuleMethods($.dnnRedactor.modules[i])},bindModuleMethods:function(module){if("undefined"!=typeof this[module]){this[module]=this[module]();for(var methods=this.getModuleMethods(this[module]),len=methods.length,z=0;z<len;z++)this[module][methods[z]]=this[module][methods[z]].bind(this)}},alignment:function(){return{left:function(){this.alignment.set("")},right:function(){this.alignment.set("right")},center:function(){this.alignment.set("center")},justify:function(){this.alignment.set("justify")},set:function(type){this.utils.browser("msie")||this.$editor.focus(),this.buffer.set(),this.selection.save(),this.alignment.blocks=this.selection.getBlocks(),this.alignment.type=type,this.alignment.isLinebreaksOrNoBlocks()?this.alignment.setText():this.alignment.setBlocks(),this.selection.restore(),this.code.sync()},setText:function(){var wrapper=this.selection.wrap("div");$(wrapper).attr("data-tagblock","redactor").css("text-align",this.alignment.type)},setBlocks:function(){$.each(this.alignment.blocks,$.proxy(function(i,el){var $el=this.utils.getAlignmentElement(el);$el&&(this.alignment.isNeedReplaceElement($el)?this.alignment.replaceElement($el):this.alignment.alignElement($el))},this))},isLinebreaksOrNoBlocks:function(){return this.opts.linebreaks&&this.alignment.blocks[0]===!1},isNeedReplaceElement:function($el){return""===this.alignment.type&&"undefined"!=typeof $el.data("tagblock")},replaceElement:function($el){$el.replaceWith($el.html())},alignElement:function($el){$el.css("text-align",this.alignment.type),this.utils.removeEmptyAttr($el,"style")}}},autosave:function(){return{html:!1,enable:function(){this.opts.autosave&&(this.autosave.name=this.opts.autosaveName?this.opts.autosaveName:this.$textarea.attr("name"),this.opts.autosaveOnChange||(this.autosaveInterval=setInterval(this.autosave.load,1e3*this.opts.autosaveInterval)))},onChange:function(){this.opts.autosaveOnChange&&this.autosave.load()},load:function(){if(this.autosave.source=this.code.get(),this.autosave.html!==this.autosave.source){var data={};data.name=this.autosave.name,data[this.autosave.name]=this.autosave.source,data=this.autosave.getHiddenFields(data);var jsxhr=$.ajax({url:this.opts.autosave,type:"post",data:data});jsxhr.done(this.autosave.success)}},getHiddenFields:function(data){return this.opts.autosaveFields===!1||"object"!=typeof this.opts.autosaveFields?data:($.each(this.opts.autosaveFields,$.proxy(function(k,v){null!==v&&0===v.toString().indexOf("#")&&(v=$(v).val()),data[k]=v},this)),data)},success:function(data){var json;try{json=$.parseJSON(data)}catch(e){json=data}var callbackName="undefined"==typeof json.error?"autosave":"autosaveError";this.core.setCallback(callbackName,this.autosave.name,json),this.autosave.html=this.autosave.source},disable:function(){clearInterval(this.autosaveInterval)}}},block:function(){return{formatting:function(name){this.block.clearStyle=!1;var type,value;"undefined"!=typeof this.formatting[name].data?type="data":"undefined"!=typeof this.formatting[name].attr?type="attr":"undefined"!=typeof this.formatting[name].class&&(type="class"),"undefined"!=typeof this.formatting[name].clear&&(this.block.clearStyle=!0),type&&(value=this.formatting[name][type]),this.block.format(this.formatting[name].tag,type,value)},format:function(tag,type,value){"quote"==tag&&(tag="blockquote");var formatTags=["p","pre","blockquote","h1","h2","h3","h4","h5","h6"];if($.inArray(tag,formatTags)!=-1){this.block.isRemoveInline="pre"==tag||tag.search(/h[1-6]/i)!=-1,this.utils.browser("msie")||this.$editor.focus();var html=$.trim(this.$editor.html());if(this.block.isEmpty=this.utils.isEmpty(html),this.utils.browser("mozilla")&&!this.focus.isFocused()&&this.block.isEmpty){var $first;this.opts.linebreaks||($first=this.$editor.children().first(),this.caret.setEnd($first))}this.block.blocks=this.selection.getBlocks(),this.block.blocksSize=this.block.blocks.length,this.block.type=type,this.block.value=value,this.buffer.set(),this.selection.save(),this.block.set(tag),this.selection.restore(),this.code.sync()}},set:function(tag){this.selection.get(),this.block.containerTag=this.range.commonAncestorContainer.tagName,this.range.collapsed?this.block.setCollapsed(tag):this.block.setMultiple(tag)},setCollapsed:function(tag){if(this.opts.linebreaks&&this.block.isEmpty&&"p"!=tag){var node=document.createElement(tag);return this.$editor.html(node),void this.caret.setEnd(node)}var block=this.block.blocks[0];if(block!==!1){if("LI"==block.tagName){if("blockquote"!=tag)return;return void this.block.formatListToBlockquote()}var isContainerTable="TD"==this.block.containerTag||"TH"==this.block.containerTag;if(isContainerTable&&!this.opts.linebreaks)document.execCommand("formatblock",!1,"<"+tag+">"),block=this.selection.getBlock(),this.block.toggle($(block));else if(block.tagName.toLowerCase()!=tag)if(this.opts.linebreaks&&"p"==tag)$(block).append("<br>"),this.utils.replaceWithContents(block);else{var $formatted=this.utils.replaceToTag(block,tag);this.block.toggle($formatted),"p"!=tag&&"blockquote"!=tag&&$formatted.find("img").remove(),this.block.isRemoveInline&&this.utils.removeInlineTags($formatted),("p"==tag||this.block.headTag)&&$formatted.find("p").contents().unwrap(),this.block.formatTableWrapping($formatted)}else if("blockquote"==tag&&block.tagName.toLowerCase()==tag)if(this.opts.linebreaks)$(block).append("<br>"),this.utils.replaceWithContents(block);else{var $el=this.utils.replaceToTag(block,"p");this.block.toggle($el)}else block.tagName.toLowerCase()==tag&&this.block.toggle($(block));"undefined"==typeof this.block.type&&"undefined"==typeof this.block.value&&$(block).removeAttr("class").removeAttr("style")}},setMultiple:function(tag){var block=this.block.blocks[0],isContainerTable="TD"==this.block.containerTag||"TH"==this.block.containerTag;if(block!==!1&&1===this.block.blocksSize)if(block.tagName.toLowerCase()==tag&&"blockquote"==tag)if(this.opts.linebreaks)$(block).append("<br>"),this.utils.replaceWithContents(block);else{var $el=this.utils.replaceToTag(block,"p");this.block.toggle($el)}else if("LI"==block.tagName){if("blockquote"!=tag)return;this.block.formatListToBlockquote()}else if("BLOCKQUOTE"==this.block.containerTag)this.block.formatBlockquote(tag);else if(this.opts.linebreaks&&(isContainerTable||this.range.commonAncestorContainer!=block))this.block.formatWrap(tag);else if(this.opts.linebreaks&&"p"==tag)$(block).prepend("<br>").append("<br>"),this.utils.replaceWithContents(block);else if("TD"===block.tagName)this.block.formatWrap(tag);else{var $formatted=this.utils.replaceToTag(block,tag);this.block.toggle($formatted),this.block.isRemoveInline&&this.utils.removeInlineTags($formatted),("p"==tag||this.block.headTag)&&$formatted.find("p").contents().unwrap()}else if(this.opts.linebreaks||"p"!=tag){if("blockquote"==tag){for(var count=0,i=0;i<this.block.blocksSize;i++)"BLOCKQUOTE"==this.block.blocks[i].tagName&&count++;if(count==this.block.blocksSize)return void $.each(this.block.blocks,$.proxy(function(i,s){var $formatted=!1;this.opts.linebreaks?($(s).prepend("<br>").append("<br>"),$formatted=this.utils.replaceWithContents(s)):$formatted=this.utils.replaceToTag(s,"p"),$formatted&&"undefined"==typeof this.block.type&&"undefined"==typeof this.block.value&&$formatted.removeAttr("class").removeAttr("style")},this))}this.block.formatWrap(tag)}else{var classSize=0,toggleType=!1;"class"==this.block.type&&(toggleType="toggle",classSize=$(this.block.blocks).filter("."+this.block.value).length,this.block.blocksSize==classSize?toggleType="toggle":this.block.blocksSize>classSize?toggleType="set":0===classSize&&(toggleType="set"));var exceptTags=["ul","ol","li","td","th","dl","dt","dd"];$.each(this.block.blocks,$.proxy(function(i,s){if($.inArray(s.tagName.toLowerCase(),exceptTags)==-1){var $formatted=this.utils.replaceToTag(s,tag);toggleType?"toggle"==toggleType?this.block.toggle($formatted):"remove"==toggleType?this.block.remove($formatted):"set"==toggleType&&this.block.setForce($formatted):this.block.toggle($formatted),"p"!=tag&&"blockquote"!=tag&&$formatted.find("img").remove(),this.block.isRemoveInline&&this.utils.removeInlineTags($formatted),("p"==tag||this.block.headTag)&&$formatted.find("p").contents().unwrap(),"undefined"==typeof this.block.type&&"undefined"==typeof this.block.value&&$formatted.removeAttr("class").removeAttr("style")}},this))}},setForce:function($el){return this.block.clearStyle&&$el.removeAttr("class").removeAttr("style"),"class"==this.block.type?void $el.addClass(this.block.value):"attr"==this.block.type||"data"==this.block.type?void $el.attr(this.block.value.name,this.block.value.value):void 0},toggle:function($el){return this.block.clearStyle&&$el.removeAttr("class").removeAttr("style"),"class"==this.block.type?void $el.toggleClass(this.block.value):"attr"==this.block.type||"data"==this.block.type?void($el.attr(this.block.value.name)==this.block.value.value?$el.removeAttr(this.block.value.name):$el.attr(this.block.value.name,this.block.value.value)):void $el.removeAttr("style class")},remove:function($el){$el.removeClass(this.block.value)},formatListToBlockquote:function(){var block=$(this.block.blocks[0]).closest("ul, ol",this.$editor[0]);$(block).find("ul, ol").contents().unwrap(),$(block).find("li").append($("<br>")).contents().unwrap();var $el=this.utils.replaceToTag(block,"blockquote");this.block.toggle($el)},formatBlockquote:function(tag){document.execCommand("outdent"),document.execCommand("formatblock",!1,tag),this.clean.clearUnverified(),this.$editor.find("p:empty").remove();var formatted=this.selection.getBlock();"p"!=tag&&$(formatted).find("img").remove(),this.opts.linebreaks||this.block.toggle($(formatted)),this.$editor.find("ul, ol, tr, blockquote, p").each($.proxy(this.utils.removeEmpty,this)),this.opts.linebreaks&&"p"==tag&&this.utils.replaceWithContents(formatted)},formatWrap:function(tag){if("UL"==this.block.containerTag||"OL"==this.block.containerTag){if("blockquote"!=tag)return;this.block.formatListToBlockquote()}var formatted=this.selection.wrap(tag);if(formatted!==!1){var $formatted=$(formatted);this.block.formatTableWrapping($formatted);var $elements=$formatted.find(this.opts.blockLevelElements.join(",")+", td, table, thead, tbody, tfoot, th, tr");if($elements.contents().unwrap(),"p"!=tag&&"blockquote"!=tag&&$formatted.find("img").remove(),$.each(this.block.blocks,$.proxy(this.utils.removeEmpty,this)),$formatted.append(this.selection.getMarker(2)),this.opts.linebreaks||this.block.toggle($formatted),this.$editor.find("ul, ol, tr, blockquote, p").each($.proxy(this.utils.removeEmpty,this)),$formatted.find("blockquote:empty").remove(),this.block.isRemoveInline&&this.utils.removeInlineTags($formatted),this.opts.linebreaks&&"p"==tag&&this.utils.replaceWithContents($formatted),this.opts.linebreaks){var $next=$formatted.next().next();0!=$next.size()&&"BR"===$next[0].tagName&&$next.remove()}}},formatTableWrapping:function($formatted){0!==$formatted.closest("table",this.$editor[0]).length&&(0===$formatted.closest("tr",this.$editor[0]).length&&$formatted.wrap("<tr>"),0===$formatted.closest("td",this.$editor[0]).length&&0===$formatted.closest("th").length&&$formatted.wrap("<td>"))},removeData:function(name,value){var blocks=this.selection.getBlocks();$(blocks).removeAttr("data-"+name),this.code.sync()},setData:function(name,value){var blocks=this.selection.getBlocks();$(blocks).attr("data-"+name,value),this.code.sync()},toggleData:function(name,value){var blocks=this.selection.getBlocks();$.each(blocks,function(){$(this).attr("data-"+name)?$(this).removeAttr("data-"+name):$(this).attr("data-"+name,value)})},removeAttr:function(attr,value){var blocks=this.selection.getBlocks();$(blocks).removeAttr(attr),this.code.sync()},setAttr:function(attr,value){var blocks=this.selection.getBlocks();$(blocks).attr(attr,value),this.code.sync()},toggleAttr:function(attr,value){var blocks=this.selection.getBlocks();$.each(blocks,function(){$(this).attr(name)?$(this).removeAttr(name):$(this).attr(name,value)})},removeClass:function(className){var blocks=this.selection.getBlocks();$(blocks).removeClass(className),this.utils.removeEmptyAttr(blocks,"class"),this.code.sync()},setClass:function(className){var blocks=this.selection.getBlocks();$(blocks).addClass(className),this.code.sync()},toggleClass:function(className){var blocks=this.selection.getBlocks();$(blocks).toggleClass(className),this.code.sync()}}},buffer:function(){return{set:function(type){"undefined"==typeof type||"undo"==type?this.buffer.setUndo():this.buffer.setRedo()},setUndo:function(){this.selection.save(),this.opts.buffer.push(this.$editor.html()),this.selection.restore()},setRedo:function(){this.selection.save(),this.opts.rebuffer.push(this.$editor.html()),this.selection.restore()},getUndo:function(){this.$editor.html(this.opts.buffer.pop())},getRedo:function(){this.$editor.html(this.opts.rebuffer.pop())},add:function(){this.opts.buffer.push(this.$editor.html())},undo:function(){0!==this.opts.buffer.length&&(this.buffer.set("redo"),this.buffer.getUndo(),this.selection.restore(),setTimeout($.proxy(this.observe.load,this),50))},redo:function(){0!==this.opts.rebuffer.length&&(this.buffer.set("undo"),this.buffer.getRedo(),this.selection.restore(),setTimeout($.proxy(this.observe.load,this),50))}}},build:function(){return{run:function(){this.build.createContainerBox(),this.build.loadContent(),this.build.loadEditor(),this.build.enableEditor(),this.build.setCodeAndCall()},isTextarea:function(){return"TEXTAREA"===this.$element[0].tagName},createContainerBox:function(){this.$box=$('<div class="redactor-box" role="application" />')},createTextarea:function(){this.$textarea=$("<textarea />").attr("name",this.build.getTextareaName())},getTextareaName:function(){return"undefined"==typeof name?"content-"+this.uuid:this.$element.attr("id")},loadContent:function(){var func=this.build.isTextarea()?"val":"html";this.content=$.trim(this.$element[func]())},enableEditor:function(){this.$editor.attr({contenteditable:!0,dir:this.opts.direction})},loadEditor:function(){var func=this.build.isTextarea()?"fromTextarea":"fromElement";this.build[func]()},fromTextarea:function(){this.$editor=$("<div />"),this.$textarea=this.$element,this.$box.insertAfter(this.$element).append(this.$editor).append(this.$element),this.$editor.addClass("redactor-editor"),this.$element.hide()},fromElement:function(){this.$editor=this.$element,this.build.createTextarea(),this.$box.insertAfter(this.$editor).append(this.$editor).append(this.$textarea),this.$editor.addClass("redactor-editor"),this.$textarea.hide()},setCodeAndCall:function(){this.code.set(this.content),this.build.setOptions(),this.build.callEditor(),this.opts.visual||setTimeout($.proxy(this.code.showCode,this),200)},callEditor:function(){this.build.disableMozillaEditing(),this.build.disableIeLinks(),this.build.setEvents(),this.build.setHelpers(),this.opts.toolbar&&(this.opts.toolbar=this.toolbar.init(),this.toolbar.build()),this.modal.loadTemplates(),this.build.plugins(),setTimeout($.proxy(this.observe.load,this),4),this.core.setCallback("init")},setOptions:function(){$(this.$textarea).attr("dir",this.opts.direction),this.opts.linebreaks&&this.$editor.addClass("redactor-linebreaks"),this.opts.tabindex&&this.$editor.attr("tabindex",this.opts.tabindex),this.opts.minHeight&&this.$editor.css("minHeight",this.opts.minHeight),this.opts.maxHeight&&this.$editor.css("maxHeight",this.opts.maxHeight)},setEventDropUpload:function(e){if(e.preventDefault(),this.opts.dragImageUpload&&this.opts.dragFileUpload){var files=e.dataTransfer.files;this.upload.directUpload(files[0],e)}},setEventDrop:function(e){this.code.sync(),setTimeout(this.clean.clearUnverified,1),this.core.setCallback("drop",e)},setEvents:function(){this.$editor.on("drop.redactor",$.proxy(function(e){return e=e.originalEvent||e,void 0===window.FormData||!e.dataTransfer||(0===e.dataTransfer.files.length?this.build.setEventDrop(e):(this.build.setEventDropUpload(e),setTimeout(this.clean.clearUnverified,1),void this.core.setCallback("drop",e)))},this)),this.$editor.on("click.redactor",$.proxy(function(e){var event=this.core.getEvent(),type="click"!=event&&"arrow"!=event&&"click";this.core.addEvent(type),this.utils.disableSelectAll(),this.core.setCallback("click",e)},this)),this.$editor.on("paste.redactor",$.proxy(this.paste.init,this)),this.$editor.on("cut.redactor",$.proxy(this.code.sync,this)),this.$editor.on("keydown.redactor",$.proxy(this.keydown.init,this)),this.$editor.on("keyup.redactor",$.proxy(this.keyup.init,this)),$.isFunction(this.opts.codeKeydownCallback)&&this.$textarea.on("keydown.redactor-textarea",$.proxy(this.opts.codeKeydownCallback,this)),$.isFunction(this.opts.codeKeyupCallback)&&this.$textarea.on("keyup.redactor-textarea",$.proxy(this.opts.codeKeyupCallback,this)),$.isFunction(this.opts.focusCallback)&&this.$editor.on("focus.redactor",$.proxy(this.opts.focusCallback,this));var clickedElement;this.$editor.on("dragover.redactor",$.proxy(function(e){e.stopPropagation(),e.preventDefault()},this)),this._documentClickEventHandler||(this._documentClickEventHandler=$.proxy(function(e){clickedElement=$(e.target);var blockBlur=clickedElement.parents(".redactor-blockBlur").size()>0||clickedElement.parents(".redactor-box").size()>0||"redactor-modal-overlay"==clickedElement.attr("id");blockBlur||this.$editor.triggerHandler("blur.redactor")},this)),$(document).mousedown(this._documentClickEventHandler),this.$editor.on("blur.redactor",$.proxy(function(e){var $clickedElement=$(clickedElement);if(!$clickedElement.hasClass("redactor-toolbar")&&0==$clickedElement.parents(".redactor-toolbar").size()&&0==$clickedElement.parents(".redactor-blockBlur").size()&&0==$clickedElement.parents(".redactor-box").size()&&"redactor-modal-overlay"!=$clickedElement.attr("id")){if(this.rtePaste)return;if(this.blurClickedElement=clickedElement,!this.build.isBlured())return;this.utils.disableSelectAll(),$.isFunction(this.opts.blurCallback)&&this.core.setCallback("blur",e)}},this))},isBlured:function(){if(this.blurClickedElement===!0)return!0;var $el=$(this.blurClickedElement);return!$el.hasClass("redactor-toolbar, redactor-dropdown")&&!$el.is("#redactor-modal")&&0===$el.parents(".redactor-toolbar, .redactor-dropdown, #redactor-modal").length},setHelpers:function(){this.linkify.isEnabled()&&this.linkify.format(),this.placeholder.enable(),this.opts.focus&&setTimeout(this.focus.setStart,100),this.opts.focusEnd&&setTimeout(this.focus.setEnd,100)},plugins:function(){this.opts.plugins&&$.each(this.opts.plugins,$.proxy(function(i,s){var func="undefined"!=typeof RedactorPlugins&&"undefined"!=typeof RedactorPlugins[s]?RedactorPlugins:Redactor.fn;if($.isFunction(func[s])){this[s]=func[s]();for(var methods=this.getModuleMethods(this[s]),len=methods.length,z=0;z<len;z++)this[s][methods[z]]=this[s][methods[z]].bind(this);$.isFunction(this[s].init)&&this[s].init()}},this))},disableMozillaEditing:function(){if(this.utils.browser("mozilla"))try{document.execCommand("enableObjectResizing",!1,!1),document.execCommand("enableInlineTableEditing",!1,!1)}catch(e){}},disableIeLinks:function(){this.utils.browser("ie")&&document.execCommand("AutoUrlDetect",!1,!1)}}},button:function(){return{build:function(btnName,btnObject){var $button=$('<a href="#" class="re-icon re-'+btnName+'" rel="'+btnName+'" />').attr({role:"button","aria-label":btnObject.title,tabindex:"-1"});if((btnObject.func||btnObject.command||btnObject.dropdown)&&this.button.setEvent($button,btnName,btnObject),btnObject.dropdown){$button.addClass("redactor-toolbar-link-dropdown").attr("aria-haspopup",!0);var $dropdown=$('<div class="redactor-dropdown redactor-dropdown-'+this.uuid+" redactor-dropdown-box-"+btnName+'" style="display: none;">');$button.data("dropdown",$dropdown),this.dropdown.build(btnName,$dropdown,btnObject.dropdown)}return this.utils.isDesktop()&&this.button.createTooltip($button,btnName,btnObject.title),$button},setEvent:function($button,btnName,btnObject){$button.on("touchstart click",$.proxy(function(e){if($button.hasClass("redactor-button-disabled"))return!1;var type="func",callback=btnObject.func;btnObject.command?(type="command",callback=btnObject.command):btnObject.dropdown&&(type="dropdown",callback=!1),this.button.onClick(e,btnName,type,callback)},this))},createTooltip:function($button,name,title){var $tooltip=$("<span>").addClass("redactor-toolbar-tooltip redactor-toolbar-tooltip-"+this.uuid+" redactor-toolbar-tooltip-"+name).hide().html(title);$tooltip.appendTo("body"),$button.on("mouseover",function(){if(!$(this).hasClass("redactor-button-disabled")){var pos=$button.offset();$tooltip.show(),$tooltip.css({top:pos.top+$button.innerHeight()+"px",left:pos.left+$button.innerWidth()/2-$tooltip.innerWidth()/2+"px"})}}),$button.on("mouseout",function(){$tooltip.hide()})},onClick:function(e,btnName,type,callback){this.button.caretOffset=this.caret.getOffset(),e.preventDefault(),this.utils.browser("msie")&&(e.returnValue=!1),"command"==type?this.inline.format(callback):"dropdown"==type?this.dropdown.show(e,btnName):this.button.onClickCallback(e,callback,btnName)},onClickCallback:function(e,callback,btnName){var func;if(this.blurClickedElement=!0,$.isFunction(callback))callback.call(this,btnName);else if("-1"!=callback.search(/\./)){if(func=callback.split("."),"undefined"==typeof this[func[0]])return;this[func[0]][func[1]](btnName)}else this[callback](btnName);this.observe.buttons(e,btnName)},get:function(key){return this.$toolbar.find("a.re-"+key)},setActive:function(key){this.button.get(key).addClass("redactor-act")},setInactive:function(key){this.button.get(key).removeClass("redactor-act")},setInactiveAll:function(key){"undefined"==typeof key?this.$toolbar.find("a.re-icon").removeClass("redactor-act"):this.$toolbar.find("a.re-icon").not(".re-"+key).removeClass("redactor-act")},setActiveInVisual:function(){this.$toolbar.find("a.re-icon").not("a.re-html").removeClass("redactor-button-disabled")},setInactiveInCode:function(){this.$toolbar.find("a.re-icon").not("a.re-html").addClass("redactor-button-disabled")},changeIcon:function(key,classname){this.button.get(key).addClass("re-"+classname)},removeIcon:function(key,classname){this.button.get(key).removeClass("re-"+classname)},setAwesome:function(key,name){var $button=this.button.get(key);$button.removeClass("redactor-btn-image").addClass("fa-redactor-btn"),$button.html('<i class="fa '+name+'"></i>')},addCallback:function($btn,callback){if("buffer"!=$btn){var type="dropdown"==callback?"dropdown":"func",key=$btn.attr("rel");$btn.on("touchstart click",$.proxy(function(e){return!$btn.hasClass("redactor-button-disabled")&&void this.button.onClick(e,key,type,callback)},this))}},addDropdown:function($btn,dropdown){$btn.addClass("redactor-toolbar-link-dropdown").attr("aria-haspopup",!0);var key=$btn.attr("rel");this.button.addCallback($btn,"dropdown");var $dropdown=$('<div class="redactor-dropdown redactor-dropdown-'+this.uuid+" redactor-dropdown-box-"+key+'" style="display: none;">');return $btn.data("dropdown",$dropdown),dropdown&&this.dropdown.build(key,$dropdown,dropdown),$dropdown},add:function(key,title){if(this.opts.toolbar){if(this.button.isMobileUndoRedo(key))return"buffer";var btn=this.button.build(key,{title:title});return btn.addClass("redactor-btn-image"),this.$toolbar.append($("<li>").append(btn)),btn}},addFirst:function(key,title){if(this.opts.toolbar){if(this.button.isMobileUndoRedo(key))return"buffer";var btn=this.button.build(key,{title:title});return btn.addClass("redactor-btn-image"),this.$toolbar.prepend($("<li>").append(btn)),btn}},addAfter:function(afterkey,key,title){if(this.opts.toolbar){if(this.button.isMobileUndoRedo(key))return"buffer";var btn=this.button.build(key,{title:title});btn.addClass("redactor-btn-image");var $btn=this.button.get(afterkey);return 0!==$btn.length?$btn.parent().after($("<li>").append(btn)):this.$toolbar.append($("<li>").append(btn)),btn}},addBefore:function(beforekey,key,title){if(this.opts.toolbar){if(this.button.isMobileUndoRedo(key))return"buffer";var btn=this.button.build(key,{title:title});btn.addClass("redactor-btn-image");var $btn=this.button.get(beforekey);return 0!==$btn.length?$btn.parent().before($("<li>").append(btn)):this.$toolbar.append($("<li>").append(btn)),
btn}},remove:function(key){this.button.get(key).remove()},isMobileUndoRedo:function(key){return("undo"==key||"redo"==key)&&!this.utils.isDesktop()}}},caret:function(){return{setStart:function(node){if(this.utils.isBlock(node))this.caret.set(node,0,node,0);else{var space=this.utils.createSpaceElement();$(node).prepend(space),this.caret.setEnd(space)}},setEnd:function(node){this.caret.set(node,1,node,1)},set:function(orgn,orgo,focn,foco){if(orgn=orgn[0]||orgn,focn=focn[0]||focn,this.utils.isBlockTag(orgn.tagName)&&""===orgn.innerHTML&&(orgn.innerHTML=this.opts.invisibleSpace),"BR"==orgn.tagName&&this.opts.linebreaks===!1){var parent=$(this.opts.emptyHtml)[0];$(orgn).replaceWith(parent),orgn=parent,focn=orgn}this.selection.get();try{this.range.setStart(orgn,orgo),this.range.setEnd(focn,foco)}catch(e){}this.selection.addRange()},setAfter:function(node){try{var tag=$(node)[0].tagName;if("BR"==tag||this.utils.isBlock(node))"BR"!=tag&&this.utils.browser("msie")?this.caret.setStart($(node).next()):this.caret.setAfterOrBefore(node,"after");else{var space=this.utils.createSpaceElement();$(node).after(space),this.caret.setEnd(space)}}catch(e){var space=this.utils.createSpaceElement();$(node).after(space),this.caret.setEnd(space)}},setBefore:function(node){this.utils.isBlock(node)?this.caret.setEnd($(node).prev()):this.caret.setAfterOrBefore(node,"before")},setAfterOrBefore:function(node,type){if(this.utils.browser("msie")||this.$editor.focus(),node=node[0]||node,this.selection.get(),"after"==type)try{this.range.setStartAfter(node),this.range.setEndAfter(node)}catch(e){}else try{this.range.setStartBefore(node),this.range.setEndBefore(node)}catch(e){}this.range.collapse(!1),this.selection.addRange()},getOffsetOfElement:function(node){node=node[0]||node,this.selection.get();var cloned=this.range.cloneRange();return cloned.selectNodeContents(node),cloned.setEnd(this.range.endContainer,this.range.endOffset),$.trim(cloned.toString()).length},getOffset:function(){var offset=0,sel=window.getSelection();if(sel.rangeCount>0){var range=window.getSelection().getRangeAt(0),caretRange=range.cloneRange();caretRange.selectNodeContents(this.$editor[0]),caretRange.setEnd(range.endContainer,range.endOffset),offset=caretRange.toString().length}return offset},setOffset:function(start,end){"undefined"==typeof end&&(end=start),this.focus.isFocused()||this.focus.setStart();for(var node,offset=(this.selection.get(),0),walker=document.createTreeWalker(this.$editor[0],NodeFilter.SHOW_TEXT,null,null);node==walker.nextNode();)if(offset+=node.nodeValue.length,offset>start&&(this.range.setStart(node,node.nodeValue.length+start-offset),start=1/0),offset>=end){this.range.setEnd(node,node.nodeValue.length+end-offset);break}this.range.collapse(!1),this.selection.addRange()},setToPoint:function(start,end){this.caret.setOffset(start,end)},getCoords:function(){return this.caret.getOffset()}}},clean:function(){return{onSet:function(html){html=this.clean.savePreCode(html),html=html.replace(/<script(.*?[^>]?)>([\w\W]*?)<\/script>/gi,'<pre class="redactor-script-tag" style="display: none;" $1>$2</pre>'),html=html.replace(/\$/g,"&#36;"),html=html.replace(/<a href="(.*?[^>]?)®(.*?[^>]?)">/gi,'<a href="$1&reg$2">'),this.opts.replaceDivs&&(html=this.clean.replaceDivs(html)),this.opts.linebreaks&&(html=this.clean.replaceParagraphsToBr(html)),html=this.clean.saveFormTags(html);var $div=$("<div>");$div.html(html);var fonts=$div.find("font[style]");return 0!==fonts.length&&(fonts.replaceWith(function(){var $el=$(this),$span=$("<span>").attr("style",$el.attr("style"));return $span.append($el.contents())}),html=$div.html()),$div.remove(),html=html.replace(/<font(.*?[^<])>/gi,""),html=html.replace(/<\/font>/gi,""),html=this.tidy.load(html),this.opts.paragraphize&&(html=this.paragraphize.load(html)),html=this.clean.setVerified(html),html=this.clean.convertInline(html),html=html.replace(/&amp;/g,"&")},onSync:function(html){if(html=html.replace(/\u200B/g,""),html=html.replace(/&#x200b;/gi,""),this.opts.cleanSpaces&&(html=html.replace(/&nbsp;/gi," ")),html.search(/^<p>(||\s||<br\s?\/?>||&nbsp;)<\/p>$/i)!=-1)return"";html=html.replace(/<pre class="redactor-script-tag" style="display: none;"(.*?[^>]?)>([\w\W]*?)<\/pre>/gi,"<script$1>$2</script>"),html=this.clean.restoreFormTags(html);var chars={"™":"&trade;","©":"&copy;","…":"&hellip;","—":"&mdash;","‐":"&dash;"};$.each(chars,function(i,s){html=html.replace(new RegExp(i,"g"),s)}),this.utils.browser("mozilla")&&(html=html.replace(/<br\s?\/?>$/gi,"")),html=html.replace(new RegExp("<br\\s?/?></li>","gi"),"</li>"),html=html.replace(new RegExp("</li><br\\s?/?>","gi"),"</li>"),html=html.replace(/<(.*?)rel="\s*?"(.*?[^>]?)>/gi,'<$1$2">'),html=html.replace(/<(.*?)style="\s*?"(.*?[^>]?)>/gi,'<$1$2">'),html=html.replace(/""">/gi,'">'),html=html.replace(/"">/gi,'">'),html=html.replace(/<div(.*?[^>]) data-tagblock="redactor"(.*?[^>])>/gi,"<div$1$2>"),html=html.replace(/<(.*?) data-verified="redactor"(.*?[^>])>/gi,"<$1$2>");var $div=$("<div/>").html($.parseHTML(html,document,!0));return $div.find("span").removeAttr("rel"),$div.find("pre .redactor-invisible-space").each(function(){$(this).contents().unwrap()}),html=$div.html(),html=html.replace(/<img(.*?[^>])rel="(.*?[^>])"(.*?[^>])>/gi,"<img$1$3>"),html=html.replace(/<span class="redactor-invisible-space">(.*?)<\/span>/gi,"$1"),html=html.replace(/ data-save-url="(.*?[^>])"/gi,""),html=html.replace(/<span(.*?)id="redactor-image-box"(.*?[^>])>([\w\W]*?)<img(.*?)><\/span>/gi,"$3<img$4>"),html=html.replace(/<span(.*?)id="redactor-image-resizer"(.*?[^>])>(.*?)<\/span>/gi,""),html=html.replace(/<span(.*?)id="redactor-image-editter"(.*?[^>])>(.*?)<\/span>/gi,""),html=html.replace(/<font(.*?[^<])>/gi,""),html=html.replace(/<\/font>/gi,""),html=this.tidy.load(html),this.opts.linkNofollow&&(html=html.replace(/<a(.*?)rel="nofollow"(.*?[^>])>/gi,"<a$1$2>"),html=html.replace(/<a(.*?[^>])>/gi,'<a$1 rel="nofollow">')),html=html.replace(/\sdata-redactor-(tag|class|style)="(.*?[^>])"/gi,""),html=html.replace(new RegExp('<(.*?) data-verified="redactor"(.*?[^>])>',"gi"),"<$1$2>"),html=html.replace(new RegExp('<(.*?) data-verified="redactor">',"gi"),"<$1>"),html=html.replace(/&amp;/g,"&")},onPaste:function(html,setMode){if(html=$.trim(html),html=html.replace(/\$/g,"&#36;"),html=html.replace(/<span class="s[0-9]">/gi,"<span>"),html=html.replace(/<span class="Apple-converted-space">&nbsp;<\/span>/gi," "),html=html.replace(/<span class="Apple-tab-span"[^>]*>\t<\/span>/gi,"\t"),html=html.replace(/<span[^>]*>(\s|&nbsp;)<\/span>/gi," "),this.opts.pastePlainText)return this.clean.getPlainText(html);if(!this.utils.isSelectAll()&&"undefined"==typeof setMode){if(this.utils.isCurrentOrParent(["FIGCAPTION","A"]))return this.clean.getPlainText(html,!1);if(this.utils.isCurrentOrParent("PRE"))return html=html.replace(/”/g,'"'),html=html.replace(/“/g,'"'),html=html.replace(/‘/g,"'"),html=html.replace(/’/g,"'"),this.clean.getPreCode(html);if(this.utils.isCurrentOrParent(["BLOCKQUOTE","H1","H2","H3","H4","H5","H6"])){if(html=this.clean.getOnlyImages(html),!this.utils.browser("msie")){var block=this.selection.getBlock();block&&"P"==block.tagName&&(html=html.replace(/<img(.*?)>/gi,"<p><img$1></p>"))}return html}if(this.utils.isCurrentOrParent(["TD"]))return html=this.clean.onPasteTidy(html,"td"),this.opts.linebreaks&&(html=this.clean.replaceParagraphsToBr(html)),html=this.clean.replaceDivsToBr(html);if(this.utils.isCurrentOrParent(["LI"]))return this.clean.onPasteTidy(html,"li")}return html=this.clean.isSingleLine(html,setMode),this.clean.singleLine||(this.opts.linebreaks&&(html=this.clean.replaceParagraphsToBr(html)),this.opts.replaceDivs&&(html=this.clean.replaceDivs(html)),html=this.clean.saveFormTags(html)),html=this.clean.onPasteWord(html),html=this.clean.onPasteExtra(html),html=this.clean.onPasteTidy(html,"all"),!this.clean.singleLine&&this.opts.paragraphize&&(html=this.paragraphize.load(html)),html=this.clean.removeDirtyStyles(html),html=this.clean.onPasteRemoveSpans(html),html=this.clean.onPasteRemoveEmpty(html),html=this.clean.convertInline(html)},onPasteWord:function(html){if(html=html.replace(/<!--[\s\S]*?-->/gi,""),html=html.replace(/<style[^>]*>[\s\S]*?<\/style>/gi,""),html=html.replace(/<o\:p[^>]*>[\s\S]*?<\/o\:p>/gi,""),html.match(/class="?Mso|style="[^"]*\bmso-|style='[^'']*\bmso-|w:WordDocument/i)){html=html.replace(/<!--[\s\S]+?-->/gi,""),html=html.replace(/<(!|script[^>]*>.*?<\/script(?=[>\s])|\/?(\?xml(:\w+)?|img|meta|link|style|\w:\w+)(?=[\s\/>]))[^>]*>/gi,""),html=html.replace(/<(\/?)s>/gi,"<$1strike>"),html=html.replace(/ /gi," "),html=html.replace(/<span\s+style\s*=\s*"\s*mso-spacerun\s*:\s*yes\s*;?\s*"\s*>([\s\u00a0]*)<\/span>/gi,function(str,spaces){return spaces.length>0?spaces.replace(/./," ").slice(Math.floor(spaces.length/2)).split("").join(" "):""}),html=this.clean.onPasteIeFixLinks(html),html=html.replace(/<img(.*?)v:shapes=(.*?)>/gi,""),html=html.replace(/src="file\:\/\/(.*?)"/,'src=""');var $div=$("<div/>").html(html),lastList=!1,lastLevel=1,listsIds=[];$div.find("p[style]").each(function(){var matches=$(this).attr("style").match(/mso\-list\:l([0-9]+)\slevel([0-9]+)/);if(matches){var currentList=parseInt(matches[1]),currentLevel=parseInt(matches[2]),listType=$(this).html().match(/^[\w]+\./)?"ol":"ul",$li=$("<li/>").html($(this).html());if($li.html($li.html().replace(/^([\w\.]+)</,"<")),$li.find("span:first").remove(),1==currentLevel&&$.inArray(currentList,listsIds)==-1){var $list=$("<"+listType+"/>").attr({"data-level":currentLevel,"data-list":currentList}).html($li);$(this).replaceWith($list),lastList=currentList,listsIds.push(currentList)}else{if(currentLevel>lastLevel){for(var $prevList=$div.find('[data-level="'+lastLevel+'"][data-list="'+lastList+'"]'),$lastList=$prevList,i=lastLevel;i<currentLevel;i++)$list=$("<"+listType+"/>"),$list.appendTo($lastList.find("li").last()),$lastList=$list;$lastList.attr({"data-level":currentLevel,"data-list":currentList}).html($li)}else{var $prevList=$div.find('[data-level="'+currentLevel+'"][data-list="'+currentList+'"]').last();$prevList.append($li)}lastLevel=currentLevel,lastList=currentList,$(this).remove()}}}),$div.find("[data-level][data-list]").removeAttr("data-level data-list"),html=$div.html(),html=html.replace(/·/g,""),html=html.replace(/<p class="Mso(.*?)"/gi,"<p"),html=html.replace(/ class=\"(mso[^\"]*)\"/gi,""),html=html.replace(/ class=(mso\w+)/gi,""),html=html.replace(/<o:p(.*?)>([\w\W]*?)<\/o:p>/gi,"$2"),html=html.replace(/\n/g," "),html=html.replace(/<p>\n?<li>/gi,"<li>")}return html},onPasteExtra:function(html){return html=html.replace(/<b\sid="internal-source-marker(.*?)">([\w\W]*?)<\/b>/gi,"$2"),html=html.replace(/<b(.*?)id="docs-internal-guid(.*?)">([\w\W]*?)<\/b>/gi,"$3"),html=html.replace(/<span[^>]*(font-style: italic; font-weight: bold|font-weight: bold; font-style: italic)[^>]*>/gi,'<span style="font-weight: bold;"><span style="font-style: italic;">'),html=html.replace(/<span[^>]*font-style: italic[^>]*>/gi,'<span style="font-style: italic;">'),html=html.replace(/<span[^>]*font-weight: bold[^>]*>/gi,'<span style="font-weight: bold;">'),html=html.replace(/<span[^>]*text-decoration: underline[^>]*>/gi,'<span style="text-decoration: underline;">'),html=html.replace(/<img>/gi,""),html=html.replace(/\n{3,}/gi,"\n"),html=html.replace(/<font(.*?)>([\w\W]*?)<\/font>/gi,"$2"),html=html.replace(/<p><p>/gi,"<p>"),html=html.replace(/<\/p><\/p>/gi,"</p>"),html=html.replace(/<li>(\s*|\t*|\n*)<p>/gi,"<li>"),html=html.replace(/<\/p>(\s*|\t*|\n*)<\/li>/gi,"</li>"),html=html.replace(/<\/p>\s<p/gi,"</p><p"),html=html.replace(/<img src="webkit-fake-url\:\/\/(.*?)"(.*?)>/gi,""),html=html.replace(/<p>•([\w\W]*?)<\/p>/gi,"<li>$1</li>"),this.utils.browser("mozilla")&&(html=html.replace(/<br\s?\/?>$/gi,"")),html},onPasteTidy:function(html,type){var tags=["span","a","pre","blockquote","small","em","strong","code","kbd","mark","address","cite","var","samp","dfn","sup","sub","b","i","u","del","ol","ul","li","dl","dt","dd","p","br","video","audio","iframe","embed","param","object","img","table","td","th","tr","tbody","tfoot","thead","h1","h2","h3","h4","h5","h6"],tagsEmpty=!1,attrAllowed=[["a","*"],["img",["src","alt"]],["span",["class","rel","data-verified"]],["iframe","*"],["video","*"],["audio","*"],["embed","*"],["object","*"],["param","*"],["source","*"]];"all"==type?(tagsEmpty=["p","span","h1","h2","h3","h4","h5","h6"],attrAllowed=[["table","class"],["td",["colspan","rowspan"]],["a","*"],["img",["src","alt","data-redactor-inserted-image"]],["span",["class","rel","data-verified"]],["iframe","*"],["video","*"],["audio","*"],["embed","*"],["object","*"],["param","*"],["source","*"]]):"td"==type?tags=["ul","ol","li","span","a","small","em","strong","code","kbd","mark","cite","var","samp","dfn","sup","sub","b","i","u","del","ol","ul","li","dl","dt","dd","br","iframe","video","audio","embed","param","object","img","h1","h2","h3","h4","h5","h6"]:"li"==type&&(tags=["ul","ol","li","span","a","small","em","strong","code","kbd","mark","cite","var","samp","dfn","sup","sub","b","i","u","del","br","iframe","video","audio","embed","param","object","img"]);var options={deniedTags:!!this.opts.deniedTags&&this.opts.deniedTags,allowedTags:this.opts.allowedTags?this.opts.allowedTags:tags,removeComments:!0,removePhp:!0,removeAttr:!!this.opts.removeAttr&&this.opts.removeAttr,allowedAttr:this.opts.allowedAttr?this.opts.allowedAttr:attrAllowed,removeEmpty:tagsEmpty};return this.tidy.load(html,options)},onPasteRemoveEmpty:function(html){return html=html.replace(/<(p|h[1-6])>(|\s|\n|\t|<br\s?\/?>)<\/(p|h[1-6])>/gi,""),this.opts.linebreaks||(html=html.replace(/<br>$/i,"")),html},onPasteRemoveSpans:function(html){return html=html.replace(/<span>(.*?)<\/span>/gi,"$1"),html=html.replace(/<span[^>]*>\s|&nbsp;<\/span>/gi," ")},onPasteIeFixLinks:function(html){if(!this.utils.browser("msie"))return html;var tmp=$.trim(html);return 0===tmp.search(/^<a(.*?)>(.*?)<\/a>$/i)&&(html=html.replace(/^<a(.*?)>(.*?)<\/a>$/i,"$2")),html},isSingleLine:function(html,setMode){if(this.clean.singleLine=!1,!this.utils.isSelectAll()&&"undefined"==typeof setMode){var blocks=this.opts.blockLevelElements.join("|").replace("P|","").replace("DIV|",""),matchBlocks=html.match(new RegExp("</("+blocks+")>","gi")),matchContainers=html.match(/<\/(p|div)>/gi);if(!matchBlocks&&(null===matchContainers||matchContainers&&matchContainers.length<=1)){var matchBR=html.match(/<br\s?\/?>/gi);matchBR||(this.clean.singleLine=!0,html=html.replace(/<\/?(p|div)(.*?)>/gi,""))}}return html},stripTags:function(input,allowed){allowed=(((allowed||"")+"").toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join("");var tags=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi;return input.replace(tags,function($0,$1){return allowed.indexOf("<"+$1.toLowerCase()+">")>-1?$0:""})},savePreCode:function(html){return html=this.clean.savePreFormatting(html),html=this.clean.saveCodeFormatting(html),html=this.clean.restoreSelectionMarker(html)},savePreFormatting:function(html){var pre=html.match(/<pre(.*?)>([\w\W]*?)<\/pre>/gi);return null!==pre&&$.each(pre,$.proxy(function(i,s){var arr=s.match(/<pre(.*?)>([\w\W]*?)<\/pre>/i);arr[2]=arr[2].replace(/<br\s?\/?>/g,"\n"),arr[2]=arr[2].replace(/&nbsp;/g," "),this.opts.preSpaces&&(arr[2]=arr[2].replace(/\t/g,Array(this.opts.preSpaces+1).join(" "))),arr[2]=this.clean.encodeEntities(arr[2]),arr[2]=arr[2].replace(/\$/g,"&#36;"),html=html.replace(s,"<pre"+arr[1]+">"+arr[2]+"</pre>")},this)),html},saveCodeFormatting:function(html){var code=html.match(/<code(.*?)>([\w\W]*?)<\/code>/gi);return null!==code&&$.each(code,$.proxy(function(i,s){var arr=s.match(/<code(.*?)>([\w\W]*?)<\/code>/i);arr[2]=arr[2].replace(/&nbsp;/g," "),arr[2]=this.clean.encodeEntities(arr[2]),arr[2]=arr[2].replace(/\$/g,"&#36;"),html=html.replace(s,"<code"+arr[1]+">"+arr[2]+"</code>")},this)),html},restoreSelectionMarker:function(html){return html=html.replace(/&lt;span id=&quot;selection-marker-([0-9])&quot; class=&quot;redactor-selection-marker&quot; data-verified=&quot;redactor&quot;&gt;​&lt;\/span&gt;/g,'<span id="selection-marker-$1" class="redactor-selection-marker" data-verified="redactor">​</span>')},getTextFromHtml:function(html){html=html.replace(/<br\s?\/?>|<\/H[1-6]>|<\/p>|<\/div>|<\/li>|<\/td>/gi,"\n");var tmp=document.createElement("div");return tmp.innerHTML=html,html=tmp.textContent||tmp.innerText,$.trim(html)},getPlainText:function(html,paragraphize){return html=this.clean.getTextFromHtml(html),html=html.replace(/\n/g,"<br />"),this.opts.paragraphize&&"undefined"==typeof paragraphize&&!this.utils.browser("mozilla")&&(html=this.paragraphize.load(html)),html},getPreCode:function(html){return html=html.replace(/<img(.*?) style="(.*?)"(.*?[^>])>/gi,"<img$1$3>"),html=html.replace(/<img(.*?)>/gi,"&lt;img$1&gt;"),html=this.clean.getTextFromHtml(html),this.opts.preSpaces&&(html=html.replace(/\t/g,Array(this.opts.preSpaces+1).join(" "))),html=this.clean.encodeEntities(html)},getOnlyImages:function(html){return html=html.replace(/<img(.*?)>/gi,"[img$1]"),html=html.replace(/<([Ss]*?)>/gi,""),html=html.replace(/\[img(.*?)\]/gi,"<img$1>")},getOnlyLinksAndImages:function(html){return html=html.replace(/<a(.*?)href="(.*?)"(.*?)>([\w\W]*?)<\/a>/gi,'[a href="$2"]$4[/a]'),html=html.replace(/<img(.*?)>/gi,"[img$1]"),html=html.replace(/<(.*?)>/gi,""),html=html.replace(/\[a href="(.*?)"\]([\w\W]*?)\[\/a\]/gi,'<a href="$1">$2</a>'),html=html.replace(/\[img(.*?)\]/gi,"<img$1>")},encodeEntities:function(str){return str=String(str).replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"'),str.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},removeDirtyStyles:function(html){if(this.utils.browser("msie"))return html;var div=document.createElement("div");return div.innerHTML=html,this.clean.clearUnverifiedRemove($(div)),html=div.innerHTML,$(div).remove(),html},clearUnverified:function(){if(!this.utils.browser("msie")){this.clean.clearUnverifiedRemove(this.$editor);var headers=this.$editor.find("h1, h2, h3, h4, h5, h6");headers.find("span").removeAttr("style"),headers.find(this.opts.verifiedTags.join(", ")).removeAttr("style"),this.code.sync()}},clearUnverifiedRemove:function($editor){$editor.find(this.opts.verifiedTags.join(", ")).removeAttr("style"),$editor.find("span").not('[data-verified="redactor"]').removeAttr("style"),$editor.find('span[data-verified="redactor"], img[data-verified="redactor"]').each(function(i,s){var $s=$(s);$s.attr("style",$s.attr("rel"))})},cleanEmptyParagraph:function(){},setVerified:function(html){if(this.utils.browser("msie"))return html;html=html.replace(new RegExp("<img(.*?[^>])>","gi"),'<img$1 data-verified="redactor">'),html=html.replace(new RegExp("<span(.*?[^>])>","gi"),'<span$1 data-verified="redactor">');var matches=html.match(new RegExp('<(span|img)(.*?)style="(.*?)"(.*?[^>])>',"gi"));if(matches)for(var len=matches.length,i=0;i<len;i++)try{var newTag=matches[i].replace(/style="(.*?)"/i,'style="$1" rel="$1"');html=html.replace(matches[i],newTag)}catch(e){}return html},convertInline:function(html){var $div=$("<div />").html(html),tags=this.opts.inlineTags;return tags.push("span"),$div.find(tags.join(",")).each(function(){var $el=$(this),tag=this.tagName.toLowerCase();$el.attr("data-redactor-tag",tag),"span"==tag&&($el.attr("style")?$el.attr("data-redactor-style",$el.attr("style")):$el.attr("class")&&$el.attr("data-redactor-class",$el.attr("class")))}),html=$div.html(),$div.remove(),html},normalizeLists:function(){this.$editor.find("li").each(function(i,s){var $next=$(s).next();0===$next.length||"UL"!=$next[0].tagName&&"OL"!=$next[0].tagName||$(s).append($next)})},removeSpaces:function(html){return html=html.replace(/\n/g,""),html=html.replace(/[\t]*/g,""),html=html.replace(/\n\s*\n/g,"\n"),html=html.replace(/^[\s\n]*/g," "),html=html.replace(/[\s\n]*$/g," "),html=html.replace(/>\s{2,}</g,"> <"),html=html.replace(/\n\n/g,"\n"),html=html.replace(/\u200B/g,"")},replaceDivs:function(html){return this.opts.linebreaks?(html=html.replace(/<div><br\s?\/?><\/div>/gi,"<br />"),html=html.replace(/<div(.*?)>([\w\W]*?)<\/div>/gi,"$2<br />")):html=html.replace(/<div(.*?)>([\w\W]*?)<\/div>/gi,"<p$1>$2</p>"),html=html.replace(/<div(.*?[^>])>/gi,""),html=html.replace(/<\/div>/gi,"")},replaceDivsToBr:function(html){return html=html.replace(/<div\s(.*?)>/gi,"<p>"),html=html.replace(/<div><br\s?\/?><\/div>/gi,"<br /><br />"),html=html.replace(/<div>([\w\W]*?)<\/div>/gi,"$1<br /><br />")},replaceParagraphsToBr:function(html){return html=html.replace(/<p\s(.*?)>/gi,"<p>"),html=html.replace(/<p><br\s?\/?><\/p>/gi,"<br />"),html=html.replace(/<p>([\w\W]*?)<\/p>/gi,"$1<br /><br />"),html=html.replace(/(<br\s?\/?>){1,}\n?<\/blockquote>/gi,"</blockquote>")},saveFormTags:function(html){return html.replace(/<form(.*?)>([\w\W]*?)<\/form>/gi,'<section$1 rel="redactor-form-tag">$2</section>')},restoreFormTags:function(html){return html.replace(/<section(.*?) rel="redactor-form-tag"(.*?)>([\w\W]*?)<\/section>/gi,"<form$1$2>$3</form>")}}},code:function(){return{set:function(html){html=$.trim(html.toString()),html=this.clean.onSet(html),this.$editor.html(html),this.code.sync(),""!==html&&this.placeholder.remove(),setTimeout($.proxy(this.buffer.add,this),15),this.start===!1&&this.observe.load()},get:function(){var code=this.$textarea.val();return this.opts.replaceDivs&&(code=this.clean.replaceDivs(code)),this.opts.linebreaks&&(code=this.clean.replaceParagraphsToBr(code)),code=this.tabifier.get(code)},getCleanHtml:function(){var html=this.code.get();return this.tidy.replaceTags(),this.tidy.replaceStyles(),this.tidy.removeTags(),html=this.clean.replaceDivs(html),"<p>&#x200b;</p>"===html&&(html=""),this.code.set(html),html},sync:function(){setTimeout($.proxy(this.code.startSync,this),10)},startSync:function(){var html=this.$editor.html();this.code.syncCode&&this.code.syncCode==html||(this.code.syncCode=html,html=this.core.setCallback("syncBefore",html),html=this.clean.onSync(html),this.$textarea.val(html),this.core.setCallback("sync",html),this.start===!1&&this.core.setCallback("change",html),this.start=!1,0==this.autosave.html&&(this.autosave.html=this.code.get()),this.opts.codemirror&&this.$textarea.next(".CodeMirror").each(function(i,el){el.CodeMirror.setValue(html)}),this.autosave.onChange(),this.autosave.enable())},toggle:function(){this.opts.visual?this.code.showCode():this.code.showVisual()},showCode:function(){this.selection.save(),this.code.offset=this.caret.getOffset();var scroll=$(window).scrollTop(),height=(this.$editor.innerWidth(),this.$editor.innerHeight());this.$editor.hide();var html=this.$textarea.val();this.modified=this.clean.removeSpaces(html),html=this.tabifier.get(html);var start=0,end=0,$editorDiv=$("<div/>").append($.parseHTML(this.clean.onSync(this.$editor.html()),document,!0)),$selectionMarkers=$editorDiv.find("span.redactor-selection-marker");if($selectionMarkers.length>0){var editorHtml=this.tabifier.get($editorDiv.html()).replace(/&amp;/g,"&");1==$selectionMarkers.length?(start=this.utils.strpos(editorHtml,$editorDiv.find("#selection-marker-1").prop("outerHTML")),end=start):2==$selectionMarkers.length&&(start=this.utils.strpos(editorHtml,$editorDiv.find("#selection-marker-1").prop("outerHTML")),end=this.utils.strpos(editorHtml,$editorDiv.find("#selection-marker-2").prop("outerHTML"))-$editorDiv.find("#selection-marker-1").prop("outerHTML").toString().length)}this.selection.removeMarkers(),this.$textarea.val(html),this.opts.codemirror?this.$textarea.next(".CodeMirror").each(function(i,el){$(el).show(),el.CodeMirror.setValue(html),el.CodeMirror.setSize("100%",height),el.CodeMirror.refresh(),start==end?el.CodeMirror.setCursor(el.CodeMirror.posFromIndex(start).line,el.CodeMirror.posFromIndex(end).ch):el.CodeMirror.setSelection({line:el.CodeMirror.posFromIndex(start).line,ch:el.CodeMirror.posFromIndex(start).ch},{line:el.CodeMirror.posFromIndex(end).line,ch:el.CodeMirror.posFromIndex(end).ch}),el.CodeMirror.focus()}):(this.$textarea.height(height).show().focus(),this.$textarea.on("keydown.redactor-textarea-indenting",this.code.textareaIndenting),$(window).scrollTop(scroll),this.$textarea[0].setSelectionRange&&this.$textarea[0].setSelectionRange(start,end),this.$textarea[0].scrollTop=0),this.opts.visual=!1,this.button.setInactiveInCode(),this.button.setActive("html"),this.core.setCallback("source",html)},showVisual:function(){var html;if(!this.opts.visual){var start=0,end=0;if(this.opts.codemirror){var selection;this.$textarea.next(".CodeMirror").each(function(i,el){selection=el.CodeMirror.listSelections(),start=el.CodeMirror.indexFromPos(selection[0].anchor),end=el.CodeMirror.indexFromPos(selection[0].head),html=el.CodeMirror.getValue()})}else start=this.$textarea.get(0).selectionStart,end=this.$textarea.get(0).selectionEnd,html=this.$textarea.hide().val();if(start>end&&end>0){var tempStart=end,tempEnd=start;start=tempStart,end=tempEnd}if(start=this.code.enlargeOffset(html,start),end=this.code.enlargeOffset(html,end),html=html.substr(0,start)+this.selection.getMarkerAsHtml(1)+html.substr(start),end>start){var markerLength=this.selection.getMarkerAsHtml(1).toString().length;html=html.substr(0,end+markerLength)+this.selection.getMarkerAsHtml(2)+html.substr(end+markerLength)}this.modified!==this.clean.removeSpaces(html)&&this.code.set(html),this.opts.codemirror&&this.$textarea.next(".CodeMirror").hide(),this.$editor.show(),this.utils.isEmpty(html)||this.placeholder.remove(),this.selection.restore(),this.$textarea.off("keydown.redactor-textarea-indenting"),this.button.setActiveInVisual(),this.button.setInactive("html"),this.observe.load(),this.opts.visual=!0,this.core.setCallback("visual",html)}},textareaIndenting:function(e){if(9!==e.keyCode)return!0;var $el=this.$textarea,start=$el.get(0).selectionStart;return $el.val($el.val().substring(0,start)+"\t"+$el.val().substring($el.get(0).selectionEnd)),$el.get(0).selectionStart=$el.get(0).selectionEnd=start+1,!1},enlargeOffset:function(html,offset){var htmlLength=html.length,c=0;if(">"==html[offset])c++;else for(var i=offset;i<=htmlLength&&(c++,">"!=html[i]);i++)if("<"==html[i]||i==htmlLength){c=0;break}return offset+c}}},core:function(){return{getObject:function(){return $.extend({},this)},getEditor:function(){return this.$editor},getBox:function(){return this.$box},getElement:function(){return this.$element},getTextarea:function(){return this.$textarea},getToolbar:function(){return!!this.$toolbar&&this.$toolbar},addEvent:function(name){this.core.event=name},getEvent:function(){return this.core.event},setCallback:function(type,e,data){var eventName=type+"Callback",eventNamespace="redactor",callback=this.opts[eventName];if(this.$textarea){var returnValue=!1,events=$._data(this.$textarea[0],"events");if("undefined"!=typeof events&&"undefined"!=typeof events[eventName]&&$.each(events[eventName],$.proxy(function(key,value){if(value.namespace==eventNamespace){var data="undefined"==typeof data?[e]:[e,data];returnValue="undefined"==typeof data?value.handler.call(this,e):value.handler.call(this,e,data)}},this)),returnValue)return returnValue}return $.isFunction(callback)?"undefined"==typeof data?callback.call(this,e):callback.call(this,e,data):"undefined"==typeof data?e:data},destroy:function(){this.opts.destroyed=!0,this.core.setCallback("destroy"),this.$element.off(".redactor").removeData("redactor"),this.$editor.off(".redactor"),$(document).off("mousedown.redactor"),$(document).off("click.redactor-image-delete."+this.uuid),$(document).off("click.redactor-image-resize-hide."+this.uuid),$(document).off("touchstart.redactor."+this.uuid+" click.redactor."+this.uuid),$("body").off("scroll.redactor."+this.uuid),$(this.opts.toolbarFixedTarget).off("scroll.redactor."+this.uuid),this.$editor.removeClass("redactor-editor redactor-linebreaks redactor-placeholder"),this.$editor.removeAttr("contenteditable");var html=this.code.get();this.opts.toolbar&&this.$toolbar.find("a").each(function(){var $el=$(this);$el.data("dropdown")&&($el.data("dropdown").remove(),$el.data("dropdown",{}))}),this.build.isTextarea()?(this.$box.after(this.$element),this.$box.remove(),this.$element.val(html).show()):(this.$box.after(this.$editor),this.$box.remove(),this.$element.html(html).show()),this.$pasteBox&&this.$pasteBox.remove(),this.$modalBox&&this.$modalBox.remove(),this.$modalOverlay&&this.$modalOverlay.remove(),$(".redactor-toolbar-tooltip-"+this.uuid).remove(),this._documentClickEventHandler&&$(document).off("mousedown",this._documentClickEventHandler),clearInterval(this.autosaveInterval)}}},dropdown:function(){return{build:function(name,$dropdown,dropdownObject){"formatting"==name&&this.opts.formattingAdd&&$.each(this.opts.formattingAdd,$.proxy(function(i,s){var func,name=s.tag;"undefined"!=typeof s.class&&(name=name+"-"+s.class),s.type=this.utils.isBlockTag(s.tag)?"block":"inline",func="undefined"!=typeof s.func?s.func:"inline"==s.type?"inline.formatting":"block.formatting",this.opts.linebreaks&&"block"==s.type&&"p"==s.tag||(this.formatting[name]={tag:s.tag,style:s.style,class:s.class,attr:s.attr,data:s.data,clear:s.clear},dropdownObject[name]={func:func,title:s.title})},this)),$.each(dropdownObject,$.proxy(function(btnName,btnObject){var $item=$('<a href="#" class="redactor-dropdown-'+btnName+'" role="button">'+btnObject.title+"</a>");"formatting"==name&&$item.addClass("redactor-formatting-"+btnName),$item.on("click",$.proxy(function(e){e.preventDefault();var type="func",callback=btnObject.func;btnObject.command?(type="command",callback=btnObject.command):btnObject.dropdown&&(type="dropdown",callback=btnObject.dropdown),$(e.target).hasClass("redactor-dropdown-link-inactive")||(this.button.onClick(e,btnName,type,callback),this.dropdown.hideAll())},this)),this.observe.addDropdown($item,btnName,btnObject),$dropdown.append($item)},this))},show:function(e,key){if(!this.opts.visual)return e.preventDefault(),!1;var $button=this.button.get(key),$dropdown=$button.data("dropdown").appendTo(document.body);if(this.opts.highContrast&&$dropdown.addClass("redactor-dropdown-contrast"),this.utils.isMobile()&&document.activeElement.blur(),$button.hasClass("dropact"))this.dropdown.hideAll();else{this.dropdown.hideAll(),this.observe.dropdowns(),this.core.setCallback("dropdownShow",{dropdown:$dropdown,key:key,button:$button}),this.button.setActive(key),$button.addClass("dropact");var keyPosition=$button.offset(),dropdownWidth=$dropdown.width();keyPosition.left+dropdownWidth>$(document).width()&&(keyPosition.left=Math.max(0,keyPosition.left-dropdownWidth));var left=keyPosition.left+"px";if(this.$toolbar.hasClass("toolbar-fixed-box")){var top=this.$toolbar.innerHeight()+this.opts.toolbarFixedTopOffset,position="fixed";this.opts.toolbarFixedTarget!==document&&(top=this.$toolbar.innerHeight()+this.$toolbar.offset().top+this.opts.toolbarFixedTopOffset,position="absolute"),$dropdown.css({position:position,left:left,top:top+"px"}).show()}else{var top=$button.innerHeight()+keyPosition.top+"px";$dropdown.css({position:"absolute",left:left,top:top}).show()}this.core.setCallback("dropdownShown",{dropdown:$dropdown,key:key,button:$button}),this.$dropdown=$dropdown}$(document).one("click.redactor-dropdown",$.proxy(this.dropdown.hide,this)),this.$editor.one("click.redactor-dropdown",$.proxy(this.dropdown.hide,this)),$(document).one("keyup.redactor-dropdown",$.proxy(this.dropdown.closeHandler,this)),$dropdown.on("mouseover.redactor-dropdown",$.proxy(this.utils.disableBodyScroll,this)).on("mouseout.redactor-dropdown",$.proxy(this.utils.enableBodyScroll,this)),e.stopPropagation()},closeHandler:function(e){e.which==this.keyCode.ESC&&(this.dropdown.hideAll(),this.$editor.focus())},hideAll:function(){this.$toolbar.find("a.dropact").removeClass("redactor-act").removeClass("dropact"),this.utils.enableBodyScroll(),$(".redactor-dropdown-"+this.uuid).hide(),$(".redactor-dropdown-link-selected").removeClass("redactor-dropdown-link-selected"),this.$dropdown&&(this.$dropdown.off(".redactor-dropdown"),
this.core.setCallback("dropdownHide",this.$dropdown),this.$dropdown=!1)},hide:function(e){var $dropdown=$(e.target);$dropdown.hasClass("dropact")||$dropdown.hasClass("redactor-dropdown-link-inactive")||($dropdown.removeClass("dropact"),$dropdown.off("mouseover mouseout"),this.dropdown.hideAll())}}},file:function(){return{show:function(){this.modal.load("file",this.lang.get("file"),700),this.upload.init("#redactor-modal-file-upload",this.opts.fileUpload,this.file.insert),this.selection.save(),this.selection.get();var text=this.sel.toString();$("#redactor-filename").val(text),this.modal.show()},insert:function(json,direct,e){if("undefined"!=typeof json.error)return this.modal.close(),this.selection.restore(),void this.core.setCallback("fileUploadError",json);var link;if("string"==typeof json)link=json;else{var text=$("#redactor-filename").val();"undefined"!=typeof text&&""!==text||(text=json.filename),link='<a href="'+json.filelink+'" id="filelink-marker">'+text+"</a>"}if(direct){this.selection.removeMarkers();var marker=this.selection.getMarker();this.insert.nodeToCaretPositionFromPoint(e,marker)}else this.modal.close();if(this.selection.restore(),this.buffer.set(),this.insert.htmlWithoutClean(link),"string"!=typeof json){var linkmarker=$(this.$editor.find("a#filelink-marker"));0!==linkmarker.length?linkmarker.removeAttr("id").removeAttr("style"):linkmarker=!1,this.core.setCallback("fileUpload",linkmarker,json)}}}},focus:function(){return{setStart:function(){this.$editor.focus();var first=this.$editor.children().first();if(0!==first.length&&0!==first[0].length&&"BR"!=first[0].tagName&&3!=first[0].nodeType){if("UL"==first[0].tagName||"OL"==first[0].tagName){var child=first.find("li").first();if(!this.utils.isBlock(child)&&""===child.text())return void this.caret.setStart(child)}return this.opts.linebreaks&&!this.utils.isBlockTag(first[0].tagName)?(this.selection.get(),this.range.setStart(this.$editor[0],0),this.range.setEnd(this.$editor[0],0),void this.selection.addRange()):void this.caret.setStart(first)}},setEnd:function(){var last=this.$editor.children().last();this.$editor.focus(),0!==last.size()&&(this.utils.isEmpty(this.$editor.html())?(this.selection.get(),this.range.collapse(!0),this.range.setStartAfter(last[0]),this.range.setEnd(last[0],0),this.selection.addRange()):(this.selection.get(),this.range.selectNodeContents(last[0]),this.range.collapse(!1),this.selection.addRange()))},isFocused:function(){var focusNode=document.getSelection().focusNode;return null!==focusNode&&(!(!this.opts.linebreaks||!$(focusNode.parentNode).hasClass("redactor-linebreaks"))||!!this.utils.isRedactorParent(focusNode.parentNode)&&this.$editor.is(":focus"))}}},image:function(){return{show:function(){this.modal.load("image",this.lang.get("image"),700),this.upload.init("#redactor-modal-image-droparea",this.opts.imageUpload,this.image.insert),this.selection.save(),this.modal.show()},showEdit:function($image){var $link=$image.closest("a",this.$editor[0]);if(this.modal.load("imageEdit",this.lang.get("edit"),705),this.modal.createCancelButton(),this.image.buttonDelete=this.modal.createDeleteButton(this.lang.get("_delete")),this.image.buttonSave=this.modal.createActionButton(this.lang.get("save")),this.image.buttonDelete.on("click",$.proxy(function(){this.image.remove($image)},this)),this.image.buttonSave.on("click",$.proxy(function(){this.image.update($image)},this)),$(".redactor-link-tooltip").remove(),$("#redactor-image-title").val($image.attr("title")),this.opts.imageLink){var $redactorImageLink=$("#redactor-image-link");$redactorImageLink.attr("href",$image.attr("src")),0!==$link.length&&($redactorImageLink.val($link.attr("href")),"_blank"==$link.attr("target")&&$("#redactor-image-link-blank").prop("checked",!0))}else $(".redactor-image-link-option").hide();if(this.opts.imagePosition){var floatValue="block"==$image.css("display")&&"none"==$image.css("float")?"center":$image.css("float");$("#redactor-image-align").val(floatValue)}else $(".redactor-image-position-option").hide();this.modal.show(),$("#redactor-image-title").focus()},setFloating:function($image){var floating=$("#redactor-image-align").val(),imageFloat="",imageDisplay="",imageMargin="";switch(floating){case"left":imageFloat="left",imageMargin="0 "+this.opts.imageFloatMargin+" "+this.opts.imageFloatMargin+" 0";break;case"right":imageFloat="right",imageMargin="0 0 "+this.opts.imageFloatMargin+" "+this.opts.imageFloatMargin;break;case"center":imageDisplay="block",imageMargin="auto"}$image.css({float:imageFloat,display:imageDisplay,margin:imageMargin}),$image.attr("rel",$image.attr("style"))},update:function($image){this.image.hideResize(),this.buffer.set();var $link=$image.closest("a",this.$editor[0]);$image.attr("alt",$("#redactor-image-title").val()),$image.attr("title",$("#redactor-image-title").val()),this.image.setFloating($image);var link=$.trim($("#redactor-image-link").val());if(""!==link){var pattern="((xn--)?[a-z0-9]+(-[a-z0-9]+)*\\.)+[a-z]{2,}",re=new RegExp("^(http|ftp|https)://"+pattern,"i"),re2=new RegExp("^"+pattern,"i");link.search(re)==-1&&0===link.search(re2)&&this.opts.linkProtocol&&(link=this.opts.linkProtocol+"://"+link);var target=!!$("#redactor-image-link-blank").prop("checked");if(0===$link.length){var a=$('<a href="'+link+'">'+this.utils.getOuterHtml($image)+"</a>");target&&a.attr("target","_blank"),$image.replaceWith(a)}else $link.attr("href",link),target?$link.attr("target","_blank"):$link.removeAttr("target")}else 0!==$link.length&&$link.replaceWith(this.utils.getOuterHtml($image));this.modal.close(),this.observe.images(),this.code.sync()},setEditable:function($image){this.opts.imageEditable&&$image.on("dragstart",$.proxy(this.image.onDrag,this));var handler=$.proxy(function(e){this.observe.image=$image,0===this.$editor.find("#redactor-image-box").length&&(this.image.resizer=this.image.loadEditableControls($image),$(document).on("mousedown.redactor-image-resize-hide."+this.uuid,$.proxy(this.image.hideResize,this)),this.opts.imageResizable&&this.image.resizer.on("mousedown.redactor touchstart.redactor",$.proxy(function(e){this.image.setResizable(e,$image)},this)))},this);$image.off("mousedown.redactor").on("mousedown.redactor",$.proxy(this.image.hideResize,this)),$image.off("click.redactor touchstart.redactor",handler).on("click.redactor touchstart.redactor",handler)},setResizable:function(e,$image){e.preventDefault(),this.image.resizeHandle={x:e.pageX,y:e.pageY,el:$image,ratio:$image.width()/$image.height(),h:$image.height()},e=e.originalEvent||e,e.targetTouches&&(this.image.resizeHandle.x=e.targetTouches[0].pageX,this.image.resizeHandle.y=e.targetTouches[0].pageY),this.image.startResize()},startResize:function(){$(document).on("mousemove.redactor-image-resize touchmove.redactor-image-resize",$.proxy(this.image.moveResize,this)),$(document).on("mouseup.redactor-image-resize touchend.redactor-image-resize",$.proxy(this.image.stopResize,this))},moveResize:function(e){e.preventDefault(),e=e.originalEvent||e;var height=this.image.resizeHandle.h;height+=e.targetTouches?e.targetTouches[0].pageY-this.image.resizeHandle.y:e.pageY-this.image.resizeHandle.y;var width=Math.round(height*this.image.resizeHandle.ratio);if(!(height<50||width<100)){var height=Math.round(this.image.resizeHandle.el.width()/this.image.resizeHandle.ratio);this.image.resizeHandle.el.attr({width:width,height:height}),this.image.resizeHandle.el.width(width),this.image.resizeHandle.el.height(height),this.code.sync()}},stopResize:function(){this.handle=!1,$(document).off(".redactor-image-resize"),this.image.hideResize()},onDrag:function(e){return 0!==this.$editor.find("#redactor-image-box").length?(e.preventDefault(),!1):void this.$editor.on("drop.redactor-image-inside-drop",$.proxy(function(){setTimeout($.proxy(this.image.onDrop,this),1)},this))},onDrop:function(){this.image.fixImageSourceAfterDrop(),this.observe.images(),this.$editor.off("drop.redactor-image-inside-drop"),this.clean.clearUnverified(),this.code.sync()},fixImageSourceAfterDrop:function(){this.$editor.find("img[data-save-url]").each(function(){var $el=$(this);$el.attr("src",$el.attr("data-save-url")),$el.removeAttr("data-save-url")})},hideResize:function(e){if(!e||0===$(e.target).closest("#redactor-image-box",this.$editor[0]).length){if(e&&"IMG"==e.target.tagName){var $image=$(e.target);$image.attr("data-save-url",$image.attr("src"))}var imageBox=this.$editor.find("#redactor-image-box");0!==imageBox.length&&(this.opts.imageEditable&&this.image.editter.remove(),$(this.image.resizer).remove(),imageBox.find("img").css({marginTop:imageBox[0].style.marginTop,marginBottom:imageBox[0].style.marginBottom,marginLeft:imageBox[0].style.marginLeft,marginRight:imageBox[0].style.marginRight}),imageBox.css("margin",""),imageBox.find("img").css("opacity",""),imageBox.replaceWith(function(){return $(this).contents()}),$(document).off("mousedown.redactor-image-resize-hide."+this.uuid),"undefined"!=typeof this.image.resizeHandle&&this.image.resizeHandle.el.attr("rel",this.image.resizeHandle.el.attr("style")),this.code.sync())}},loadResizableControls:function($image,imageBox){if(this.opts.imageResizable&&!this.utils.isMobile()){var imageResizer=$('<span id="redactor-image-resizer" data-redactor="verified"></span>');return this.utils.isDesktop()||imageResizer.css({width:"15px",height:"15px"}),imageResizer.attr("contenteditable",!1),imageBox.append(imageResizer),imageBox.append($image),imageResizer}return imageBox.append($image),!1},loadEditableControls:function($image){var imageBox=$('<span id="redactor-image-box" data-redactor="verified">');if(imageBox.css("float",$image.css("float")).attr("contenteditable",!1),"auto"!=$image[0].style.margin?(imageBox.css({marginTop:$image[0].style.marginTop,marginBottom:$image[0].style.marginBottom,marginLeft:$image[0].style.marginLeft,marginRight:$image[0].style.marginRight}),$image.css("margin","")):imageBox.css({display:"block",margin:"auto"}),$image.css("opacity",".5").after(imageBox),this.opts.imageEditable){this.image.editter=$('<span id="redactor-image-editter" data-redactor="verified">'+this.lang.get("edit")+"</span>"),this.image.editter.attr("contenteditable",!1),this.image.editter.on("click",$.proxy(function(){this.image.showEdit($image)},this)),imageBox.append(this.image.editter);var editerWidth=this.image.editter.innerWidth();this.image.editter.css("margin-left","-"+editerWidth/2+"px")}return this.image.loadResizableControls($image,imageBox)},remove:function(image){var $image=$(image),$link=$image.closest("a",this.$editor[0]),$figure=$image.closest("figure",this.$editor[0]),$parent=$image.parent();0!==$("#redactor-image-box").length&&($parent=$("#redactor-image-box").parent());var $next;0!==$figure.length?($next=$figure.next(),$figure.remove()):0!==$link.length?($parent=$link.parent(),$link.remove()):$image.remove(),$("#redactor-image-box").remove(),0!==$figure.length?this.caret.setStart($next):this.caret.setStart($parent),this.core.setCallback("imageDelete",$image[0].src,$image),this.modal.close(),this.code.sync()},insert:function(json,direct,e){if("undefined"!=typeof json.error)return this.modal.close(),this.selection.restore(),void this.core.setCallback("imageUploadError",json);var $img;"string"==typeof json?$img=$(json).attr("data-redactor-inserted-image","true"):($img=$("<img>"),$img.attr("src",json.filelink).attr("data-redactor-inserted-image","true"));var node=$img,isP=this.utils.isCurrentOrParent("P");if(isP&&(node=$("<blockquote />").append($img)),direct){this.selection.removeMarkers();var marker=this.selection.getMarker();this.insert.nodeToCaretPositionFromPoint(e,marker)}else this.modal.close();this.selection.restore(),this.buffer.set(),this.insert.html(this.utils.getOuterHtml(node),!1);var $image=this.$editor.find("img[data-redactor-inserted-image=true]").removeAttr("data-redactor-inserted-image");isP?$image.parent().contents().unwrap().wrap("<p />"):this.opts.linebreaks&&(this.utils.isEmpty(this.code.get())||$image.before("<br>"),$image.after("<br>")),"string"!=typeof json&&this.core.setCallback("imageUpload",$image,json)}}},indent:function(){return{increase:function(){this.utils.browser("msie")||this.$editor.focus(),this.buffer.set(),this.selection.save();var block=this.selection.getBlock();block&&"LI"==block.tagName?this.indent.increaseLists():block===!1&&this.opts.linebreaks?this.indent.increaseText():this.indent.increaseBlocks(),this.selection.restore(),this.code.sync()},increaseLists:function(){document.execCommand("indent"),this.indent.fixEmptyIndent(),this.clean.normalizeLists(),this.clean.clearUnverified()},increaseBlocks:function(){$.each(this.selection.getBlocks(),$.proxy(function(i,elem){if("TD"!==elem.tagName&&"TH"!==elem.tagName){var $el=this.utils.getAlignmentElement(elem),left=this.utils.normalize($el.css("margin-left"))+this.opts.indentValue;$el.css("margin-left",left+"px")}},this))},increaseText:function(){var wrapper=this.selection.wrap("div");$(wrapper).attr("data-tagblock","redactor"),$(wrapper).css("margin-left",this.opts.indentValue+"px")},decrease:function(){this.buffer.set(),this.selection.save();var block=this.selection.getBlock();block&&"LI"==block.tagName?this.indent.decreaseLists():this.indent.decreaseBlocks(),this.selection.restore(),this.code.sync()},decreaseLists:function(){document.execCommand("outdent");var current=this.selection.getCurrent(),$item=$(current).closest("li",this.$editor[0]);this.indent.fixEmptyIndent(),this.opts.linebreaks||0!==$item.length||(document.execCommand("formatblock",!1,"p"),this.$editor.find("ul, ol, blockquote, p").each($.proxy(this.utils.removeEmpty,this))),this.clean.clearUnverified()},decreaseBlocks:function(){$.each(this.selection.getBlocks(),$.proxy(function(i,elem){var $el=this.utils.getAlignmentElement(elem),left=this.utils.normalize($el.css("margin-left"))-this.opts.indentValue;left<=0?this.opts.linebreaks&&"undefined"!=typeof $el.data("tagblock")?$el.replaceWith($el.html()+"<br />"):($el.css("margin-left",""),this.utils.removeEmptyAttr($el,"style")):$el.css("margin-left",left+"px")},this))},fixEmptyIndent:function(){var block=this.selection.getBlock();if(this.range.collapsed&&block&&"LI"==block.tagName&&this.utils.isEmpty($(block).text())){var $block=$(block);$block.find("span").not(".redactor-selection-marker").contents().unwrap(),$block.append("<br>")}}}},inline:function(){return{formatting:function(name){var type,value;"undefined"!=typeof this.formatting[name].style?type="style":"undefined"!=typeof this.formatting[name].class&&(type="class"),type&&(value=this.formatting[name][type]),this.inline.format(this.formatting[name].tag,type,value)},format:function(tag,type,value){if(this.blurClickedElement=!0,!this.utils.isCurrentOrParent("PRE")&&!this.utils.isCurrentOrParentHeader()){for(var tags=["b","bold","i","italic","underline","strikethrough","deleted","superscript","subscript"],replaced=["strong","strong","em","em","u","del","del","sup","sub"],i=0;i<tags.length;i++)tag==tags[i]&&(tag=replaced[i]);if(this.opts.allowedTags){if($.inArray(tag,this.opts.allowedTags)==-1)return}else if($.inArray(tag,this.opts.deniedTags)!==-1)return;this.inline.type=type||!1,this.inline.value=value||!1,this.buffer.set(),this.utils.browser("msie")||this.$editor.focus(),this.selection.get(),this.range.collapsed?this.inline.formatCollapsed(tag):this.inline.formatMultiple(tag)}},formatCollapsed:function(tag){var current=this.selection.getCurrent(),$parent=$(current).closest(tag+"[data-redactor-tag="+tag+"]",this.$editor[0]);if(0!==$parent.length&&"style"!=this.inline.type&&"SPAN"!=$parent[0].tagName)return void(this.utils.isEmpty($parent.text())?(this.caret.setAfter($parent[0]),$parent.remove(),this.code.sync()):this.utils.isEndOfElement($parent)&&this.caret.setAfter($parent[0]));var node=$("<"+tag+">").attr("data-verified","redactor").attr("data-redactor-tag",tag);node.html(this.opts.invisibleSpace),node=this.inline.setFormat(node);var node=this.insert.node(node);this.caret.setEnd(node),this.code.sync()},formatMultiple:function(tag){if(this.inline.formatConvert(tag),this.selection.save(),document.execCommand("strikethrough"),this.$editor.find("strike").each($.proxy(function(i,s){var $el=$(s);this.inline.formatRemoveSameChildren($el,tag);var $span;if(this.inline.type?($span=$("<span>").attr("data-redactor-tag",tag).attr("data-verified","redactor"),$span=this.inline.setFormat($span)):$span=$("<"+tag+">").attr("data-redactor-tag",tag).attr("data-verified","redactor"),$el.replaceWith($span.html($el.contents())),"span"==tag){var $parent=$span.parent();if($parent&&"SPAN"==$parent[0].tagName&&"style"==this.inline.type)for(var arr=this.inline.value.split(";"),z=0;z<arr.length;z++){if(""===arr[z])return;var style=arr[z].split(":");$parent.css(style[0],""),this.utils.removeEmptyAttr($parent,"style")&&$parent.replaceWith($parent.contents())}}},this)),"span"!=tag&&this.$editor.find(this.opts.inlineTags.join(", ")).each($.proxy(function(i,s){var $el=$(s),property=$el.css("text-decoration");"line-through"==property&&($el.css("text-decoration",""),this.utils.removeEmptyAttr($el,"style"))},this)),"del"!=tag){var _this=this;this.$editor.find("inline").each(function(i,s){_this.utils.replaceToTag(s,"del")})}this.selection.restore(),this.code.sync()},formatRemoveSameChildren:function($el,tag){var self=this;$el.children(tag).each(function(){var $child=$(this);if(!$child.hasClass("redactor-selection-marker"))if("style"==self.inline.type)for(var arr=self.inline.value.split(";"),z=0;z<arr.length;z++){if(""===arr[z])return;var style=arr[z].split(":");$child.css(style[0],""),self.utils.removeEmptyAttr($child,"style")&&$child.replaceWith($child.contents())}else $child.contents().unwrap()})},formatConvert:function(tag){this.selection.save();var find="";"class"==this.inline.type?find="[data-redactor-class="+this.inline.value+"]":"style"==this.inline.type&&(find='[data-redactor-style="'+this.inline.value+'"]');var self=this;"del"!=tag&&this.$editor.find("del").each(function(i,s){self.utils.replaceToTag(s,"inline")}),"span"!=tag&&this.$editor.find(tag).each(function(){var $el=$(this);$el.replaceWith($("<strike />").html($el.contents()))}),this.$editor.find('[data-redactor-tag="'+tag+'"]'+find).each(function(){if(""!==find||"span"!=tag||this.tagName.toLowerCase()!=tag){var $el=$(this);$el.replaceWith($("<strike />").html($el.contents()))}}),this.selection.restore()},setFormat:function(node){switch(this.inline.type){case"class":node.hasClass(this.inline.value)?(node.removeClass(this.inline.value),node.removeAttr("data-redactor-class")):(node.addClass(this.inline.value),node.attr("data-redactor-class",this.inline.value));break;case"style":node[0].style.cssText=this.inline.value,node.attr("data-redactor-style",this.inline.value)}return node},removeStyle:function(){this.buffer.set();var current=this.selection.getCurrent(),nodes=this.selection.getInlines();if(this.selection.save(),current&&"SPAN"===current.tagName){var $s=$(current);$s.removeAttr("style"),0===$s[0].attributes.length&&$s.replaceWith($s.contents())}$.each(nodes,$.proxy(function(i,s){var $s=$(s);$.inArray(s.tagName.toLowerCase(),this.opts.inlineTags)==-1||$s.hasClass("redactor-selection-marker")||($s.removeAttr("style"),0===$s[0].attributes.length&&$s.replaceWith($s.contents()))},this)),this.selection.restore(),this.code.sync()},removeStyleRule:function(name){this.buffer.set();var parent=this.selection.getParent(),nodes=this.selection.getInlines();if(this.selection.save(),parent&&"SPAN"===parent.tagName){var $s=$(parent);$s.css(name,""),this.utils.removeEmptyAttr($s,"style"),0===$s[0].attributes.length&&$s.replaceWith($s.contents())}$.each(nodes,$.proxy(function(i,s){var $s=$(s);$.inArray(s.tagName.toLowerCase(),this.opts.inlineTags)==-1||$s.hasClass("redactor-selection-marker")||($s.css(name,""),this.utils.removeEmptyAttr($s,"style"),0===$s[0].attributes.length&&$s.replaceWith($s.contents()))},this)),this.selection.restore(),this.code.sync()},removeFormat:function(){this.buffer.set();var current=this.selection.getCurrent();this.selection.save(),document.execCommand("removeFormat"),current&&"SPAN"===current.tagName&&$(current).replaceWith($(current).contents()),$.each(this.selection.getNodes(),$.proxy(function(i,s){var $s=$(s);$.inArray(s.tagName.toLowerCase(),this.opts.inlineTags)==-1||$s.hasClass("redactor-selection-marker")||$s.replaceWith($s.contents())},this)),this.selection.restore(),this.code.sync()},toggleClass:function(className){this.inline.format("span","class",className)},toggleStyle:function(value){this.inline.format("span","style",value)}}},insert:function(){return{set:function(html,clean){this.placeholder.remove(),html=this.clean.setVerified(html),"undefined"==typeof clean&&(html=this.clean.onPaste(html,!1)),this.$editor.html(html),this.selection.remove(),this.focus.setEnd(),this.clean.normalizeLists(),this.code.sync(),this.observe.load(),"undefined"==typeof clean&&setTimeout($.proxy(this.clean.clearUnverified,this),10)},text:function(text){if(this.placeholder.remove(),text=text.toString(),text=$.trim(text),text=this.clean.getPlainText(text,!1),this.$editor.focus(),this.utils.browser("msie"))this.insert.htmlIe(text);else{this.selection.get(),this.range.deleteContents();var el=document.createElement("div");el.innerHTML=text;for(var node,lastNode,frag=document.createDocumentFragment();node=el.firstChild;)lastNode=frag.appendChild(node);if(this.range.insertNode(frag),lastNode){var range=this.range.cloneRange();range.setStartAfter(lastNode),range.collapse(!0),this.sel.removeAllRanges(),this.sel.addRange(range)}}this.code.sync(),this.clean.clearUnverified()},htmlWithoutClean:function(html){this.insert.html(html,!1)},html:function(html,clean){this.placeholder.remove(),"undefined"==typeof clean&&(clean=!0),this.$editor.focus(),html=this.clean.setVerified(html),clean&&(html=this.clean.onPaste(html)),this.utils.browser("msie")?this.insert.htmlIe(html):(this.clean.singleLine?this.insert.execHtml(html):document.execCommand("insertHTML",!1,html),this.insert.htmlFixMozilla()),this.clean.normalizeLists(),this.opts.linebreaks||this.$editor.find("p").each($.proxy(this.utils.removeEmpty,this)),this.code.sync(),this.observe.load(),clean&&this.clean.clearUnverified()},htmlFixMozilla:function(){if(this.utils.browser("mozilla")){var $next=$(this.selection.getBlock()).next();$next.length>0&&"P"==$next[0].tagName&&""===$next.html()&&$next.remove()}},htmlIe:function(html){if(this.utils.isIe11()){var parent=this.utils.isCurrentOrParent("P"),$html=$("<div>").append(html),blocksMatch=$html.contents().is("p, :header, dl, ul, ol, div, table, td, blockquote, pre, address, section, header, footer, aside, article");return void(parent&&blocksMatch?this.insert.ie11FixInserting(parent,html):this.insert.ie11PasteFrag(html))}document.selection.createRange().pasteHTML(html)},execHtml:function(html){html=this.clean.setVerified(html),this.selection.get(),this.range.deleteContents();var el=document.createElement("div");el.innerHTML=html;for(var node,lastNode,frag=document.createDocumentFragment();node=el.firstChild;)lastNode=frag.appendChild(node);this.range.insertNode(frag),this.range.collapse(!0),this.caret.setAfter(lastNode)},node:function(node,deleteContents){node=node[0]||node;var html=this.utils.getOuterHtml(node);return html=this.clean.setVerified(html),null!==html.match(/</g)&&(node=$(html)[0]),this.selection.get(),deleteContents!==!1&&this.range.deleteContents(),this.range.insertNode(node),this.range.collapse(!1),this.selection.addRange(),node},nodeToPoint:function(node,x,y){node=node[0]||node,this.selection.get();var range;if(document.caretPositionFromPoint){var pos=document.caretPositionFromPoint(x,y);this.range.setStart(pos.offsetNode,pos.offset),this.range.collapse(!0),this.range.insertNode(node)}else if(document.caretRangeFromPoint)range=document.caretRangeFromPoint(x,y),range.insertNode(node);else if("undefined"!=typeof document.body.createTextRange){range=document.body.createTextRange(),range.moveToPoint(x,y);var endRange=range.duplicate();endRange.moveToPoint(x,y),range.setEndPoint("EndToEnd",endRange),range.select()}},nodeToCaretPositionFromPoint:function(e,node){node=node[0]||node;var range,x=e.clientX,y=e.clientY;if(document.caretPositionFromPoint){var pos=document.caretPositionFromPoint(x,y),sel=document.getSelection();range=sel.getRangeAt(0),range.setStart(pos.offsetNode,pos.offset),range.collapse(!0),range.insertNode(node)}else if(document.caretRangeFromPoint)range=document.caretRangeFromPoint(x,y),range.insertNode(node);else if("undefined"!=typeof document.body.createTextRange){var IMAGE_WRAPPER_CSS_CLASS="dnnImageWrapper",selectionResult=this.selection.getCurrent();if(!selectionResult)return void this.focus.setEnd();var isAnImageWrapperThatWillBeDeleted=$(selectionResult).hasClass(IMAGE_WRAPPER_CSS_CLASS);if(isAnImageWrapperThatWillBeDeleted)try{selectionResult=selectionResult.parentNode,this.caret.setBefore(selectionResult)}catch(error){this.focus.setEnd()}}},ie11FixInserting:function(parent,html){var node=document.createElement("span");node.className="redactor-ie-paste",this.insert.node(node);var parHtml=$(parent).html();parHtml="<p>"+parHtml.replace(/<span class="redactor-ie-paste"><\/span>/gi,"</p>"+html+"<p>")+"</p>",parHtml=parHtml.replace(/<p><\/p>/gi,""),$(parent).replaceWith(parHtml)},ie11PasteFrag:function(html){this.selection.get(),this.range.deleteContents();var el=document.createElement("div");el.innerHTML=html;for(var node,lastNode,frag=document.createDocumentFragment();node=el.firstChild;)lastNode=frag.appendChild(node);this.range.insertNode(frag),this.range.collapse(!1),this.selection.addRange()}}},keydown:function(){return{init:function(e){if(!this.rtePaste){var key=e.which,arrow=key>=37&&key<=40;this.keydown.ctrl=e.ctrlKey||e.metaKey,this.keydown.current=this.selection.getCurrent(),this.keydown.parent=this.selection.getParent(),this.keydown.block=this.selection.getBlock(),this.keydown.pre=this.utils.isTag(this.keydown.current,"pre"),this.keydown.blockquote=this.utils.isTag(this.keydown.current,"blockquote"),this.keydown.figcaption=this.utils.isTag(this.keydown.current,"figcaption"),this.shortcuts.init(e,key),this.utils.isDesktop()&&(this.keydown.checkEvents(arrow,key),this.keydown.setupBuffer(e,key)),this.keydown.addArrowsEvent(arrow),this.keydown.setupSelectAll(e,key);var keydownStop=this.core.setCallback("keydown",e);if(keydownStop===!1)return e.preventDefault(),!1;if(this.opts.enterKey&&(this.utils.browser("msie")||this.utils.browser("mozilla"))&&(key===this.keyCode.DOWN||key===this.keyCode.RIGHT)){var isEndOfTable=!1,$table=!1;if(this.keydown.block&&"TD"===this.keydown.block.tagName&&($table=$(this.keydown.block).closest("table",this.$editor[0])),$table&&$table.find("td").last()[0]===this.keydown.block&&(isEndOfTable=!0),this.utils.isEndOfElement()&&isEndOfTable){var node=$(this.opts.emptyHtml);$table.after(node),this.caret.setStart(node)}}if(this.opts.enterKey&&key===this.keyCode.DOWN&&this.keydown.onArrowDown(),!this.opts.enterKey&&key===this.keyCode.ENTER)return e.preventDefault(),void(this.range.collapsed||this.range.deleteContents());if(key==this.keyCode.ENTER&&!e.shiftKey&&!e.ctrlKey&&!e.metaKey){var stop=this.core.setCallback("enter",e);if(stop===!1)return e.preventDefault(),!1;if(this.keydown.blockquote&&this.keydown.exitFromBlockquote(e)===!0)return!1;var current,$next;if(this.keydown.pre)return this.keydown.insertNewLine(e);if(this.keydown.blockquote||this.keydown.figcaption)return current=this.selection.getCurrent(),$next=$(current).next(),0!==$next.length&&"BR"==$next[0].tagName?this.keydown.insertBreakLine(e):this.utils.isEndOfElement()&&current&&"SPAN"!=current?this.keydown.insertDblBreakLine(e):this.keydown.insertBreakLine(e);if(this.opts.linebreaks&&!this.keydown.block)return current=this.selection.getCurrent(),$next=$(this.keydown.current).next(),0!==$next.length&&"BR"==$next[0].tagName?this.keydown.insertBreakLine(e):current!==!1&&$(current).hasClass("redactor-invisible-space")?(this.caret.setAfter(current),$(current).contents().unwrap(),this.keydown.insertDblBreakLine(e)):this.utils.isEndOfEditor()?this.keydown.insertDblBreakLine(e):0===$next.length&&current===!1&&"undefined"!=typeof $next.context?this.keydown.insertBreakLine(e):this.keydown.insertBreakLine(e);if(this.opts.linebreaks&&this.keydown.block)setTimeout($.proxy(this.keydown.replaceDivToBreakLine,this),1);else if(!this.opts.linebreaks&&this.keydown.block){if(setTimeout($.proxy(this.keydown.replaceDivToParagraph,this),1),"LI"===this.keydown.block.tagName){current=this.selection.getCurrent();var $parent=$(current).closest("li",this.$editor[0]),$list=$parent.closest("ul,ol",this.$editor[0]);if(0!==$parent.length&&this.utils.isEmpty($parent.html())&&0===$list.next().length&&this.utils.isEmpty($list.find("li").last().html())){$list.find("li").last().remove();var node=$(this.opts.emptyHtml);return $list.after(node),this.caret.setStart(node),!1}}}else if(!this.opts.linebreaks&&!this.keydown.block)return this.keydown.insertParagraph(e)}if(key===this.keyCode.ENTER&&(e.ctrlKey||e.shiftKey))return this.keydown.onShiftEnter(e);if(key===this.keyCode.TAB||e.metaKey&&221===key||e.metaKey&&219===key)return this.keydown.onTab(e,key);if(key===this.keyCode.BACKSPACE||key===this.keyCode.DELETE){var nodes=this.selection.getNodes();if(nodes)for(var last,len=nodes.length,i=0;i<len;i++){var children=$(nodes[i]).children("img");if(0!==children.length){var self=this;$.each(children,function(z,s){var $s=$(s);"none"==$s.css("float")&&(self.core.setCallback("imageDelete",s.src,$s),last=s)})}else"IMG"==nodes[i].tagName&&last!=nodes[i]&&(this.core.setCallback("imageDelete",nodes[i].src,$(nodes[i])),last=nodes[i])}}if(key===this.keyCode.BACKSPACE){var block=this.selection.getBlock(),indented="0px"!==$(block).css("margin-left");if(block&&indented&&this.range.collapsed&&this.utils.isStartOfElement())return this.indent.decrease(),void e.preventDefault();if(this.utils.browser("mozilla")){var prev=this.selection.getPrev(),prev2=$(prev).prev()[0];prev&&"HR"===prev.tagName&&$(prev).remove(),prev2&&"HR"===prev2.tagName&&$(prev2).remove()}this.keydown.removeInvisibleSpace(),this.keydown.removeEmptyListInTable(e)}this.code.sync()}},checkEvents:function(arrow,key){arrow||"click"!=this.core.getEvent()&&"arrow"!=this.core.getEvent()||(this.core.addEvent(!1),this.keydown.checkKeyEvents(key)&&this.buffer.set())},checkKeyEvents:function(key){var k=this.keyCode,keys=[k.BACKSPACE,k.DELETE,k.ENTER,k.SPACE,k.ESC,k.TAB,k.CTRL,k.META,k.ALT,k.SHIFT];return $.inArray(key,keys)==-1},addArrowsEvent:function(arrow){if(arrow)return"click"==this.core.getEvent()||"arrow"==this.core.getEvent()?void this.core.addEvent(!1):void this.core.addEvent("arrow")},setupBuffer:function(e,key){return this.keydown.ctrl&&90===key&&!e.shiftKey&&!e.altKey&&this.opts.buffer.length?(e.preventDefault(),void this.buffer.undo()):this.keydown.ctrl&&90===key&&e.shiftKey&&!e.altKey&&0!==this.opts.rebuffer.length?(e.preventDefault(),void this.buffer.redo()):void(this.keydown.ctrl||key!=this.keyCode.BACKSPACE&&key!=this.keyCode.DELETE&&(key!=this.keyCode.ENTER||e.ctrlKey||e.shiftKey)&&key!=this.keyCode.SPACE||this.buffer.set())},setupSelectAll:function(e,key){this.keydown.ctrl&&65===key?this.utils.enableSelectAll():key==this.keyCode.LEFT_WIN||this.keydown.ctrl||this.utils.disableSelectAll()},onArrowDown:function(){for(var tags=[this.keydown.blockquote,this.keydown.pre,this.keydown.figcaption],i=0;i<tags.length;i++)if(tags[i])return this.keydown.insertAfterLastElement(tags[i]),!1},onShiftEnter:function(e){return this.buffer.set(),this.utils.isEndOfElement()?this.keydown.insertDblBreakLine(e):this.keydown.insertBreakLine(e)},onTab:function(e,key){if(!this.opts.tabKey)return!0;if(this.utils.isEmpty(this.code.get())&&this.opts.tabAsSpaces===!1)return!0;e.preventDefault();var node;return this.keydown.pre&&!e.shiftKey?(node=this.opts.preSpaces?document.createTextNode(Array(this.opts.preSpaces+1).join(" ")):document.createTextNode("\t"),this.insert.node(node),this.code.sync()):this.opts.tabAsSpaces!==!1?(node=document.createTextNode(Array(this.opts.tabAsSpaces+1).join(" ")),
this.insert.node(node),this.code.sync()):e.metaKey&&219===key?this.indent.decrease():e.metaKey&&221===key?this.indent.increase():e.shiftKey?this.indent.decrease():this.indent.increase(),!1},replaceDivToBreakLine:function(){var blockElem=this.selection.getBlock(),blockHtml=blockElem.innerHTML.replace(/<br\s?\/?>/gi,"");if(("DIV"===blockElem.tagName||"P"===blockElem.tagName)&&""===blockHtml&&!$(blockElem).hasClass("redactor-editor")){var br=document.createElement("br");return $(blockElem).replaceWith(br),this.caret.setBefore(br),this.code.sync(),!1}},replaceDivToParagraph:function(){var blockElem=this.selection.getBlock(),blockHtml=blockElem.innerHTML.replace(/<br\s?\/?>/gi,"");if("DIV"===blockElem.tagName&&this.utils.isEmpty(blockHtml)&&!$(blockElem).hasClass("redactor-editor")){var p=document.createElement("p");return p.innerHTML=this.opts.invisibleSpace,$(blockElem).replaceWith(p),this.caret.setStart(p),this.code.sync(),!1}this.opts.cleanStyleOnEnter&&"P"==blockElem.tagName&&$(blockElem).removeAttr("class").removeAttr("style")},insertParagraph:function(e){e.preventDefault(),this.selection.get();var p=document.createElement("p");return p.innerHTML=this.opts.invisibleSpace,this.range.deleteContents(),this.range.insertNode(p),this.caret.setStart(p),this.code.sync(),!1},exitFromBlockquote:function(e){if(this.utils.isEndOfElement()){var tmp=$.trim($(this.keydown.block).html());if(tmp.search(/(<br\s?\/?>){2}$/i)!=-1){if(e.preventDefault(),this.opts.linebreaks){var br=document.createElement("br");$(this.keydown.blockquote).after(br),this.caret.setBefore(br),$(this.keydown.block).html(tmp.replace(/<br\s?\/?>$/i,""))}else{var node=$(this.opts.emptyHtml);$(this.keydown.blockquote).after(node),this.caret.setStart(node)}return!0}}},insertAfterLastElement:function(element){if(this.utils.isEndOfElement())if(this.buffer.set(),this.opts.linebreaks){var contents=$("<div>").append($.trim(this.$editor.html())).contents(),last=contents.last()[0];if("SPAN"==last.tagName&&""===last.innerHTML&&(last=contents.prev()[0]),this.utils.getOuterHtml(last)!=this.utils.getOuterHtml(element))return;var br=document.createElement("br");$(element).after(br),this.caret.setAfter(br)}else{if(this.$editor.contents().last()[0]!==element)return;var node=$(this.opts.emptyHtml);$(element).after(node),this.caret.setStart(node)}},insertNewLine:function(e){e.preventDefault();var node=document.createTextNode("\n");return this.selection.get(),this.range.deleteContents(),this.range.insertNode(node),this.caret.setAfter(node),this.code.sync(),!1},insertBreakLine:function(e){return this.keydown.insertBreakLineProcessing(e)},insertDblBreakLine:function(e){return this.keydown.insertBreakLineProcessing(e,!0)},insertBreakLineProcessing:function(e,dbl){e.stopPropagation(),this.selection.get();var br1=document.createElement("br");this.utils.browser("msie")?(this.range.collapse(!1),this.range.setEnd(this.range.endContainer,this.range.endOffset)):this.range.deleteContents(),this.range.insertNode(br1);var $parentA=$(br1).parent("a");if($parentA.length>0&&($parentA.find(br1).remove(),$parentA.after(br1)),dbl===!0){var $next=$(br1).next();if(0!==$next.length&&"BR"===$next[0].tagName&&this.utils.isEndOfEditor())return this.caret.setAfter(br1),this.code.sync(),!1;var br2=document.createElement("br");this.range.insertNode(br2),this.caret.setAfter(br2)}else if(this.utils.browser("msie")){var space=document.createElement("span");space.innerHTML="&#x200b;",$(br1).after(space),this.caret.setAfter(space),$(space).remove()}else{var range=document.createRange();range.setStartAfter(br1),range.collapse(!0);var selection=window.getSelection();selection.removeAllRanges(),selection.addRange(range)}return this.code.sync(),!1},removeInvisibleSpace:function(){var $current=$(this.keydown.current);0===$current.text().search(/^\u200B$/g)&&$current.remove()},removeEmptyListInTable:function(e){var $current=$(this.keydown.current),$parent=$(this.keydown.parent),td=$current.closest("td",this.$editor[0]);if(0!==td.length&&$current.closest("li",this.$editor[0])&&1===$parent.children("li").length){if(!this.utils.isEmpty($current.text()))return;e.preventDefault(),$current.remove(),$parent.remove(),this.caret.setStart(td)}}}},keyup:function(){return{init:function(e){if(!this.rtePaste){var key=e.which;this.keyup.current=this.selection.getCurrent(),this.keyup.parent=this.selection.getParent();var $parent=this.utils.isRedactorParent($(this.keyup.parent).parent()),keyupStop=this.core.setCallback("keyup",e);if(keyupStop===!1)return e.preventDefault(),!1;if(!this.opts.linebreaks&&3==this.keyup.current.nodeType&&this.keyup.current.length<=1&&(this.keyup.parent===!1||"BODY"==this.keyup.parent.tagName)&&this.keyup.replaceToParagraph(),!this.opts.linebreaks&&this.utils.isRedactorParent(this.keyup.current)&&"DIV"===this.keyup.current.tagName&&this.keyup.replaceToParagraph(!1),this.opts.linebreaks||!$(this.keyup.parent).hasClass("redactor-invisible-space")||$parent!==!1&&"BODY"!=$parent[0].tagName||($(this.keyup.parent).contents().unwrap(),this.keyup.replaceToParagraph()),this.linkify.isEnabled()&&this.linkify.isKey(key)&&this.linkify.format(),key===this.keyCode.DELETE||key===this.keyCode.BACKSPACE){if(this.utils.browser("mozilla")){var td=$(this.keydown.current).closest("td",this.$editor[0]);if(0!==td.size()&&""!==td.text())return e.preventDefault(),!1}return this.clean.clearUnverified(),this.observe.image?(e.preventDefault(),this.image.hideResize(),this.buffer.set(),this.image.remove(this.observe.image),this.observe.image=!1,!1):(this.$editor.find("p").each($.proxy(function(i,s){this.utils.removeEmpty(i,$(s).html())},this)),this.opts.linebreaks&&this.keyup.current&&"DIV"==this.keyup.current.tagName&&this.utils.isEmpty(this.keyup.current.innerHTML)&&($(this.keyup.current).after(this.selection.getMarkerAsHtml()),this.selection.restore(),$(this.keyup.current).remove()),this.keyup.formatEmpty(e))}}},replaceToParagraph:function(clone){var node,$current=$(this.keyup.current);node=clone===!1?$("<p>").append($current.html()):$("<p>").append($current.clone()),$current.replaceWith(node);var next=$(node).next();"undefined"!=typeof next[0]&&"BR"==next[0].tagName&&next.remove(),this.caret.setEnd(node)},formatEmpty:function(e){var html=$.trim(this.$editor.html());if(this.utils.isEmpty(html))return e.preventDefault(),this.opts.linebreaks?(this.$editor.html(this.selection.getMarkerAsHtml()),this.selection.restore()):(this.$editor.html(this.opts.emptyHtml),this.focus.setStart()),this.code.sync(),!1}}},lang:function(){return{load:function(){this.opts.curLang=this.opts.langs[this.opts.lang]},get:function(name){return"undefined"!=typeof this.opts.curLang[name]?this.opts.curLang[name]:""}}},line:function(){return{insert:function(){this.buffer.set();var blocks=this.selection.getBlocks();return blocks[0]!==!1&&this.line.isExceptLastOrFirst(blocks)?void(this.utils.browser("msie")||this.$editor.focus()):void(this.utils.browser("msie")?this.line.insertInIe():this.line.insertInOthersBrowsers())},isExceptLastOrFirst:function(blocks){var exceptTags=["li","td","th","blockquote","figcaption","pre","dl","dt","dd"],first=blocks[0].tagName.toLowerCase(),last=this.selection.getLastBlock();last="undefined"==typeof last?first:last.tagName.toLowerCase();var firstFound=$.inArray(first,exceptTags)!=-1,lastFound=$.inArray(last,exceptTags)!=-1;if(firstFound&&lastFound||firstFound)return!0},insertInIe:function(){this.utils.saveScroll(),this.buffer.set(),this.insert.node(document.createElement("hr")),this.utils.restoreScroll(),this.code.sync()},insertInOthersBrowsers:function(){this.buffer.set();var extra='<p id="redactor-insert-line"><br /></p>';this.opts.linebreaks&&(extra='<br id="redactor-insert-line">'),document.execCommand("insertHtml",!1,"<hr>"+extra),this.line.setFocus(),this.code.sync()},setFocus:function(){var node=this.$editor.find("#redactor-insert-line"),next=$(node).next()[0],target=next;this.utils.browser("mozilla")&&next&&""===next.innerHTML&&(target=$(next).next()[0],$(next).remove()),target?(node.remove(),this.opts.linebreaks||(this.$editor.focus(),this.line.setStart(target))):(node.removeAttr("id"),this.line.setStart(node[0]))},setStart:function(node){if("undefined"!=typeof node){var textNode=document.createTextNode("​");this.selection.get(),this.range.setStart(node,0),this.range.insertNode(textNode),this.range.collapse(!0),this.selection.addRange()}}}},link:function(){return{show:function(e){"undefined"!=typeof e&&e.preventDefault&&e.preventDefault(),this.observe.isCurrent("a")?this.modal.load("link",this.lang.get("link_edit"),600):this.modal.load("link",this.lang.get("link_insert"),600),this.modal.createCancelButton();var buttonText=this.observe.isCurrent("a")?this.lang.get("edit"):this.lang.get("insert");this.link.buttonInsert=this.modal.createActionButton(buttonText),this.selection.get(),this.link.getData(),this.link.cleanUrl(),"_blank"==this.link.target&&$("#redactor-link-blank").prop("checked",!0),this.link.$inputUrl=$("#redactor-link-url"),this.link.$inputText=$("#redactor-link-url-text"),this.link.$inputText.val(this.link.text),this.link.$inputUrl.val(this.link.url),this.link.buttonInsert.on("click",$.proxy(this.link.insert,this)),$(".redactor-link-tooltip").remove(),this.selection.save(),this.modal.show(),this.link.$inputUrl.focus()},cleanUrl:function(){var thref=self.location.href.replace(/\/$/i,"");if("undefined"!=typeof this.link.url&&(this.link.url=this.link.url.replace(thref,""),this.link.url=this.link.url.replace(/^\/#/,"#"),this.link.url=this.link.url.replace("mailto:",""),!this.opts.linkProtocol)){var re=new RegExp("^(http|ftp|https)://"+self.location.host,"i");this.link.url=this.link.url.replace(re,"")}},getData:function(){this.link.$node=!1;var $el=$(this.selection.getCurrent()).closest("a",this.$editor[0]);0!==$el.length&&"A"===$el[0].tagName?(this.link.$node=$el,this.link.url=$el.attr("href"),this.link.text=$el.text(),this.link.target=$el.attr("target")):(this.link.text=this.sel.toString(),this.link.url="",this.link.target="")},insert:function(){this.placeholder.remove();var target="",link=this.link.$inputUrl.val(),text=this.link.$inputText.val();if(""===$.trim(link))return this.link.$inputUrl.addClass("redactor-input-error").on("keyup",function(){$(this).removeClass("redactor-input-error"),$(this).off("keyup")}),void this.$modal.append('<p role="alert" class="redactor-voice-alert" aria-hidden="false">'+this.lang.get("url_required")+"</p>");if(link.search("@")!=-1&&/(http|ftp|https):\/\//i.test(link)===!1)link="mailto:"+link;else if(0!==link.search("#")){$("#redactor-link-blank").prop("checked")&&(target="_blank");var pattern="((xn--)?[a-z0-9]+(-[a-z0-9]+)*\\.)+[a-z]{2,}",re=new RegExp("^(http|ftp|https)://"+pattern,"i"),re2=new RegExp("^"+pattern,"i"),re3=new RegExp(".(html|php)$","i");link.search(re)==-1&&link.search(re3)==-1&&0===link.search(re2)&&this.opts.linkProtocol&&(link=this.opts.linkProtocol+"://"+link)}this.link.set(text,link,target),this.modal.close()},set:function(text,link,target){if(text=$.trim(text.replace(/<|>/g,"")),this.selection.restore(),""!==text||""!==link){if(""===text&&""!==link&&(text=link),this.link.$node){this.buffer.set();var $link=this.link.$node,$el=$link.children();if($el.length>0){for(;$el.length;)$el=$el.children();$el=$el.end()}else $el=$link;$link.attr("href",link),$el.text(text),""!==target?$link.attr("target",target):$link.removeAttr("target"),this.selection.selectElement($link),this.code.sync()}else{if(this.utils.browser("mozilla")&&""===this.link.text){var $a=$("<a />").attr("href",link).text(text);""!==target&&$a.attr("target",target),this.insert.node($a),this.selection.selectElement($a)}else{var $a;this.utils.browser("msie")?($a=$('<a href="'+link+'">').text(text),""!==target&&$a.attr("target",target),$a=$(this.insert.node($a)),this.selection.getText().match(/\s$/)&&$a.after(" "),this.selection.selectElement($a)):(document.execCommand("createLink",!1,link),$a=$(this.selection.getCurrent()).closest("a",this.$editor[0]),this.utils.browser("mozilla")&&($a=$('a[_moz_dirty=""]')),""!==target&&$a.attr("target",target),$a.removeAttr("style").removeAttr("_moz_dirty"),this.selection.getText().match(/\s$/)&&$a.after(" "),""===this.link.text&&this.link.text==text||($a.text(text),this.selection.selectElement($a)))}this.code.sync(),this.core.setCallback("insertedLink",$a)}setTimeout($.proxy(function(){this.observe.links()},this),5)}},unlink:function(e){"undefined"!=typeof e&&e.preventDefault&&e.preventDefault();var nodes=this.selection.getNodes();if(nodes){this.buffer.set();for(var len=nodes.length,i=0;i<len;i++){var $node=$(nodes[i]).closest("a",this.$editor[0]);$node.replaceWith($node.contents())}$(".redactor-link-tooltip").remove(),this.code.sync()}},toggleClass:function(className){this.link.setClass(className,"toggleClass")},addClass:function(className){this.link.setClass(className,"addClass")},removeClass:function(className){this.link.setClass(className,"removeClass")},setClass:function(className,func){var links=this.selection.getInlinesTags(["a"]);links!==!1&&$.each(links,function(){$(this)[func](className)})}}},linkify:function(){return{isKey:function(key){return key==this.keyCode.ENTER||key==this.keyCode.SPACE},isEnabled:function(){return this.opts.convertLinks&&(this.opts.convertUrlLinks||this.opts.convertImageLinks||this.opts.convertVideoLinks)&&!this.utils.isCurrentOrParent("PRE")},format:function(){var linkify=this.linkify,opts=this.opts;this.$editor.find(":not(iframe,img,a,pre)").addBack().contents().filter(function(){return 3===this.nodeType&&""!=$.trim(this.nodeValue)&&!$(this).parent().is("pre")&&(this.nodeValue.match(opts.linkify.regexps.youtube)||this.nodeValue.match(opts.linkify.regexps.vimeo)||this.nodeValue.match(opts.linkify.regexps.image)||this.nodeValue.match(opts.linkify.regexps.url))}).each(function(){var text=$(this).text(),html=text;opts.convertVideoLinks&&(html.match(opts.linkify.regexps.youtube)||html.match(opts.linkify.regexps.vimeo))?html=linkify.convertVideoLinks(html):opts.convertImageLinks&&html.match(opts.linkify.regexps.image)?html=linkify.convertImages(html):opts.convertUrlLinks&&(html=linkify.convertLinks(html)),$(this).before(text.replace(text,html)).remove()}),this.code.sync()},convertVideoLinks:function(html){var iframeStart='<iframe width="500" height="281" src="',iframeEnd='" frameborder="0" allowfullscreen></iframe>';return html.match(this.opts.linkify.regexps.youtube)&&(html=html.replace(this.opts.linkify.regexps.youtube,iframeStart+"//www.youtube.com/embed/$1"+iframeEnd)),html.match(this.opts.linkify.regexps.vimeo)&&(html=html.replace(this.opts.linkify.regexps.vimeo,iframeStart+"//player.vimeo.com/video/$2"+iframeEnd)),html},convertImages:function(html){var matches=html.match(this.opts.linkify.regexps.image);return matches&&(html=html.replace(html,'<img src="'+matches+'" />'),this.opts.linebreaks&&(this.utils.isEmpty(this.code.get())||(html="<br>"+html)),html+="<br>"),html},convertLinks:function(html){var matches=html.match(this.opts.linkify.regexps.url);if(matches){matches=$.grep(matches,function(v,k){return $.inArray(v,matches)===k});for(var length=matches.length,i=0;i<length;i++){var href=matches[i],text=href,linkProtocol=this.opts.linkProtocol+"://";null!==href.match(/(https?|ftp):\/\//i)&&(linkProtocol=""),text.length>this.opts.linkSize&&(text=text.substring(0,this.opts.linkSize)+"..."),text=decodeURIComponent(text);var regexB="\\b";$.inArray(href.slice(-1),["/","&","="])!=-1&&(regexB="");var regexp=new RegExp("("+href.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")+regexB+")","g");html=html.replace(regexp,'<a href="'+linkProtocol+$.trim(href)+'">'+$.trim(text)+"</a>")}}return html}}},list:function(){return{toggle:function(cmd){this.placeholder.remove(),this.utils.browser("msie")||this.$editor.focus(),this.buffer.set(),this.selection.save();var parent=this.selection.getParent(),$list=$(parent).closest("ol, ul",this.$editor[0]);this.utils.isRedactorParent($list)||0===$list.length||($list=!1);var isUnorderedCmdOrdered,isOrderedCmdUnordered,remove=!1;if($list&&$list.length){remove=!0;var listTag=$list[0].tagName;isUnorderedCmdOrdered="orderedlist"===cmd&&"UL"===listTag,isOrderedCmdUnordered="unorderedlist"===cmd&&"OL"===listTag}isUnorderedCmdOrdered?this.utils.replaceToTag($list,"ol"):isOrderedCmdUnordered?this.utils.replaceToTag($list,"ul"):remove?this.list.remove(cmd):this.list.insert(cmd),this.selection.restore(),this.code.sync()},insert:function(cmd){var parent=this.selection.getParent(),current=this.selection.getCurrent(),$td=$(current).closest("td, th",this.$editor[0]);this.utils.browser("msie")&&this.opts.linebreaks?this.list.insertInIe(cmd):document.execCommand("insert"+cmd);var $list=$(this.selection.getParent()).closest("ol, ul",this.$editor[0]);if(0!==$td.length){var prev=$td.prev(),html=$td.html();$td.html(""),!prev||1!==prev.length||"TD"!==prev[0].tagName&&"TH"!==prev[0].tagName?$(parent).prepend($td):$(prev).after($td),$td.html(html)}if(this.utils.isEmpty($list.find("li").text())){var $children=$list.children("li");$children.find("br").remove(),$children.append(this.selection.getMarkerAsHtml()),this.opts.linebreaks&&this.utils.browser("mozilla")&&2==$children.size()&&this.utils.isEmpty($children.eq(1).text())&&$children.eq(1).remove()}if($list.length){var $listParent=$list.parent();this.utils.isRedactorParent($listParent)&&"LI"!=$listParent[0].tagName&&this.utils.isBlock($listParent[0])&&$listParent.replaceWith($listParent.contents())}this.utils.browser("msie")||this.$editor.focus(),this.clean.clearUnverified()},insertInIe:function(cmd){var wrapper=this.selection.wrap("div"),wrapperHtml=$(wrapper).html(),tmpList=$("orderedlist"==cmd?"<ol>":"<ul>"),tmpLi=$("<li>");if(""===$.trim(wrapperHtml))tmpLi.append(this.selection.getMarkerAsHtml()),tmpList.append(tmpLi),this.$editor.find("#selection-marker-1").replaceWith(tmpList);else{var items=wrapperHtml.split(/<br\s?\/?>/gi);if(items)for(var i=0;i<items.length;i++)""!==$.trim(items[i])&&tmpList.append($("<li>").html(items[i]));else tmpLi.append(wrapperHtml),tmpList.append(tmpLi);$(wrapper).replaceWith(tmpList)}},remove:function(cmd){$.inArray("ul",this.selection.getBlocks())&&(cmd="unorderedlist"),document.execCommand("insert"+cmd);var $current=$(this.selection.getCurrent());this.indent.fixEmptyIndent(),this.opts.linebreaks||0!==$current.closest("li, th, td",this.$editor[0]).length||(document.execCommand("formatblock",!1,"p"),this.$editor.find("ul, ol, blockquote").each($.proxy(this.utils.removeEmpty,this)));var $table=$(this.selection.getCurrent()).closest("table",this.$editor[0]),$prev=$table.prev();this.opts.linebreaks||0===$table.length||0===$prev.length||"BR"!=$prev[0].tagName||$prev.remove(),this.clean.clearUnverified()}}},modal:function(){return{callbacks:{},loadTemplates:function(){this.opts.modal={imageEdit:String()+'<section id="redactor-modal-image-edit"><label>'+this.lang.get("title")+'</label><input type="text" id="redactor-image-title" /><label class="redactor-image-link-option">'+this.lang.get("link")+'</label><input type="text" id="redactor-image-link" class="redactor-image-link-option" aria-label="'+this.lang.get("link")+'" /><label class="redactor-image-link-option"><input type="checkbox" id="redactor-image-link-blank" aria-label="'+this.lang.get("link_new_tab")+'"> '+this.lang.get("link_new_tab")+'</label><label class="redactor-image-position-option">'+this.lang.get("image_position")+'</label><select class="redactor-image-position-option" id="redactor-image-align" aria-label="'+this.lang.get("image_position")+'"><option value="none">'+this.lang.get("none")+'</option><option value="left">'+this.lang.get("left")+'</option><option value="center">'+this.lang.get("center")+'</option><option value="right">'+this.lang.get("right")+"</option></select></section>",image:String()+'<section id="redactor-modal-image-insert"><div id="redactor-modal-image-droparea"></div></section>',file:String()+'<section id="redactor-modal-file-insert"><div id="redactor-modal-file-upload-box"><label>'+this.lang.get("filename")+'</label><input type="text" id="redactor-filename" aria-label="'+this.lang.get("filename")+'" /><br><br><div id="redactor-modal-file-upload"></div></div></section>',link:String()+'<section id="redactor-modal-link-insert"><label>URL</label><input type="url" id="redactor-link-url" aria-label="URL" /><label>'+this.lang.get("text")+'</label><input type="text" id="redactor-link-url-text" aria-label="'+this.lang.get("text")+'" /><label><input type="checkbox" id="redactor-link-blank"> '+this.lang.get("link_new_tab")+"</label></section>"},$.extend(this.opts,this.opts.modal)},addCallback:function(name,callback){this.modal.callbacks[name]=callback},createTabber:function($modal){this.modal.$tabber=$("<div>").attr("id","redactor-modal-tabber"),$modal.prepend(this.modal.$tabber)},addTab:function(id,name,active){var $tab=$('<a href="#" rel="tab'+id+'">').text(name);active&&$tab.addClass("active");var self=this;$tab.on("click",function(e){e.preventDefault(),$(".redactor-tab").hide(),$(".redactor-"+$(this).attr("rel")).show(),self.modal.$tabber.find("a").removeClass("active"),$(this).addClass("active")}),this.modal.$tabber.append($tab)},addTemplate:function(name,template){this.opts.modal[name]=template},getTemplate:function(name){return this.opts.modal[name]},getModal:function(){return this.$modalBody.find("section")},load:function(templateName,title,width){this.modal.templateName=templateName,this.modal.width=width,this.modal.build(),this.modal.enableEvents(),this.modal.setTitle(title),this.modal.setDraggable(),this.modal.setContent(),"undefined"!=typeof this.modal.callbacks[templateName]&&this.modal.callbacks[templateName].call(this)},resizeWithPersonaBar:function(){var PERSONA_BAR_WIDTH=85,PERSONA_BAR_IFRAME_ID="personaBar-iframe",PERSONA_BAR_ID="personabar",personaBarIframe=document.getElementById(PERSONA_BAR_IFRAME_ID);if(personaBarIframe&&personaBarIframe.contentWindow.document.getElementById(PERSONA_BAR_ID)){var windowWidth=$(window).width(),noWidthEnough=this.$modal.width()>windowWidth-PERSONA_BAR_WIDTH;noWidthEnough&&this.$modal.css({width:this.$modal.width()-PERSONA_BAR_WIDTH}),this.$modal.css({left:Math.floor(PERSONA_BAR_WIDTH/2)})}},show:function(){this.utils.isMobile()&&document.activeElement.blur(),this.utils.disableBodyScroll(),this.utils.isMobile()?this.modal.showOnMobile():this.modal.showOnDesktop(),this.opts.highContrast&&this.$modalBox.addClass("redactor-modal-contrast"),this.$modalOverlay.show(),this.$modalBox.show(),this.$modal.attr("tabindex","-1"),this.$modal.focus(),this.modal.setButtonsWidth(),this.utils.saveScroll(),this.utils.isMobile()?this.modal.resizeWithPersonaBar():(setTimeout($.proxy(function(){this.modal.showOnDesktop(),this.modal.resizeWithPersonaBar()},this),0),$(window).on("resize.redactor-modal",$.proxy(this.modal.resize,this))),this.core.setCallback("modalOpened",this.modal.templateName,this.$modal),$(document).off("focusin.modal"),this.$modal.find("input[type=text],input[type=url],input[type=email]").on("keydown.redactor-modal",$.proxy(this.modal.setEnter,this))},showOnDesktop:function(){var height=this.$modal.outerHeight(),windowHeight=$(window).height(),windowWidth=$(window).width();return this.modal.width>windowWidth?void this.$modal.css({width:"96%",marginTop:windowHeight/2-height/2+"px"}):void(height>windowHeight?this.$modal.css({width:this.modal.width+"px",marginTop:"20px"}):this.$modal.css({width:this.modal.width+"px",marginTop:windowHeight/2-height/2+"px"}))},showOnMobile:function(){this.$modal.css({width:"96%",marginTop:"2%"})},resize:function(){this.utils.isMobile()?this.modal.showOnMobile():this.modal.showOnDesktop(),this.modal.resizeWithPersonaBar()},setTitle:function(title){this.$modalHeader.html(title)},setContent:function(){this.$modalBody.html(this.modal.getTemplate(this.modal.templateName))},setDraggable:function(){"undefined"!=typeof $.fn.draggable&&(this.$modal.draggable({handle:this.$modalHeader}),this.$modalHeader.css("cursor","move"))},setEnter:function(e){13==e.which&&(e.preventDefault(),this.$modal.find("button.redactor-modal-action-btn").click())},createCancelButton:function(){var button=$("<button>").addClass("redactor-modal-btn redactor-modal-close-btn").html(this.lang.get("cancel"));button.on("click",$.proxy(this.modal.close,this)),this.$modalFooter.append(button)},createDeleteButton:function(label){return this.modal.createButton(label,"delete")},createActionButton:function(label){return this.modal.createButton(label,"action")},createButton:function(label,className){var button=$("<button>").addClass("redactor-modal-btn").addClass("redactor-modal-"+className+"-btn").html(label);return this.$modalFooter.append(button),button},setButtonsWidth:function(){var buttons=this.$modalFooter.find("button"),buttonsSize=buttons.length;0!==buttonsSize&&buttons.css("width",100/buttonsSize+"%")},build:function(){this.modal.buildOverlay(),this.$modalBox=$('<div id="redactor-modal-box"/>').hide(),this.$modal=$('<div id="redactor-modal" role="dialog" aria-labelledby="redactor-modal-header" />'),this.$modalHeader=$('<header id="redactor-modal-header"/>'),this.$modalClose=$('<button type="button" id="redactor-modal-close" tabindex="1" aria-label="Close" />').html("&times;"),this.$modalBody=$('<div id="redactor-modal-body" />'),this.$modalFooter=$("<footer />"),this.$modal.append(this.$modalHeader),this.$modal.append(this.$modalClose),this.$modal.append(this.$modalBody),this.$modal.append(this.$modalFooter),this.$modalBox.append(this.$modal),this.$modalBox.appendTo(document.body)},buildOverlay:function(){this.$modalOverlay=$('<div id="redactor-modal-overlay">').hide(),$("body").prepend(this.$modalOverlay)},enableEvents:function(){this.$modalClose.on("click.redactor-modal",$.proxy(this.modal.close,this)),$(document).on("keyup.redactor-modal",$.proxy(this.modal.closeHandler,this)),this.$editor.on("keyup.redactor-modal",$.proxy(this.modal.closeHandler,this)),this.$modalBox.on("click.redactor-modal",$.proxy(this.modal.close,this))},disableEvents:function(){this.$modalClose.off("click.redactor-modal"),$(document).off("keyup.redactor-modal"),this.$editor.off("keyup.redactor-modal"),this.$modalBox.off("click.redactor-modal"),$(window).off("resize.redactor-modal")},closeHandler:function(e){e.which==this.keyCode.ESC&&this.modal.close(!1)},close:function(e){if(e){if(!$(e.target).hasClass("redactor-modal-close-btn")&&e.target!=this.$modalClose[0]&&e.target!=this.$modalBox[0])return;e.preventDefault()}this.$modalBox&&(this.modal.disableEvents(),this.utils.enableBodyScroll(),this.$modalOverlay.remove(),this.$modalBox.fadeOut("fast",$.proxy(function(){this.$modalBox.remove(),setTimeout($.proxy(this.utils.restoreScroll,this),0),void 0!==e&&this.selection.restore(),$(document.body).css("overflow",this.modal.bodyOveflow),this.core.setCallback("modalClosed",this.modal.templateName)},this)))}}},observe:function(){return{load:function(){"undefined"==typeof this.opts.destroyed&&(this.observe.images(),this.observe.links())},toolbar:function(e,btnName){this.observe.buttons(e,btnName),this.observe.dropdowns()},isCurrent:function($el,$current){if("undefined"==typeof $current)var $current=$(this.selection.getCurrent());return $current.is($el)||$current.parents($el).length>0},dropdowns:function(){var $current=$(this.selection.getCurrent());$.each(this.opts.observe.dropdowns,$.proxy(function(key,value){var observe=value.observe,element=observe.element,$item=value.item,inValues="undefined"!=typeof observe.in&&observe.in,outValues="undefined"!=typeof observe.out&&observe.out;$current.closest(element).size()>0?this.observe.setDropdownProperties($item,inValues,outValues):this.observe.setDropdownProperties($item,outValues,inValues)},this))},setDropdownProperties:function($item,addProperties,deleteProperties){deleteProperties&&"undefined"!=typeof deleteProperties.attr&&this.observe.setDropdownAttr($item,deleteProperties.attr,!0),"undefined"!=typeof addProperties.attr&&this.observe.setDropdownAttr($item,addProperties.attr),"undefined"!=typeof addProperties.title&&$item.text(addProperties.title)},setDropdownAttr:function($item,properties,isDelete){$.each(properties,function(key,value){"class"==key?isDelete?$item.removeClass(value):$item.addClass(value):isDelete?$item.removeAttr(key):$item.attr(key,value)})},addDropdown:function($item,btnName,btnObject){"undefined"!=typeof btnObject.observe&&(btnObject.item=$item,this.opts.observe.dropdowns.push(btnObject))},buttons:function(e,btnName){var current=this.selection.getCurrent(),parent=this.selection.getParent();if(e!==!1?this.button.setInactiveAll():this.button.setInactiveAll(btnName),e===!1&&"html"!==btnName)return void($.inArray(btnName,this.opts.activeButtons)!=-1&&this.button.toggleActive(btnName));$.each(this.opts.activeButtonsStates,$.proxy(function(key,value){var parentEl=$(parent).closest(key,this.$editor[0]),currentEl=$(current).closest(key,this.$editor[0]);(0===parentEl.length||this.utils.isRedactorParent(parentEl))&&this.utils.isRedactorParent(currentEl)&&(0===parentEl.length&&0===currentEl.closest(key,this.$editor[0]).length||this.button.setActive(value))},this));var $parent=$(parent).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0]);if(this.utils.isRedactorParent(parent)&&$parent.length){var align=""===$parent.css("text-align")?"left":$parent.css("text-align");this.button.setActive("align"+align)}},addButton:function(tag,btnName){this.opts.activeButtons.push(btnName),this.opts.activeButtonsStates[tag]=btnName},images:function(){this.$editor.find("img").each($.proxy(function(i,img){var $img=$(img);$img.closest("a",this.$editor[0]).on("click",function(e){e.preventDefault()}),this.utils.browser("msie")&&$img.attr("unselectable","on"),this.image.setEditable($img)},this)),$(document).on("click.redactor-image-delete."+this.uuid,$.proxy(function(e){this.observe.image=!1,"IMG"==e.target.tagName&&this.utils.isRedactorParent(e.target)&&(this.observe.image=(!this.observe.image||this.observe.image!=e.target)&&e.target)},this))},links:function(){this.opts.linkTooltip&&(this.$editor.find("a").on("touchstart.redactor."+this.uuid+" click.redactor."+this.uuid,$.proxy(this.observe.showTooltip,this)),this.$editor.on("touchstart.redactor."+this.uuid+" click.redactor."+this.uuid,$.proxy(this.observe.closeTooltip,this)),$(document).on("touchstart.redactor."+this.uuid+" click.redactor."+this.uuid,$.proxy(this.observe.closeTooltip,this)))},getTooltipPosition:function($link){return $link.offset()},showTooltip:function(e){var $el=$(e.target);if("IMG"!=$el[0].tagName&&("A"!==$el[0].tagName&&($el=$el.closest("a",this.$editor[0])),"A"===$el[0].tagName)){var $link=$el,pos=this.observe.getTooltipPosition($link),tooltip=$('<span class="redactor-link-tooltip"></span>'),href=$link.attr("href");void 0===href&&(href=""),href.length>24&&(href=href.substring(0,24)+"...");var aLink=$('<a href="'+$link.attr("href")+'" target="_blank" />').html(href).addClass("redactor-link-tooltip-action"),aEdit=$('<a href="#" />').html(this.lang.get("edit")).on("click",$.proxy(this.link.show,this)).addClass("redactor-link-tooltip-action"),aUnlink=$('<a href="#" />').html(this.lang.get("unlink")).on("click",$.proxy(this.link.unlink,this)).addClass("redactor-link-tooltip-action");tooltip.append(aLink).append(" | ").append(aEdit).append(" | ").append(aUnlink),tooltip.css({top:pos.top+parseInt($link.css("line-height"),10)+"px",left:pos.left+"px"}),$(".redactor-link-tooltip").remove(),$("body").append(tooltip)}},closeTooltip:function(e){e=e.originalEvent||e;var target=e.target,$parent=$(target).closest("a",this.$editor[0]);0!==$parent.length&&"A"===$parent[0].tagName&&"A"!==target.tagName||"A"===target.tagName&&this.utils.isRedactorParent(target)||$(target).hasClass("redactor-link-tooltip-action")||$(".redactor-link-tooltip").remove()}}},paragraphize:function(){return{load:function(html){return this.opts.linebreaks?html:""===html||"<p></p>"===html?this.opts.emptyHtml:(html+="\n",this.paragraphize.safes=[],this.paragraphize.z=0,
html=html.replace(/(<br\s?\/?>){1,}\n?<\/blockquote>/gi,"</blockquote>"),html=this.paragraphize.getSafes(html),html=this.paragraphize.getSafesComments(html),html=this.paragraphize.replaceBreaksToNewLines(html),html=this.paragraphize.replaceBreaksToParagraphs(html),html=this.paragraphize.clear(html),html=this.paragraphize.restoreSafes(html),html=html.replace(new RegExp("<br\\s?/?>\n?<("+this.opts.paragraphizeBlocks.join("|")+")(.*?[^>])>","gi"),"<p><br /></p>\n<$1$2>"),$.trim(html))},getSafes:function(html){var $div=$("<div />").append(html);return $div.find("blockquote p").replaceWith(function(){return $(this).append("<br />").contents()}),html=$div.html(),$div.find(this.opts.paragraphizeBlocks.join(", ")).each($.proxy(function(i,s){this.paragraphize.z++,this.paragraphize.safes[this.paragraphize.z]=s.outerHTML,html=html.replace(s.outerHTML,"\n{replace"+this.paragraphize.z+"}")},this)),html},getSafesComments:function(html){var commentsMatches=html.match(/<!--([\w\W]*?)-->/gi);return commentsMatches?($.each(commentsMatches,$.proxy(function(i,s){this.paragraphize.z++,this.paragraphize.safes[this.paragraphize.z]=s,html=html.replace(s,"\n{replace"+this.paragraphize.z+"}")},this)),html):html},restoreSafes:function(html){return $.each(this.paragraphize.safes,function(i,s){s="undefined"!=typeof s?s.replace(/\$/g,"&#36;"):s,html=html.replace("{replace"+i+"}",s)}),html},replaceBreaksToParagraphs:function(html){var htmls=html.split(new RegExp("\n","g"),-1);if(html="",htmls)for(var len=htmls.length,i=0;i<len;i++){if(!htmls.hasOwnProperty(i))return;htmls[i].search("{replace")==-1?(htmls[i]=htmls[i].replace(/<p>\n\t?<\/p>/gi,""),htmls[i]=htmls[i].replace(/<p><\/p>/gi,""),""!==htmls[i]&&(html+="<p>"+htmls[i].replace(/^\n+|\n+$/g,"")+"</p>")):html+=htmls[i]}return html},replaceBreaksToNewLines:function(html){return html=html.replace(/<br \/>\s*<br \/>/gi,"\n\n"),html=html.replace(/<br\s?\/?>\n?<br\s?\/?>/gi,"\n<br /><br />"),html=html.replace(new RegExp("\r\n","g"),"\n"),html=html.replace(new RegExp("\r","g"),"\n"),html=html.replace(new RegExp("/\n\n+/"),"g","\n\n")},clear:function(html){return html=html.replace(new RegExp("</blockquote></p>","gi"),"</blockquote>"),html=html.replace(new RegExp("<p></blockquote>","gi"),"</blockquote>"),html=html.replace(new RegExp("<p><blockquote>","gi"),"<blockquote>"),html=html.replace(new RegExp("<blockquote></p>","gi"),"<blockquote>"),html=html.replace(new RegExp("<p><p ","gi"),"<p "),html=html.replace(new RegExp("<p><p>","gi"),"<p>"),html=html.replace(new RegExp("</p></p>","gi"),"</p>"),html=html.replace(new RegExp("<p>\\s?</p>","gi"),""),html=html.replace(new RegExp("\n</p>","gi"),"</p>"),html=html.replace(new RegExp("<p>\t?\t?\n?<p>","gi"),"<p>"),html=html.replace(new RegExp("<p>\t*</p>","gi"),"")}}},paste:function(){return{init:function(e){return this.opts.cleanOnPaste?(this.rtePaste=!0,this.buffer.set(),this.selection.save(),this.utils.saveScroll(),this.paste.createPasteBox(),$(window).on("scroll.redactor-freeze",$.proxy(function(){$(window).scrollTop(this.saveBodyScroll)},this)),void setTimeout($.proxy(function(){var html=this.$pasteBox.html();this.$pasteBox.remove(),this.selection.restore(),this.utils.restoreScroll(),this.paste.insert(html),$(window).off("scroll.redactor-freeze"),this.linkify.isEnabled()&&this.linkify.format()},this),1)):void setTimeout($.proxy(this.code.sync,this),1)},createPasteBox:function(){this.$pasteBox=$("<div>").html("").attr("contenteditable","true").css({position:"fixed",width:0,top:0,left:"-9999px"}),this.utils.browser("msie")?this.$box.append(this.$pasteBox):$(".modal-body").length>0?$(".modal-body").append(this.$pasteBox):$("body").append(this.$pasteBox),this.$pasteBox.focus()},insert:function(html){html=this.core.setCallback("pasteBefore",html),html=this.utils.isSelectAll()?this.clean.onPaste(html,!1):this.clean.onPaste(html),html=this.core.setCallback("paste",html),this.utils.isSelectAll()?this.insert.set(html,!1):this.insert.html(html,!1),this.utils.disableSelectAll(),this.rtePaste=!1,setTimeout($.proxy(this.clean.clearUnverified,this),10),setTimeout($.proxy(function(){var spans=this.$editor.find("span");$.each(spans,function(i,s){var html=s.innerHTML.replace(/\u200B/,"");""===html&&0===s.attributes.length&&$(s).remove()})},this),10)}}},placeholder:function(){return{enable:function(){this.placeholder.is()&&(this.$editor.attr("placeholder",this.$element.attr("placeholder")),this.placeholder.toggle(),this.$editor.on("keydown.redactor-placeholder",$.proxy(this.placeholder.toggle,this)))},toggle:function(){setTimeout($.proxy(function(){var func=this.utils.isEmpty(this.$editor.html(),!1)?"addClass":"removeClass";this.$editor[func]("redactor-placeholder")},this),5)},remove:function(){this.$editor.removeClass("redactor-placeholder")},is:function(){return this.opts.placeholder?this.$element.attr("placeholder",this.opts.placeholder):!("undefined"==typeof this.$element.attr("placeholder")||""===this.$element.attr("placeholder"))}}},progress:function(){return{show:function(){$(document.body).append($('<div id="redactor-progress"><span></span></div>')),$("#redactor-progress").fadeIn()},hide:function(){$("#redactor-progress").fadeOut(1500,function(){$(this).remove()})}}},selection:function(){return{get:function(){this.sel=document.getSelection(),document.getSelection&&this.sel.getRangeAt&&this.sel.rangeCount?this.range=this.sel.getRangeAt(0):this.range=document.createRange()},addRange:function(){try{this.sel.removeAllRanges()}catch(e){}this.sel.addRange(this.range)},getCurrent:function(){var el=!1;return this.selection.get(),this.sel&&this.sel.rangeCount>0&&(el=this.sel.getRangeAt(0).startContainer),this.utils.isRedactorParent(el)},getParent:function(elem){return elem=elem||this.selection.getCurrent(),!!elem&&this.utils.isRedactorParent($(elem).parent()[0])},getPrev:function(){return window.getSelection().anchorNode.previousSibling},getNext:function(){return window.getSelection().anchorNode.nextSibling},getBlock:function(node){for(node=node||this.selection.getCurrent();node;){if(this.utils.isBlockTag(node.tagName))return!$(node).hasClass("redactor-editor")&&node;node=node.parentNode}return!1},getInlines:function(nodes,tags){if(this.selection.get(),this.range&&this.range.collapsed)return!1;var inlines=[];nodes="undefined"==typeof nodes||nodes===!1?this.selection.getNodes():nodes;var inlineTags=this.opts.inlineTags;if(inlineTags.push("span"),"undefined"!=typeof tags)for(var i=0;i<tags.length;i++)inlineTags.push(tags[i]);return $.each(nodes,$.proxy(function(i,node){$.inArray(node.tagName.toLowerCase(),inlineTags)!=-1&&inlines.push(node)},this)),0!==inlines.length&&inlines},getInlinesTags:function(tags){if(this.selection.get(),this.range&&this.range.collapsed)return!1;var inlines=[],nodes=this.selection.getNodes();return $.each(nodes,$.proxy(function(i,node){$.inArray(node.tagName.toLowerCase(),tags)!=-1&&inlines.push(node)},this)),0!==inlines.length&&inlines},getBlocks:function(nodes){if(this.selection.get(),this.range&&this.range.collapsed)return[this.selection.getBlock()];var blocks=[];return nodes="undefined"==typeof nodes?this.selection.getNodes():nodes,$.each(nodes,$.proxy(function(i,node){this.utils.isBlock(node)&&(this.selection.lastBlock=node,blocks.push(node))},this)),0===blocks.length?[this.selection.getBlock()]:blocks},getLastBlock:function(){return this.selection.lastBlock},getNodes:function(){this.selection.get();var startNode=this.selection.getNodesMarker(1),endNode=this.selection.getNodesMarker(2);if(this.range.collapsed===!1){if(window.getSelection){var sel=window.getSelection();if(sel.rangeCount>0){var range=sel.getRangeAt(0),startPointNode=range.startContainer,startOffset=range.startOffset,boundaryRange=range.cloneRange();boundaryRange.collapse(!1),boundaryRange.insertNode(endNode),boundaryRange.setStart(startPointNode,startOffset),boundaryRange.collapse(!0),boundaryRange.insertNode(startNode),range.setStartAfter(startNode),range.setEndBefore(endNode),sel.removeAllRanges(),sel.addRange(range)}}}else this.selection.setNodesMarker(this.range,startNode,!0),endNode=startNode;var nodes=[],counter=0,self=this;this.$editor.find("*").each(function(){if(this==startNode){var parent=$(this).parent();0!==parent.length&&"BODY"!=parent[0].tagName&&self.utils.isRedactorParent(parent[0])&&nodes.push(parent[0]),nodes.push(this),counter=1}else counter>0&&(nodes.push(this),counter+=1);if(this==endNode)return!1});for(var finalNodes=[],len=nodes.length,i=0;i<len;i++)"nodes-marker-1"!=nodes[i].id&&"nodes-marker-2"!=nodes[i].id&&finalNodes.push(nodes[i]);return this.selection.removeNodesMarkers(),finalNodes},getNodesMarker:function(num){return $('<span id="nodes-marker-'+num+'" class="redactor-nodes-marker" data-verified="redactor">'+this.opts.invisibleSpace+"</span>")[0]},setNodesMarker:function(range,node,type){var range=range.cloneRange();try{range.collapse(type),range.insertNode(node)}catch(e){}},removeNodesMarkers:function(){$(document).find("span.redactor-nodes-marker").remove(),this.$editor.find("span.redactor-nodes-marker").remove()},fromPoint:function(start,end){this.caret.setOffset(start,end)},wrap:function(tag){if(this.selection.get(),this.range.collapsed)return!1;var wrapper=document.createElement(tag);return wrapper.appendChild(this.range.extractContents()),this.range.insertNode(wrapper),wrapper},selectElement:function(node){this.caret.set(node,0,node,1)},selectAll:function(){this.selection.get(),this.range.selectNodeContents(this.$editor[0]),this.selection.addRange()},remove:function(){this.selection.get(),this.sel.removeAllRanges()},save:function(){this.selection.createMarkers()},createMarkers:function(){this.selection.get();var node1=this.selection.getMarker(1);if(this.selection.setMarker(this.range,node1,!0),this.range.collapsed===!1){var node2=this.selection.getMarker(2);this.selection.setMarker(this.range,node2,!1)}this.savedSel=this.$editor.html()},getMarker:function(num){return"undefined"==typeof num&&(num=1),$('<span id="selection-marker-'+num+'" class="redactor-selection-marker"  data-verified="redactor">'+this.opts.invisibleSpace+"</span>")[0]},getMarkerAsHtml:function(num){return this.utils.getOuterHtml(this.selection.getMarker(num))},setMarker:function(range,node,type){range=range.cloneRange();try{range.collapse(type),range.insertNode(node)}catch(e){this.focus.setStart()}},restore:function(){var node1=this.$editor.find("span#selection-marker-1"),node2=this.$editor.find("span#selection-marker-2");0!==node1.length&&0!==node2.length?this.caret.set(node1,0,node2,0):0!==node1.length?this.caret.set(node1,0,node1,0):this.$editor.focus(),this.selection.removeMarkers(),this.savedSel=!1},removeMarkers:function(){this.$editor.find("span.redactor-selection-marker").each(function(i,s){var text=$(s).text().replace(/\u200B/g,"");""===text?$(s).remove():$(s).replaceWith(function(){return $(this).contents()})})},getText:function(){return this.selection.get(),this.sel.toString()},getHtml:function(){var html="";if(this.selection.get(),this.sel.rangeCount){for(var container=document.createElement("div"),len=this.sel.rangeCount,i=0;i<len;++i)container.appendChild(this.sel.getRangeAt(i).cloneContents());html=container.innerHTML}return this.clean.onSync(html)},replaceSelection:function(html){this.selection.get(),this.range.deleteContents();var div=document.createElement("div");div.innerHTML=html;for(var child,frag=document.createDocumentFragment();child=div.firstChild;)frag.appendChild(child);this.range.insertNode(frag)},replaceWithHtml:function(html){html=this.selection.getMarkerAsHtml(1)+html+this.selection.getMarkerAsHtml(2),this.selection.get(),window.getSelection&&window.getSelection().getRangeAt?this.selection.replaceSelection(html):document.selection&&document.selection.createRange&&this.range.pasteHTML(html),this.selection.restore(),this.code.sync()}}},shortcuts:function(){return{init:function(e,key){return this.opts.shortcuts?void $.each(this.opts.shortcuts,$.proxy(function(str,command){for(var keys=str.split(","),len=keys.length,i=0;i<len;i++)"string"==typeof keys[i]&&this.shortcuts.handler(e,$.trim(keys[i]),$.proxy(function(){var func;"-1"!=command.func.search(/\./)?(func=command.func.split("."),"undefined"!=typeof this[func[0]]&&this[func[0]][func[1]].apply(this,command.params)):this[command.func].apply(this,command.params)},this))},this)):(!e.ctrlKey&&!e.metaKey||66!==key&&73!==key||e.preventDefault(),!1)},handler:function(e,keys,origHandler){var hotkeysSpecialKeys={8:"backspace",9:"tab",10:"return",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",59:";",61:"=",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},hotkeysShiftNums={"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":": ","'":'"',",":"<",".":">","/":"?","\\":"|"};keys=keys.toLowerCase().split(" ");var special=hotkeysSpecialKeys[e.keyCode],character=String.fromCharCode(e.which).toLowerCase(),modif="",possible={};$.each(["alt","ctrl","meta","shift"],function(index,specialKey){e[specialKey+"Key"]&&special!==specialKey&&(modif+=specialKey+"+")}),special&&(possible[modif+special]=!0),character&&(possible[modif+character]=!0,possible[modif+hotkeysShiftNums[character]]=!0,"shift+"===modif&&(possible[hotkeysShiftNums[character]]=!0));for(var i=0,len=keys.length;i<len;i++)if(possible[keys[i]])return e.preventDefault(),origHandler.apply(this,arguments)}}},tabifier:function(){return{get:function(code){if(!this.opts.tabifier)return code;var ownLine=["area","body","head","hr","i?frame","link","meta","noscript","style","script","table","tbody","thead","tfoot"],contOwnLine=["li","dt","dt","h[1-6]","option","script"],newLevel=["p","blockquote","div","dl","fieldset","form","frameset","map","ol","pre","select","td","th","tr","ul"];this.tabifier.lineBefore=new RegExp("^<(/?"+ownLine.join("|/?")+"|"+contOwnLine.join("|")+")[ >]"),this.tabifier.lineAfter=new RegExp("^<(br|/?"+ownLine.join("|/?")+"|/"+contOwnLine.join("|/")+")[ >]"),this.tabifier.newLevel=new RegExp("^</?("+newLevel.join("|")+")[ >]");var i=0,codeLength=code.length,point=0,start=null,end=null,tag="",out="",cont="";for(this.tabifier.cleanlevel=0;i<codeLength;i++){if(point=i,-1==code.substr(i).indexOf("<"))return out+=code.substr(i),this.tabifier.finish(out);for(;point<codeLength&&"<"!=code.charAt(point);)point++;for(i!=point&&(cont=code.substr(i,point-i),cont.match(/^\s{2,}$/g)||("\n"==out.charAt(out.length-1)?out+=this.tabifier.getTabs():"\n"==cont.charAt(0)&&(out+="\n"+this.tabifier.getTabs(),cont=cont.replace(/^\s+/,"")),out+=cont),cont.match(/\n/)&&(out+="\n"+this.tabifier.getTabs())),start=point;point<codeLength&&">"!=code.charAt(point);)point++;tag=code.substr(start,point-start),i=point;var t;if("!--"==tag.substr(1,3)){if(!tag.match(/--$/)){for(;"-->"!=code.substr(point,3);)point++;point+=2,tag=code.substr(start,point-start),i=point}"\n"!=out.charAt(out.length-1)&&(out+="\n"),out+=this.tabifier.getTabs(),out+=tag+">\n"}else"!"==tag[1]?out=this.tabifier.placeTag(tag+">",out):"?"==tag[1]?out+=tag+">\n":(t=tag.match(/^<(script|style|pre)/i))?(t[1]=t[1].toLowerCase(),tag=this.tabifier.cleanTag(tag),out=this.tabifier.placeTag(tag,out),end=String(code.substr(i+1)).toLowerCase().indexOf("</"+t[1]),end&&(cont=code.substr(i+1,end),i+=end,out+=cont)):(tag=this.tabifier.cleanTag(tag),out=this.tabifier.placeTag(tag,out))}return this.tabifier.finish(out)},getTabs:function(){for(var s="",j=0;j<this.tabifier.cleanlevel;j++)s+="\t";return s},finish:function(code){return code=code.replace(/\n\s*\n/g,"\n"),code=code.replace(/^[\s\n]*/,""),code=code.replace(/[\s\n]*$/,""),code=code.replace(/<script(.*?)>\n<\/script>/gi,"<script$1></script>"),this.tabifier.cleanlevel=0,code},cleanTag:function(tag){var tagout="";tag=tag.replace(/\n/g," "),tag=tag.replace(/\s{2,}/g," "),tag=tag.replace(/^\s+|\s+$/g," ");var suffix="";tag.match(/\/$/)&&(suffix="/",tag=tag.replace(/\/+$/,""));for(var m;m=/\s*([^= ]+)(?:=((['"']).*?\3|[^ ]+))?/.exec(tag);)m[2]?tagout+=m[1].toLowerCase()+"="+m[2]:m[1]&&(tagout+=m[1].toLowerCase()),tagout+=" ",tag=tag.substr(m[0].length);return tagout.replace(/\s*$/,"")+suffix+">"},placeTag:function(tag,out){var nl=tag.match(this.tabifier.newLevel);return(tag.match(this.tabifier.lineBefore)||nl)&&(out=out.replace(/\s*$/,""),out+="\n"),nl&&"/"==tag.charAt(1)&&this.tabifier.cleanlevel--,"\n"==out.charAt(out.length-1)&&(out+=this.tabifier.getTabs()),nl&&"/"!=tag.charAt(1)&&this.tabifier.cleanlevel++,out+=tag,(tag.match(this.tabifier.lineAfter)||tag.match(this.tabifier.newLevel))&&(out=out.replace(/ *$/,"")),out}}},tidy:function(){return{setupAllowed:function(){if(this.opts.allowedTags&&(this.opts.deniedTags=!1),this.opts.allowedAttr&&(this.opts.removeAttr=!1),!this.opts.linebreaks){var tags=["p","section"];this.opts.allowedTags&&this.tidy.addToAllowed(tags),this.opts.deniedTags&&this.tidy.removeFromDenied(tags)}},addToAllowed:function(tags){for(var len=tags.length,i=0;i<len;i++)$.inArray(tags[i],this.opts.allowedTags)==-1&&this.opts.allowedTags.push(tags[i])},removeFromDenied:function(tags){for(var len=tags.length,i=0;i<len;i++){var pos=$.inArray(tags[i],this.opts.deniedTags);pos!=-1&&this.opts.deniedTags.splice(pos,1)}},load:function(html,options){return this.tidy.settings={deniedTags:this.opts.deniedTags,allowedTags:this.opts.allowedTags,removeComments:this.opts.removeComments,replaceTags:this.opts.replaceTags,replaceStyles:this.opts.replaceStyles,removeDataAttr:this.opts.removeDataAttr,removeAttr:this.opts.removeAttr,allowedAttr:this.opts.allowedAttr,removeWithoutAttr:this.opts.removeWithoutAttr,removeEmpty:this.opts.removeEmpty},$.extend(this.tidy.settings,options),html=this.tidy.removeComments(html),this.tidy.$div=$("<div />").append(html),this.tidy.replaceTags(),this.tidy.replaceStyles(),this.tidy.removeTags(),this.tidy.removeAttr(),this.tidy.removeEmpty(),this.tidy.removeParagraphsInLists(),this.tidy.removeDataAttr(),this.tidy.removeWithoutAttr(),html=this.tidy.$div.html(),this.tidy.$div.remove(),html},removeComments:function(html){return this.tidy.settings.removeComments?html.replace(/<!--[\s\S]*?-->/gi,""):html},replaceTags:function(html){if(!this.tidy.settings.replaceTags)return html;for(var len=this.tidy.settings.replaceTags.length,replacement=[],rTags=[],i=0;i<len;i++)rTags.push(this.tidy.settings.replaceTags[i][1]),replacement.push(this.tidy.settings.replaceTags[i][0]);$.each(replacement,$.proxy(function(key,value){this.tidy.$div.find(value).replaceWith(function(){return $("<"+rTags[key]+" />",{html:$(this).html()})})},this))},replaceStyles:function(){if(this.tidy.settings.replaceStyles){var len=this.tidy.settings.replaceStyles.length;this.tidy.$div.find("span").each($.proxy(function(n,s){for(var $el=$(s),style=$el.attr("style"),i=0;i<len;i++)if(style&&style.match(new RegExp("^"+this.tidy.settings.replaceStyles[i][0],"i"))){var tagName=this.tidy.settings.replaceStyles[i][1];$el.replaceWith(function(){var tag=document.createElement(tagName);return $(tag).append($(this).contents())})}},this))}},removeTags:function(){!this.tidy.settings.deniedTags&&this.tidy.settings.allowedTags&&this.tidy.$div.find("*").not(this.tidy.settings.allowedTags.join(",")).each(function(i,s){""===s.innerHTML?$(s).remove():$(s).contents().unwrap()}),this.tidy.settings.deniedTags&&this.tidy.$div.find(this.tidy.settings.deniedTags.join(",")).each(function(i,s){$(s).hasClass("redactor-script-tag")||(""===s.innerHTML?$(s).remove():$(s).contents().unwrap())})},removeAttr:function(){var len;if(!this.tidy.settings.removeAttr&&this.tidy.settings.allowedAttr){var allowedAttrTags=[],allowedAttrData=[];len=this.tidy.settings.allowedAttr.length;for(var i=0;i<len;i++)allowedAttrTags.push(this.tidy.settings.allowedAttr[i][0]),allowedAttrData.push(this.tidy.settings.allowedAttr[i][1]);this.tidy.$div.find("*").each($.proxy(function(n,s){var $el=$(s),pos=$.inArray($el[0].tagName.toLowerCase(),allowedAttrTags),attributesRemove=this.tidy.removeAttrGetRemoves(pos,allowedAttrData,$el);attributesRemove&&$.each(attributesRemove,function(z,f){$el.removeAttr(f)})},this))}if(this.tidy.settings.removeAttr){len=this.tidy.settings.removeAttr.length;for(var i=0;i<len;i++){var attrs=this.tidy.settings.removeAttr[i][1];$.isArray(attrs)&&(attrs=attrs.join(" ")),this.tidy.$div.find(this.tidy.settings.removeAttr[i][0]).removeAttr(attrs)}}},removeAttrGetRemoves:function(pos,allowed,$el){var attributesRemove=[];return pos==-1?$.each($el[0].attributes,function(i,item){attributesRemove.push(item.name)}):"*"==allowed[pos]?attributesRemove=[]:$.each($el[0].attributes,function(i,item){$.isArray(allowed[pos])?$.inArray(item.name,allowed[pos])==-1&&attributesRemove.push(item.name):allowed[pos]!=item.name&&attributesRemove.push(item.name)}),attributesRemove},removeAttrs:function(el,regex){return regex=new RegExp(regex,"g"),el.each(function(){for(var self=$(this),len=this.attributes.length-1,i=len;i>=0;i--){var item=this.attributes[i];item&&item.specified&&item.name.search(regex)>=0&&self.removeAttr(item.name)}})},removeEmpty:function(){this.tidy.settings.removeEmpty&&this.tidy.$div.find(this.tidy.settings.removeEmpty.join(",")).each(function(){var $el=$(this),text=$el.text();text=text.replace(/\u200B/g,""),text=text.replace(/&nbsp;/gi,""),text=text.replace(/\s/g,""),""===text&&0===$el.children().length&&$el.remove()})},removeParagraphsInLists:function(){this.tidy.$div.find("li p").contents().unwrap()},removeDataAttr:function(){if(this.tidy.settings.removeDataAttr){var tags=this.tidy.settings.removeDataAttr;$.isArray(this.tidy.settings.removeDataAttr)&&(tags=this.tidy.settings.removeDataAttr.join(",")),this.tidy.removeAttrs(this.tidy.$div.find(tags),"^(data-)")}},removeWithoutAttr:function(){this.tidy.settings.removeWithoutAttr&&this.tidy.$div.find(this.tidy.settings.removeWithoutAttr.join(",")).each(function(){0===this.attributes.length&&$(this).contents().unwrap()})}}},toolbar:function(){return{init:function(){return{html:{title:this.lang.get("html"),func:"code.toggle"},formatting:{title:this.lang.get("formatting"),dropdown:{p:{title:this.lang.get("paragraph"),func:"block.format"},blockquote:{title:this.lang.get("quote"),func:"block.format"},pre:{title:this.lang.get("code"),func:"block.format"},h1:{title:this.lang.get("header1"),func:"block.format"},h2:{title:this.lang.get("header2"),func:"block.format"},h3:{title:this.lang.get("header3"),func:"block.format"},h4:{title:this.lang.get("header4"),func:"block.format"},h5:{title:this.lang.get("header5"),func:"block.format"}}},bold:{title:this.lang.get("bold"),func:"inline.format"},italic:{title:this.lang.get("italic"),func:"inline.format"},deleted:{title:this.lang.get("deleted"),func:"inline.format"},underline:{title:this.lang.get("underline"),func:"inline.format"},unorderedlist:{title:"&bull; "+this.lang.get("unorderedlist"),func:"list.toggle"},orderedlist:{title:"1. "+this.lang.get("orderedlist"),func:"list.toggle"},outdent:{title:"< "+this.lang.get("outdent"),func:"indent.decrease"},indent:{title:"> "+this.lang.get("indent"),func:"indent.increase"},image:{title:this.lang.get("image"),func:"image.show"},file:{title:this.lang.get("file"),func:"file.show"},link:{title:this.lang.get("link"),dropdown:{link:{title:this.lang.get("link_insert"),func:"link.show",observe:{element:"a",in:{title:this.lang.get("link_edit")},out:{title:this.lang.get("link_insert")}}},unlink:{title:this.lang.get("unlink"),func:"link.unlink",observe:{element:"a",out:{attr:{class:"redactor-dropdown-link-inactive","aria-disabled":!0}}}}}},alignment:{title:this.lang.get("alignment"),dropdown:{left:{title:this.lang.get("align_left"),func:"alignment.left"},center:{title:this.lang.get("align_center"),func:"alignment.center"},right:{title:this.lang.get("align_right"),func:"alignment.right"},justify:{title:this.lang.get("align_justify"),func:"alignment.justify"}}},horizontalrule:{title:this.lang.get("horizontalrule"),func:"line.insert"}}},build:function(){this.toolbar.hideButtons(),this.toolbar.hideButtonsOnMobile(),this.toolbar.isButtonSourceNeeded(),0!==this.opts.buttons.length&&(this.$toolbar=this.toolbar.createContainer(),this.toolbar.setOverflow(),this.toolbar.append(),this.toolbar.setFormattingTags(),this.toolbar.loadButtons(),this.toolbar.setFixed(),this.opts.activeButtons&&this.$editor.on("mouseup.redactor keyup.redactor focus.redactor",$.proxy(this.observe.toolbar,this)))},createContainer:function(){return $("<ul>").addClass("redactor-toolbar").attr({id:"redactor-toolbar-"+this.uuid,role:"toolbar"})},setFormattingTags:function(){$.each(this.opts.toolbar.formatting.dropdown,$.proxy(function(i,s){$.inArray(i,this.opts.formatting)==-1&&delete this.opts.toolbar.formatting.dropdown[i]},this))},loadButtons:function(){$.each(this.opts.buttons,$.proxy(function(i,btnName){if(this.opts.toolbar[btnName]){if("file"===btnName){if(this.opts.fileUpload===!1)return;if(!this.opts.fileUpload&&this.opts.s3===!1)return}if("image"===btnName){if(this.opts.imageUpload===!1)return;if(!this.opts.imageUpload&&this.opts.s3===!1)return}var btnObject=this.opts.toolbar[btnName];this.$toolbar.append($("<li>").append(this.button.build(btnName,btnObject)))}},this))},append:function(){this.opts.toolbarExternal?(this.$toolbar.addClass("redactor-toolbar-external"),$(this.opts.toolbarExternal).html(this.$toolbar)):this.$box.prepend(this.$toolbar)},setFixed:function(){this.utils.isDesktop()&&(this.opts.toolbarExternal||this.opts.toolbarFixed&&(this.toolbar.observeScroll(),$(this.opts.toolbarFixedTarget).on("scroll.redactor."+this.uuid,$.proxy(this.toolbar.observeScroll,this))))},setOverflow:function(){this.utils.isMobile()&&this.opts.toolbarOverflow&&this.$toolbar.addClass("redactor-toolbar-overflow")},isButtonSourceNeeded:function(){if(!this.opts.source){var index=this.opts.buttons.indexOf("html");index!==-1&&this.opts.buttons.splice(index,1)}},hideButtons:function(){0!==this.opts.buttonsHide.length&&$.each(this.opts.buttonsHide,$.proxy(function(i,s){var index=this.opts.buttons.indexOf(s);this.opts.buttons.splice(index,1)},this))},hideButtonsOnMobile:function(){this.utils.isMobile()&&0!==this.opts.buttonsHideOnMobile.length&&$.each(this.opts.buttonsHideOnMobile,$.proxy(function(i,s){var index=this.opts.buttons.indexOf(s);this.opts.buttons.splice(index,1)},this))},observeScroll:function(){var scrollTop=$(this.opts.toolbarFixedTarget).scrollTop(),boxTop=1;this.opts.toolbarFixedTarget===document&&(boxTop=this.$box.offset().top),scrollTop>boxTop?this.toolbar.observeScrollEnable(scrollTop,boxTop):this.toolbar.observeScrollDisable()},observeScrollEnable:function(scrollTop,boxTop){var top=this.opts.toolbarFixedTopOffset+scrollTop-boxTop,left=0,end=boxTop+this.$box.height()-32,width=this.$box.innerWidth();this.$toolbar.addClass("toolbar-fixed-box"),this.$toolbar.css({position:"absolute",width:width,top:top+"px",left:left}),scrollTop>end&&$(".redactor-dropdown-"+this.uuid+":visible").hide(),this.toolbar.setDropdownsFixed(),this.$toolbar.css("visibility",scrollTop<end?"visible":"hidden")},observeScrollDisable:function(){this.$toolbar.css({position:"relative",width:"auto",top:0,left:0,visibility:"visible"}),this.toolbar.unsetDropdownsFixed(),this.$toolbar.removeClass("toolbar-fixed-box")},setDropdownsFixed:function(){var top=this.$toolbar.innerHeight()+this.opts.toolbarFixedTopOffset,position="fixed";this.opts.toolbarFixedTarget!==document&&(top=this.$toolbar.innerHeight()+this.$toolbar.offset().top+this.opts.toolbarFixedTopOffset,position="absolute"),$(".redactor-dropdown-"+this.uuid).each(function(){$(this).css({position:position,top:top+"px"})})},unsetDropdownsFixed:function(){var top=this.$toolbar.innerHeight()+this.$toolbar.offset().top;$(".redactor-dropdown-"+this.uuid).each(function(){$(this).css({position:"absolute",top:top+"px"})})}}},upload:function(){return{init:function(id,url,callback){this.upload.direct=!1,this.upload.callback=callback,this.upload.url=url,this.upload.$el=$(id),this.upload.$droparea=$('<div id="redactor-droparea" />'),this.upload.$placeholdler=$('<div id="redactor-droparea-placeholder" />').text(this.lang.get("upload_label")),this.upload.$input=$('<input type="file" name="file" />'),this.upload.$placeholdler.append(this.upload.$input),this.upload.$droparea.append(this.upload.$placeholdler),this.upload.$el.append(this.upload.$droparea),this.upload.$droparea.off("redactor.upload"),this.upload.$input.off("redactor.upload"),this.upload.$droparea.on("dragover.redactor.upload",$.proxy(this.upload.onDrag,this)),this.upload.$droparea.on("dragleave.redactor.upload",$.proxy(this.upload.onDragLeave,this)),this.upload.$input.on("change.redactor.upload",$.proxy(function(e){e=e.originalEvent||e,this.upload.traverseFile(this.upload.$input[0].files[0],e)},this)),this.upload.$droparea.on("drop.redactor.upload",$.proxy(function(e){e.preventDefault(),this.upload.$droparea.removeClass("drag-hover").addClass("drag-drop"),this.upload.onDrop(e)},this))},directUpload:function(file,e){this.upload.direct=!0,this.upload.traverseFile(file,e)},onDrop:function(e){e=e.originalEvent||e;var files=e.dataTransfer.files;this.upload.traverseFile(files[0],e)},traverseFile:function(file,e){if(this.opts.s3)return this.upload.setConfig(file),void this.upload.s3uploadFile(file);var formData=window.FormData?new FormData:null;if(window.FormData){this.upload.setConfig(file);var name="image"==this.upload.type?this.opts.imageUploadParam:this.opts.fileUploadParam;formData.append(name,file)}this.progress.show(),this.core.setCallback("uploadStart",e,formData),this.upload.sendData(formData,e)},setConfig:function(file){this.upload.getType(file),this.upload.direct&&(this.upload.url="image"==this.upload.type?this.opts.imageUpload:this.opts.fileUpload,this.upload.callback="image"==this.upload.type?this.image.insert:this.file.insert)},getType:function(file){this.upload.type="image",this.opts.imageTypes.indexOf(file.type)==-1&&(this.upload.type="file")},getHiddenFields:function(obj,fd){return obj===!1||"object"!=typeof obj?fd:($.each(obj,$.proxy(function(k,v){null!==v&&0===v.toString().indexOf("#")&&(v=$(v).val()),fd.append(k,v)},this)),fd)},sendData:function(formData,e){"image"==this.upload.type?(formData=this.upload.getHiddenFields(this.opts.uploadImageFields,formData),formData=this.upload.getHiddenFields(this.upload.imageFields,formData)):(formData=this.upload.getHiddenFields(this.opts.uploadFileFields,formData),formData=this.upload.getHiddenFields(this.upload.fileFields,formData));var xhr=new XMLHttpRequest;xhr.open("POST",this.upload.url),xhr.setRequestHeader("X-Requested-With","XMLHttpRequest"),xhr.onreadystatechange=$.proxy(function(){if(4==xhr.readyState){var data=xhr.responseText;data=data.replace(/^\[/,""),data=data.replace(/\]$/,"");var json;try{json="string"==typeof data?$.parseJSON(data):data}catch(err){json={error:!0}}this.progress.hide(),this.upload.direct||this.upload.$droparea.removeClass("drag-drop"),this.upload.callback(json,this.upload.direct,e)}},this),xhr.send(formData)},onDrag:function(e){e.preventDefault(),this.upload.$droparea.addClass("drag-hover")},onDragLeave:function(e){e.preventDefault(),this.upload.$droparea.removeClass("drag-hover")},clearImageFields:function(){this.upload.imageFields={}},addImageFields:function(name,value){this.upload.imageFields[name]=value},removeImageFields:function(name){delete this.upload.imageFields[name]},clearFileFields:function(){this.upload.fileFields={}},addFileFields:function(name,value){this.upload.fileFields[name]=value},removeFileFields:function(name){delete this.upload.fileFields[name]},s3uploadFile:function(file){this.upload.s3executeOnSignedUrl(file,$.proxy(function(signedURL){this.upload.s3uploadToS3(file,signedURL);
},this))},s3executeOnSignedUrl:function(file,callback){var xhr=new XMLHttpRequest,mark="?";"-1"!=this.opts.s3.search(/\?/)&&(mark="&"),xhr.open("GET",this.opts.s3+mark+"name="+file.name+"&type="+file.type,!0),xhr.overrideMimeType&&xhr.overrideMimeType("text/plain; charset=x-user-defined");var that=this;xhr.onreadystatechange=function(e){4==this.readyState&&200==this.status?(that.progress.show(),callback(decodeURIComponent(this.responseText))):4==this.readyState&&200!=this.status},xhr.send()},s3createCORSRequest:function(method,url){var xhr=new XMLHttpRequest;return"withCredentials"in xhr?xhr.open(method,url,!0):"undefined"!=typeof XDomainRequest?(xhr=new XDomainRequest,xhr.open(method,url)):xhr=null,xhr},s3uploadToS3:function(file,url){var xhr=this.upload.s3createCORSRequest("PUT",url);xhr&&(xhr.onload=$.proxy(function(){if(200==xhr.status){this.progress.hide();var s3file=url.split("?");if(!s3file[0])return!1;this.upload.direct||this.upload.$droparea.removeClass("drag-drop");var json={filelink:s3file[0]};if("file"==this.upload.type){var arr=s3file[0].split("/");json.filename=arr[arr.length-1]}this.upload.callback(json,this.upload.direct,!1)}},this),xhr.onerror=function(){},xhr.upload.onprogress=function(e){},xhr.setRequestHeader("Content-Type",file.type),xhr.setRequestHeader("x-amz-acl","public-read"),xhr.send(file))}}},utils:function(){return{isMobile:function(){return/(iPhone|iPod|BlackBerry|Android)/.test(navigator.userAgent)},isDesktop:function(){return!/(iPhone|iPod|iPad|BlackBerry|Android)/.test(navigator.userAgent)},isString:function(obj){return"[object String]"==Object.prototype.toString.call(obj)},isEmpty:function(html,removeEmptyTags){return html=html.replace(/[\u200B-\u200D\uFEFF]/g,""),html=html.replace(/&nbsp;/gi,""),html=html.replace(/<\/?br\s?\/?>/g,""),html=html.replace(/\s/g,""),html=html.replace(/^<p>[^\W\w\D\d]*?<\/p>$/i,""),html=html.replace(/<iframe(.*?[^>])>$/i,"iframe"),html=html.replace(/<source(.*?[^>])>$/i,"source"),removeEmptyTags!==!1&&(html=html.replace(/<[^\/>][^>]*><\/[^>]+>/gi,""),html=html.replace(/<[^\/>][^>]*><\/[^>]+>/gi,"")),html=$.trim(html),""===html},normalize:function(str){return"undefined"==typeof str?0:parseInt(str.replace("px",""),10)},hexToRgb:function(hex){if("undefined"!=typeof hex){if(hex.search(/^#/)==-1)return hex;var shorthandRegex=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;hex=hex.replace(shorthandRegex,function(m,r,g,b){return r+r+g+g+b+b});var result=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);return"rgb("+parseInt(result[1],16)+", "+parseInt(result[2],16)+", "+parseInt(result[3],16)+")"}},getOuterHtml:function(el){return $("<div>").append($(el).eq(0).clone()).html()},getAlignmentElement:function(el){return $.inArray(el.tagName,this.opts.alignmentTags)!==-1?$(el):$(el).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0])},removeEmptyAttr:function(el,attr){var $el=$(el);return"undefined"==typeof $el.attr(attr)||""===$el.attr(attr)&&($el.removeAttr(attr),!0)},removeEmpty:function(i,s){var $s=$($.parseHTML(s));if($s.find(".redactor-invisible-space").removeAttr("style").removeAttr("class"),0===$s.find("hr, br, img, iframe, source").length){var text=$.trim($s.text());this.utils.isEmpty(text,!1)&&$s.remove()}},saveScroll:function(){this.saveEditorScroll=this.$editor.scrollTop(),this.saveBodyScroll=$(window).scrollTop(),this.opts.scrollTarget&&(this.saveTargetScroll=$(this.opts.scrollTarget).scrollTop())},restoreScroll:function(){"undefined"==typeof this.saveScroll&&"undefined"==typeof this.saveBodyScroll||($(window).scrollTop(this.saveBodyScroll),this.$editor.scrollTop(this.saveEditorScroll),this.opts.scrollTarget&&$(this.opts.scrollTarget).scrollTop(this.saveTargetScroll))},createSpaceElement:function(){var space=document.createElement("span");return space.className="redactor-invisible-space",space.innerHTML=this.opts.invisibleSpace,space},removeInlineTags:function(node){var tags=this.opts.inlineTags;tags.push("span"),"PRE"==node.tagName&&tags.push("a"),$(node).find(tags.join(",")).not("span.redactor-selection-marker").contents().unwrap()},replaceWithContents:function(node,removeInlineTags){var self=this;return $(node).replaceWith(function(){return removeInlineTags===!0&&self.utils.removeInlineTags(this),$(this).contents()}),$(node)},replaceToTag:function(node,tag,removeInlineTags){var replacement,self=this;return $(node).replaceWith(function(){replacement=$("<"+tag+" />").append($(this).contents());for(var i=0;i<this.attributes.length;i++)replacement.attr(this.attributes[i].name,this.attributes[i].value);return removeInlineTags===!0&&self.utils.removeInlineTags(replacement),replacement}),replacement},isStartOfElement:function(){var block=this.selection.getBlock();if(!block)return!1;var offset=this.caret.getOffsetOfElement(block);return 0===offset},isEndOfElement:function(element){if("undefined"==typeof element){var element=this.selection.getBlock();if(!element)return!1}var offset=this.caret.getOffsetOfElement(element),text=$.trim($(element).text()).replace(/\n\r\n/g,"");return offset==text.length},isEndOfEditor:function(){var block=this.$editor[0],offset=this.caret.getOffsetOfElement(block),text=$.trim($(block).html().replace(/(<([^>]+)>)/gi,""));return offset==text.length},isBlock:function(block){return block=block[0]||block,block&&this.utils.isBlockTag(block.tagName)},isBlockTag:function(tag){return"undefined"!=typeof tag&&this.reIsBlock.test(tag)},isTag:function(current,tag){var element=$(current).closest(tag,this.$editor[0]);return 1==element.length&&element[0]},isSelectAll:function(){return this.selectAll},enableSelectAll:function(){this.selectAll=!0},disableSelectAll:function(){this.selectAll=!1},isRedactorParent:function(el){return!!el&&(0===$(el).parents("#image-edit-bar").length&&(0!==$(el).parents(".redactor-editor").length&&!$(el).hasClass("redactor-editor")&&el))},isCurrentOrParentHeader:function(){return this.utils.isCurrentOrParent(["H1","H2","H3","H4","H5","H6"])},isCurrentOrParent:function(tagName){var parent=this.selection.getParent(),current=this.selection.getCurrent();if($.isArray(tagName)){var matched=0;return $.each(tagName,$.proxy(function(i,s){this.utils.isCurrentOrParentOne(current,parent,s)&&matched++},this)),0!==matched}return this.utils.isCurrentOrParentOne(current,parent,tagName)},isCurrentOrParentOne:function(current,parent,tagName){return tagName=tagName.toUpperCase(),parent&&parent.tagName===tagName?parent:!(!current||current.tagName!==tagName)&&current},isOldIe:function(){return!!(this.utils.browser("msie")&&parseInt(this.utils.browser("version"),10)<9)},isLessIe10:function(){return!!(this.utils.browser("msie")&&parseInt(this.utils.browser("version"),10)<10)},isIe11:function(){return!!navigator.userAgent.match(/Trident\/7\./)},browser:function(browser){var ua=navigator.userAgent.toLowerCase(),match=/(opr)[\/]([\w.]+)/.exec(ua)||/(chrome)[ \/]([\w.]+)/.exec(ua)||/(webkit)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec(ua)||/(webkit)[ \/]([\w.]+)/.exec(ua)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(ua)||/(msie) ([\w.]+)/.exec(ua)||ua.indexOf("trident")>=0&&/(rv)(?::| )([\w.]+)/.exec(ua)||ua.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(ua)||[];return"safari"==browser?"undefined"!=typeof match[3]&&"safari"==match[3]:"version"==browser?match[2]:"webkit"==browser?"chrome"==match[1]||"opr"==match[1]||"webkit"==match[1]:"rv"==match[1]?"msie"==browser:"opr"==match[1]?"webkit"==browser:browser==match[1]},strpos:function(haystack,needle,offset){var i=haystack.indexOf(needle,offset);return i>=0&&i},disableBodyScroll:function(){var $body=$("html"),windowWidth=window.innerWidth;if(!windowWidth){var documentElementRect=document.documentElement.getBoundingClientRect();windowWidth=documentElementRect.right-Math.abs(documentElementRect.left)}var isOverflowing=document.body.clientWidth<windowWidth,scrollbarWidth=this.utils.measureScrollbar();$body.css("overflow","hidden"),isOverflowing&&$body.css("padding-right",scrollbarWidth)},measureScrollbar:function(){var $body=$("body"),scrollDiv=document.createElement("div");scrollDiv.className="redactor-scrollbar-measure",$body.append(scrollDiv);var scrollbarWidth=scrollDiv.offsetWidth-scrollDiv.clientWidth;return $body[0].removeChild(scrollDiv),scrollbarWidth},enableBodyScroll:function(){$("html").css({overflow:"","padding-right":""}),$("body").remove("redactor-scrollbar-measure")}}}},$(window).on("load.tools.redactor",function(){$('[data-tools="redactor"]').dnnRedactor()}),Redactor.prototype.init.prototype=Redactor.prototype}(jQuery);