if(!RedactorPlugins)var RedactorPlugins={};var isCustomImage=!1;RedactorPlugins.dnnImageUpload=function(){function supportAjaxUpload(){var xhr=new XMLHttpRequest;return!!(xhr&&"upload"in xhr&&"onprogress"in xhr.upload)}function browserSupportsDragDrop(){return"draggable"in document.createElement("span")}return{FAKE_PROGRESS_TIME:5e3,init:function(){var button=this.button.add("dnnImageUpload","Insert image");this.button.addCallback(button,this.dnnImageUpload.dnnImageShow)},dnnImageEditText:function(){var dnnInsertImage;return this.opts.curLang.exceedLimit=this.opts.curLang.exceedLimit.replace("{0}",this.opts.maxFileSize/1048576),dnnInsertImage='<section id="redactor-modal-image-insert"><div id="redactor-tabs"><a href="#" id="redactor-tab-control-1" class="redactor-tabs-act leftside"><span>'+this.opts.curLang.uploadFile+'</span></a><a href="#" id="redactor-tab-control-2"><span>'+this.opts.curLang.storedLocation+'</span></a><a href="#" id="redactor-tab-control-3" class="rightside"><span>'+this.opts.curLang.fromUrl+'</span></a></div><form id="redactorInsertImageForm" method="post" action="" enctype="multipart/form-data"><div id="redactor-tab1" class="redactor-tab"><div class="redactor-droparea"><div class="redactor-dropareabox draggableUiElement">'+this.opts.curLang.dragDropText+'</div><div class="redactor-drag-drop-text draggableUiElement">'+this.opts.curLang.dragDropText+'</div><div class="redactor-or-text draggableUiElement">'+this.opts.curLang.orText+'</div><div class="redactor-browse-to-upload"><span>'+this.opts.curLang.browseToUploadText+'</span></div></div><div class="redactor-dropalternative draggableUiElement">'+this.opts.curLang.or_choose+'</div><input type="file" id="redactor-file" name="'+this.opts.imageUploadParam+'" /></div><div id="redactor-tab2" class="redactor-tab" style="display: none;"><div class="redactor-content" style="display:none;"><div class="redactor-search"><input type="text" name="redactor-search-file" id="redactor-search-file" class="redactor-input" placeholder="Search"></div></div><div id="redactor-image-box"></div></div></form><div id="redactor-tab3" class="redactor-tab redactor-tab-url" style="display: none;"><div class="link-form"><label>'+this.opts.curLang.enterResourceUrl+'</label><input type="text" name="redactor-file-link" id="redactor-file-link" class="redactor-input"  /></div><div class="preview-main"><div class="preview-img"><img /></div><div class="preview-name"></div></div></div><div id="redactor-modal-image-upload-status"><div class="upload-status-container"><div class="upload-status-caption">'+this.opts.curLang.uploadStatusTitle+'</div><div class="upload-status-main"><div class="upload-status-preview"><img /></div><div class="upload-status-name"></div><div class="upload-status-progress"><div class="bar"><span /></div><span class="btn-cancel" /></div><div class="upload-status-message"></div></div></div></div></section><footer><button class="redactor-modal-btn redactor-modal-close-btn">'+this.opts.curLang.cancel+'</button><button class="redactor-modal-btn redactor-modal-action-btn redactor-upload-btn-1 redactor-img-btn" id="redactor-upload-btn1" disabled="disabled">'+this.opts.curLang.insertImage+'</button><button class="redactor-modal-btn redactor-modal-action-btn redactor-upload-btn-2 redactor-img-btn" id="redactor-upload-btn2" disabled="disabled">'+this.opts.curLang.insertImage+'</button><button class="redactor-modal-btn redactor-modal-action-btn redactor-upload-btn-3 redactor-img-btn" id="redactor-upload-btn" disabled="disabled">'+this.opts.curLang.insertImage+"</button></footer>"},dnnImageShow:function(){this.selection.save();var callback=$.proxy(function(){var context=this;if(this.opts.imageGetJson){"undefined"!=typeof redactorDropDownOptions&&(redactorDropDownOptions.onSelectionChangedBackScript=function(){var folderId=context._folderPicker.selectedItem().key;context.dnnImageUpload.dnnLoadImages($("#redactor-search-file").val(),folderId)},redactorDropDownOptions.itemList.containerCss="dt-container redactor-box",this._folderPicker=new dnn.DropDownList(null,redactorDropDownOptions),$("form#redactorInsertImageForm #redactor-image-box").before(this._folderPicker.$element),this._folderPicker.$element.wrapAll('<div id="dnnRedactor-select" />'));var searchKeyChangedHandler;$("#redactor-search-file").keyup(function(){searchKeyChangedHandler&&clearTimeout(searchKeyChangedHandler),searchKeyChangedHandler=setTimeout(function(){var folderId=-1;"undefined"!=typeof context._folderPicker&&(folderId=context._folderPicker.selectedItem().key),context.dnnImageUpload.dnnLoadImages($("#redactor-search-file").val(),folderId)},500)}),$(".redactor-upload-btn-2").on("click",function(){var $selectedImg=$(".redactor-thumb-wrapper.checked img").eq(0);if($selectedImg.length>0){var loadImg='<p><img src="'+$selectedImg.attr("src")+'" alt="'+$selectedImg.attr("title")+'" title="'+$selectedImg.attr("title")+'" style="max-width: 100%;" /></p>';context.dnnImageUpload.dnnImageInsert(loadImg,!0)}}),this.dnnImageUpload.dnnLoadImages("",-1),"undefined"==typeof redactorDropDownOptions&&$("#redactor-tab2 .redactor-search").hide()}else $("#redactor-modal-tab-2").remove();this.opts.imageUpload||this.opts.s3?this.opts.s3===!1?this.dnnImageUpload.dnnUploadInit({auto:!0,url:this.opts.imageUpload,success:$.proxy(this.dnnImageUpload.dnnImageCallback,this),error:$.proxy(function(obj,json){this.callback("imageUploadError",json)},this)}):$("#redactor-file").on("change.redactor",$.proxy(this.s3handleFileSelect,this)):($(".redactor-tab").hide(),this.opts.imageGetJson?($("#redactor-tab-control-1").remove(),$("#redactor-tab-control-2").addClass("redactor-tabs-act leftside"),$(".redactor-modal-action-btn").hide().eq(1).show(),$("#redactor-tab2").show()):($("#redactor-tabs").remove(),$("#redactor-tab3").show(),$(".redactor-modal-action-btn").hide().eq(2).show())),$("#redactor-upload-btn").click($.proxy(this.dnnImageUpload.dnnImageCallbackLink,this)),this.opts.imageUpload||this.opts.imageGetJson||setTimeout(function(){$("#redactor-file-link").focus()},200),$("#redactor-file-link").on("propertychange change click keyup input paste",function(e){$(this).data("oldvar")&&$(this).data("oldvar")==$(this).val()||(context._previewFromUrlHandler&&clearTimeout(context._previewFromUrlHandler),context._previewFromUrlHandler=setTimeout($.proxy(context.dnnImageUpload.dnnPreviewFromUrl,context.dnnImageUpload),500))}),$("#redactor-modal").addClass("redactor-blockBlur")},this);this.dnnImageUpload.dnnModalInit(this.opts.curLang.image,this.dnnImageUpload.dnnImageEditText(),590,callback)},dnnLoadImages:function(keyword,folderId,callback){var context=this,loadRecent=!1;"-1"==folderId&&(""!==this.dnnImageUpload.dnnGetUploadPath()&&(folderId=this.dnnImageUpload.dnnGetUploadPath()),loadRecent=!0);var permission="undefined"!=typeof redactorDropDownOptions?redactorDropDownOptions.services.parameters.permission:"";$.getJSON(this.opts.imageGetJson,{keyword:keyword,folderId:folderId,loadRecent:loadRecent,permission:permission},function(data){$("form#redactorInsertImageForm #redactor-image-box").empty(),$(".redactor-upload-btn-2").prop("disabled",!0),$.each(data,function(key,val){if("switch"==val.type){var item={key:val.id.toString(),value:val.title};context._folderPicker.selectedItem(item)}else{var thumbtitle="";"undefined"!=typeof val.title&&(thumbtitle=val.title);var img=$('<span class="redactor-thumb-wrapper"><span class="redactor-thumb-holder"><img src="'+val.thumb+'" class="redactorfolder" rel="'+val.image+'" title="'+thumbtitle+'" /><span class="active-state"></span></span><p>'+thumbtitle.substring(0,20)+"</p></span>");$("form#redactorInsertImageForm #redactor-image-box").append(img),"undefined"==typeof val.type||"file"==val.type?$(img).click(function(){$(".redactor-thumb-wrapper").removeClass("checked"),$(this).addClass("checked"),$(".redactor-upload-btn-2").prop("disabled",!1)}):"folder"==val.type&&$(img).dblclick(function(e){var item={key:val.id.toString(),value:val.title};"undefined"!=typeof context._folderPicker&&(context._folderPicker.selectedItem(item),dnn.setVar(context._folderPicker.id()+"_expandPath",val.path),context.dnnImageUpload.dnnLoadImages($("#redactor-search-file").val(),val.id)),e.preventDefault()})}}),"function"==typeof callback&&callback.call(context)})},dnnImageThumbClick:function(e){var img='<img id="image-marker" src="'+$(e.target).attr("rel")+'" alt="'+$(e.target).attr("title")+'" />',parent=this.getParent();this.opts.paragraphy&&0===$(parent).closest("li").size()&&(img="<p>"+img+"</p>"),this.dnnImageUpload.dnnImageInsert(img,!0)},dnnImageCallbackLink:function(){var val=$("#redactor-file-link").val();if(""!==val){var data='<img id="image-marker" src="'+val+'" />';this.opts.linebreaks===!1&&(data="<p>"+data+"</p>"),this.dnnImageUpload.dnnImageInsert(data,!0)}else this.dnnImageUpload.modalClose()},dnnImageCallback:function(data){this.dnnImageUpload.dnnImageInsert(data)},dnnImageInsert:function(json,link){var html;if(!this._isworking){if(this._isworking=!0,json.hasOwnProperty("message"))return html="<p>"+json.message+"</p>",this.insert.node($(html)),this.code.sync(),void this.dnnImageUpload.dnnModalClose();if(this.selection.restore(),json!==!1){if(link!==!0){if(html='<img id="image-marker" src="'+json.filelink+'" />',this.getParent){var parent=this.getParent();this.opts.paragraphy&&0===$(parent).closest("li").size()&&(html="<p>"+html+"</p>")}}else html=json;this.insert.node($(html));var image=$(this.$editor.find("img#image-marker"));image.length?image.removeAttr("id").css("max-width","100%"):image=!1,this.code.sync(),link!==!0&&this.core.setCallback("imageUpload",image,json)}this.dnnImageUpload.dnnModalClose(),this.observe.images(),this._isworking=!1}},dnnPreviewFromUrl:function(){var redactorModalInner,fakeloader,progress,$urlElement=$("#redactor-file-link"),url=$urlElement.val(),$insertButton=$("#redactor-upload-btn"),$previewArea=$("#redactor-tab3 .preview-main"),$previewImg=$previewArea.find("img"),$previewName=$previewArea.find(".preview-name");return $urlElement.data("oldvar",url),""===url?($insertButton.prop("disabled","disabled"),void $previewArea.hide()):($previewImg.data("loadEventBinded")||(redactorModalInner=$("#redactor-modal-body"),redactorModalInner.prepend('<div class="fakeloader"><div class="progress"></div><div>'),fakeloader=redactorModalInner.find(".fakeloader:first"),progress=fakeloader.find(".progress:first"),progress.animate({width:"98%"},this.dnnImageUpload.FAKE_PROGRESS_TIME),$previewImg.on("load",function(){$previewArea.show(),$urlElement.removeClass("error");var name=$previewImg.attr("src").replace("\\","/").split("/").pop().split("?")[0];$previewName.html(name),$insertButton.prop("disabled",""),progress.stop(!0,!0).css("width","100%"),fakeloader.fadeOut()}).on("error",function(){$previewArea.hide(),$urlElement.addClass("error"),$insertButton.prop("disabled","disabled"),progress.stop(!0,!0).css("width","100%"),fakeloader.fadeOut()}),$previewImg.data("loadEventBinded",!0)),void $previewImg.attr("src",url))},imageInsert:function(json,link){if(this.selection.restore(),json!==!1){var html="";if(link!==!0){html='<img id="image-marker" src="'+json.filelink+'" />';var parent=this.getParent();this.opts.paragraphy&&0===$(parent).closest("li").size()&&(html="<p>"+html+"</p>")}else html=json;this.execCommand("inserthtml",html,!1);var image=$(this.$editor.find("img#image-marker"));image.length?image.removeAttr("id"):image=!1,this.code.sync(),link!==!0&&this.callback("imageUpload",image,json)}this.dnnImageUpload.dnnModalClose(),this.observe.images()},dnnModalInit:function(title,content,width,callback){return isCustomImage=!0,this.modal.buildOverlay(),this.$redactorModal=$("#redactor-modal"),$("#redactor-modal-close").on("click",$.proxy(this.dnnImageUpload.dnnModalClose,this)),$(document).keyup($.proxy(this.dnnModalCloseHandler,this)),this.$editor.keyup($.proxy(this.dnnModalCloseHandler,this)),this.modal.addTemplate("dnnImageUpload",content),this.modal.build(),this.modal.setDraggable(),this.modal.load("dnnImageUpload",title,width),this.modal.setButtonsWidth(width),this.dnnImageUpload.dnnModalLoadTabs(),this.saveModalScroll=document.body.scrollTop,this.opts.autoresize===!1&&(this.saveModalScroll=this.$editor.scrollTop()),this.modal.show(),"function"==typeof callback&&callback(),setTimeout($.proxy(function(){this.core.setCallback("modalOpened",this.modal.templateName,this.$modal)},this),11),$(document).off("focusin.modal"),window.jQuery&&window.jQuery.ui.dialog&&$(document).unbind("focusin"),this.$redactorModal.find("input[type=text]").on("keypress",$.proxy(function(e){13===e.which&&(this.$redactorModal.find(".redactor-modal-action-btn").click(),e.preventDefault())},this)),this.$redactorModal},dnnModalCloseHandler:function(e){if(e.keyCode===this.keyCode.ESC)return this.modal.close(),isCustomImage=!1,!1},dnnModalClose:function(){return this.xhr&&(this.xhr.abort(),this.dnnImageUpload.dnnUploadAsyncAborted()),$("#redactor-modal-close").off("click",this.dnnImageUpload.dnnModalClose),$("#redactor-modal").fadeOut("fast",$.proxy(function(){$(document).unbind("keyup",this.hdlModalClose),this.$editor.unbind("keyup",this.hdlModalClose),isCustomImage=!1,this.selection.restore(),this.modal.close(),this.opts.autoresize&&this.saveModalScroll?$(document.body).scrollTop(this.saveModalScroll):this.opts.autoresize===!1&&this.saveModalScroll&&this.$editor.scrollTop(this.saveModalScroll),this.core.setCallback("modalClosed",this.modal.templateName,this.$modal)},this)),this.utils.isMobile()===!1&&$(document.body).css("overflow",this.modalSaveBodyOveflow?this.modalSaveBodyOveflow:"visible"),!1},dnnModalLoadTabs:function(){var $redactor_tabs=$("#redactor-tabs");if(!$redactor_tabs.length)return!1;var that=this;$redactor_tabs.find("> a").each(function(i,s){i++,$(s).on("click",function(e){if(e.preventDefault(),$(".redactor-modal-action-btn").hide(),$(".redactor-upload-btn-"+i).show(),$redactor_tabs.find("a").removeClass("redactor-tabs-act"),$(this).addClass("redactor-tabs-act"),$(".redactor-tab").hide(),$("#redactor-tab"+i).show(),$("#redactor-tab-selected").val(i),that.utils.isMobile()===!1){var height=that.$redactorModal.outerHeight();that.$redactorModal.css("margin-top","-"+(height+10)/2+"px")}})}),$(".redactor-upload-btn-1").show()},dnnUploadInit:function(options){this.dnnUploadOptions={url:!1,success:!1,error:!1,start:!1,trigger:!1,auto:!1,input:!1},$.extend(this.dnnUploadOptions,options);var self=this,wrapper=$("#redactor-tab1"),uploader=wrapper.find("#redactor-file");uploader.fileupload({url:options.url,beforeSend:null,replaceFileInput:!1,dropZone:wrapper.find(".redactor-droparea"),submit:function(e,d){var $status,file=d.files[0],fileName=file.name,extension=fileName.split(".").pop().toLowerCase();return self.dnnImageUpload.showUploadStatus(file),"jpg|jpe|bmp|gif|png|jpeg|ico".indexOf(extension)==-1?($status=$("#redactor-modal-image-upload-status"),self.dnnImageUpload.dnnUploadAsyncFailed.call(self,self.opts.curLang.invalidFileMessage),$status.find("img").attr("src",""),!1):file.size>self.opts.maxFileSize?($status=$("#redactor-modal-image-upload-status"),self.dnnImageUpload.dnnUploadAsyncFailed.call(self,self.opts.curLang.exceedLimit),$status.find("img").attr("src",""),!1):(d.formData||(d.formData={}),!0)},done:function(e,d){var result=supportAjaxUpload()?d.result:$("pre",d.result).html();self.dnnImageUpload.dnnUploadAsyncLoaded.call(self,result)},always:function(){},error:function(e,d,message){self.dnnImageUpload.dnnUploadAsyncFailed.call(self,null,e,d,message)},progress:function(e,data){self.dnnImageUpload.uploadProgressChanged.call(self,data)}}),browserSupportsDragDrop()&&!this.utils.isMobile()||wrapper.find(".draggableUiElement").hide()},dnnUploadFrame:function(){this.id="f"+Math.floor(99999*Math.random());var d=document.createElement("div"),iframe='<iframe style="display:none" id="'+this.id+'" name="'+this.id+'"></iframe>';return d.innerHTML=iframe,$(d).appendTo("body"),this.dnnUploadOptions.start&&this.dnnUploadOptions.start(),$("#"+this.id).load($.proxy(this.dnnUploadLoaded,this)),this.id},dnnGetUploadPath:function(){var moduleId=this.opts.dnnModuleId;if("undefined"==typeof moduleId||"undefined"==typeof window.dnn||"undefined"==typeof window.dnn.getVar)return"";var path=window.dnn.getVar("redactor-uploadpath-"+moduleId);return path||""},showUploadStatus:function(file){var context=this,$status=$("#redactor-modal-image-upload-status");$status.show(),$status.find(".upload-status-progress").removeClass("failed abort complete"),$status.find(".upload-status-progress .bar span").width(0),$status.find(".upload-status-message").html(""),$status.find(".upload-status-name").html(file.name),"undefined"!=typeof URL&&$status.find("img").attr("src",URL.createObjectURL(file)),this.dnnImageUpload.cancelUploadAsyncHandler=$.proxy(this.dnnImageUpload.cancelUploadAsync,this),context.$redactorModal.find(".redactor-modal-btn").hide(),context.$redactorModal.find(".redactor-modal-btn.redactor-modal-close-btn").show().click(this.dnnImageUpload.cancelUploadAsyncHandler).each(function(){var events=$._data(this,"events").click,fisrt=events.pop();events.splice(0,0,fisrt)}),$status.find(".btn-cancel").click(this.dnnImageUpload.cancelUploadAsyncHandler)},hideUploadStatus:function(){var $status=$("#redactor-modal-image-upload-status");$status.hide(),$status.find(".btn-cancel").off("click"),this.$redactorModal.find("#redactor-upload-btn1").show(),this.$redactorModal.find(".redactor-modal-btn.redactor-modal-close-btn").off("click",this.dnnImageUpload.cancelUploadAsyncHandler)},uploadProgressChanged:function(e){var percentValue=Math.round(100*e.loaded/e.total),$status=$("#redactor-modal-image-upload-status");$status.find(".upload-status-progress .bar span").width(percentValue+"%")},dnnUploadLoaded:function(){var d,i=$("#"+this.id)[0];if(d=i.contentDocument?i.contentDocument:i.contentWindow?i.contentWindow.document:window.frames[this.id].document,this.dnnUploadOptions.success)if("undefined"!=typeof d){var rawString=d.body.innerHTML;if(!rawString)return;var jsonString=rawString.match(/\{(.|\n)*\}/)[0];jsonString=jsonString.replace(/^\[/,""),jsonString=jsonString.replace(/\]$/,"");var json=$.parseJSON(jsonString);if(this.dnnUploadOptions.input&&this.dnnUploadOptions.input.val(""),this._folderPicker){if("-1"!=this._folderPicker.selectedItem().key){var item={key:"-1",value:this.opts.curLang.recentUploads};this._folderPicker.selectedItem(item)}$("#redactor-search-file").val(""),this.dnnImageUpload.dnnLoadImages("",-1,function(){$("form#redactorInsertImageForm #redactor-image-box").find(".redactor-thumb-wrapper:eq(0)").click()}),$("#redactor-tabs").find("> a").eq(1).click()}else"undefined"==typeof json.error?this.dnnUploadOptions.success(json):(this.dnnUploadOptions.error(this,json),this.modalClose())}else this.modalClose(),alert("Upload failed!")},dnnUploadAsyncLoaded:function(result){var $status=$("#redactor-modal-image-upload-status");$status.find(".upload-status-progress").addClass("complete");var rawString=result;if(rawString){var jsonString=rawString.match(/\{(.|\n)*\}/)[0];jsonString=jsonString.replace(/^\[/,""),jsonString=jsonString.replace(/\]$/,"");var json=$.parseJSON(jsonString);if(this.xhr=null,this.dnnUploadOptions.input&&this.dnnUploadOptions.input.val(""),this.dnnImageUpload.hideUploadStatus(),this._folderPicker){if("-1"!=this._folderPicker.selectedItem().key){var item={key:"-1",value:this.opts.curLang.recentUploads};this._folderPicker.selectedItem(item)}$("#redactor-search-file").val(""),this.dnnImageUpload.dnnLoadImages("",-1,function(){$("form#redactorInsertImageForm #redactor-image-box").find(".redactor-thumb-wrapper:eq(0)").click()}),$("#redactor-tabs").find("> a").eq(1).click()}else"undefined"==typeof json.error?this.dnnUploadOptions.success(json):(this.dnnUploadOptions.error(this,json),this.modalClose())}},dnnUploadAsyncFailed:function(customMessage,e,d,responseMessage){var $status=$("#redactor-modal-image-upload-status");if($status.find(".upload-status-progress").addClass("failed"),!customMessage&&e)switch(e.status){case 404:customMessage=this.opts.curLang.exceedLimit;break;case 500:var content=e.responseText;content||(content=responseMessage),customMessage=0===content.indexOf("{")?eval("("+content+")").message:content}$status.find(".upload-status-message").html(customMessage),this.dnnUploadOptions.input&&this.dnnUploadOptions.input.val("")},dnnUploadAsyncAborted:function(){var $status=$("#redactor-modal-image-upload-status");$status.find(".upload-status-progress").addClass("abort")},cancelUploadAsync:function(e){this.xhr&&(this.xhr.abort(),this.xhr=null,this.dnnImageUpload.dnnUploadAsyncAborted(),this.dnnUploadOptions.input&&this.dnnUploadOptions.input.val("")),this.dnnImageUpload.hideUploadStatus(),e.stopImmediatePropagation(),$(".redactor-drag-drop-text").show()},dnnLinkObserver:function(e){var $link=$(e.target);if(0!==$link.size()&&"A"===$link[0].tagName){var pos=$link.offset();if(this.opts.iframe){var posFrame=this.$frame.offset();pos.top=posFrame.top+(pos.top-$(this.document).scrollTop()),pos.left+=posFrame.left}var tooltip=$('<span class="redactor-link-tooltip"></span>'),href=$link.attr("href");void 0===href&&(href=""),href.length>24&&(href=href.substring(0,24)+"...");var aLink=$('<a href="'+$link.attr("href")+'" target="_blank">'+href+"</a>").on("click",$.proxy(function(e){this.linkObserverTooltipClose(!1)},this)),aEdit=$('<a href="#">'+this.opts.curLang.edit+"</a>").on("click",$.proxy(function(e){e.preventDefault(),this.linkShow(),this.linkObserverTooltipClose(!1)},this)),aUnlink=$('<a href="#">'+this.opts.curLang.unlink+"</a>").on("click",$.proxy(function(e){e.preventDefault(),this.execCommand("unlink"),this.linkObserverTooltipClose(!1)},this));tooltip.append(aLink),tooltip.append(" | "),tooltip.append(aEdit),tooltip.append(" | "),tooltip.append(aUnlink),tooltip.css({top:pos.top+20+"px",left:pos.left+"px"}),$(".redactor-link-tooltip").remove(),$("body").append(tooltip)}}}};