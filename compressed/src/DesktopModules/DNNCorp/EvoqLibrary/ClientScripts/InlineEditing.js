window.dnn=window.dnn||{},window.dnn.HTMLPro=window.dnn.HTMLPro||{},function(){var InlineEditingClass;InlineEditingClass=function(){"use strict";function InlineEditing(options,resx){var moduleId;if(this.moduleId=null,this.clientId=null,this.emptyEditContentText=null,this.module=null,this.redactorFacade=null,this.sfImage=null,this.siteRoot=null,this.storedHtml=null,this.destroyed=null,this.changes=null,this.uploadUrl=null,this.getImage=null,this.saveInterval=null,this.visual=!1,_resxRedactor={},moduleId=parseInt(options.moduleId,10),isNaN(moduleId))throw"moduleId not present";if(this.moduleId=moduleId,!options.clientId)throw"clientId not present";this.clientId=""+options.clientId,_culture=resx.culture&&"string"==typeof resx.culture?resx.culture.replace("-","_"):"en",resx.inlineEditor&&"object"==typeof resx.inlineEditor&&Object.keys(resx.inlineEditor).length>0&&(_resxInlineEditor=resx.inlineEditor),resx.imageEditing&&"object"==typeof resx.imageEditing&&Object.keys(resx.imageEditing).length>0&&(_resxImageEditing=resx.imageEditing),resx.redactor&&"object"==typeof resx.redactor&&Object.keys(resx.redactor).length>0&&(_resxRedactor=resx.redactor),this.redactorFacade=window.dnn.HTMLPro.RedactorFacade(),_redactorFacadeConfiguration={maxFileSize:options.maxFileSize||5e6},this.redactorFacade.setConfig(_redactorFacadeConfiguration),_maxFileSize=options.maxFileSize||5e6,localize(),options.canUpload||(options.canUpload=!1),this.canUpload=options.canUpload,this.onChangeCallback=options.onChangeCallback,this.onEditorInitCallback=options.onEditorInitCallback,this.editUrl=options.editUrl,this.saveUrl=options.saveUrl,this.externalSaveSuccessCallback=options.saveSuccessCallback,this.module=$("#"+this.clientId),this.redactorFacade.setModule(this.module),this.editorMask=null,this.autoSaveEnabled=void 0===options.autoSaveEnabled||options.autoSaveEnabled,_autoSave=this.autoSaveEnabled,configServiceFramework.call(this),loadRedactorResources.call(this,resx,function(resxInformation){_resxRedactor=resxInformation.redactor,_culture=resxInformation.culture}),bindModule.call(this,this)}function showEditorMask($editorMask){$editorMask.css("background-color","transparent"),$editorMask.css("opacity","1")}function hideEditorMask($editorMask){$editorMask.css("background-color","#fff"),$editorMask.css("opacity","0")}function isContentEmpty(html){var $html,tagsToDelete;return tagsToDelete=["p","br"],$html=$("<div/>").append(html),$html.find(tagsToDelete.join(",")).each(function(){var $el=$(this),text=$el.text();text=text.replace(/\u200B/g,""),text=text.replace(/&nbsp;/gi,""),text=text.replace(/\s/g,""),""===text&&0===$el.children().length&&$el.remove()}),""===$html.html()}function addEditorMask(){var self=this;self.editorMask=$(_editorMask);var hasNoContent=isContentEmpty(self.module.html());hasNoContent||0===self.module.height()||0===self.module.width()?(hasNoContent&&self.editorMask.html(_resxInlineEditor.emptyEditContentText),showEditorMask(self.editorMask)):hideEditorMask(self.editorMask),self.editorMask.insertAfter(self.module),self.editorMask.on("click",function(evt){evt.preventDefault(),self.isRedactorInit||setTimeout(function(){initRedactor.call(self)},TIME_TO_PREVENT_OTHER_MODULES_OPENED)})}function removeEditorMask(){var self=this;self.editorMask&&(self.editorMask.remove(),self.editorMask=null)}function isImageEditingInProgress(){return _imageEditing&&_imageEditing.isEditingInProcess()}var TIME_TO_AUTOSAVE,TIME_PROGRESS_BAR_SAVE_LAYER,ESC,TIME_TO_PREVENT_OTHER_MODULES_OPENED,TIME_OUT_FOR_WAITING_RESOURCES,_imageEditing,_history,_culture,_resxInlineEditor,_resxImageEditing,_resxRedactor,_maxFileSize,_savingLayer,_editorMask,_inFullscren,_beforeAdvancedWasInFullScreen,_moduleWithRedactor,_autoSave,_redactorFacadeConfiguration,_changeCallbackEnabled,configServiceFramework,bindModule,initRedactor,initRedactorWithResourcesLoaded,cleanHtml,isTheSameHtmlContent,saveEditor,autosaveEditor,destroyEditor,initInterval,endInterval,showHideCodeEditor,initImageEditing,bindImageEditing,unbindImageEditing,injectAdvancedButton,advancedButtonSaveCallback,localize,linkImage,unlinkImage,executingBlurCallback,loadRedactorResources,areRedactorResourcesLoaded;InlineEditing.class="InlineEditing",InlineEditing.type="Class",TIME_TO_AUTOSAVE=5e3,TIME_PROGRESS_BAR_SAVE_LAYER=4e3,ESC=27,TIME_TO_PREVENT_OTHER_MODULES_OPENED=300,TIME_OUT_FOR_WAITING_RESOURCES=100,_savingLayer='<div class="dnnInlineEditingSavingLayer"><div class="loopBar"><div class="progressA" style="width: 0;"></div></div><div class="optacityLayer"><h1 style="">{0}</h1></div></div>',_editorMask='<div class="dnnInlineEditingMask" style="display: block; position: absolute; top: 0; width: 100%; height: 100%; cursor: pointer; min-height:12px; background-color:#fff;opacity:0"></div>',_resxInlineEditor={emptyEditContentText:"Click here to edit content",advancedEditor:"Advanced Editor",errorSavingText:"Error saving the HTML content",savingChanges:"Saving changes..."},loadRedactorResources=function(resxInformation,loadedCallback){var self,localizationOptionsRedactor;self=this,resxInformation.redactor?"function"==typeof loadedCallback&&loadedCallback(resxInformation):(resxInformation.redactor=!0,localizationOptionsRedactor={service:"DNNCorp/EvoqLibrary",controller:"Localization",resxName:"RedactorResx",resourceSettings:{method:"GetRedactorSettings",callback200:function(data){resxInformation.culture&&resxInformation.culture===data.culture||(resxInformation.culture=data.culture)}},resources:{method:"GetRedactor",paramName:"localization",callback200:function(data){resxInformation.redactor=data.localization,resxInformation.culture=resxInformation.culture||"en","function"==typeof loadedCallback&&loadedCallback(resxInformation)},callbackError:function(data){console.log("Error",data)}}},new dnn.utils.Localization(localizationOptionsRedactor))},configServiceFramework=function(){var antiForgeryToken=$('input[name="__RequestVerificationToken"]').val();this.sfImage=$.ServicesFramework(this.moduleId),this.siteRoot=this.sfImage.getServiceRoot("DNNCorp/EvoqLibrary").replace("API/",""),this.siteImageRoot=this.sfImage.getServiceRoot("DNNCorp/EvoqLibrary")+"Redactor/",this.uploadUrl=this.canUpload?this.siteImageRoot+"postimages?moduleId="+this.moduleId+"&__RequestVerificationToken="+antiForgeryToken:null,this.getImage=this.siteImageRoot+"getimages"},bindModule=function(self){$("div.DnnModule-"+this.moduleId).on("editmodule",function(){var $module=$(this);self.isRedactorInit||(initRedactor.call(self),setTimeout(function(){var $img,src;$img=$module.find(".redactor-editor img").last(),$img.length>0&&(src=$img.attr("src"),$img.on("load",function(){var $editor,offsetTop;$editor=$module.find(".redactor-editor"),offsetTop=$img.offset().top-$editor.offset().top-$("#image-edit-bar").outerHeight(!0),setTimeout(function(){$img.click(),$editor.scrollTop(offsetTop)},100)}).attr("src","").attr("src",src)),_beforeAdvancedWasInFullScreen&&($(".re-fullscreen").trigger("click"),_beforeAdvancedWasInFullScreen=!1)},0))}),addEditorMask.call(self)},initInterval=function(){var self=this;endInterval.call(this),this.saveInterval=setInterval(function(){autosaveEditor.call(self)},TIME_TO_AUTOSAVE)},endInterval=function(){this.saveInterval&&clearInterval(this.saveInterval)},showHideCodeEditor=function(){var self=this;this.visual=!this.visual,unbindImageEditing.call(this),_imageEditing?(_history=_imageEditing.getHistory(),_imageEditing.destroy(function(){_imageEditing=null,self.redactorFacade.sync(),self.visual||(self.changes=!0),self.redactorFacade.toggle()})):(this.visual||(this.changes=!0),this.redactorFacade.toggle(),initImageEditing.call(this),_history&&(_imageEditing.setHistory(_history),_history=null))};var initRedactorCallback,postInitRedactorCallback,blurCallback,focusCallback,changeCallback,imageUploadCallback,customToolbarEventCallback,addLinkToImage,removeLinkFromImage;return addLinkToImage=function(inlineEditor){inlineEditor.redactorFacade.hideModalInsertLinkTextElements(),_imageEditing.removeWrappers()},removeLinkFromImage=function(inlineEditor){var imageToUnlink;imageToUnlink=_imageEditing.getActiveImage(),_imageEditing.removeWrappers(),unlinkImage(imageToUnlink),_imageEditing.addWrappers()},customToolbarEventCallback=function(event,inlineEditor){_imageEditing&&(_imageEditing.stopEditingImage(),_imageEditing.addWrappers())},postInitRedactorCallback=function(inlineEditor){inlineEditor.redactorFacade.setCustomShowInsertLinkModal(function(){isImageEditingInProgress()&&addLinkToImage(inlineEditor)}),inlineEditor.redactorFacade.setCustomInsertLinkAction(_imageEditing,function(linkValue,checked){var image=$(_imageEditing.getActiveImage());_imageEditing.stopEditingImage(),linkImage(image,linkValue,checked),_imageEditing.addWrappers()}),inlineEditor.redactorFacade.setCustomRemoveLinkFromImage(function(){isImageEditingInProgress()&&removeLinkFromImage(inlineEditor)}),inlineEditor.redactorFacade.setCustomHtmlToggle(function(){_imageEditing?_imageEditing.executeAfterSaving(function(){showHideCodeEditor.call(inlineEditor)}):showHideCodeEditor.call(inlineEditor)}),_imageEditing.notifyRedactorReady()},initRedactorCallback=function(inlineEditor){var toolbar,redactor=this;removeEditorMask.call(inlineEditor),inlineEditor.redactorFacade.setCustomToolbarEvent(redactor,function(event){customToolbarEventCallback(event,inlineEditor)}),inlineEditor.redactorFacade.onOnKeyDownIE(function(evt){evt.keyCode===ESC&&_inFullscren&&!isImageEditingInProgress()&&$(".re-fullscreen").trigger("click")}),redactor.code.startSync(),inlineEditor.storedHtml=redactor.code.get(),initImageEditing.call(inlineEditor),inlineEditor.destroyed=!0,inlineEditor.isRedactorInit=!1,inlineEditor.changes=!1,_autoSave&&initInterval.call(inlineEditor),inlineEditor.destroyed=!1,inlineEditor.editUrl&&(toolbar=inlineEditor.redactorFacade.getToolbar(redactor),injectAdvancedButton.call(inlineEditor,toolbar))},blurCallback=function(evt,inlineEditor){executingBlurCallback||inlineEditor.redactorFacade.isBlurCommingFromModal(evt)||(executingBlurCallback=!0,window.dnn.utils.PendingSavesManager.addPendingSave(inlineEditor.moduleId),inlineEditor.visual&&(unbindImageEditing.call(inlineEditor),_imageEditing?(_history=_imageEditing.getHistory(),_imageEditing.destroy(function(){executingBlurCallback=!1,_imageEditing=null})):(initImageEditing.call(inlineEditor),_history&&(_imageEditing.setHistory(_history),_history=null)),inlineEditor.redactorFacade.toggle()),inlineEditor.module.off(".imageEditing"),destroyEditor.call(inlineEditor))},focusCallback=function(inlineEditor){_changeCallbackEnabled=!0,setTimeout(function(){_imageEditing&&_imageEditing.addWrappers()},0)},changeCallback=function(inlineEditor){if(_changeCallbackEnabled&&(inlineEditor.changes=!0,window.dnn.utils.PendingSavesManager.addPendingSave(inlineEditor.moduleId),!_imageEditing&&"function"==typeof inlineEditor.onChangeCallback)){var currentHtml=inlineEditor.redactorFacade.get();isTheSameHtmlContent.call(inlineEditor,currentHtml)||inlineEditor.onChangeCallback()}},imageUploadCallback=function(e,image,json){var $element,$img,src;image&&image.filelink&&($element=this.$element,$img=$element.find('img[src$="'+image.filelink+'"]'),$img.length>0&&(src=$img.attr("src"),$img.on("load",function(){var offsetTop=$img.offset().top-$element.offset().top-$("#image-edit-bar").outerHeight(!0);setTimeout(function(){$img.click(),$element.scrollTop(offsetTop)},100)}).attr("src","").attr("src",src).css("max-width","100%")))},areRedactorResourcesLoaded=function(){return _culture&&_resxRedactor&&Object.keys(_resxRedactor).length},initRedactor=function(){areRedactorResourcesLoaded()?initRedactorWithResourcesLoaded.call(this):setTimeout($.proxy(initRedactor,this),TIME_OUT_FOR_WAITING_RESOURCES)},initRedactorWithResourcesLoaded=function(){var self;if(!window.dnn.HTMLPro.redactorActive){window.dnn.HTMLPro.redactorActive=!0,this.isRedactorInit=!0,self=this,self.visual=!1,_inFullscren=!1;var resxSettings={culture:_culture,resxRedactor:_resxRedactor};self.redactorFacade.setConfig(_redactorFacadeConfiguration,resxSettings),self.redactorFacade.initRedactor(_resxRedactor,function(){postInitRedactorCallback(self)},{allowedTags:["a","abbr","acronym","address","applet","area","article","aside","audio","b","base","basefont","bdi","bdo","big","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","datalist","dd","del","details","dfn","dialog","dir","div","dl","dt","em","embed","fieldset","figcaption","figure","font","footer","form","frame","frameset","h1","h2","h3","h4","h5","h6","head","header","hr","html","i","iframe","img","input","ins","kbd","keygen","label","legend","li","link","main","map","mark","menu","menuitem","meta","meter","nav","noframes","noscript","object","ol","optgroup","option","output","p","param","pre","progress","q","rp","rt","ruby","s","samp","script","section","select","small","source","span","strike","strong","style","sub","summary","sup","table","tbody","td","textarea","tfoot","th","thead","time","title","tr","track","tt","u","ul","var","video","wbr","inline"],deniedTags:[],buttons:["formatting","|","bold","italic","underline","|","orderedlist","unorderedlist","|","outdent","indent","|","|","link","file","|","html","|"],plugins:["dnnImageUpload","advancedmode"],imageTypes:["image/png","image/jpeg","image/gif","image/bmp"],removeEmpty:!1,cleanSpaces:!1,inlineTags:[],paragraphy:!1,focus:!0,shortcuts:!0,convertDivs:!1,imageResizable:!1,imageLink:!0,imagePosition:!1,allowImageEditor:!1,imageEditable:!1,convertLinks:!1,paragraphize:!1,replaceDivs:!1,observeImages:!1,cleanFontTag:!1,imageUpload:this.uploadUrl,imageGetJson:this.getImage,zIndexMax:1100,initCallback:function(){initRedactorCallback.call(this,self)},blurCallback:function(evt){blurCallback(evt,self)},focusCallback:function(){focusCallback(self)},changeCallback:function(){changeCallback(self)},imageUploadCallback:function(e,image,json){imageUploadCallback.call(this,e,image,json)},dropdownShowCallback:function(args){"formatting"===args.key&&_imageEditing&&(_imageEditing.isEditingInProcess()&&_imageEditing.stopEditingImage(),_imageEditing.removeWrappers())}}),_moduleWithRedactor=self.module,"function"==typeof self.onEditorInitCallback&&self.onEditorInitCallback.call(self)}},cleanHtml=function(html){return html.replace(/\>\s+/gm,">").replace(/\s+\</gm,"<").replace(/ unselectable="on"/gm,"")},isTheSameHtmlContent=function(html){return cleanHtml(this.storedHtml)===cleanHtml(html)},saveEditor=function(successCallback,redactorWillBeDestroyed){var currentHtml,sf,savingLayer,progress,redactorBox,self=this;if(self.autoSaveEnabled){if(self.destroyed)return void("function"==typeof successCallback&&successCallback.call(this));self.changes=!1,_imageEditing&&_imageEditing.removeWrappers();var syncCallback=$.proxy(function(){return currentHtml=self.redactorFacade.get(),_imageEditing&&_imageEditing.addWrappers(),isTheSameHtmlContent.call(self,currentHtml)?void("function"==typeof successCallback&&successCallback.call(self)):(this.storedHtml=currentHtml,redactorWillBeDestroyed&&(savingLayer=$(_savingLayer),$("body").append(savingLayer),self.savingLayer=$(".dnnImageEditingSavingLayer"),progress=savingLayer.find(".progressA"),redactorBox=self.module.parent(),savingLayer.css({width:redactorBox.css("width"),height:redactorBox.css("height")}),savingLayer.offset(redactorBox.offset()),progress.animate({width:"99%"},TIME_PROGRESS_BAR_SAVE_LAYER)),sf=$.ServicesFramework(self.moduleId),void $.ajax({type:"POST",url:self.saveUrl,beforeSend:sf.setModuleHeaders,data:{HtmlText:currentHtml},success:function(data){savingLayer&&(savingLayer.remove(),savingLayer=null),"function"==typeof self.externalSaveSuccessCallback&&self.externalSaveSuccessCallback(data),"function"==typeof successCallback&&successCallback.call(self)},error:function(xhr,status,error){var response,message;savingLayer&&savingLayer.remove(),response=$.parseJSON(xhr.responseText),message=response.ExceptionMessage||response.Message,$.dnnAlert({title:_resxInlineEditor.errorSavingText,text:message?message.replace(/^"(.+(?="$))"$/,"$1"):""})}}))},this);self.redactorFacade.sync(syncCallback)}},autosaveEditor=function(){this.changes===!1||this.visual||isImageEditingInProgress()||saveEditor.call(this)},destroyEditor=function(finalCallback){var self,saveCallback,destroyCallback;this.destroyed||(this.isRedactorInit=!1,this.changes=!1,endInterval.call(this),self=this,saveCallback=function(){_imageEditing&&(_imageEditing=null),$(window).off("keydown.dnnRedactorIE"),_moduleWithRedactor=null;var destroyCallback=function(){self.destroyed=!0,addEditorMask.call(self),"function"==typeof finalCallback&&finalCallback.call(self),window.dnn.HTMLPro.redactorActive=!1,window.dnn.utils.PendingSavesManager.completePendingSave(self.moduleId),executingBlurCallback=!1};self.redactorFacade.sync(function(){changeCallback(self),self.redactorFacade.destroy(destroyCallback),_changeCallbackEnabled=!1})},destroyCallback=function(){_autoSave?saveEditor.call(self,saveCallback,!0):saveCallback.call(self)},_imageEditing?_imageEditing.destroy(destroyCallback):destroyCallback.call(this,null,!0))},initImageEditing=function(){_imageEditing=new window.dnn.HTMLPro.ImageEditing(this.module,this.redactorFacade,this.siteRoot.replace("API/",""),this.sfImage,this.siteImageRoot+"/SaveImageStream",this.siteImageRoot+"/ProxyImage",_resxImageEditing),bindImageEditing.call(this)},bindImageEditing=function(){var self=this;this.module.on("hideToolbar.imageEditing",function(){self.redactorFacade.sync(),initInterval.call(self)}),this.module.on("showToolbar.imageEditing",function(){endInterval.call(self)})},unbindImageEditing=function(){this.module.off(".imageEditing")},injectAdvancedButton=function(redactorToolbar){var self,advancedButton;self=this,advancedButton=redactorToolbar.find(".re-advancedmode"),advancedButton.on("click",function(evt){_inFullscren?($(".re-fullscreen").trigger("click"),_beforeAdvancedWasInFullScreen=!0):_beforeAdvancedWasInFullScreen=!1,evt.preventDefault(),destroyEditor.call(self,advancedButtonSaveCallback)})},advancedButtonSaveCallback=function(){location.href=this.editUrl,setTimeout(function(){var $modal=$("#iPopUp"),$window=$(window),newHeight=$window.height()-46,newWidth=$window.width()-220;$modal.dialog({height:newHeight,width:newWidth}),$modal.dialog({position:"center"});var loading=$modal.prev("div.dnnLoading");loading.css({width:$modal.width(),height:$modal.height()})},0)},localize=function(){_resxInlineEditor&&0!==Object.keys(_resxInlineEditor).length&&(_savingLayer=_savingLayer.replace("{0}",_resxInlineEditor.savingChanges))},linkImage=function(image,url,openLinkInANewTab){var tag;image&&url&&"string"==typeof url&&(tag='<a href="',0!==url.search(/^https?:\/\//)&&(url="http://"+url),tag+=url+'"',openLinkInANewTab&&(tag+=' target="_blank"'),tag+="></a>",image.parent().is("a")&&image.unwrap(),image.wrap(tag))},unlinkImage=function(image){image&&image.parent().is("a")&&image.unwrap()},InlineEditing.setCulture=function(culture){_culture=culture.replace("-","_")},InlineEditing.setResx=function(resx){_resxInlineEditor=resx,localize()},InlineEditing.setRedactorResx=function(resx,culture){_resxRedactor=resx,_culture=culture},InlineEditing.setImageEditingResx=function(resx){_resxImageEditing=resx,window.dnn.HTMLPro.ImageEditing.localize(_resxImageEditing)},InlineEditing}(),window.dnn.HTMLPro.InlineEditing=InlineEditingClass}.call(this);