"undefined"!=typeof dnn&&null!==dnn||(dnn={}),"undefined"!=typeof dnn.ContentLayout&&null!==dnn.ContentLayout||(dnn.ContentLayout={}),function($){$.fn.dnnLayoutEditor=function(options){return this.data("dnnLayoutEditor")||this.data("dnnLayoutEditor",new dnnLayoutEditor(this,options)),this};var dnnLayoutEditor=function(container,options){this.options=options,this.container=container,this.init()};dnnLayoutEditor.prototype={constructor:dnnLayoutEditor,init:function(){this.options=$.extend({},$.fn.dnnLayoutEditor.defaultOptions,this.options),this._checkActionsState(),this._addResizer(),this._adjustColumnHeight(),this.container.parents("div.DnnModule").addClass("CatchDragState"),this._tryCatchAddModuleEvents()},_updateColumnWidth:function(){var totalWidth=0,columns=this.container.find("> div.row > .pane");columns.each(function(){totalWidth+=$(this).outerWidth()});for(var totalPercent=0,i=0;i<columns.length;i++){var $this=$(columns[i]);if(i<columns.length-1){var percentWidth=parseFloat(($this.outerWidth()/totalWidth*100).toFixed(2));totalPercent+=percentWidth,$this.css({width:percentWidth+"%"})}else $this.css({width:100-totalPercent+"%"})}},_checkActionsState:function(){this._doesContainModules()?this._removeModuleActions():(this._removeModuleActionButton("Settings"),this._removeModuleActionButton("Import"),this._removeModuleActionButton("Export"),this._removeMoveContentLayoutPanesMenuItems())},_doesContainModules:function(){return $("div.DnnModule",this.container).length>0},_removeModuleActions:function(){var moduleId=this.options.moduleId,$moduleActions=$("#moduleActions-"+moduleId);this.container.parents("div.DnnModule").addClass("EditDisabled"),$moduleActions.remove()},_removeModuleActionButton:function(actionName){var moduleId=this.options.moduleId,$moduleActionsMenuItem=$("#moduleActions-"+moduleId+"-"+actionName);$moduleActionsMenuItem.remove()},_removeMoveContentLayoutPanesMenuItems:function(){var moduleId=this.options.moduleId,$moduleMoveMenuItems=$("#moduleActions-"+moduleId+" .actionMenuMove li");$moduleMoveMenuItems.filter(this._isContentLayoutPaneMoveMenuItem).remove()},_isContentLayoutPaneMoveMenuItem:function(){var regex=new RegExp("^[A-F0-9]{4}_Pane[1-4]{1}[0-9]+$");return regex.test(this.id)},_addResizer:function(){for(var handler=this,columns=this.container.find('[class~="pane"]'),i=0;i<columns.length;i++){var $item=$(columns[i]);i!==columns.length-1&&$item.resizable({handles:"e",containment:"parent",minWidth:handler.options.colMinWidth,maxWidth:$item.outerWidth()+$item.next().outerWidth()-handler.options.colMinWidth-1,start:$.proxy(handler._onResizeStart,handler),resize:$.proxy(handler._onResize,handler),stop:$.proxy(handler._onResizeStop,handler)})}$(window).resize(function(){if(2!==arguments.length||!arguments[1].element||!arguments[1].element.hasClass("ui-resizable"))for(var index=0;index<columns.length-1;index++){var $col=$(columns[index]),maxWidth=$col.outerWidth()+$col.next().outerWidth()-handler.options.colMinWidth-1;$col.resizable("option","maxWidth",maxWidth)}}),this.container.find(".ui-resizable-handle").mouseenter(function(e){handler._showSizeViewer()}).mouseleave(function(e){handler._isResizing||handler._hideSizeViewer()})},_isResizing:!1,_onResizeStart:function(event,ui){var handler=this;handler._isResizing=!0},_onResizeStop:function(event,ui){var handler=this;handler._isResizing=!1;var sizes=[],columns=this.container.find('[class~="pane"]'),totalWidth=0;columns.each(function(){totalWidth+=$(this).outerWidth()});for(var totalPercent=0,i=0;i<=columns.length-1;i++){var $item=$(columns[i]);if(i<columns.length-1){var percentWidth=this._calcColumnWidthAsPercent($item);sizes.push(percentWidth),totalPercent+=percentWidth,$item.css({width:percentWidth+"%"});var maxWidth=$item.outerWidth()+$item.next().outerWidth()-handler.options.colMinWidth-1;$item.resizable("option","maxWidth",maxWidth)}else $item.css({width:100-totalPercent+"%"})}var successCallback=function(data){handler._hideSizeViewer(),$(document).trigger("changeOnPageContent")};this._getService().request("UpdateLayoutWithColumnSizes","POST",{sizes:sizes.join()},successCallback)},_onResize:function(event,ui){var width=ui.element.outerWidth(),totalWidth=ui.element.resizable("option","maxWidth")+this.options.colMinWidth;ui.element.next().css("width",totalWidth-width),this._updateSizeViewer()},_createSizeViewer:function(){var handler=this,$columns=this.container.find('[class~="pane"]'),totalWidth=0;$columns.each(function(index){var $col=$(this),width=index<$columns.length-1?handler._calcColumnWidthAsPercent($col):100-totalWidth;totalWidth+=width;var $viewer=$('<span class="size-viewer"></span>').html(width+"%");$col.append($viewer)})},_updateSizeViewer:function(){var handler=this,$columns=this.container.find('[class~="pane"]'),totalWidth=0;$columns.each(function(index){var $col=$(this),width=index<$columns.length-1?handler._calcColumnWidthAsPercent($col):100-totalWidth;totalWidth+=width,$col.find(".size-viewer").html(width+"%")})},_showSizeViewer:function(){var $viewer=this.container.find(".size-viewer");$viewer.length||(this._createSizeViewer(),$viewer=this.container.find(".size-viewer")),$viewer.fadeIn("fast")},_hideSizeViewer:function(){var $viewer=this.container.find(".size-viewer");$viewer.fadeOut("fast")},_calcColumnWidthAsPercent:function(col){var columns=this.container.find('[class~="pane"]'),totalWidth=0;return columns.each(function(){totalWidth+=$(this).outerWidth()}),parseFloat((col.outerWidth()/totalWidth*100).toFixed(0))},_adjustColumnHeight:function(){var handler=this;this.container.find("> div.row > .pane").each(function(){var $col=$(this);$col.data("o-height",$col.height()).on("heightChange",$.proxy(handler._adjustColumnHeightHandler,handler))}),handler._adjustColumnHeightHandler(),dnnLayoutEditor.LayoutHeightChange||(dnnLayoutEditor.LayoutHeightChange=setTimeout(function(){handler._checkColumnHeight()},20))},_checkColumnHeight:function(){var handler=this;$("div.layoutContainer > div.row > .pane").each(function(){var $col=$(this),height=handler._getColumnHeight($col);height!=$col.data("o-height")&&($col.trigger("heightChange"),$col.data("o-height",height))}),dnnLayoutEditor.LayoutHeightChange=setTimeout(function(){handler._checkColumnHeight()},20)},_getColumnHeight:function(col){var height=0;return col.children('.DnnModule:not([class~="floating"]), .handlerContainer:visible').each(function(){height+=$(this).outerHeight(!0)}),height>0&&(height+=parseInt(col.css("border-top-width"))+parseInt(col.css("border-bottom-width"))+parseInt(col.css("padding-top"))+parseInt(col.css("padding-bottom"))),parseInt(height)},_adjustColumnHeightHandler:function(){var maxCol,handler=this,maxHeight=0;this.container.find("> div.row > .pane").each(function(){if($(this).find("> .DnnModule").length>0){var $col=$(this),height=handler._getColumnHeight($col);height>maxHeight&&(maxHeight=height,maxCol=$col)}}),maxHeight>0&&(maxHeight<110&&(maxHeight=110),this.container.find("> div.row > .pane").each(function(){this.style.setProperty("min-height",maxHeight+"px","important")}))},_tryCatchAddModuleEvents:function(){var layoutPrefix=this.options.layoutPrefix,instance=this;$(document).on("mousedown","div.ControlBar_ModuleDiv",function(){instance._isContentLayoutModule(this)&&instance.container.parents("div.DnnModule").addClass("dragging")}).on("mouseup","div.ControlBar_ModuleDiv",function(){instance.container.parents("div.DnnModule").removeClass("dragging")}).on("mouseenter","div.ControlBar_ModuleDiv",function(){var $menuItems=$("#ControlBar_Module_ModulePosition").find("li");instance._isContentLayoutModule(this)?$menuItems.each(function(){var pane=$(this).data("pane");0===pane.indexOf(layoutPrefix)&&$(this).hide()}):$menuItems.show()}),this.container.parents("div.DnnModule").on("dragstart",function(){$("div.DnnModule.DnnModule-ContentLayout.CatchDragState").find("div.pane").each(function(){var $pane=$(this);$pane.data("ui-sortable")&&$pane.sortable("disable")})}).on("dragend",function(){$("div.DnnModule.DnnModule-ContentLayout.CatchDragState").find("div.pane").each(function(){var $pane=$(this);$pane.data("ui-sortable")&&$pane.sortable("enable")})})},_isContentLayoutModule:function(element){var $element=$(element),desktopModuleId=this.options.desktopModuleId,moduleId=$element.data("module");return $element.parents("#ControlBar_ModuleListHolder_ExistingModule").length?$element.find("img").attr("src").toLowerCase().indexOf(this.options.moduleIcon)>-1:moduleId&&moduleId===desktopModuleId},_getService:function(){return this._serviceController||(this._serviceController=new dnn.dnnModuleService({service:"DnnCorp/ContentLayout",controller:"Service",moduleId:this.options.moduleId})),this._serviceController}},$.fn.dnnLayoutEditor.defaultOptions={colMinWidth:105,moduleIcon:"icon-contentlayout.png"}}(jQuery);