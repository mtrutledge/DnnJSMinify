"undefined"!=typeof dnn&&null!==dnn||(dnn={}),dnn.ContentLayout={},function($){$.fn.dnnModuleLayout=function(dialog,options){return this.data("dnnModuleLayout")||this.data("dnnModuleLayout",new dnnModuleLayout(this,dialog,options)),this};var dnnModuleLayout=function(container,moduleDialog,options){this.options=options,this.container=container,this.moduleDialog=moduleDialog,this.init()};dnnModuleLayout.prototype={constructor:dnnModuleLayout,init:function(){this.options=$.extend({},$.fn.dnnModuleLayout.defaultOptions,this.options),this._getService().request("GetContentLayoutTemplates","GET",{},$.proxy(this._getLayoutTemplates,this))},_getLayoutTemplates:function(data){var list=this.container.find(".dnnLayoutList .listContainer ul");for(var i in data)if(data.hasOwnProperty(i)){var dataItem=data[i],item=$('<li class=""><a href="#"><img src="'+dataItem.icon+'" /><span class="title">'+dataItem.name+'</span><span class="button"></span></a></li>');item.data("layout",dataItem),item.click($.proxy(this._itemClick,this)),list.append(item)}this._initScrollView()},_itemClick:function(e){if(this._working)return!1;this._working=!0;var dataItem=$(e.currentTarget).data("layout"),pane=this.moduleDialog.options.paneName,templateId=dataItem.id;return this._addingLayout=$(e.currentTarget),this._getService().request("AddLayout","POST",{PaneName:pane,TemplateId:templateId},$.proxy(this._addLayoutComplete,this)),!1},_addLayoutComplete:function(data){var handler=this;this.moduleDialog.refreshPane("","layout-"+data,function(){dnnLayoutEditor.refreshContent(this);var layout=this.find(".layoutContainer[data-layoutid="+data+"]");!handler.moduleDialog._noFloat||this.find("div.DnnModule, .layoutContainer").length>1?layout.data("dnnLayoutEditor").readyForDrag():layout.parent().addClass("dnn-cl"),handler._motionToNewLayout(layout),handler._working=!1})},_motionToNewLayout:function(layout){var $listItem=this._addingLayout,$motion=$('<div class="module-motion" />').hide().css({width:$listItem.width(),height:$listItem.height(),left:$listItem.offset().left,top:$listItem.offset().top}).appendTo($(document.body));this.moduleDialog.close(function(){$motion.show().animate({width:layout.width(),height:layout.height(),left:layout.offset().left,top:layout.offset().top},"fast",function(){$motion.remove()})})},_initScrollView:function(){var container=this.container.find(".dnnLayoutList .listContainer");container.data("jsp")?container.data("jsp").reinitialise():container.jScrollPane()},_getService:function(){return this._serviceController||(this._serviceController=new dnn.dnnModuleService({service:"EvoqContentLibrary",controller:"ContentEditor"})),this._serviceController}},$.fn.dnnModuleLayout.defaultOptions={},$.fn.dnnLayoutEditor=function(options){return this.data("dnnLayoutEditor")||this.data("dnnLayoutEditor",new dnnLayoutEditor(this,options)),this};var dnnLayoutEditor=function(container,options){this.options=options,this.container=container,this.init()};dnnLayoutEditor.prototype={constructor:dnnLayoutEditor,init:function(){this.options=$.extend({},$.fn.dnnLayoutEditor.defaultOptions,this.options),this._addResizer(),this._addToolbar(),this._adjustColumnHeight(),dnnLayoutEditor.catchSortEvents()},updatePosition:function(layoutId,paneName,position,callback){this._getService().request("UpdateLayoutPosition","GET",{layoutId:layoutId,paneName:paneName,position:position},callback)},readyForDrag:function(){var left,top,moduleWidth=this.container.outerWidth(),moduleHeight=this.container.outerHeight();this.container.addClass("floating"),this.container.width(.8*moduleWidth),moduleWidth=this.container.outerWidth(),left=$("#personaBar-iframe").outerWidth()/2+($(window).width()-moduleWidth)/2,top=$(window).height()/2-moduleHeight,this.container.css({left:left,top:top}),this.container.addClass("drift").mouseover(function(){$(this).removeClass("drift")}).mouseout(function(){$(this).addClass("drift")}),this._updateColumnWidth();var moduleDialog=dnn.ContentEditorManager.getModuleDialog(),layoutId=this.container.data("layoutid");moduleDialog._setPending("layout-"+layoutId),$("div.dnnDragHint").off("mouseenter").addClass("dnnDragDisabled")},_updateColumnWidth:function(){var totalWidth=0,columns=this.container.find("> div.row > .pane");columns.each(function(){totalWidth+=$(this).outerWidth()});for(var totalPercent=0,i=0;i<columns.length;i++){var $this=$(columns[i]);if(i<columns.length-1){var percentWidth=parseFloat(($this.outerWidth()/totalWidth*100).toFixed(2));totalPercent+=percentWidth,$this.css({width:percentWidth+"%"})}else $this.css({width:100-totalPercent+"%"})}},_addResizer:function(){for(var handler=this,columns=this.container.find('[class~="pane"]'),i=0;i<columns.length;i++){var $item=$(columns[i]);i!=columns.length-1&&$item.resizable({handles:"e",containment:"parent",minWidth:handler.options.colMinWidth,maxWidth:$item.outerWidth()+$item.next().outerWidth()-handler.options.colMinWidth-1,start:$.proxy(handler._onResizeStart,handler),resize:$.proxy(handler._onResize,handler),stop:$.proxy(handler._onResizeStop,handler)})}$(window).resize(function(){if(2!=arguments.length||!arguments[1].element||!arguments[1].element.hasClass("ui-resizable"))for(var index=0;index<columns.length-1;index++){var $col=$(columns[index]),maxWidth=$col.outerWidth()+$col.next().outerWidth()-handler.options.colMinWidth-1;$col.resizable("option","maxWidth",maxWidth)}})},_onResizeStart:function(event,ui){},_onResizeStop:function(event,ui){var handler=this,sizes=[],columns=this.container.find('[class~="pane"]'),totalWidth=0;columns.each(function(){totalWidth+=$(this).outerWidth()});for(var totalPercent=0,i=0;i<=columns.length-1;i++){var $item=$(columns[i]);if(i<columns.length-1){var percentWidth=parseFloat(($item.outerWidth()/totalWidth*100).toFixed(2));sizes.push(percentWidth),totalPercent+=percentWidth,$item.css({width:percentWidth+"%"});var maxWidth=$item.outerWidth()+$item.next().outerWidth()-handler.options.colMinWidth-1;$item.resizable("option","maxWidth",maxWidth)}else $item.css({width:100-totalPercent+"%"})}this._getService().request("UpdateColumnSize","GET",{layoutId:this.container.data("layoutid"),sizes:sizes.join()})},_onResize:function(event,ui){var width=ui.element.outerWidth(),totalWidth=ui.element.resizable("option","maxWidth")+this.options.colMinWidth;ui.element.next().css("width",totalWidth-width)},_addToolbar:function(){var toolbar=this._toolbar=$('<div class="layout-toolbar"></div>');if(this.container.append(toolbar),0==$("div.DnnModule",this.container).length){this._addToolButton("btn-delete",$.proxy(this._deleteLayoutHandler,this));this._addToolButton("btn-move")}else toolbar.hide()},_addToolButton:function(cssClass,action){var button=$('<a class="toolbar-button '+cssClass+'" href="#"><span /></span></a>');return this._toolbar.append(button),"function"==typeof action?button.click(action):button.click(function(){return!1}),button},_adjustColumnHeight:function(){var handler=this;this.container.find("> div.row > .pane").each(function(){var $col=$(this);$col.data("o-height",$col.height()).on("heightChange",$.proxy(handler._adjustColumnHeightHandler,handler))}),handler._adjustColumnHeightHandler(),dnnLayoutEditor.LayoutHeightChange||(dnnLayoutEditor.LayoutHeightChange=setTimeout(function(){handler._checkColumnHeight()},20))},_checkColumnHeight:function(){var handler=this;$("div.layoutContainer > div.row > .pane").each(function(){var $col=$(this),height=handler._getColumnHeight($col);height!=$col.data("o-height")&&($col.trigger("heightChange"),$col.data("o-height",height))}),dnnLayoutEditor.LayoutHeightChange=setTimeout(function(){handler._checkColumnHeight()},20)},_getColumnHeight:function(col){var height=0;return col.children('.DnnModule:not([class~="floating"]), .handlerContainer:visible').each(function(){height+=$(this).outerHeight(!0)}),height>0&&(height+=parseInt(col.css("border-top-width"))+parseInt(col.css("border-bottom-width"))+parseInt(col.css("padding-top"))+parseInt(col.css("padding-bottom"))),parseInt(height)},_adjustColumnHeightHandler:function(){var maxCol,handler=this,maxHeight=0;this.container.find("> div.row > .pane").each(function(){if($(this).find("> .DnnModule").length>0){var $col=$(this),height=handler._getColumnHeight($col);height>maxHeight&&(maxHeight=height,maxCol=$col)}}),maxHeight>0&&(maxHeight<110&&(maxHeight=110),this.container.find("> div.row > .pane").each(function(){this.style.setProperty("min-height",maxHeight+"px","important")}))},_deleteLayoutHandler:function(e){var handler=this,opts={callbackTrue:function(){handler.container.find("div.DnnModule").each(function(){var moduleId=$(this).find("a").first().attr("name"),menu=$("#moduleActions-"+moduleId);menu.remove()}),handler._getService().request("DeleteLayout","GET",{layoutId:handler.container.data("layoutid")},function(data){0!=data.Status&&$.dnnAlert({text:data.Message}),dnn.ContentEditorManager.getModuleDialog()._resetPending(),handler._refreshPane("","",function(){dnnLayoutEditor.refreshContent(this),handler._refreshPane("ContentPane","",function(){dnnLayoutEditor.refreshContent(this)})})},function(xhr){handler._refreshPane("","",function(){dnnLayoutEditor.refreshContent(this)})})},text:dnn.ContentLayout.resources.deleteConfirm,yesText:dnn.ContentLayout.resources.confirmYes,noText:dnn.ContentLayout.resources.confirmNo,title:dnn.ContentLayout.resources.confirmTitle};return $.dnnConfirm(opts),!1},_getLayoutIndex:function(container){var parentPane=container.parent(),layoutId=container.data("layoutid"),items=parentPane.find("> .DnnModule, > .layoutContainer").not("[data-layoutid="+layoutId+"][id]");if(1==items.length)return-1;var findIndex=-1;return items.each(function(index,item){$(item).data("layoutid")&&$(item).data("layoutid")==layoutId&&(findIndex=index)}),findIndex},_refreshPane:function(paneName,args,callback){paneName||(paneName=this.container.parent().attr("id"));var moduleDialog=dnn.ContentEditorManager.getModuleDialog();moduleDialog.refreshPane(paneName,args,callback)},_getService:function(){return this._serviceController||(this._serviceController=new dnn.dnnModuleService({service:"EvoqContentLibrary",controller:"ContentEditor"})),this._serviceController}},dnnLayoutEditor.catchSortEvents=function(){$(".dnnSortable").each(function(){var instance=this;setTimeout(function(){var handle=$(instance).sortable("option","handle");handle+=", div.layout-toolbar a.btn-move",$(instance).sortable("option","handle",handle),$(instance).sortable("option","helper",function(event,element){if(element.hasClass("floating"))return element.addClass("forDrag");var helper=element.clone();helper.addClass("floating forDrag");var $dragHint=helper.find("> div.dnnDragHint"),$dragContent=$("<div />");$dragHint.append($dragContent);var title=helper.find('span[id$="titleLabel"]:eq(0)').html();return $('<span class="title" />').appendTo($dragContent).html(title),helper}),$(instance).sortable("option","cursorAt",{left:0,top:0}),$(instance).sortable("option","start")!=dnnLayoutEditor.sortStart&&($(instance).data("sortStartEvent",$(instance).sortable("option","start")),$(instance).sortable("option","start",dnnLayoutEditor.sortStart),$(instance).data("eventCatched")||($(instance).on("sortbeforestop",function(event,ui){var $newPane=ui.item.parent();if($newPane.sortable("option","stop")!=dnnLayoutEditor.sortStop){$newPane.data("sortStopEvent",$newPane.sortable("option","stop")),$newPane.sortable("option","stop",dnnLayoutEditor.sortStop);var $oldPane=$(event.target);$oldPane.sortable("option","stop")!=dnnLayoutEditor.sortStop&&($oldPane.data("sortStopEvent",$oldPane.sortable("option","stop")),$oldPane.sortable("option","stop",dnnLayoutEditor.sortStop))}}),$(instance).find("div.dnnDragHint").on("mousedown",dnnLayoutEditor.dragHandlerCheck),$(instance).data("eventCatched",!0)))},500)})},dnnLayoutEditor.refreshContent=function(pane){setTimeout(function(){dnnLayoutEditor.catchSortEvents(),$("div.actionMenu").show();var moduleDialog=dnn.ContentEditorManager.getModuleDialog(),cookieNewModuleId=moduleDialog.getModuleId();if(cookieNewModuleId){var newModule=pane.find("div.DnnModule-"+cookieNewModuleId);newModule.length>0&&(moduleDialog.setModuleId(-1),newModule.trigger("editmodule"))}},100)},dnnLayoutEditor.sortStart=function(event,ui){window.cem_dragging=!0,ui.item.hasClass("layoutContainer")?$("div.layoutContainer").addClass("dragging"):$(this).data("sortStartEvent").call(this,event,ui)},dnnLayoutEditor.sortStop=function(event,ui){var newPane=ui.item.parent(),oldPane=$(this),moveLayout=ui.item.hasClass("layoutContainer"),instance=this,$item=ui.item;if($item.hasClass("layoutContainer")?($item.removeClass("floating"),newPane.addClass("dnn-cl"),$("div.layoutContainer").removeClass("dragging")):($item.removeClass("floating").css({left:"",top:"",position:"",zIndex:""}),$(".actionMenu").removeClass("floating")),newPane.find("div.handlerContainer").hide(),$item.addClass("highlight").removeClass("drift forDrag"),setTimeout(function(){$item.addClass("animate")},1e3),setTimeout(function(){$item.removeClass("highlight animate")},1500),$("div.dnnDragHint").removeClass("dnnDragDisabled"),window.cem_dragging=!1,!$item.hasClass("layoutContainer")){var relatedModules=$item.data("relatedModules");if(relatedModules&&relatedModules.length>0)for(var serviceController=new dnn.dnnModuleService({service:"InternalServices",controller:"ModuleService",async:!1}),tabId=serviceController.getTabId(),i=0;i<relatedModules.length;i++){var moduleId=relatedModules[i],dataVar={TabId:tabId,ModuleId:moduleId,Pane:newPane.attr("id").replace("dnn_",""),ModuleOrder:-1},onSuccess=function(){dnn.ContentEditorManager.triggerChangeOnPageContentEvent()};serviceController.request("MoveModule","POST",dataVar,onSuccess)}}var updatePosition=function(pane,callback){var totalLayout=pane.children("div.layoutContainer").length,updated=0;0==totalLayout&&callback.call(pane),pane.children("div.DnnModule, div.layoutContainer").each(function(index,item){var $layout=$(item);if($layout.hasClass("layoutContainer")){var layoutEditor=$layout.data("dnnLayoutEditor"),layoutId=$layout.data("layoutid"),paneName=pane.attr("id").replace("dnn_","");layoutEditor.updatePosition(layoutId,paneName,index,function(){updated++,updated==totalLayout&&callback.call(pane)})}})},moduleDialog=dnn.ContentEditorManager.getModuleDialog(),refreshPane=function(){var oldPaneId=oldPane.attr("id"),newPaneId=newPane.attr("id");oldPane.data("parentpane")&&(oldPaneId=$("[id$="+oldPane.data("parentpane")+'][class~="dnnSortable"]').attr("id")),newPane.data("parentpane")&&(newPaneId=$("[id$="+newPane.data("parentpane")+'][class~="dnnSortable"]').attr("id")),moduleDialog.refreshPane(oldPaneId,"",function(){dnnLayoutEditor.refreshContent(this),newPaneId!=oldPaneId&&moduleDialog.refreshPane(newPaneId,"",function(){dnnLayoutEditor.refreshContent(this)})})},refreshContent=function(){moduleDialog._resetPending(),moveLayout?refreshPane():$(instance).data("sortStopEvent").call(instance,event,ui,function(){dnn.ContentEditorManager.triggerChangeOnPageContentEvent(),refreshPane()})};updatePosition(newPane,function(){newPane.attr("id")!=oldPane.attr("id")?updatePosition(oldPane,function(){refreshContent()}):refreshContent()})},dnnLayoutEditor.dragHandlerCheck=function(e){$(this).hasClass("dnnDragDisabled")&&e.stopImmediatePropagation()},$.fn.dnnLayoutEditor.defaultOptions={colMinWidth:10},$(document).ready(function(){function generateLayout(){return $('<div class="dnnDialogTitle"><span class="dnnButton back"></span><span class="title">'+dnn.ContentLayout.resources.title+'</span></div><div class="dnnDialogBody dnnLayoutList"><div class="listContainer"><ul></ul></div></div>')}var moduleDialog=dnn.ContentEditorManager.getModuleDialog();moduleDialog.getElement().on("dialoginit",function(e){var $this=$(this),moduleList=$this.find(".dnnModuleList ul"),layoutItem=$('<li class="dnnModuleItem dnnLayoutItem"><span class="icon content-layout"></span><span class="title">'+dnn.ContentLayout.resources.title+'</span><span class="actions"><a href="#" class="button addModule"></a></span></li>');moduleList.append(layoutItem);var pageLayout=generateLayout();moduleDialog.addPage("dnnLayout",pageLayout),layoutItem.click(function(){moduleDialog.showPage("dnnLayout")}),pageLayout.find(".dnnButton.back").click(function(){moduleDialog.showPage(0)})}),moduleDialog.getElement().on("dialogopen",function(e){var $this=$(this),moduleList=$this.find(".dnnModuleList ul"),parentPane=moduleDialog.getModuleManager().getPane().data("parentpane");null!=parentPane?moduleList.find("li.dnnLayoutItem").hide():moduleList.find("li.dnnLayoutItem").show()}),moduleDialog.getElement().on("addmodulecomplete",function(e){dnnLayoutEditor.catchSortEvents()});var _layoutInitialized=!1;moduleDialog.getElement().on("pageChanged",function(e,page){!_layoutInitialized&&page.hasClass("dnnLayout")&&(page.dnnModuleLayout(moduleDialog,{}),_layoutInitialized=!0)}),dnnLayoutEditor.catchSortEvents()}),$(window).load(function(){var handleNewLayoutFromCookie=function(){var cookieModuleId=dnn.dom.getCookie("CEM_CallbackData");if(cookieModuleId&&cookieModuleId.indexOf("layout-")>-1){var layoutId=cookieModuleId.substr(7),layout=$(".layoutContainer[data-layoutid="+layoutId+"]");layout.parent().find("div.DnnModule, .layoutContainer").length>1&&layout.data("dnnLayoutEditor").readyForDrag();var moduleDialog=dnn.ContentEditorManager.getModuleDialog();dnn.dom.setCookie("CEM_CallbackData","",-1,moduleDialog.getSiteRoot())}};setTimeout(handleNewLayoutFromCookie,250)})}(jQuery);