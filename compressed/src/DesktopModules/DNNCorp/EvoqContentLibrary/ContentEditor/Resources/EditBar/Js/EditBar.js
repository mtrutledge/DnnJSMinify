"undefined"!=typeof dnn&&null!==dnn||(dnn={}),dnn.EditBar=function($){"use strict";var _service,resx={},request=function(service,controller,method,type,params,callback,errorCallBack,sync){$.ajax({url:getServiceUrl(service,controller)+method,type:type,data:params,async:!sync,beforeSend:$.proxy(onBeforeSend,this),success:function(data){"function"==typeof callback&&callback(data)},error:function(xhr){"function"==typeof errorCallBack&&errorCallBack(xhr)}})},getService=function(){return _service||(_service=$.dnnSF()),_service},onBeforeSend=function(xhr){getService().setModuleHeaders(xhr)},getServiceUrl=function(service,controller){return getService().getServiceRoot(service)+controller+"/"},initAuthCheck=function(){$("#edit-bar .left-button").click(function(e){var authenticateUrl=getServiceUrl("EvoqContentLibrary","Common")+"CheckAuthorized";$.ajax({url:authenticateUrl,type:"GET",data:null,async:!1,beforeSend:$.proxy(onBeforeSend,this),success:function(data){},error:function(xhr){if(xhr&&"401"==xhr.status){var loginUrl=dnn.getVar("cem_loginurl");return"undefined"!=typeof window.dnnModal?window.dnnModal.show(loginUrl+(loginUrl.indexOf("?")==-1?"?":"&")+"popUp=true",!0,300,650,!0,""):location.href=loginUrl,void e.stopImmediatePropagation()}}})})},initAddModuleButton=function(){var $button=$("#edit-bar .AddModule");$button.click(function(){var dialog=dnn.ContentEditorManager.getModuleDialog(),contentPane=dialog.getDefaultPane(),moduleManager=contentPane.data("dnnModuleManager");moduleManager&&moduleManager.getHandler().click()})},initPageSettingsButton=function(){var $button=$("#edit-bar .Settings");"template"==dnn.getVar("cem_pagetype")?$button.hide():$button.click(function(){openPageSetting("edit")})},initPrivatePageButton=function(){var $button=$("#edit-bar .private-page");"template"==dnn.getVar("cem_pagetype")?$button.hide():($button.css("cursor","pointer"),$button.click(function(){openPageSetting("edit",[null,1])}))},openPageSetting=function(view,params){var personaBar=$("#personaBar-iframe"),$$=personaBar[0].contentWindow.jQuery;!function($){var pagesPanel=$("#pages-panel"),btnPages=$('li[data-panel-id="#pages-panel"]');pagesPanel.data("init-view",view),params&&pagesPanel.data("init-view-params",params);var pageSettingsContainer=pagesPanel.find(".pageSettingsContainer");pageSettingsContainer.hide(),btnPages.click(),$("body").on("click",".btn_showsite",pageEditComplete)}($$)},pageEditComplete=function(){var personaBar=$("#personaBar-iframe"),$$=personaBar[0].contentWindow.jQuery;!function($){$("body").off("click",".btn_showsite",pageEditComplete)}($$),null!=window.CEM_EditBar._workflowManager&&(window.CEM_EditBar._workflowManager.getPublishingState(),window.CEM_EditBar._workflowManager.isPrivatePage())},EditBar=function(resxSettings){var self=this;this._previewModeManager=PreviewModeManager.getInstance(),this._pageHistoryManager=new PageHistoryVersionModel,this._pageHistoryManager.request=request,this._pageHistoryManager.previewModeTypes=ViewMode.PreviewModeTypes,this._pageHistoryManager.previewModeManager=self._previewModeManager,this._workflowManager=null,this.koScopes={},this._showPublishingControls=function(visible){null!=this._workflowManager?this._workflowManager.hasPendingChanges(visible):this._hasPendingChanges=visible},this._getPageVersions=function(cb){request("EvoqContentLibrary","Versions","GetPageVersions","get",{},function(data){self.koScopes.history||(self.koScopes.history=self._pageHistoryManager),self.koScopes.history.clearVersions();for(var i=0;i<data.length;i++){var state,version=data[i];version.State||(state=version.IsPublished?"Published":"Draft"),version.IsCurrentVersion&&(self._pageHistoryManager.currentVersion=version.VersionNumber),self.koScopes.history.addVersion(version.VersionNumber,version.Date,version.User,state,version.IsPublished,version.IsCurrentVersion)}data[0]&&(self._previewModeManager.version=data[0].VersionNumber,null!=self._workflowManager?self._workflowManager.updateHistoryList():self._updateHistoryList=!0),cb&&"function"==typeof cb&&cb()},function(){})},this._pageContentChanged=function(){var params={};request("EvoqContentLibrary","PageManagement","DeleteThumbnails","POST",params,function(data){},function(){},!0)},this._pageHistoryManager.getPageVersions=this._getPageVersions,this._revomeUnusefulButtonsForAdmins=function(){$(".notForPageEditors").remove()},this._revomeUnusefulButtonsWhenVersioningDisabled=function(){$(".notIfVersionsDisabled").remove()},this.applyChangeTriggerToEditBar=function(){$("*","#edit-bar").not(".noChangeTrigger").each(function(i,element){var $element=$(element),events=$._data($element[0],"events");"undefined"!=typeof events&&null!==events.click&&$element.click(function(){$(document).trigger("dnnActionOnEditBar",element)})})};var resxCallback200=function(response){resx=response.localization,self._workflowManager=new window.dnn.pageWorkflow.PageWorkflowManager(request,self._pageHistoryManager,resx,getService(),"true"===dnn.getVar("dnn_history_hasPendingChanges")),"undefined"!=typeof self._hasPendingChanges&&(self._workflowManager.hasPendingChanges(self._hasPendingChanges),self._hasPendingChanges=void 0),"undefined"!=typeof self._updateHistoryList&&(self._workflowManager.updateHistoryList(),self._updateHistoryList=void 0),self.koScopes.resx=resx,self.koScopes.history=self._pageHistoryManager,self.koScopes.workflow=self._workflowManager.getViewModel(),ko.applyBindings(self.koScopes,document.getElementById("editBarContainer")),self._pageHistoryManager.resx=resx,self._getPageVersions(),self.applyChangeTriggerToEditBar(),$(document).trigger("dnnEditBarActive")};this.initUI=function(){self._previewModeManager.initViewMode(),initAuthCheck();var isPageEditor=dnn.getVar("cem_isPageEditor").toLowerCase();"true"!=isPageEditor?($("#editBarContainer").addClass("personaBarShown"),initAddModuleButton(),initPageSettingsButton(),initPrivatePageButton()):self._revomeUnusefulButtonsForAdmins();var isModuleEditor=dnn.getVar("cem_isModuleEditor").toLowerCase();"true"==isModuleEditor&&$(".notForModuleEditors").remove();var versionsEnabled=dnn_tabVersioningEnabled;versionsEnabled||self._revomeUnusefulButtonsWhenVersioningDisabled();var localizationOptions={service:"EvoqContentLibrary",controller:"Localization",resxName:"EditBarResx",resourceSettings:{local:resxSettings},resources:{method:"GetTable",paramName:null,callback200:resxCallback200,callbackError:null}};new dnn.utils.Localization(localizationOptions)},$(document).on("changeOnPageContent",function(){dnn_tabVersioningEnabled||dnn_tabWorkflowEnabled?(self._showPublishingControls(!0),self._getPageVersions()):self._pageContentChanged()}).on("personabaropened",function(){$("#edit-bar").hide(),setTimeout(function(){$("#edit-bar").show()},0)})};return EditBar}(jQuery||$),$(window).load(function(){$.get(dnn.getVar("cem_resourceroot")+"/EditBar/Html/edit-bar.html",function(data){$("#Body").append(data);var resxSettings={culture:dnn.getVar("cem_editBar_resx_culture"),resxTimeStamp:dnn.getVar("cem_editBar_resx_timestamp")},editBar=window.CEM_EditBar=new dnn.EditBar(resxSettings);editBar.initUI(),$(".editbar").animate({bottom:0},100,"linear")})});