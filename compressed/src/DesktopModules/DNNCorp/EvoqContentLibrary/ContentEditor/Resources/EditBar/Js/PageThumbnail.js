var WebPageThumbnailGenerator=function(options){this.options=options,this.init()};WebPageThumbnailGenerator.prototype={constructor:WebPageThumbnailGenerator,init:function(){var options=this.options=$.extend({},WebPageThumbnailGenerator.defaultOptions,this.options);this.pageId=-1,options.pageId&&options.pageId>0&&(this.pageId=options.pageId),this.minHeight=480,this.imageRatio=1.333333333333333,this._onCanvasRenderHandler=$.proxy(this._onCanvasRender,this),this._onPageLoadedHandler=$.proxy(this._onPageLoaded,this),this._onCanvasToBlobHandler=$.proxy(this._onCanvasToBlob,this)},createThumbnails:function(){this.contentDocument=$(document.body),html2canvas([this.contentDocument[0]],{onrendered:this._onCanvasRenderHandler,useCORS:!1,proxy:this._getServiceUrl()+"GetImageProxy"})},_onCanvasRender:function(canvas){var handler=this,postData={postfile:canvas.toDataURL(),pageId:this.pageId,area:this._calculateArea()},serviceUrl=this._getServiceUrl()+"CreateThumbnails";$.ajax({url:serviceUrl,beforeSend:$.dnnSF().ServicesFramework().setModuleHeaders,data:postData,cache:!1,type:"POST",success:function(data){!function(jq){jq(window.parent.document.body).trigger("thumbnailcreated",[{pageId:handler.pageId,thumbnails:data.Thumbnails}])}(window.parent.$)}})},_getServiceUrl:function(){var $dnnSF=$.dnnSF().ServicesFramework();return $dnnSF.getServiceRoot("EvoqContentLibrary")+"Thumbnails/"},_calculateArea:function(){var left,right,top,bottom,paneElements=this.contentDocument.find("[data-ispane]"),logoElement=this.contentDocument.find('[id$="dnnLOGO_imgLogo"]');paneElements.filter(":not(:empty)").length>0?(left=Math.min.apply(null,paneElements.filter(":not(:empty)").map(function(){return $(this).offset().left}).get()),right=Math.max.apply(null,paneElements.filter(":not(:empty)").map(function(){return $(this).offset().left+$(this).outerWidth()}).get())):(left=Math.min.apply(null,paneElements.map(function(){return $(this).offset().left}).get()),right=Math.max.apply(null,paneElements.map(function(){return $(this).offset().left+$(this).outerWidth()}).get())),top=Math.min.apply(null,paneElements.map(function(){return $(this).offset().top}).get()),bottom=Math.max.apply(null,paneElements.map(function(){return $(this).offset().top+$(this).outerHeight()}).get());var width=right-left,height=bottom-top;return height<this.minHeight?(logoElement.length>0?(left=logoElement.offset().left,top=logoElement.offset().top):left=top=0,width=right-left,height=width/this.imageRatio):height=width/height>this.imageRatio?width/this.imageRatio:width/this.imageRatio,[left,top,width,height]}},WebPageThumbnailGenerator.defaultOptions={};