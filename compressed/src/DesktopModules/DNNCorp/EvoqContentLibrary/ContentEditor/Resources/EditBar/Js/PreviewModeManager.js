var ViewMode=function($){"use strict";var ViewMode=function(name,viewId,portraitWidth,portraitHeigth){this.name=name,this.viewId=viewId,portraitWidth&&portraitHeigth?(this.mobileDevice=!0,this.portraitWidth=portraitWidth,this.portraitHeigth=portraitHeigth,this.landscapeWidth=portraitHeigth,this.landscapeHeigth=portraitWidth):(this.mobileDevice=!1,this.portraitWidth="100%")};return ViewMode.PreviewModeTypes={},ViewMode.PreviewModeTypes.Desktop=new ViewMode("desktop",".DesktopModeButton"),ViewMode.PreviewModeTypes.Phone=new ViewMode("phone",".PhoneModeButton",265,463),ViewMode.PreviewModeTypes.Tablet=new ViewMode("tablet",".TabletModeButton",605,808),ViewMode.MobileViewTypes={},ViewMode.MobileViewTypes.Portrait=".Portrait",ViewMode.MobileViewTypes.Landscape=".Landscape",ViewMode}(jQuery||$),PreviewModeManager=function($){"use strict";function checkAuthenticationPreview(handleData){var service=$.dnnSF?$.dnnSF(-1):null,url=service.getServiceRoot("EvoqContentLibrary")+"Common/CheckAuthorized";$.ajax({url:url,type:"GET",beforeSend:service.setModuleHeaders,success:function(data){handleData(data)}})}var PreviewModeManager=function(){var self=this;this._service=$.dnnSF(),this._request=function(service,controller,method,type,params,callback,errorCallBack){$.ajax({url:self._getServiceUrl(service,controller)+method,type:type,data:params,beforeSend:$.proxy(self._beforeSend,this),complete:$.proxy(self._completeRequest,this),success:function(data){"function"==typeof callback&&callback(data)},error:function(xhr){"function"==typeof errorCallBack&&errorCallBack(xhr)}})},this._beforeSend=function(xhr){self._service.setModuleHeaders(xhr)},this._completeRequest=function(xhr,status){},this._getServiceUrl=function(service,controller){return self._service.getServiceRoot(service)+controller+"/"},this._selectedViewMode,this._selectedMobileOrientation,this.version=-1,this.beforeCloseCallback=null,this.url=null,this.tabVersionQueryStringParameter=dnn_tabVersionQueryStringParameter,this._setDefaultMode=function(){self._selectedViewMode=ViewMode.PreviewModeTypes.Desktop,self._selectedMobileOrientation=ViewMode.MobileViewTypes.Portrait},this._getDefaultUserPreviewMode=function(){this._request("EvoqContentLibrary","Common","GetUserSetting","get",{key:"Usability:PreviewMode"},function(data){if(!data.Value)return void self._setDefaultMode();var mode=$.parseJSON(data.Value);mode.mobileOrientationId&&($(mode.mobileOrientationId).addClass("selected"),self._selectedMobileOrientation=mode.mobileOrientationId)},function(){self._setDefaultMode()})},this._sendDefaultUserPreviewMode=function(){var orientationIdAttribute="";self._selectedMobileOrientation&&(orientationIdAttribute=', "mobileOrientationId": "'+self._selectedMobileOrientation+'"');var value='{ "viewModeId": "'+self._selectedViewMode.viewId+'"'+orientationIdAttribute+" }";this._request("EvoqContentLibrary","Common","SetUserSetting","post",{Key:"Usability:PreviewMode",Value:value},function(data){},function(){})},this._isSmallScreen=function(){var width=$("#Body").width(),height=$("#Body").height();return width<1024||height<600},this.initViewMode=function(){self._isSmallScreen()&&$(".TabletModeButton").hide(),$(".previewModeOptions").hide();var mode=ViewMode.PreviewModeTypes.Desktop.viewId;$(mode).click(self.openDesktopMode),mode=ViewMode.PreviewModeTypes.Phone.viewId,$(mode).click(self.openPhoneMode),mode=ViewMode.PreviewModeTypes.Tablet.viewId,$(mode).click(self.openTabletMode);var portraitOption=$(".Portrait");$(portraitOption).click(self.showPortait);var landscapeOption=$(".Landscape");$(landscapeOption).click(self.showLandscape);var closeOption=$(".ClosePreviewMode");$(closeOption).click(self.hidePreview),self._getDefaultUserPreviewMode()},this.removeViewModeSelected=function(){$(".ViewMenuButton.selected").removeClass("selected"),$(".MobileOptionButton.selected").removeClass("selected")},this.showMobileOptions=function(){$(".editbar .mobileOptions").show(),$(".editbar .notInPreviewMode").hide()},this.hideMobileOptions=function(){$(".editbar .mobileOptions").hide()},this.showDesktopOptions=function(){$(".editbar .desktopOptions").show(),$(".editbar .notInPreviewMode").hide()},this.hideDesktopOptions=function(){$(".editbar .desktopOptions").hide()},this._changeSelectedPreviewMode=function(mode,mobileOrientation){self._selectedViewMode=mode,self._selectedMobileOrientation=mobileOrientation,self._sendDefaultUserPreviewMode()},this._previewMustBeRefreshed=function(viewId){var container=$(".previewModeContainer");return!self._isShow(container)||self._selectedViewMode&&viewId!=self._selectedViewMode.viewId},this.openDesktopMode=function(){checkAuthenticationPreview(function(output){var mode=ViewMode.PreviewModeTypes.Desktop.viewId;self._previewMustBeRefreshed(mode)&&(self._selectedViewMode=ViewMode.PreviewModeTypes.Desktop,self.removeViewModeSelected(),self.hideMobileOptions(),self.showDesktopOptions(),self.showPreview())})},this.openPhoneMode=function(){checkAuthenticationPreview(function(output){var mode=ViewMode.PreviewModeTypes.Phone.viewId;self._previewMustBeRefreshed(mode)&&(self._selectedViewMode=ViewMode.PreviewModeTypes.Phone,self.removeViewModeSelected(),self.hideDesktopOptions(),self.showMobileOptions(),self.showPreview())})},this.openTabletMode=function(){checkAuthenticationPreview(function(output){var mode=ViewMode.PreviewModeTypes.Tablet.viewId;self._previewMustBeRefreshed(mode)&&(self._selectedViewMode=ViewMode.PreviewModeTypes.Tablet,self.removeViewModeSelected(),self.hideDesktopOptions(),self.showMobileOptions(),self.showPreview())})},this.showPortait=function(event){$(".Portrait").addClass("selected"),$(".Landscape").removeClass("selected"),self._selectedMobileOrientation=ViewMode.MobileViewTypes.Portrait,self.showPreview()},this.showLandscape=function(event){$(".Landscape").addClass("selected"),$(".Portrait").removeClass("selected"),self._selectedMobileOrientation=ViewMode.MobileViewTypes.Landscape,self.showPreview()},this._getIFrameUrl=function(){var iframeUrl;return iframeUrl=self.url||"object"!=typeof window.top?self.url:window.top.location.href,iframeUrl&&(iframeUrl+=iframeUrl.indexOf("?")>0?"&dnnprintmode=true":"?dnnprintmode=true",self.version!=-1&&(iframeUrl+="&"+self.tabVersionQueryStringParameter+"="+self.version)),iframeUrl},this._isShow=function(element){return element.is(":visible")},this._updateIframe=function(container,viewModeType,mobileViewType){var iframeUrl=self._getIFrameUrl(),iframe=$("#previewModeFrame");iframe.attr("src",iframeUrl),viewModeType.mobileDevice||(viewModeType.portraitHeigth="100%",viewModeType.portraitWidth="100%");var iframeHeigth=viewModeType.portraitHeigth,iframeWidth=viewModeType.portraitWidth;viewModeType.mobileDevice&&mobileViewType==ViewMode.MobileViewTypes.Landscape&&(iframeHeigth=viewModeType.landscapeHeigth,iframeWidth=viewModeType.landscapeWidth),iframe.height(iframeHeigth),iframe.width(iframeWidth),iframe.load(function(){self.applyMaskToPreview(iframe.contents())})},this._updatePreviewModeImage=function(container,viewMode,mobileViewType){$("#previewModeImage").removeClass();var image=$("#previewModeImage");if(viewMode.mobileDevice){var mobileImageSuffix=mobileViewType.toLowerCase().substring(1);image.addClass(viewMode.name+"-"+mobileImageSuffix),image.css("top",(container.height()-image.height())/2+"px")}else image.addClass(viewMode.name),image.css("top","0px")},this.applyMaskToPreview=function(iframeContents){this.tabVersionMask="<div id='dnnTabVersionMask'></div><style type='text/css'>#dnnTabVersionMask { position: absolute; left: 0; top: 0; width: 100%; height: 100%; z-index: 9999; background-color: trasparent; }</style>";var iframeBody=iframeContents.find("body");iframeBody.append(self.tabVersionMask),iframeBody.find("#dnnTabVersionMask").height(iframeContents.height())},this.hidePreview=function(){$(".previewModeOptions").hide();var container=$(".previewModeContainer");container.hide(),$("html, body").css({overflow:""}),$(".editbar .notInPreviewMode").show(),self.beforeCloseCallback&&"function"==typeof self.beforeCloseCallback&&self.beforeCloseCallback()},this.showPreview=function(){var viewModeHighlighted=$(".ViewMenuButton.selected");!self._selectedViewMode&&viewModeHighlighted&&$.each(ViewMode.PreviewModeTypes,function(key,type){type.viewId=="."+$(".ViewMenuButton.selected").attr("id")&&(self._selectedViewMode=this)}),self._selectedMobileOrientation||(self._selectedMobileOrientation=ViewMode.MobileViewTypes.Portrait);var viewModeType=self._selectedViewMode,mobileViewType=self._selectedMobileOrientation;viewModeType.mobileDevice&&$(mobileViewType).addClass("selected"),self.showCustomPreview(viewModeType,mobileViewType),self._changeSelectedPreviewMode(self._selectedViewMode,self._selectedMobileOrientation)},this.showCustomPreview=function(viewModeType,mobileViewType){self._selectedViewMode=viewModeType,$(".previewModeOptions").show();var container=$(".previewModeContainer");self._isShow(container)||$("html, body").css({overflow:"hidden"}),self._updatePreviewModeImage(container,viewModeType,mobileViewType),self._updateIframe(container,viewModeType,mobileViewType),self._isShow(container)||container.show()}};return PreviewModeManager.instance=null,PreviewModeManager.getInstance=function(){return PreviewModeManager.instance||(PreviewModeManager.instance=new PreviewModeManager),PreviewModeManager.instance},PreviewModeManager}(jQuery||$);