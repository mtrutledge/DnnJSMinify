window.dnn=window.dnn||{},window.dnn.pageWorkflow=window.dnn.pageWorkflow||{},function(){var PageWorkflowManagerClass;PageWorkflowManagerClass=function(){"use strict";function PageWorkflowManager(request,historyManager,resx,services,hasPendingChanges){var agent,osx,dropMsg,loadingMsg;switch(_request=request,_pageHistoryManager=historyManager,_resx=resx,_services=services,_hasPendingChanges=hasPendingChanges,dropMsg=_resx.workflow_approval_reject_image_label.replace("{0}","browse").replace("{1}",'data-bind="openBrowser"'),_htmlApprovalReject=_htmlApprovalReject.replace(/DROP_MSG/m,dropMsg),loadingMsg=_resx.workflow_approval_reject_loadingDropZone_label,_htmlApprovalReject=_htmlApprovalReject.replace(/LOADING_MSG/m,loadingMsg),agent=navigator.userAgent,osx=agent.search(/Macintosh/i)!==-1?"osx":"",!0){case agent.search(/msie|\.net/i)!==-1:_browser="ie";break;case agent.search(/Firefox/i)!==-1:_browser="ff"+osx;break;case agent.search(/Chrome/i)!==-1:_browser="chrome";break;default:_browser="unknown"}createViewModel(),getPublishingState(),isPrivatePage(),ko.bindingHandlers.startProgressBar={init:function(element,valueAccessor){var $element,TIME_PROGRESS_BAR_SAVE_LAYER;$element=$(element),TIME_PROGRESS_BAR_SAVE_LAYER=4e3,$element.append('<div class="progressBar" style="width: 0;"></div>'),$element.is(":visible")&&$(".progressBar",$element).animate({width:"99%"},TIME_PROGRESS_BAR_SAVE_LAYER)}},ko.bindingHandlers.fileUpload={init:function(element,valueAccessor){function getSubmitFolderInfo200Callback(data){_submitViewModel.dropZoneAvailable(!0);var el=$(element);el.EditBarWorkflowImageUpload({paintInObj:el.closest(".workflowManagerDropZone").find(".paintImageZone"),addElementDragover:el.closest(".workflowManagerDropZone"),url:_services.getServiceRoot("internalservices")+"FileUpload/PostFile",request:{folder:data.UploadImageInfo.FolderPath,filter:data.UploadImageInfo.ExtensionsFilter,overwrite:"true"},imageCallbackInfo:_imageCallbackInfo,paramName:"POSTFILE",servicesFramework:_services,param:valueAccessor()})}_submitViewModel.dropZoneAvailable(!1),_request("EvoqContentLibrary","Publishing","GetImageUploadInfo","get",null,getSubmitFolderInfo200Callback,getSubmitFolderInfoErrorCallback)}},ko.bindingHandlers.openBrowser={init:function(element,valueAccessor){var el=$(element);el.on("click",function(){el.closest(".workflowManagerDropZone").find(".uploadFileInput").trigger("click")})}}}var _browser,_request,_resx,_services,_state,_hasPendingChanges,_viewModel,_pageHistoryManager,_editBarDialog,_imageCallbackInfo,_htmlSubmit,_htmlApprovalReject,_submitViewModel,_canEditThePage,toggleUserMode,doActionAfterDiscarding,confirmAction,submit,approve,viewModelSubmitCallback,viewModelAproveCallback,viewModelDiscardCallback,viewModelRejectCallback,goNextOnSubmitCallback,goNextOnApprovalCallback,onCancelConfirmDialogCallback,goPrevious,rejectCallback,discardWithComment,discardWithCommentCallback,publish,discard,close,createViewModel,isPrivatePage,getPublishingState,getPublishingState200Callback,getPublishingStateErrorCallback,getSubmitFolderInfoErrorCallback,manageRequestError,publishingStateHasToBeUpdated,updateStateIfNeeded,configureVisibleControls,printInfo;return PageWorkflowManager.class="PageWorkflowManager",PageWorkflowManager.type="Class",_imageCallbackInfo={},_htmlSubmit='<div class="PageWorkflowMangaer message"><textarea rows="8" data-bind="value: message, valueUpdate: \'afterkeydown\'"></textarea></div>',_htmlApprovalReject='<div class="EditBarDialog message" data-bind="css: browser"><textarea rows="8" data-bind="value: message, valueUpdate: \'afterkeydown\'"></textarea><ul class="errors" data-bind="foreach: messageErrors"><li><span class="backError" data-bind="text: Description"></span></li></ul></div><div class="workflowManagerDropZone"><div class="loadingDropZone" data-bind="startProgressBar, visible: !dropZoneAvailable()">LOADING_MSG</div><div class="fileUploadZone" data-bind="fileUpload, visible: dropZoneAvailable()"><input type="file" class="uploadFileInput normalFileUpload" /><div class="paintImageZone"></div><div class="dropMessage">DROP_MSG</div></div></div>',confirmAction=function(options,yesAction,noAction){$("<div class='dnnDialog'></div>").html(options.dialogText).dialog({modal:!0,autoOpen:!0,dialogClass:"dnnFormPopup",width:400,height:215,resizable:!1,title:options.dialogTitle,buttons:[{id:"delete_button",text:options.yesText,class:"dnnPrimaryAction",click:function(){$(this).dialog("close"),yesAction&&"function"==typeof yesAction&&yesAction()}},{id:"cancel_button",text:options.noText,click:function(){$(this).dialog("close"),noAction&&"function"==typeof noAction&&noAction()},class:"dnnSecondaryAction"}]})},publishingStateHasToBeUpdated=function(){return _state&&_state.IsCompleteWorkflow},isPrivatePage=function(){_request("EvoqContentLibrary","Common","IsPrivatePage","get",null,function(data){_viewModel.isPrivatePage(data)},getPublishingStateErrorCallback)},getPublishingState=function(){_request("EvoqContentLibrary","Publishing","GetPublishingState","get",null,getPublishingState200Callback,getPublishingStateErrorCallback)},updateStateIfNeeded=function(){publishingStateHasToBeUpdated()?getPublishingState():configureVisibleControls()},createViewModel=function(){_viewModel={close:close,goPrevious:goPrevious,submit:submit,approve:approve,isApprovalAction:ko.observable(!1),publish:publish,discard:discard,discardWithComment:discardWithComment,hasPrevious:ko.observable(!1),hasNext:ko.observable(!1),isPublishAvailable:ko.observable(!1),isDiscardAvailable:ko.observable(!1),isDiscardWithCommentAvailable:ko.observable(!1),isCloseAvailable:ko.observable(!1),isSaveDraftAvailable:ko.observable(!1),isEditableByUser:ko.observable(!1),hasPendingChanges:ko.observable(_hasPendingChanges),info:ko.observable(""),isPrivatePage:ko.observable(!1),isConfirmDialogOpen:ko.observable(!1),isPublishing:ko.observable(!1),dropZoneAvailable:ko.observable(!1)}},printInfo=function(){if(!_state)return"";var isEditor=_canEditThePage(_state),isEditorOnDraft=isEditor&&null===_state.PreviousState,editableInfo=_state.IsEditableByUser||isEditorOnDraft?_resx.message_ChangesNotPublished:_resx.workflow_hasStateReviewerPermission_errorMessage,workflowInfo=_state.IsCompleteWorkflow?"":editableInfo;return workflowInfo},getPublishingState200Callback=function(data){_state=data.State,PageWorkflowManager.prototype.updateHistoryList(),configureVisibleControls()},getPublishingStateErrorCallback=function(e){_viewModel.isPublishing(!1),manageRequestError(e)},getSubmitFolderInfoErrorCallback=function(e){manageRequestError(e)},manageRequestError=function(e){var response,message;500==e.status?(response=$.parseJSON(e.responseText),message=response.ExceptionMessage||response.Message,$.dnnAlert({title:_resx.WorkFlowErrorTitle,text:message?message.replace(/^"(.+(?="$))"$/,"$1"):""})):(response=$.parseJSON(e.responseText),message=response.Message,$.dnnAlert({title:_resx.WorkFlowErrorTitle,text:message}))},_canEditThePage=function(state){var isPageEditor=dnn.getVar("cem_isPageEditor").toLowerCase();return"true"==isPageEditor&&null===state.PreviousState},configureVisibleControls=function(){if(_state){var isEditor=_canEditThePage(_state);_viewModel.isEditableByUser(_state.IsEditableByUser||isEditor),_viewModel.hasPrevious(_viewModel.isEditableByUser()&&_viewModel.hasPendingChanges()&&_state.PreviousState),_viewModel.hasNext(_viewModel.isEditableByUser()&&_viewModel.hasPendingChanges()&&!_state.ReadyToBePublished&&_state.NextState),_viewModel.isPublishAvailable(_viewModel.isEditableByUser()&&_viewModel.hasPendingChanges()&&_state.ReadyToBePublished),_viewModel.isDiscardAvailable(_viewModel.isEditableByUser()&&_viewModel.hasPendingChanges()&&!_state.PreviousState),_viewModel.isDiscardWithCommentAvailable(_viewModel.isEditableByUser()&&!_viewModel.isDiscardAvailable()),_viewModel.isSaveDraftAvailable(_viewModel.isEditableByUser()&&_viewModel.hasPendingChanges()&&_state.IsSaveDraftWorkflow);var isCloseAvailableSaveDraftWorkflow=_state.IsSaveDraftWorkflow&&!_viewModel.hasPendingChanges()&&(!_viewModel.isEditableByUser()||_state.CanStayInDraft),isCloseAvailableOtherWorkflows=!_state.IsSaveDraftWorkflow&&(!_viewModel.hasPendingChanges()||!_viewModel.isEditableByUser()||_state.CanStayInDraft);_viewModel.isCloseAvailable(isCloseAvailableSaveDraftWorkflow||isCloseAvailableOtherWorkflows),_viewModel.isApprovalAction(!_state.ReadyToBePublished&&_state.PreviousState),_viewModel.info(printInfo())}},toggleUserMode=function(mode){_request("internalservices","controlBar","ToggleUserMode","post",{UserMode:mode},function(){"EDIT"!==mode&&(document.cookie=document.cookie.replace("StayInEditMode=YES","StayInEditMode=NO")),window.location.reload()},function(){})},close=function closeHandler(){return window.dnn.utils.PendingSavesManager.hasPendingSaves()?void window.dnn.utils.PendingSavesManager.addListenerWhenNoPendingSaves($.proxy(closeHandler,this)):void toggleUserMode("VIEW")},viewModelSubmitCallback=function(){return _submitViewModel={browser:_browser,message:ko.observable(""),messageErrors:ko.observableArray([]),dropZoneAvailable:ko.observable(!1)}},viewModelAproveCallback=function(){return _submitViewModel={browser:_browser,message:ko.observable(""),messageErrors:ko.observableArray([]),dropZoneAvailable:ko.observable(!1)}},viewModelDiscardCallback=function(){return _submitViewModel={browser:_browser,message:ko.observable(""),messageErrors:ko.observableArray([]),dropZoneAvailable:ko.observable(!1)}},viewModelRejectCallback=function(){return _submitViewModel={browser:_browser,message:ko.observable("").extend({required:!0}),messageErrors:ko.observableArray([]),dropZoneAvailable:ko.observable(!1)},_submitViewModel.enableAcceptForDialog=function(){return 0===_submitViewModel.message().length&&(_submitViewModel.message(" "),_submitViewModel.message("")),_submitViewModel.message.isValid()},_submitViewModel},goNextOnSubmitCallback=function goNextOnSubmitCallbackHandler(){return window.dnn.utils.PendingSavesManager.hasPendingSaves()?void window.dnn.utils.PendingSavesManager.addListenerWhenNoPendingSaves($.proxy(goNextOnSubmitCallbackHandler,this)):void _request("EvoqContentLibrary","Publishing","SubmitChanges","post",{CurrentStateId:_state.CurrentState.StateID,Message:_submitViewModel.message()},getPublishingState200Callback,getPublishingStateErrorCallback)},goNextOnApprovalCallback=function goNextOnApprovalCallbackHandler(){if(window.dnn.utils.PendingSavesManager.hasPendingSaves())return void window.dnn.utils.PendingSavesManager.addListenerWhenNoPendingSaves($.proxy(goNextOnApprovalCallbackHandler,this));var params={CurrentStateId:_state.CurrentState.StateID,Message:_submitViewModel.message()};_imageCallbackInfo.filePath&&(params.ImagePath=_imageCallbackInfo.filePath,params.ImageId=_imageCallbackInfo.fileId),_request("EvoqContentLibrary","Publishing","SubmitChanges","post",params,getPublishingState200Callback,getPublishingStateErrorCallback)},rejectCallback=function rejectCallbackHandler(){if(window.dnn.utils.PendingSavesManager.hasPendingSaves())return void window.dnn.utils.PendingSavesManager.addListenerWhenNoPendingSaves($.proxy(rejectCallbackHandler,this));if(_submitViewModel.message.isValid){var params={CurrentStateId:_state.CurrentState.StateID,Message:_submitViewModel.message()};_imageCallbackInfo.filePath&&(params.ImagePath=_imageCallbackInfo.filePath,params.ImageId=_imageCallbackInfo.fileId),_request("EvoqContentLibrary","Publishing","RejectChanges","post",params,getPublishingState200Callback,getPublishingStateErrorCallback)}},onCancelConfirmDialogCallback=function(){_viewModel.isConfirmDialogOpen(!1)},submit=function(){_viewModel.isConfirmDialogOpen()||(_viewModel.isConfirmDialogOpen(!0),_imageCallbackInfo={},_editBarDialog=new window.dnn.editBar.EditBarDialog({width:419,title:_resx.workflow_submit_title,innerTitle:_resx.workflow_submit_innerTitle,cancelBtnLbl:_resx.WorkFlowDiscardConfirmCancel,acceptBtnLbl:_resx.workflows_submit_accept_btn,showAcceptBtn:!0,onAcceptCallback:goNextOnSubmitCallback,onCancelCallback:onCancelConfirmDialogCallback,onCloseCallback:onCancelConfirmDialogCallback},_htmlSubmit,viewModelSubmitCallback,null))},approve=function(){_viewModel.isConfirmDialogOpen()||(_viewModel.isConfirmDialogOpen(!0),_imageCallbackInfo={},_editBarDialog=new window.dnn.editBar.EditBarDialog({width:419,title:_resx.workflow_approval_title,innerTitle:_resx.workflow_approval_innerTitle,cancelBtnLbl:_resx.workflows_common_cancel_btn,acceptBtnLbl:_resx.workflows_approve_accept_btn,showAcceptBtn:!0,onAcceptCallback:goNextOnApprovalCallback,onCancelCallback:onCancelConfirmDialogCallback,onCloseCallback:onCancelConfirmDialogCallback},_htmlApprovalReject,viewModelAproveCallback,null))},goPrevious=function(){_viewModel.isConfirmDialogOpen()||(_viewModel.isConfirmDialogOpen(!0),_imageCallbackInfo={},_editBarDialog=new window.dnn.editBar.EditBarDialog({width:419,title:_resx.workflow_rejection_title,innerTitle:_resx.workflow_rejection_innerTitle,cancelBtnLbl:_resx.workflows_common_cancel_btn,acceptBtnLbl:_resx.workflows_reject_accept_btn,showAcceptBtn:!0,onAcceptCallback:rejectCallback,onCancelCallback:onCancelConfirmDialogCallback,onCloseCallback:onCancelConfirmDialogCallback},_htmlApprovalReject,viewModelRejectCallback,null))},publish=function(){if(!_viewModel.isPublishing()){_viewModel.isPublishing(!0);var sendPublishRequest=function(){if(_request&&"function"==typeof _request){var params={CurrentStateId:_state.CurrentState.StateID};_request("EvoqContentLibrary","Publishing","PublishTab","post",params,function(){$.dnnNotif({dialogClass:"noTittle",height:50,outline:"none",styleBlue:!0,text:_resx.page_published_successfully,onCloseCallback:function(){toggleUserMode("VIEW")}})},getPublishingStateErrorCallback)}};return window.dnn.utils.PendingSavesManager.hasPendingSaves()?void window.dnn.utils.PendingSavesManager.addListenerWhenNoPendingSaves($.proxy(sendPublishRequest,this)):void sendPublishRequest()}},doActionAfterDiscarding=function(data){if(data.TabDeleted===!0){var urlToNavigate=dnn.getVar("dnn_urlWhenDiscardActionDeletesTab");window.location.href=urlToNavigate}else toggleUserMode("VIEW")},discardWithComment=function(){_imageCallbackInfo={},_editBarDialog=new window.dnn.editBar.EditBarDialog({title:_resx.WorkFlowDiscardTitle,innerTitle:_resx.workflow_discard_innerTitle,cancelBtnLbl:_resx.WorkFlowDiscardConfirmCancel,acceptBtnLbl:_resx.WorkFlowDiscardConfirmYes,showAcceptBtn:!0,onAcceptCallback:discardWithCommentCallback,width:"420px"},_htmlApprovalReject,viewModelDiscardCallback,null)},discardWithCommentCallback=function discardWithCommentCallbackHandler(){if(window.dnn.utils.PendingSavesManager.hasPendingSaves())return void window.dnn.utils.PendingSavesManager.addListenerWhenNoPendingSaves($.proxy(discardWithCommentCallbackHandler,this));var params={CurrentStateId:_state.CurrentState.StateID,Message:_submitViewModel.message()};_imageCallbackInfo.filePath&&(params.ImagePath=_imageCallbackInfo.filePath,params.ImageId=_imageCallbackInfo.fileId),_request&&"function"==typeof _request&&_request("EvoqContentLibrary","Publishing","DiscardTab","post",params,doActionAfterDiscarding,getPublishingStateErrorCallback)},discard=function(){var options={dialogTitle:_resx.WorkFlowDiscardTitle,dialogText:_resx.WorkFlowDiscardConfirmText,yesText:_resx.WorkFlowDiscardConfirmYes,noText:_resx.WorkFlowDiscardConfirmCancel};confirmAction(options,function confirmDiscardActionHandler(){if(window.dnn.utils.PendingSavesManager.hasPendingSaves())return void window.dnn.utils.PendingSavesManager.addListenerWhenNoPendingSaves($.proxy(confirmDiscardActionHandler,this));var params={CurrentStateId:_state.CurrentState.StateID};_request&&"function"==typeof _request&&_request("EvoqContentLibrary","Publishing","DiscardTab","post",params,function(data){$.dnnNotif({dialogClass:"noTittle",height:50,styleBlue:!0,text:_resx.page_discarded_successfully,onCloseCallback:function(){doActionAfterDiscarding(data)}})},getPublishingStateErrorCallback)},function(){})},PageWorkflowManager.prototype.getViewModel=function(){return _viewModel},PageWorkflowManager.prototype.hasPendingChanges=function(visible){_viewModel.hasPendingChanges(visible),visible&&updateStateIfNeeded()},PageWorkflowManager.prototype.updateHistoryList=function(){_state&&!_state.IsCompleteWorkflow&&_pageHistoryManager.modifyLastVersionState(_state.CurrentState.StateName)},PageWorkflowManager.prototype.isPrivatePage=function(){isPrivatePage()},PageWorkflowManager.prototype.getPublishingState=function(){getPublishingState()},PageWorkflowManager}(),window.dnn.pageWorkflow.PageWorkflowManager=PageWorkflowManagerClass}.call(this);