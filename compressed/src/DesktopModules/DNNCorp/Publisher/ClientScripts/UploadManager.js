window.dnn=dnn||{},window.dnn.modules=dnn.modules||{},window.dnn.modules.publisher=dnn.modules.publisher||{},window.dnn.modules.publisher.UploadManager=function($,ko){"use strict";function supportAjaxUpload(){var xhr=new XMLHttpRequest;return!!(xhr&&"upload"in xhr&&"onprogress"in xhr.upload)}function initFileUpload(wrapper){var url=dnn.modules.publisher.RequestUtils.getServiceUrl("Publisher","FileUpload")+"UploadFile";if(!supportAjaxUpload()){var antiForgeryToken=$('input[name="__RequestVerificationToken"]').val();url+="?__RequestVerificationToken="+antiForgeryToken+"&ModuleId="+config.moduleId+"&TabId="+config.tabId}var uploader=wrapper.find("#uploader");uploader.fileupload({url:url,beforeSend:dnn.modules.publisher.RequestUtils.setHeaders,replaceFileInput:!1,dropZone:wrapper.find("div.droparea"),submit:function(e,d){return viewModel.uploading(!0),d.formData||(d.formData={}),!0},done:function(e,d){var result=supportAjaxUpload()?d.result:$("pre",d.result).html();onImageUploaded(result)},always:function(){viewModel.uploading(!1),viewModel.draggingOver(!1)},error:function(e,d,message){dnn.modules.publisher.RequestUtils.showError(e)},progress:function(e,data){var percent=100*data.loaded/data.total;viewModel.uploadPercent(percent)}}),browserSupportsDragDrop()||uploader.parent().addClass("not-supported")}function setOnImageUploaded(onImageUploadedCallback){onImageUploaded=onImageUploadedCallback}function init(configurations){config=configurations;var viewModelBinding=$(config.bindingElementSelector),node=viewModelBinding[0];ko.dataFor(node)&&ko.cleanNode(node),ko.applyBindings(viewModel,node),initFileUpload(viewModelBinding),getImages()}var onImageUploaded,getImages,config,browserSupportsDragDrop,viewModel={activeTab:ko.observable("upload-file"),draggingOver:ko.observable(!1),uploading:ko.observable(!1),uploadPercent:ko.observable(0),uploadUrl:ko.observable(),uploadingFromUrl:ko.observable(!1),previewAvailable:ko.observable(!1),searchInput:ko.observable(null),selectedFileId:ko.observable(null),currentFolder:ko.observable({key:-1}),storedFiles:ko.observableArray()};return viewModel.activateTab=function(d,e){var tab=e.target.attributes.href.nodeValue.substring(1);viewModel.activeTab(tab)},viewModel.dragOver=function(){browserSupportsDragDrop()&&viewModel.draggingOver(!0)},viewModel.dragLeave=function(){viewModel.draggingOver(!1)},viewModel.uploadFromUrl=function(){if(viewModel.uploadUrl()&&viewModel.previewAvailable){viewModel.uploadingFromUrl(!0);var data={url:viewModel.uploadUrl()};dnn.modules.publisher.RequestUtils.request("Publisher","FileUpload","UploadFromUrl","POST",data,onImageUploaded,null,function(){viewModel.uploadingFromUrl(!1)})}},viewModel.previewUrl=ko.computed(function(){return viewModel.previewAvailable(!0),viewModel.uploadUrl()}).extend({throttle:500}),viewModel.hidePreview=function(){viewModel.previewAvailable(!1)},viewModel.searchText=ko.computed(function(){return viewModel.searchInput()}).extend({throttle:500}),viewModel.searchText.subscribe(function(){getImages()}),viewModel.itemClick=function(d,e){"folder"===d.type?(viewModel.currentFolder({key:d.id,value:d.title,path:d.path}),getImages()):viewModel.selectedFileId(d.id)},viewModel.setStoredImage=function(){if(null!=viewModel.selectedFileId()){var data={fileId:viewModel.selectedFileId()};dnn.modules.publisher.RequestUtils.request("Publisher","FileUpload","setStoredImage","POST",data,onImageUploaded)}},viewModel.selectedFolderChanged=function(folder){viewModel.currentFolder(folder),viewModel.searchInput(""),viewModel.selectedFileId(null),getImages(!1)},browserSupportsDragDrop=function(){return"draggable"in document.createElement("span")},getImages=function(){var params={keyword:viewModel.searchText(),folderId:viewModel.currentFolder().key,loadRecent:viewModel.currentFolder().key===-1,permission:"READ,ADD"};viewModel.storedFiles.removeAll(),dnn.modules.publisher.RequestUtils.request("DNNCorp/EvoqLibrary","Redactor","getimages","GET",params,function(data){ko.utils.arrayPushAll(viewModel.storedFiles,data)})},{init:init,setOnImageUploaded:setOnImageUploaded}}(jQuery||$,ko);