window.dnn=dnn||{},window.dnn.personalizedTabs=dnn.personalizedTabs||{},window.dnn.personalizedTabs.rules=dnn.personalizedTabs.rules||{},function(){var UserProfileRuleClass;UserProfileRuleClass=function(){"use strict";function UserProfileRule(onDeleteRuleCallback,resx){_resx=resx,this._id="",this._viewModel={},this._dataTypeController={},this._ruleElement=null,this.onDeleteRuleCallback=onDeleteRuleCallback,_templateLoader=window.dnn.personalizedTabs.TemplateLoader,UserProfileRule.template||_templateLoader.readHtmlTemplate(dnn.getVar("dnn_content_personalization_resourceroot")+HTML_PATH,function(template){UserProfileRule.template=template})}var _templateLoader,_service,_resx,getService,getServiceUrl,getViewModel,remove,getDataTypeController,getViewModelValidation,onBeforeSend,makeRequest,HTML_PATH="Assests/Html/Rules/UserProfileTemplate.html";return UserProfileRule.class="UserProfileRule",UserProfileRule.type="Class",UserProfileRule.template,UserProfileRule.allowMultipleInstances=!0,getService=function(){return _service||(_service=$.dnnSF()),_service},getServiceUrl=function(service,controller){return getService().getServiceRoot(service)+controller+"/"},onBeforeSend=function(xhr){getService().setModuleHeaders(xhr)},makeRequest=function(service,controller,method,type,params,data,callback,errorCallBack,sync){var d=data;params&&"json"===params.dataType&&(d=JSON.stringify(data));var request={url:getServiceUrl(service,controller)+method,type:type,data:d,async:!sync,beforeSend:$.proxy(onBeforeSend,this),success:function(data){"function"==typeof callback&&callback(data)},error:function(xhr){"function"==typeof errorCallBack&&errorCallBack(xhr)}};$.extend(request,params),$.ajax(request)},getDataTypeController=function(property,self,data){if(self._dataTypeController=window.dnn.personalizedTabs.rules.userProfile.DataTypeController[property.DataType](),!self._dataTypeController)return void console.log("The type "+dataType+" still is not supported");self._viewModel.changes(!0),self._viewModel.matchTemplate(self._dataTypeController.template),data&&data.PropertyInfo.PropertyId===property.PropertyId?self._viewModel.matchValue(self._dataTypeController.viewModelController.fillViewModel(property.PropertyId,self._viewModel.id,_resx,data)):self._viewModel.matchValue(self._dataTypeController.viewModelController.getViewModel(property.PropertyId,self._viewModel.id,_resx));var validationObject=getViewModelValidation(self._viewModel),extendedValidationObject=$.extend({},validationObject,self._dataTypeController.viewModelController.getViewModelValidation(self._viewModel.matchValue()));self._viewModel.validationObservable=ko.validatedObservable(extendedValidationObject),$(self).trigger("validationUpdated",[self._id,self._viewModel.validationObservable]),self._viewModel.validationObservable.valueHasMutated(),self._viewModel.changes(!1),self._viewModel.matchValue.valueHasMutated()},getViewModelValidation=function(viewModel){return{selectedProperty:viewModel.selectedProperty}},getViewModel=function(self,data){self._viewModel={id:self._id,remove:remove,self:self,resx:_resx,changes:ko.observable(!1),allowedProperties:ko.observableArray(UserProfileRule.allowedProperties),selectedProperty:ko.observable().extend({required:!0}),matchTemplate:ko.observable(),matchValue:ko.observable()},self._viewModel.selectedProperty.subscribe(function(selectedProperty){getDataTypeController(selectedProperty,self,data)}),data&&UserProfileRule.allowedProperties.forEach(function(property,idx){data.PropertyInfo.PropertyId==property.PropertyId&&self._viewModel.selectedProperty(property)}),self._viewModel.validationObservable=ko.validatedObservable(getViewModelValidation(self._viewModel))},remove=function(){this.self.onDeleteRuleCallback&&"function"==typeof this.self.onDeleteRuleCallback&&this.self.onDeleteRuleCallback(this.id)},UserProfileRule.getId=function(){return"UserProfileRule"},UserProfileRule.getName=function(resx){return resx.RulesUserProfileName},UserProfileRule.loadTemplate=function(callback){UserProfileRule.template?callback():_templateLoader.readHtmlTemplate(dnn.getVar("dnn_content_personalization_resourceroot")+HTML_PATH,function(template){UserProfileRule.template=template,callback()})},UserProfileRule.initStaticElements=function(){UserProfileRule.allowedProperties=[],makeRequest("ContentPersonalization","UserProfile","GetProperties","get",null,null,function(data){data.forEach(function(property,idx){UserProfileRule.allowedProperties.push(property)})})},UserProfileRule.prototype.getId=function(){return this._id},UserProfileRule.prototype.injectRule=function(parentElement,afterInjectCallback,data){var self=this;UserProfileRule.loadTemplate(function(){var dateNow=(new Date).getTime(),html=UserProfileRule.template.replace(/\{0\}/g,dateNow);parentElement.append(html),self._id=dateNow,self._ruleElement=$("#{0}".replace(/\{0\}/g,self._id)),getViewModel(self,data),ko.applyBindings(self._viewModel,self._ruleElement[0],{decorateElement:!0,insertMessages:!0,deep:!0}),afterInjectCallback(self,parentElement,self._viewModel.validationObservable)})},UserProfileRule.prototype.getDataToBeSent=function(){if(this._viewModel){var matchValueData=this._dataTypeController.viewModelController.fillData(this._viewModel.matchValue());return{type:"UserProfileRule",PortalId:parseInt(dnn.getVar("dnn_content_personalization_portalId")),PropertyInfo:{PropertyId:this._viewModel.selectedProperty().PropertyId,MatchValue:matchValueData}}}},UserProfileRule.prototype.freeContext=function(){var element=$("#{0}".replace(/\{0\}/g,this._id));ko.cleanNode(element)},UserProfileRule.prototype.doesRuleAllowMultipleInstances=function(){return UserProfileRule.allowMultipleInstances},UserProfileRule.prototype.getRuleClass=function(){return UserProfileRule.class},UserProfileRule}(),window.dnn.personalizedTabs.rules.UserProfileRule=UserProfileRuleClass}.call(this);