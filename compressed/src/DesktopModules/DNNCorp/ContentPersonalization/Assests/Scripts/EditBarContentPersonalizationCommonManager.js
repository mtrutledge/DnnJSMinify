window.dnn=dnn||{},window.dnn.personalizedTabs=dnn.personalizedTabs||{},function(){var EditBarContentPersonalizationCommonManagerClass;EditBarContentPersonalizationCommonManagerClass=function(){"use strict";function EditBarContentPersonalizationCommonManager(parentToInject){var isModuleEditor=dnn.getVar("cem_isModuleEditor").toLowerCase();"true"!==isModuleEditor&&(_templateLoader=new window.dnn.personalizedTabs.TemplateLoader,_masterTabId=dnn.getVar("dnn_content_personalization_masterTabId"),_personalizedTabManager=new window.dnn.personalizedTabs.PersonalizedTabManager(_masterTabId,addNewPersonalizedTabToViewModel),_previewModeManager=PreviewModeManager.getInstance(),dnnEditBarActiveCallback(parentToInject),iniListeners())}var _viewModel,_masterTabId,_templateLoader,_personalizedTabManager,_previewModeManager,resx,createViewModel,dnnEditBarActiveCallback,togglePersonalizedTabsPanel,iniListeners,makeRequest,getService,getServiceUrl,service,onBeforeSend,confirmAction,getPersonalizedTabs,populatePersonalizedTabs,deletePersonalizedTab,_deletePersonalizedTab,goToPageInEditMode,goToPageInViewMode,showPreviewMode,previewModeBeforeCloseCallback,addNewPersonalizedTab,editPersonalizedPage,addNewPersonalizedTabToViewModel,setExtensionPointBehavior,changePersonalizedPagePriority,setPrioritySuccessCallback,resxCallback200,OPTIONS_HTML_PATH="Assests/Html/EditBarContentPersonalizationCommonTabOptions.html",PANELS_HTML_PATH="Assests/Html/EditBarContentPersonalizationCommonTabPanels.html",OPTIONS_BINDING_ID="editBarContentPersonalizationCommonTabOptions",PANELS_BINDING_ID="personalizedPagesContainer",RIGHT_SECTION_ELEMENTS_QUERY=".editbar .right-section",VIEW_PERSONALIZATION_PAGES_ID="viewPersonalizedPagesButton";return EditBarContentPersonalizationCommonManager.class="EditBarContentPersonalizationCommonManager",EditBarContentPersonalizationCommonManager.type="Class",_viewModel={},getService=function(){return service||(service=$.dnnSF()),service},getServiceUrl=function(service,controller){return getService().getServiceRoot(service)+controller+"/"},onBeforeSend=function(xhr){getService().setModuleHeaders(xhr)},makeRequest=function(service,controller,method,type,params,data,callback,errorCallBack,sync){var d=data;params&&"json"===params.dataType&&(d=JSON.stringify(data));var request={url:getServiceUrl(service,controller)+method,type:type,data:d,async:!sync,beforeSend:$.proxy(onBeforeSend,this),success:function(data){"function"==typeof callback&&callback(data)},error:function(xhr){"function"==typeof errorCallBack&&errorCallBack(xhr)}};$.extend(request,params),$.ajax(request)},confirmAction=function(options,yesAction,noAction){$("<div class='dnnDialog'></div>").html(options.dialogText).dialog({modal:!0,autoOpen:!0,dialogClass:"dnnFormPopup",width:400,height:215,resizable:!1,title:options.dialogTitle,buttons:[{id:"delete_button",text:options.yesText,class:"dnnPrimaryAction",click:function(){$(this).dialog("close"),yesAction&&"function"==typeof yesAction&&yesAction()}},{id:"cancel_button",text:options.noText,click:function(){$(this).dialog("close"),noAction&&"function"==typeof noAction&&noAction()},class:"dnnSecondaryAction"}]})},createViewModel=function(){var maxNumberOfVersions=parseInt(dnn.getVar("dnn_content_personalization_maxNumberOfVersions"));_viewModel={maxNumberOfVersions:maxNumberOfVersions,visible:ko.observable(!1),disabled:"true"===dnn.getVar("dnn_content_personalization_personalizedPagesDisable"),togglePersonalizedTabsPanel:togglePersonalizedTabsPanel,deletePersonalizedTab:deletePersonalizedTab,goToPageInViewMode:goToPageInViewMode,goToPageInEditMode:goToPageInEditMode,showPreviewMode:showPreviewMode,currentTabId:getService().getTabId(),addNewPersonalizedTab:addNewPersonalizedTab,editPersonalizedPage:editPersonalizedPage,personalizedTabs:ko.observableArray([]),changePersonalizedPagePriority:changePersonalizedPagePriority,resx:{ViewPersonalizedTabsButton:resx.ViewPersonalizedTabsButton,ViewPersonalizedTabsButtonDisabled:resx.ViewPersonalizedTabsButtonDisabled,panel:{title:resx.PanelTitle,headers:{versionName:resx.PanelHeaderVersionName,date:resx.PanelHeaderDate,published:resx.PanelHeaderPublished,actions:resx.PanelHeaderActions,priority:resx.PanelHeaderPriority},buttons:{editPersonalizedTab:resx.PanelButtonEditPersonalizedTab,editMasterTab:resx.PanelButtonEditMasterTab,editRulesPersonalizedTab:resx.PanelButtonEditRulesPersonalizedTab,viewPersonalizedTab:resx.PanelButtonViewPersonalizedTab,viewMasterTab:resx.PanelButtonViewMasterTab,deletePersonalizedTab:resx.PanelButtonDeletePersonalizedTab,addNew:resx.PanelButtonAddNew,close:resx.PanelButtonClose},labels:{maxNumberAllowed:String.format(resx.PanelLabelMaxNumberAllowed,maxNumberOfVersions),noPersonalizedTabsCreatedYet:resx.PanelLabelNoPersonalizedPages,labelDefaultView:resx.LabelDefaultView}},confirmDialog:{deleteTitle:resx.ConfirmDialogDeleteTitle,deleteText:resx.ConfirmDialogDeleteText,deleteYesText:resx.ConfirmDialogDeleteYes,deleteNoText:resx.ConfirmDialogDeleteNo}}},_viewModel.canAddNewPersonalizedTab=ko.computed(function(){return _viewModel.personalizedTabs().length<_viewModel.maxNumberOfVersions+1}),_viewModel.getNumberOfPersonalizedPages=ko.computed(function(){return _viewModel.personalizedTabs().length>0?_viewModel.personalizedTabs().length-1:0})},iniListeners=function(){$(document).on("dnnActionOnEditBar",function(event,data){data.id!=VIEW_PERSONALIZATION_PAGES_ID&&_viewModel.visible()&&_viewModel.visible(!1)})},resxCallback200=function(response,parentToInject){resx=response.localization,createViewModel(),getPersonalizedTabs();var toInject=[{extensionPointId:dnn.getVar("dnn_content_personalization_editBarPanelsExtensionPoint"),path:dnn.getVar("dnn_content_personalization_resourceroot")+PANELS_HTML_PATH,viewModel:_viewModel,viewModelBindingId:PANELS_BINDING_ID,callback:function(){setExtensionPointBehavior()}},{extensionPointId:dnn.getVar("dnn_content_personalization_editBarOptionsExtensionPoint"),path:dnn.getVar("dnn_content_personalization_resourceroot")+OPTIONS_HTML_PATH,viewModel:_viewModel,viewModelBindingId:OPTIONS_BINDING_ID,callback:function(){setExtensionPointBehavior()}}];parentToInject&&(toInject=toInject.concat(parentToInject)),_templateLoader.registerTemplates(toInject)},dnnEditBarActiveCallback=function(parentToInject){var localizationOptions={service:"ContentPersonalization",controller:"Localization",resxName:"EditBarMasterTabResourcesSettingsResx",resourceSettings:{local:{culture:dnn.getVar("cem_EditBarCommonTabResourcesSettings_resx_culture"),resxTimeStamp:dnn.getVar("cem_EditBarCommonTabResourcesSettings_resx_timestamp")}},resources:{method:"GetEditBarMasterTabTable",paramName:null,callback200:function(response){resxCallback200(response,parentToInject)},callbackError:null}};new dnn.utils.Localization(localizationOptions)},populatePersonalizedTabs=function(data){_viewModel.personalizedTabs.removeAll();var item;data.forEach(function(tab,idx){item={tabId:tab.TabId,originalTabId:tab.OriginalTabId,portalId:tab.PortalId,name:tab.Name,createdOnDate:tab.CreatedOnDate,hasBeenPublished:tab.HasBeenPublished?"âœ“":"---",priority:tab.Priority,tabLink:tab.TabLink,rules:tab.Rules,isMasterPage:tab.TabId===tab.OriginalTabId},_viewModel.personalizedTabs.push(item)})},getPersonalizedTabs=function(){makeRequest("ContentPersonalization","ContentPersonalization","GetPersonalizationTabs","get",null,{tabId:_masterTabId},function(data){populatePersonalizedTabs(data)},function(e){$.dnnAlert({title:"",text:e.responseText})})},_deletePersonalizedTab=function(tab){makeRequest&&"function"==typeof makeRequest&&makeRequest("ContentPersonalization","ContentPersonalization","DeletePersonalizationTab","post",null,{TabId:tab.tabId},function(data){_viewModel.personalizedTabs.remove(tab)},function(e){$.dnnAlert({title:"",text:e.responseText})})},deletePersonalizedTab=function(tab){var options={dialogText:String.format(_viewModel.resx.confirmDialog.deleteText,tab.name),dialogTitle:_viewModel.resx.confirmDialog.deleteTitle,yesText:_viewModel.resx.confirmDialog.deleteYesText,noText:_viewModel.resx.confirmDialog.deleteNoText};confirmAction(options,function(){_deletePersonalizedTab(tab)})},goToPageInViewMode=function(tab){window.location.href=tab.tabLink},goToPageInEditMode=function(tab){makeRequest&&"function"==typeof makeRequest&&makeRequest("ContentPersonalization","ContentPersonalization","GoToTabInEditMode","post",null,{TabId:tab.tabId,PortalId:tab.portalId},function(data){window.location=data.TabLink},function(e){$.dnnAlert({title:"",text:e.responseText})})},previewModeBeforeCloseCallback=function(){_viewModel.visible(!0),$(RIGHT_SECTION_ELEMENTS_QUERY).show()},showPreviewMode=function(tab){var previousVersion=_previewModeManager.version,previousUrl=_previewModeManager.url,previousCallback=_previewModeManager.beforeCloseCallback;_previewModeManager.version=-1,_previewModeManager.url=tab.tabLink,_previewModeManager.beforeCloseCallback=function(){previewModeBeforeCloseCallback(),_previewModeManager.version=previousVersion,_previewModeManager.url=previousUrl,_previewModeManager.beforeCloseCallback=previousCallback},$(RIGHT_SECTION_ELEMENTS_QUERY).hide(),_previewModeManager.openDesktopMode(),_viewModel.visible(!1)},addNewPersonalizedTabToViewModel=function(){getPersonalizedTabs()},addNewPersonalizedTab=function(){_personalizedTabManager.openDialog(null)},editPersonalizedPage=function(tab){_personalizedTabManager.openDialog(tab)},togglePersonalizedTabsPanel=function(){_viewModel.visible()||$(document).trigger("dnnActionOnEditBar",$("#"+VIEW_PERSONALIZATION_PAGES_ID)),_viewModel.visible(!_viewModel.visible())},setExtensionPointBehavior=function(){_viewModel.disabled||$(".ViewPersonalizedPages").hover(function(){$(".NumberOfTabsBox").addClass("isHovered")},function(){$(".NumberOfTabsBox").removeClass("isHovered")})},changePersonalizedPagePriority=function(tab,priority){makeRequest("ContentPersonalization","ContentPersonalization","SetPersonalizedTabPriority","post",null,{TabId:tab.tabId,Priority:priority},function(){setPrioritySuccessCallback(tab,priority)},function(e){$.dnnAlert({title:"",text:e.responseText})})},setPrioritySuccessCallback=function(tab,priority){var removedElement,currentIndex,newIndex,i;for(currentIndex=tab.priority-1,newIndex=priority-1,_viewModel.personalizedTabs.valueWillMutate(),removedElement=_viewModel.personalizedTabs().splice(currentIndex,1)[0],_viewModel.personalizedTabs().splice(newIndex,0,removedElement),i=0;i<_viewModel.personalizedTabs().length;i++)_viewModel.personalizedTabs()[i].priority=i+1;_viewModel.personalizedTabs.valueHasMutated(),$("td","#personalizedTab"+newIndex).effect("highlight")},EditBarContentPersonalizationCommonManager}(),window.dnn.personalizedTabs.EditBarContentPersonalizationCommonManager=EditBarContentPersonalizationCommonManagerClass}.call(this);