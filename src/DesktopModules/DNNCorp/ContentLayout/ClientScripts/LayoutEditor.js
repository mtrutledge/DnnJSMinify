
﻿if(typeof dnn==="undefined"||dnn===null){dnn={};};﻿if(typeof dnn.ContentLayout==="undefined"||dnn.ContentLayout===null){dnn.ContentLayout={};};(function($){$.fn.dnnLayoutEditor=function(options){if(!this.data("dnnLayoutEditor")){this.data("dnnLayoutEditor",new dnnLayoutEditor(this,options));}
return this;};var dnnLayoutEditor=function(container,options){this.options=options;this.container=container;this.init();};dnnLayoutEditor.prototype={constructor:dnnLayoutEditor,init:function(){this.options=$.extend({},$.fn.dnnLayoutEditor.defaultOptions,this.options);this._checkActionsState();this._addResizer();this._adjustColumnHeight();this.container.parents('div.DnnModule').addClass('CatchDragState');this._tryCatchAddModuleEvents();},_updateColumnWidth:function(){var totalWidth=0;var columns=this.container.find('> div.row > .pane');columns.each(function(){totalWidth+=$(this).outerWidth();});var totalPercent=0;for(var i=0;i<columns.length;i++){var $this=$(columns[i]);if(i<columns.length-1){var percentWidth=parseFloat((($this.outerWidth()/totalWidth)*100).toFixed(2));totalPercent+=percentWidth;$this.css({width:percentWidth+'%'});}else{$this.css({width:(100-totalPercent)+'%'});}};},_checkActionsState:function(){if(this._doesContainModules()){this._removeModuleActions();}else{this._removeModuleActionButton("Settings");this._removeModuleActionButton("Import");this._removeModuleActionButton("Export");this._removeMoveContentLayoutPanesMenuItems();}},_doesContainModules:function(){return $('div.DnnModule',this.container).length>0;},_removeModuleActions:function(){var moduleId=this.options.moduleId;var $moduleActions=$('#moduleActions-'+moduleId);this.container.parents('div.DnnModule').addClass('EditDisabled');$moduleActions.remove();},_removeModuleActionButton:function(actionName){var moduleId=this.options.moduleId;var $moduleActionsMenuItem=$('#moduleActions-'+moduleId+'-'+actionName);$moduleActionsMenuItem.remove();},_removeMoveContentLayoutPanesMenuItems:function(){var moduleId=this.options.moduleId;var $moduleMoveMenuItems=$('#moduleActions-'+moduleId+' .actionMenuMove li');$moduleMoveMenuItems.filter(this._isContentLayoutPaneMoveMenuItem).remove();},_isContentLayoutPaneMoveMenuItem:function(){var regex=new RegExp('^[A-F0-9]{4}_Pane[1-4]{1}[0-9]+$');return regex.test(this.id);},_addResizer:function(){var handler=this;var columns=this.container.find('[class~="pane"]');for(var i=0;i<columns.length;i++){var $item=$(columns[i]);if(i!==columns.length-1){$item.resizable({handles:'e',containment:'parent',minWidth:handler.options.colMinWidth,maxWidth:$item.outerWidth()+$item.next().outerWidth()-handler.options.colMinWidth-1,start:$.proxy(handler._onResizeStart,handler),resize:$.proxy(handler._onResize,handler),stop:$.proxy(handler._onResizeStop,handler)});}}
$(window).resize(function(){if(arguments.length===2&&arguments[1].element&&arguments[1].element.hasClass('ui-resizable')){return;}
for(var index=0;index<columns.length-1;index++){var $col=$(columns[index]);var maxWidth=$col.outerWidth()+$col.next().outerWidth()-handler.options.colMinWidth-1;$col.resizable('option','maxWidth',maxWidth);}});this.container.find('.ui-resizable-handle').mouseenter(function mouseEnterHandler(e){handler._showSizeViewer();}).mouseleave(function mouseLeaveHandler(e){if(handler._isResizing){return;}
handler._hideSizeViewer();});},_isResizing:false,_onResizeStart:function(event,ui){var handler=this;handler._isResizing=true;},_onResizeStop:function(event,ui){var handler=this;handler._isResizing=false;var sizes=[];var columns=this.container.find('[class~="pane"]');var totalWidth=0;columns.each(function(){totalWidth+=$(this).outerWidth();});var totalPercent=0;for(var i=0;i<=columns.length-1;i++){var $item=$(columns[i]);if(i<columns.length-1){var percentWidth=this._calcColumnWidthAsPercent($item);sizes.push(percentWidth);totalPercent+=percentWidth;$item.css({width:percentWidth+'%'});var maxWidth=$item.outerWidth()+$item.next().outerWidth()-handler.options.colMinWidth-1;$item.resizable('option','maxWidth',maxWidth);}else{$item.css({width:(100-totalPercent)+'%'});}};var successCallback=function successCallbackHandler(data){handler._hideSizeViewer();$(document).trigger("changeOnPageContent");}
this._getService().request('UpdateLayoutWithColumnSizes','POST',{sizes:sizes.join()},successCallback);},_onResize:function(event,ui){var width=ui.element.outerWidth();var totalWidth=ui.element.resizable("option","maxWidth")+this.options.colMinWidth;ui.element.next().css('width',totalWidth-width);this._updateSizeViewer();},_createSizeViewer:function(){var handler=this;var $columns=this.container.find('[class~="pane"]');var totalWidth=0;$columns.each(function(index){var $col=$(this);var width=index<$columns.length-1?handler._calcColumnWidthAsPercent($col):100-totalWidth;totalWidth+=width;var $viewer=$('<span class="size-viewer"></span>').html(width+'%');$col.append($viewer);});},_updateSizeViewer:function(){var handler=this;var $columns=this.container.find('[class~="pane"]');var totalWidth=0;$columns.each(function(index){var $col=$(this);var width=index<$columns.length-1?handler._calcColumnWidthAsPercent($col):100-totalWidth;totalWidth+=width;$col.find('.size-viewer').html(width+'%');});},_showSizeViewer:function(){var $viewer=this.container.find('.size-viewer');if(!$viewer.length){this._createSizeViewer();$viewer=this.container.find('.size-viewer');}
$viewer.fadeIn('fast');},_hideSizeViewer:function(){var $viewer=this.container.find('.size-viewer');$viewer.fadeOut('fast');},_calcColumnWidthAsPercent:function(col){var columns=this.container.find('[class~="pane"]');var totalWidth=0;columns.each(function(){totalWidth+=$(this).outerWidth();});return parseFloat(((col.outerWidth()/totalWidth)*100).toFixed(0));},_adjustColumnHeight:function(){var handler=this;this.container.find('> div.row > .pane').each(function(){var $col=$(this);$col.data('o-height',$col.height()).on('heightChange',$.proxy(handler._adjustColumnHeightHandler,handler));});handler._adjustColumnHeightHandler();if(!dnnLayoutEditor['LayoutHeightChange']){dnnLayoutEditor['LayoutHeightChange']=setTimeout(function(){handler._checkColumnHeight();},20);}},_checkColumnHeight:function(){var handler=this;$('div.layoutContainer > div.row > .pane').each(function(){var $col=$(this);var height=handler._getColumnHeight($col);if(height!=$col.data('o-height')){$col.trigger('heightChange');$col.data('o-height',height);}});dnnLayoutEditor['LayoutHeightChange']=setTimeout(function(){handler._checkColumnHeight();},20);},_getColumnHeight:function(col){var height=0;col.children('.DnnModule:not([class~="floating"]), .handlerContainer:visible').each(function(){height+=$(this).outerHeight(true);});if(height>0){height+=parseInt(col.css('border-top-width'))
+parseInt(col.css('border-bottom-width'))
+parseInt(col.css('padding-top'))
+parseInt(col.css('padding-bottom'));}
return parseInt(height);},_adjustColumnHeightHandler:function(){var handler=this;var maxHeight=0,maxCol;this.container.find('> div.row > .pane').each(function(){if($(this).find('> .DnnModule').length>0){var $col=$(this);var height=handler._getColumnHeight($col);if(height>maxHeight){maxHeight=height;maxCol=$col;}}});if(maxHeight>0){if(maxHeight<110){maxHeight=110;}
this.container.find('> div.row > .pane').each(function(){this.style.setProperty('min-height',maxHeight+'px','important');});}},_tryCatchAddModuleEvents:function(){var layoutPrefix=this.options.layoutPrefix;var instance=this;$(document).on('mousedown','div.ControlBar_ModuleDiv',function(){if(instance._isContentLayoutModule(this)){instance.container.parents('div.DnnModule').addClass('dragging');}}).on('mouseup','div.ControlBar_ModuleDiv',function(){instance.container.parents('div.DnnModule').removeClass('dragging');}).on('mouseenter','div.ControlBar_ModuleDiv',function(){var $menuItems=$('#ControlBar_Module_ModulePosition').find('li');if(instance._isContentLayoutModule(this)){$menuItems.each(function(){var pane=$(this).data('pane');if(pane.indexOf(layoutPrefix)===0){$(this).hide();}});}else{$menuItems.show();}});this.container.parents('div.DnnModule').on('dragstart',function(){$('div.DnnModule.DnnModule-ContentLayout.CatchDragState').find('div.pane').each(function(){var $pane=$(this);if($pane.data('ui-sortable')){$pane.sortable('disable');}});}).on('dragend',function(){$('div.DnnModule.DnnModule-ContentLayout.CatchDragState').find('div.pane').each(function(){var $pane=$(this);if($pane.data('ui-sortable')){$pane.sortable('enable');}});});},_isContentLayoutModule:function(element){var $element=$(element);var desktopModuleId=this.options.desktopModuleId;var moduleId=$element.data('module');if($element.parents('#ControlBar_ModuleListHolder_ExistingModule').length){return $element.find('img').attr('src').toLowerCase().indexOf(this.options.moduleIcon)>-1;};return moduleId&&moduleId===desktopModuleId;},_getService:function(){if(!this._serviceController){this._serviceController=new dnn.dnnModuleService({service:'DnnCorp/ContentLayout',controller:'Service',moduleId:this.options.moduleId});}
return this._serviceController;}};$.fn.dnnLayoutEditor.defaultOptions={colMinWidth:105,moduleIcon:'icon-contentlayout.png'};})(jQuery);